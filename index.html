<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –î–ò–ó–ê–ô–ù "PREMIUM" (v2.7 - Animations) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: radial-gradient(circle at top, #0f172a, #1e293b); 
            color: #f8fafc; 
            line-height: 1.5; 
            min-height: 100vh; 
            overflow-x: hidden; 
        }
        .fade-in { 
            animation: fadeInUp 0.4s ease forwards; 
            opacity: 0; 
            transform: translateY(20px); 
        }
        @keyframes fadeInUp { 
            to { opacity: 1; transform: translateY(0); } 
        }
        .container { max-width: 640px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .card { 
            background: rgba(255,255,255,0.05); 
            border-radius: 16px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.3); 
            padding: 20px; 
            margin-bottom: 20px; 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.08); 
        }
        .header { 
            font-size: 24px; 
            font-weight: 600; 
            margin-bottom: 16px; 
            color: #ffffff; 
        }
        .stat-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 14px; 
            text-align: center; 
        }
        .stat-item { 
            background: rgba(255,255,255,0.08); 
            border-radius: 10px; 
            padding: 10px 0; 
            transition: transform 0.2s ease, background 0.2s ease; 
        }
        .stat-item:hover { 
            transform: translateY(-2px); 
            background: rgba(255,255,255,0.12); 
        }
        .stat-item p:first-child { 
            font-size: 13px; 
            color: #cbd5e1; 
        }
        .stat-item p:last-child { 
            font-size: 20px; 
            font-weight: 600; 
            color: #ffffff; 
        }
        .btn-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 14px; 
            margin-top: 20px; 
        }
        .btn { 
            padding: 18px; 
            border-radius: 14px; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 500; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 6px; 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            color: #fff; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 12px rgba(99,102,241,0.3); 
        }
        .btn:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 6px 16px rgba(139,92,246,0.4); 
        }
        .btn-secondary { 
            background: rgba(255,255,255,0.08); 
            color: #e2e8f0; 
            box-shadow: none; 
        }
        .btn-secondary:hover { 
            background: rgba(255,255,255,0.12); 
            transform: translateY(-2px); 
            box-shadow: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #f43f5e, #e11d48);
            color: white;
            box-shadow: 0 4px 12px rgba(244,63,94,0.3);
        }
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(244,63,94,0.4);
        }
        
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .back-btn { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            border: none; 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); 
            color: #fff; 
            font-size: 18px; 
            cursor: pointer; 
            box-shadow: 0 3px 8px rgba(99,102,241,0.3); 
            transition: transform 0.2s ease; 
        }
        .back-btn:hover { transform: scale(1.1); }
        .save-btn { 
            background: linear-gradient(135deg, #10b981, #059669); 
            border: none; 
            color: white; 
            padding: 10px 18px; 
            border-radius: 10px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 3px 10px rgba(16,185,129,0.3); 
            transition: all 0.2s ease; 
        }
        .save-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 14px rgba(16,185,129,0.4); 
        }
        .empty-state { 
            text-align: center; 
            color: #94a3b8; 
            padding: 40px 0; 
        }
        .hide { display: none !important; }
        
        input[type="text"], input[type="date"], input[type="number"], select { 
            width: 100%; 
            padding: 14px; 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; 
            font-size: 16px; 
            background: rgba(0,0,0,0.2);
            color: #f8fafc;
        }
        select option {
            background: #1e293b;
            color: #f8fafc;
        }
        .exercise-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 14px; 
            background: rgba(255,255,255,0.08); 
            border-radius: 10px; 
            margin-bottom: 8px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .exercise-item:hover {
            background: rgba(255,255,255,0.12);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .delete-btn { 
            background: none; 
            border: none; 
            color: #f472b6;
            cursor: pointer; 
            font-size: 20px; 
            transition: color 0.2s ease;
        }
        .delete-btn:hover { color: #fb7185; }
        .set-row { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            margin-bottom: 12px; 
        }
        .set-label { 
            font-weight: 600; 
            width: 100px; 
            color: #cbd5e1;
        }

        /* –°—Ç–∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        .month-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .month-nav button { 
            background: rgba(255,255,255,0.08);
            color: #e2e8f0;
            border: none; 
            padding: 8px 16px; 
            border-radius: 10px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .month-nav button:hover {
            background: rgba(255,255,255,0.12);
        }
        .month-nav h3 { 
            font-size: 20px; 
            text-transform: capitalize;
            color: #ffffff;
        }
        .calendar-header { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
            margin-bottom: 8px; 
        }
        .calendar-header div { 
            font-weight: 600; 
            text-align: center; 
            color: #94a3b8; 
            font-size: 14px; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 6px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 10px; 
            background: rgba(255,255,255,0.08); 
            border: none; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            color: #f8fafc;
            transition: all 0.2s ease; 
        }
        .calendar-day:hover { background: rgba(255,255,255,0.12); }
        .day-workout { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 3px 10px rgba(16,185,129,0.3);
        }
        .day-today { box-shadow: 0 0 0 2px #6366f1 inset; }
        .day-padding {
            background: none;
            cursor: default;
        }
        .day-padding:hover { background: none; }
        canvas { max-width: 100%; height: 250px !important; }

        /* –°—Ç–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        #toast-container {
            position: fixed;
            top: 16px;
            left: 16px;
            right: 16px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            margin: 0 auto;
        }
        .toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            animation: toast-in 0.4s ease-out; 
            width: 100%;
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .toast-content { flex-grow: 1; }
        .toast-title { font-weight: 600; margin-bottom: 2px; }
        .toast-message { font-size: 13px; opacity: 0.9; word-break: break-word; }
        .toast-icon { font-size: 20px; flex-shrink: 0; line-height: 1.2; }
        .toast-close {
            background: none; border: none; color: rgba(255, 255, 255, 0.7);
            cursor: pointer; font-size: 20px; line-height: 1; padding: 0;
        }
        .toast-info {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
        }
        .toast-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }
        .toast-error {
            background: linear-gradient(135deg, #f43f5e, #e11d48);
            box-shadow: 0 4px 12px rgba(244,63,94,0.3);
        }

        /* --- SMART NUMPAD STYLES --- */
        .numpad-overlay {
            position: fixed; bottom: 0; left: 0; right: 0; top: 0;
            background: rgba(0,0,0,0.6); z-index: 4000;
            display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .numpad-overlay.active { opacity: 1; pointer-events: all; }
        .numpad-container {
            background: #1e293b;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; padding-bottom: 40px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .numpad-overlay.active .numpad-container { transform: translateY(0); }

        .numpad-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        .numpad-display {
            font-size: 32px; font-weight: bold; color: #fff;
            text-align: right; flex-grow: 1; margin-right: 20px;
            font-family: monospace; letter-spacing: 2px;
        }
        .numpad-label { font-size: 14px; color: #94a3b8; text-transform: uppercase; font-weight: 600; }

        .numpad-body { display: grid; grid-template-columns: 3fr 1fr; gap: 16px; }

        .numpad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .num-btn {
            background: rgba(255,255,255,0.05); border: none; color: #f8fafc;
            font-size: 22px; font-weight: 500; border-radius: 12px; padding: 16px 0;
            cursor: pointer; transition: background 0.1s;
        }
        .num-btn:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }

        .quick-grid { display: flex; flex-direction: column; gap: 10px; }
        .quick-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white; border: none; border-radius: 12px;
            font-size: 14px; font-weight: 600; flex: 1;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .quick-btn:active { transform: scale(0.95); }
        .quick-btn.reps { background: linear-gradient(135deg, #10b981, #059669); }

        .action-btn { grid-column: span 1; background: rgba(244, 63, 94, 0.2); color: #f43f5e; }
        .done-btn {
            grid-column: span 3; background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white; font-weight: bold; margin-top: 10px;
        }
        /* --- –ö–û–ù–ï–¶ –°–¢–ò–õ–ï–ô --- */
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    
    <div id="toast-container"></div>
    
    <div id="numpad-modal" class="numpad-overlay" onclick="closeNumpad(event)">
        <div class="numpad-container" onclick="event.stopPropagation()">
            <div class="numpad-header">
                <div class="numpad-label" id="np-label">–í–ï–° (–ö–ì)</div>
                <div class="numpad-display" id="np-display">0</div>
            </div>
            <div class="numpad-body">
                <div class="numpad-grid">
                    <button class="num-btn" onclick="npType('1')">1</button>
                    <button class="num-btn" onclick="npType('2')">2</button>
                    <button class="num-btn" onclick="npType('3')">3</button>
                    <button class="num-btn" onclick="npType('4')">4</button>
                    <button class="num-btn" onclick="npType('5')">5</button>
                    <button class="num-btn" onclick="npType('6')">6</button>
                    <button class="num-btn" onclick="npType('7')">7</button>
                    <button class="num-btn" onclick="npType('8')">8</button>
                    <button class="num-btn" onclick="npType('9')">9</button>
                    <button class="num-btn" onclick="npType('.')">.</button>
                    <button class="num-btn" onclick="npType('0')">0</button>
                    <button class="num-btn action-btn" onclick="npBack()">‚å´</button>
                    <button class="num-btn done-btn" onclick="npSave()">–ì–û–¢–û–í–û</button>
                </div>
                <div class="quick-grid" id="quick-buttons">
                    </div>
            </div>
        </div>
    </div>

    <script>
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let exStatsBackView = 'stats';
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null; 
        let workoutBackView = 'home';

        // --- –õ–û–ì–ò–ö–ê SMART NUMPAD ---
        let npCurrentValue = '';
        let npTargetIndex = null;
        let npTargetKey = null; // 'weight' or 'reps'

        function openNumpad(index, key, value) {
            npTargetIndex = index;
            npTargetKey = key;
            npCurrentValue = (value === 0 || value === "0" || value === undefined) ? '' : value.toString();
            
            document.getElementById('np-display').innerText = npCurrentValue || '0';
            document.getElementById('np-label').innerText = key === 'weight' ? '–í–ï–° (–ö–ì)' : (key === 'time' ? '–í–†–ï–ú–Ø (–ú–ò–ù)' : (key === 'distance' ? '–î–ò–°–¢–ê–ù–¶–ò–Ø (–ö–ú)' : '–ü–û–í–¢–û–†–ï–ù–ò–Ø'));
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            const qContainer = document.getElementById('quick-buttons');
            qContainer.innerHTML = '';
            
            let increments = [];
            if (key === 'weight') increments = [1.25, 2.5, 5, 10];
            else if (key === 'time') increments = [5, 10, 15, 30];
            else if (key === 'distance') increments = [0.5, 1, 2, 5];
            else increments = [1, 2, 3, 5]; // reps
                
            increments.forEach(val => {
                const btn = document.createElement('button');
                btn.className = `quick-btn ${key === 'reps' ? 'reps' : ''}`;
                btn.innerText = `+${val}`;
                btn.onclick = () => {
                    let curr = parseFloat(npCurrentValue) || 0;
                    curr += val;
                    // –û–∫—Ä—É–≥–ª—è–µ–º
                    if(key === 'weight' || key === 'distance') npCurrentValue = (Math.round(curr * 100) / 100).toString();
                    else npCurrentValue = Math.round(curr).toString();
                    
                    document.getElementById('np-display').innerText = npCurrentValue;
                    // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
                    if (window.Telegram?.WebApp?.HapticFeedback) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    }
                };
                qContainer.appendChild(btn);
            });

            const modal = document.getElementById('numpad-modal');
            modal.classList.add('active');
            
            // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        }

        function closeNumpad(e) {
            if (e) e.stopPropagation();
            document.getElementById('numpad-modal').classList.remove('active');
        }

        function npType(char) {
            if (char === '.' && npCurrentValue.includes('.')) return;
            if (npCurrentValue.length > 6) return; // –õ–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤
            npCurrentValue += char;
            document.getElementById('np-display').innerText = npCurrentValue;
        }

        function npBack() {
            npCurrentValue = npCurrentValue.slice(0, -1);
            document.getElementById('np-display').innerText = npCurrentValue || '0';
        }

        function npSave() {
            if (npTargetIndex !== null && npTargetKey) {
                updateSet(npTargetIndex, npTargetKey, npCurrentValue);
                render(); 
            }
            closeNumpad();
            if (window.Telegram?.WebApp?.HapticFeedback) {
                Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        }
        // --- –ö–û–ù–ï–¶ –õ–û–ì–ò–ö–ò NUMPAD ---

        function showToast(title, message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = 'üí¨';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = 'üóëÔ∏è';

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toast-out 0.3s ease-in forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, duration);
        }

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            Telegram.WebApp.setHeaderColor('#0f172a');
            Telegram.WebApp.setBackgroundColor('#0f172a');
        }

        function init() {
            try {
                Chart.defaults.color = '#cbd5e1';
                Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:", e);
                exercises = [];
                workouts = [];
                routines = [];
            }
            render();
        }

        function save() {
            try {
                localStorage.setItem('workout-exercises', JSON.stringify(exercises));
                localStorage.setItem('workout-logs', JSON.stringify(workouts));
                localStorage.setItem('workout-routines', JSON.stringify(routines)); 
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage:", e);
            }
        }
        
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `workout_tracker_data_${date}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('–≠–∫—Å–ø–æ—Ä—Ç', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
        }

        function importData() {
            if (!confirm('–í–Ω–∏–º–∞–Ω–∏–µ! –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –í–°–ï —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.exercises || !importedData.workouts || !importedData.routines) {
                            throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö.");
                        }
                        exercises = importedData.exercises;
                        workouts = importedData.workouts;
                        routines = importedData.routines;
                        save();
                        showToast('–ò–º–ø–æ—Ä—Ç', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
                        go('home'); 
                    } catch (error) {
                        showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', error.message, 'error', 5000);
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines, 
                editRoutine: renderEditRoutine, 
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail, 
                editExercise: renderEditExercise,
                workoutDetails: renderWorkoutDetails
            };
            document.getElementById('view').innerHTML = views[currentView]();
            window.scrollTo(0, 0); 
        }

        function go(view) {
            currentView = view;
            if (view === 'calendar' || view === 'home') {
                 currentViewDate = new Date();
                 if (view === 'home') {
                    selectedDate = new Date().toISOString().split('T')[0]; 
                 }
                 workoutBackView = 'home';
            }
            if (currentView !== 'editExercise') {
                selectedExIdEdit = null;
            }
            if (currentView !== 'editRoutine') {
                selectedRoutineIdEdit = null;
            }
            render();
        }
        
        function changeMonth(offset) {
            currentViewDate.setDate(1); 
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            render(); 
        }

        function viewHomeExDetail(exId) {
            selExIdHome = exId;
            go('homeExDetail');
        }

        function editTodayExercise(exId) {
            const todayDateStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDateStr);
            if (!wo) {
                console.error("–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è '—Å–µ–≥–æ–¥–Ω—è' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                return; 
            }

            selectedDate = todayDateStr;
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            selExId = exId;
            workoutBackView = 'home'; 
            
            go('workoutDetails');
        }

        function editEx(id) {
            selectedExIdEdit = id;
            go('editExercise');
        }

        function editRoutine(id) { 
            selectedRoutineIdEdit = id;
            go('editRoutine');
        }

        function onCalendarDayClick(dateStr) {
            selectedDate = dateStr;
            const hasWorkout = workouts.some(w => w.date === dateStr);
            if (hasWorkout) {
                go('detail');
            } else {
                go('newWorkout');
            }
        }
        
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(12, 0, 0, 0); 
            return monday.toISOString().split('T')[0];
        }

        function getWeeklyStreak() {
            if (!workouts.length) return 0;
            const uniqueWeekIds = new Set(workouts.map(w => getMonday(w.date)));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            let currentMonday = new Date(getMonday(curr));
            
            while (true) {
                const id = currentMonday.toISOString().split('T')[0];
                if (uniqueWeekIds.has(id)) {
                    streak++;
                    currentMonday.setDate(currentMonday.getDate() - 7);
                } else {
                    break;
                }
                if (streak > 260) break; 
            }
            return streak;
        }

        function getStreak() {
            if (!workouts.length) return 0;
            const dates = new Set(workouts.map(w => w.date));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 

            for (let i = 0; i < 365; i++) {
                const ds = curr.toISOString().split('T')[0];
                const isToday = i === 0 && dates.has(ds);
                const isYesterday = i > 0 && dates.has(ds);

                if (isToday || isYesterday) {
                    streak++;
                    curr.setDate(curr.getDate() - 1);
                } else if (i === 0) {
                    curr.setDate(curr.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }

        function calculateSetVolume(set, type) {
            const reps = parseFloat(set.reps || 0);
            if (type === 'weight') {
                const weight = parseFloat(set.weight || 0);
                return weight * reps; 
            } else if (type === 'distance' || type === 'time' || type === 'reps') {
                return reps; 
            }
            return 0;
        }

        function calculateWorkoutVolume(workout) {
            let totalVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                
                ex.sets.forEach(set => {
                    totalVolume += calculateSetVolume(set, type);
                });
            });
            return Math.round(totalVolume); 
        }

        function getMaxSetVolume(exerciseId) {
            let maxVolume = 0;
            workouts.forEach(w => {
                const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                if (ex) {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';

                    ex.sets.forEach(set => {
                        const volume = calculateSetVolume(set, type);
                        if (volume > maxVolume) { 
                            maxVolume = volume;
                        }
                    });
                }
            });
            return maxVolume;
        }

        function renderHome() {
            const dayStreak = getStreak();
            const weekStreak = getWeeklyStreak(); 
            const todayDateStr = new Date().toISOString().split('T')[0]; 
            const today = workouts.find(w => w.date === todayDateStr); 
            
            let h = `
                <div class="header fade-in" style="animation-delay: 0.05s;">üí™ –¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                <div class="card stat-grid fade-in" style="animation-delay: 0.1s;">
                    <div class="stat-item">
                        <p>–î–Ω–∏ üî•</p>
                        <p>${dayStreak}</p>
                    </div>
                    <div class="stat-item">
                        <p>–ù–µ–¥–µ–ª–∏ üóìÔ∏è</p>
                        <p>${weekStreak}</p>
                    </div>
                    <div class="stat-item">
                        <p>–í—Å–µ–≥–æ</p>
                        <p>${workouts.length}</p>
                    </div>
                </div>

                <div class="btn-grid">
                    <button class="btn fade-in" style="animation-delay: 0.15s;" onclick="go('newWorkout')">‚ûï –ù–æ–≤–∞—è</button>
                    <button class="btn fade-in" style="animation-delay: 0.2s;" onclick="go('exercises')">üèãÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                    <button class="btn fade-in" style="animation-delay: 0.25s;" onclick="go('routines')">üìã –®–∞–±–ª–æ–Ω—ã</button>
                    <button class="btn fade-in" style="animation-delay: 0.3s;" onclick="go('calendar')">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                </div>
                
                <button class="btn btn-secondary fade-in" style="width:100%; margin-top:16px; animation-delay:0.35s;" onclick="go('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="btn btn-secondary fade-in" style="width:100%; margin-top:8px; animation-delay:0.4s;" onclick="go('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            `;

            if (today) {
                h += `
                <div class="card fade-in" style="margin-top: 20px; animation-delay: 0.45s;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0; font-size: 18px;" class="header">–°–µ–≥–æ–¥–Ω—è</h3>
                        <button onclick="editToday()" class="save-btn" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); box-shadow: 0 3px 8px rgba(99,102,241,0.3); padding: 8px 12px; font-size: 16px;">‚úèÔ∏è</button>
                    </div>`;
                today.exercises.forEach((ex, index) => {
                    const e = exercises.find(e => e.id === ex.exerciseId);
                    const t = e ? e.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                    let d = '';
                    if (t === 'weight') {
                        const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                        d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥`;
                    } else if (t === 'distance') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps.toFixed(1)} –∫–º`;
                    else if (t === 'time') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(totalReps)} –º–∏–Ω`;
                    else d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;
                    
                    h += `<div class="fade-in" style="animation-delay: ${index * 0.05}s; border-bottom: 1px solid rgba(255,255,255,0.08); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="editTodayExercise('${ex.exerciseId}')">
                        <div style="padding: 12px 0;">
                            <div style="font-weight: 600; color: #f8fafc;">${ex.exerciseName}</div>
                            <div style="color: #cbd5e1; font-size: 14px;">${d}</div>
                        </div>
                        <span style="font-size: 24px; color: #94a3b8;">‚Ä∫</span>
                    </div>`;
                });
                h += '</div>';
            }
            return h;
        }

        function renderHomeExerciseDetail() {
            if (!selExIdHome) return go('home'); 
            const todayDate = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDate);
            if (!wo) { selExIdHome = null; return go('home'); } 
            const ex = wo.exercises.find(e => e.exerciseId === selExIdHome);
            if (!ex) { selExIdHome = null; return go('home'); } 
            const eBase = exercises.find(e => e.id === ex.exerciseId);
            const t = eBase ? eBase.type : 'reps';
            const maxVol = getMaxSetVolume(ex.exerciseId);

            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0; max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.exerciseName}</h2>
                        <div style="width: 40px;"></div>
                     </div>`;
            h += `<div class="card fade-in" style="animation-delay: 0.1s;">`;
            ex.sets.forEach((set, index) => {
                const setVol = calculateSetVolume(set, t);
                const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01); 
                const prLabel = isPR ? ' <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>' : '';

                h += `<div class="fade-in" style="animation-delay: ${index * 0.05}s; display: flex; justify-content: space-between; align-items: center; padding: 12px 4px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                    <span style="font-weight: 600; color: #cbd5e1;">–ü–æ–¥—Ö–æ–¥ ${set.setNumber}</span>
                    <span style="color: #f8fafc; font-size: 16px; font-weight: 500;">`;
                if (t === 'weight') h += `${set.weight || 0} –∫–≥ √ó ${set.reps || 0} –ø–æ–≤—Ç${prLabel}`;
                else if (t === 'distance') h += `${(set.reps || 0).toFixed(1)} –∫–º${prLabel}`;
                else if (t === 'time') h += `${set.reps || 0} –º–∏–Ω${prLabel}`;
                else h += `${set.reps || 0} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π${prLabel}`;
                h += `</span></div>`;
            });
            let sum = '';
            if (t === 'weight') {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥ –æ–±—â–∏–π`;
            } else if (t === 'distance') {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr.toFixed(1)} –∫–º –≤—Å–µ–≥–æ`;
            } else if (t === 'time') {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(tr)} –º–∏–Ω –≤—Å–µ–≥–æ`;
            } else {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;
            }
            h += `<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid rgba(255,255,255,0.1); color: #f8fafc; font-weight: 600; text-align: right; font-size: 14px;">–í—Å–µ–≥–æ: ${sum}</div></div>`;
            return h;
        }

        function renderCalendar() {
            const workoutDates = new Set(workouts.map(w => w.date));
            const todayStr = new Date().toISOString().split('T')[0];
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth(); 
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startDayOfWeek = firstDayOfMonth.getDay(); 
            if (startDayOfWeek === 0) startDayOfWeek = 7; 
            const paddingDays = startDayOfWeek - 1; 
            const monthName = currentViewDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0;">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
                        <div style="width: 40px;"></div>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <div class="month-nav">
                            <button onclick="changeMonth(-1)">‚Äπ –ü—Ä–µ–¥.</button>
                            <h3>${monthName}</h3>
                            <button onclick="changeMonth(1)">–°–ª–µ–¥. ‚Ä∫</button>
                        </div>
                        <div class="calendar-header">
                            <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
                        </div>
                        <div class="calendar-grid">`;
            for (let i = 0; i < paddingDays; i++) {
                h += `<div class="calendar-day day-padding"></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(year, month, day, 12); 
                const ds = d.toISOString().split('T')[0];
                const hasWorkout = workoutDates.has(ds);
                const isToday = (ds === todayStr);
                let classes = 'calendar-day';
                if (hasWorkout) classes += ' day-workout';
                if (isToday) classes += ' day-today';
                const action = `onclick="onCalendarDayClick('${ds}')"`;
                h += `<button class="${classes}" ${action}>${day}</button>`;
            }
            h += '</div></div>';
            return h;
        }

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) return go('calendar');
            const totalVolume = calculateWorkoutVolume(wo);

            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="go('calendar')">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0;">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                        <button onclick="editWorkout('${selectedDate}')" class="btn" style="padding: 10px 18px; font-size: 16px;">‚úèÔ∏è</button>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <h3 style="margin-bottom: 8px; font-size: 16px; color: #cbd5e1;">${new Date(selectedDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}</h3>
                        <p style="font-size: 24px; font-weight: 600;">–û–±—ä–µ–º: ${totalVolume} –µ–¥.</p>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.2s;">
                        <h3 class="header" style="font-size: 18px; margin-bottom: 16px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>`;
            
            wo.exercises.forEach((ex, index) => {
                const eBase = exercises.find(e => e.id === ex.exerciseId);
                const t = eBase ? eBase.type : 'reps';
                const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                let d = '';
                if (t === 'weight') {
                    const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                    d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥`;
                } else if (t === 'distance') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps.toFixed(1)} –∫–º`;
                else if (t === 'time') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(totalReps)} –º–∏–Ω`;
                else d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;

                let setsHTML = '';
                const maxVol = getMaxSetVolume(ex.exerciseId); 
                ex.sets.forEach(set => {
                    const setVol = calculateSetVolume(set, t);
                    const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01); 
                    const prLabel = isPR ? ' <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>' : '';
                    
                    setsHTML += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.08);">
                        <span style="font-weight: 600; color: #cbd5e1;">–ü–æ–¥—Ö–æ–¥ ${set.setNumber}</span>
                        <span style="color: #f8fafc; font-size: 16px; font-weight: 500;">`;
                    if (t === 'weight') setsHTML += `${set.weight || 0} –∫–≥ √ó ${set.reps || 0} –ø–æ–≤—Ç${prLabel}`;
                    else if (t === 'distance') setsHTML += `${(set.reps || 0).toFixed(1)} –∫–º${prLabel}`;
                    else if (t === 'time') setsHTML += `${set.reps || 0} –º–∏–Ω${prLabel}`;
                    else setsHTML += `${set.reps || 0} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π${prLabel}`;
                    setsHTML += `</span></div>`;
                });
                
                h += `<div class="fade-in" style="animation-delay: ${index * 0.05}s; margin-bottom: 16px;">
                    <div style="font-weight: 600; padding: 8px 0; color: #f8fafc;">${ex.exerciseName}</div>
                    <div style="color: #cbd5e1; font-size: 14px; margin-bottom: 8px;">${d}</div>
                    <div style="background: rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 4px;">${setsHTML}</div>
                </div>`;
            });

            h += `</div>`;
            return h;
        }

        function drawChart(id, data, labels, type, color) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (window[id + 'Chart']) {
                window[id + 'Chart'].destroy();
            }
            window[id + 'Chart'] = new Chart(ctx, {
                type: type, 
                data: {
                    labels: labels,
                    datasets: [{
                        label: '',
                        data: data,
                        backgroundColor: color + '99', 
                        borderColor: color,
                        borderWidth: type === 'line' ? 3 : 0,
                        tension: 0.4,
                        pointRadius: type === 'line' ? 4 : 0,
                        fill: type === 'line' ? 'start' : false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
        
        function renderExerciseStats() {
            if (!selExId) return '';
            const ex = exercises.find(e => e.id === selExId);
            if (!ex) return '';
            
            const exWo = workouts.filter(w => w.exercises.some(e => e.exerciseId === ex.id));
            let ts = 0, tr = 0, tw = 0, mr = 0, mw = 0;
            exWo.forEach(w => {
                const e = w.exercises.find(e => e.exerciseId === ex.id);
                if (e) {
                    ts += e.sets.length;
                    e.sets.forEach(s => {
                        const reps = s.reps || 0;
                        const weight = s.weight || 0;
                        tr += reps;
                        if (ex.type === 'weight') {
                            tw += weight * reps;
                            if (weight > mw) mw = weight;
                        }
                        if (reps > mr) mr = reps;
                    });
                }
            });

            let ul = '', us = '';
            if (ex.type === 'distance') { ul = '–ö–∏–ª–æ–º–µ—Ç—Ä—ã'; us = '–∫–º'; }
            else if (ex.type === 'time') { ul = '–ú–∏–Ω—É—Ç—ã'; us = '–º–∏–Ω'; }
            else { ul = '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'; us = '–ø–æ–≤—Ç'; }

            let h = `<div class="top-bar fade-in">
                    <button class="back-btn" onclick="go('${exStatsBackView}')">‚Üê</button>
                    <h2 class="header" style="margin-bottom: 0; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${ex.name}</h2>
                    <div style="width: 40px;"></div>
                </div>
                <div class="card fade-in" style="animation-delay: 0.1s;">
                    <h3 class="header" style="font-size: 18px;">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <div class="stat-grid" style="grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="stat-item"><p>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p><p>${exWo.length}</p></div>
                        <div class="stat-item"><p>–ü–æ–¥—Ö–æ–¥–æ–≤</p><p>${ts}</p></div>`;
            
            if (ex.type === 'weight') h += `<div class="stat-item"><p>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</p><p>${tr}</p></div>
                <div class="stat-item"><p>–û–±—â–∏–π –≤–µ—Å</p><p>${Math.round(tw)} –∫–≥</p></div>`;
            else if (ex.type === 'distance') h += `<div class="stat-item"><p>–í—Å–µ–≥–æ –∫–º</p><p>${tr.toFixed(1)}</p></div>
                <div class="stat-item"><p>–ú–∞–∫—Å –∑–∞ –ø–æ–¥—Ö–æ–¥</p><p>${mr.toFixed(1)} –∫–º</p></div>`;
            else if (ex.type === 'time') h += `<div class="stat-item"><p>–í—Å–µ–≥–æ –º–∏–Ω—É—Ç</p><p>${Math.round(tr)}</p></div>
                <div class="stat-item"><p>–ú–∞–∫—Å –∑–∞ –ø–æ–¥—Ö–æ–¥</p><p>${Math.round(mr)} –º–∏–Ω</p></div>`;
            else h += `<div class="stat-item"><p>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</p><p>${tr}</p></div>
                <div class="stat-item"><p>–ú–∞–∫—Å –∑–∞ –ø–æ–¥—Ö–æ–¥</p><p>${mr}</p></div>`;
            
            h += '</div></div>';

            if (!exWo.length) h += '<div class="empty-state fade-in"><div style="font-size: 48px;">üìä</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p></div>';
            else {
                const wd = [];
                const today = new Date();
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const ds = d.toISOString().split('T')[0];
                    const wo = workouts.find(w => w.date === ds);
                    let r = 0, s = 0;
                    if (wo) {
                        const e = wo.exercises.find(e => e.exerciseId === ex.id);
                        if (e) { s = e.sets.length; r = e.sets.reduce((sum, set) => sum + (set.reps || 0), 0); }
                    }
                    wd.push({ day: d.toLocaleDateString('ru-RU', { weekday: 'short' }), reps: r, sets: s });
                }
                const wt = wd.reduce((s, d) => s + d.reps, 0);
                const ws = wd.reduce((s, d) => s + d.sets, 0);

                h += `<div class="card fade-in" style="animation-delay: 0.2s;"><h3 class="header" style="font-size: 18px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</h3>
                    <canvas id="wc"></canvas>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="stat-grid" style="grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div class="stat-item" style="background: none;"><p>–í—Å–µ–≥–æ ${ul.toLowerCase()}</p>
                    <p style="color: #6366f1;">${ex.type === 'distance' ? wt.toFixed(1) : Math.round(wt)} ${us}</p></div>
                    <div class="stat-item" style="background: none;"><p>–í—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤</p>
                    <p style="color: #6366f1;">${ws}</p></div></div></div></div>`;

                const md = [];
                for (let i = 29; i >= 0; i--) {
                    const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const ds = d.toISOString().split('T')[0];
                    const wo = workouts.find(w => w.date === ds);
                    let r = 0;
                    if (wo) {
                        const e = wo.exercises.find(e => e.exerciseId === ex.id);
                        if (e) r = e.sets.reduce((sum, set) => sum + (set.reps || 0), 0);
                    }
                    md.push({ date: d.getDate(), reps: r });
                }
                const mt = md.reduce((s, d) => s + d.reps, 0);

                h += `<div class="card fade-in" style="animation-delay: 0.3s;"><h3 class="header" style="font-size: 18px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</h3>
                    <canvas id="mc"></canvas>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <p style="font-size: 12px; color: #cbd5e1;">–í—Å–µ–≥–æ ${ul.toLowerCase()} –∑–∞ –º–µ—Å—è—Ü</p>
                    <p style="font-size: 24px; font-weight: bold; color: #10b981;">${ex.type === 'distance' ? mt.toFixed(1) : Math.round(mt)} ${us}</p></div></div>`;

                const yd = [];
                for (let i = 11; i >= 0; i--) {
                    const md = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const ms = new Date(md.getFullYear(), md.getMonth(), 1);
                    const me = new Date(md.getFullYear(), md.getMonth() + 1, 0);
                    let r = 0, s = 0;
                    workouts.forEach(w => {
                        const d = new Date(w.date);
                        if (d >= ms && d <= me) {
                            const e = w.exercises.find(e => e.exerciseId === ex.id); 
                            if (e) { s += e.sets.length; r += e.sets.reduce((sum, set) => sum + (set.reps || 0), 0); }
                        }
                    });
                    yd.push({ month: md.toLocaleDateString('ru-RU', { month: 'short' }), reps: r, sets: s });
                }
                const yt = yd.reduce((s, d) => s + d.reps, 0);
                const ys = yd.reduce((s, d) => s + d.sets, 0);
                h += `<div class="card fade-in" style="animation-delay: 0.4s;"><h3 class="header" style="font-size: 18px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤</h3>
                    <canvas id="yc"></canvas>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div class="stat-grid" style="grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div class="stat-item" style="background: none;"><p>–í—Å–µ–≥–æ ${ul.toLowerCase()}</p>
                    <p style="color: #6366f1;">${ex.type === 'distance' ? yt.toFixed(1) : Math.round(yt)} ${us}</p></div>
                    <div class="stat-item" style="background: none;"><p>–í—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤</p>
                    <p style="color: #6366f1;">${ys}</p></div></div></div></div>`;

                setTimeout(() => {
                    drawChart('wc', wd.map(d=>d.reps), wd.map(d=>d.day), 'bar', '#6366f1');
                    drawChart('mc', md.map(d=>d.reps), md.map(d=>d.date), 'line', '#10b981');
                    drawChart('yc', yd.map(d=>d.reps), yd.map(d=>d.month), 'bar', '#6366f1');
                }, 100);
            }
            return h;
        }

        function renderExercises() {
            let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('home')">‚Üê</button><h2 class="header" style="margin-bottom: 0;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2><div style="width: 40px;"></div></div>
                <div class="card fade-in" style="animation-delay: 0.1s;"><input type="text" id="newEx" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" style="margin-bottom: 12px;">
                <select id="exType" style="margin-bottom: 12px;">
                    <option value="reps">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                    <option value="weight">–í–µ—Å + –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                    <option value="distance">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</option>
                    <option value="time">–í—Ä–µ–º—è (–º–∏–Ω)</option>
                </select>
                <button class="btn" style="width: 100%; padding: 14px;" onclick="addEx()">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button></div>`;
            
            if (!exercises.length) h += '<div class="empty-state fade-in"><div style="font-size: 48px;">üèãÔ∏è</div><p>–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p></div>';
            else exercises.forEach((ex, index) => {
                const tl = ex.type === 'weight' ? 'üèãÔ∏è –í–µ—Å' : ex.type === 'distance' ? 'üö¥ –ö–º' : ex.type === 'time' ? '‚è±Ô∏è –í—Ä–µ–º—è' : 'üî¢ –ü–æ–≤—Ç';
                
                h += `<div class="exercise-item fade-in" style="animation-delay: ${index * 0.05 + 0.1}s" onclick="viewExStats('${ex.id}', 'exercises')">
                    <div>
                        <span style="font-weight: 600; color: #f8fafc;">${ex.name}</span>
                        <div style="font-size: 12px; color: #cbd5e1; margin-top: 2px;">${tl}</div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="delete-btn" onclick="event.stopPropagation(); editEx('${ex.id}')" style="color: #6366f1; font-size: 20px;">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); delEx('${ex.id}')">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            return h;
        }

        function renderEditExercise() {
            if (!selectedExIdEdit) return go('exercises');
            const ex = exercises.find(e => e.id === selectedExIdEdit);
            if (!ex) return go('exercises');

            let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('exercises')">‚Üê</button><h2 class="header" style="margin-bottom: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h2>
                <button class="save-btn" onclick="saveEditEx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                <div class="card fade-in" style="animation-delay: 0.1s;">
                <input type="text" id="editExName" value="${ex.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" style="margin-bottom: 12px;">
                <select id="editExType" style="margin-bottom: 12px;">
                    <option value="reps" ${ex.type === 'reps' ? 'selected' : ''}>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                    <option value="weight" ${ex.type === 'weight' ? 'selected' : ''}>–í–µ—Å + –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                    <option value="distance" ${ex.type === 'distance' ? 'selected' : ''}>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</option>
                    <option value="time" ${ex.type === 'time' ? 'selected' : ''}>–í—Ä–µ–º—è (–º–∏–Ω)</option>
                </select>
                <button class="btn btn-danger" style="width: 100%; padding: 14px;" onclick="delEx('${ex.id}', true)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>`;
            return h;
        }

        function saveEditEx() {
            if (!selectedExIdEdit) return;
            const exIndex = exercises.findIndex(e => e.id === selectedExIdEdit);
            if (exIndex === -1) return;

            const newName = document.getElementById('editExName').value.trim();
            const newType = document.getElementById('editExType').value;

            if (!newName) {
                showToast('–û—à–∏–±–∫–∞', '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                return;
            }

            exercises[exIndex] = { ...exercises[exIndex], name: newName, type: newType };

            workouts.forEach(wo => {
                wo.exercises.forEach(woEx => {
                    if (woEx.exerciseId === selectedExIdEdit) {
                        woEx.exerciseName = newName;
                    }
                });
            });

            routines.forEach(rt => {
                rt.exercises.forEach(rtEx => {
                    if (rtEx.exerciseId === selectedExIdEdit) {
                        rtEx.exerciseName = newName;
                    }
                });
            });

            save();
            selectedExIdEdit = null;
            showToast('–£—Å–ø–µ—Ö', '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
            go('exercises');
        }

        function delEx(id, isEditView = false) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –µ–≥–æ –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —à–∞–±–ª–æ–Ω–æ–≤!')) {
                exercises = exercises.filter(e => e.id !== id);
                workouts = workouts.map(wo => ({ ...wo, exercises: wo.exercises.filter(ex => ex.exerciseId !== id) })).filter(wo => wo.exercises.length > 0);
                routines = routines.map(rt => ({ ...rt, exercises: rt.exercises.filter(ex => ex.exerciseId !== id) })).filter(rt => rt.exercises.length > 0);
                save();
                showToast('–£–¥–∞–ª–µ–Ω–æ', '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ', 'error');

                if (isEditView) {
                    selectedExIdEdit = null;
                    go('exercises');
                } else {
                    render();
                }
            }
        }

        function addEx() {
            const inp = document.getElementById('newEx');
            const typ = document.getElementById('exType');
            if (inp.value.trim()) {
                exercises.push({
                    id: Date.now().toString(),
                    name: inp.value.trim(),
                    type: typ.value,
                    createdAt: new Date().toISOString()
                });
                save();
                showToast('–£—Å–ø–µ—Ö', `–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${inp.value.trim()}" –¥–æ–±–∞–≤–ª–µ–Ω–æ`, 'success');
                render();
            } else {
                showToast('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –®–ê–ë–õ–û–ù–û–í ---

        function renderRoutines() {
            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0;">–®–∞–±–ª–æ–Ω—ã</h2>
                        <div style="width: 40px;"></div>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <input type="text" id="newRoutineName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω–∞" style="margin-bottom: 12px;">
                        <button class="btn" style="width: 100%; padding: 14px;" onclick="addRoutine()">+ –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
                     </div>`;

            if (!routines.length) {
                h += '<div class="empty-state fade-in"><div style="font-size: 48px;">üìã</div><p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</p></div>';
            } else {
                routines.forEach((rt, index) => {
                    h += `<div class="exercise-item fade-in" style="animation-delay: ${index * 0.05 + 0.1}s" onclick="editRoutine('${rt.id}')">
                        <div>
                            <span style="font-weight: 600; color: #f8fafc;">${rt.name}</span>
                            <div style="font-size: 12px; color: #cbd5e1; margin-top: 2px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: ${rt.exercises.length}</div>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); delRoutine('${rt.id}')">üóëÔ∏è</button>
                    </div>`;
                });
            }
            return h;
        }

        function addRoutine() {
            const inp = document.getElementById('newRoutineName');
            const name = inp.value.trim();
            if (name) {
                routines.push({
                    id: Date.now().toString(),
                    name: name,
                    exercises: [] 
                });
                save();
                showToast('–£—Å–ø–µ—Ö', `–®–∞–±–ª–æ–Ω "${name}" —Å–æ–∑–¥–∞–Ω`, 'success');
                inp.value = '';
                render();
            } else {
                showToast('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞', 'error');
            }
        }

        function delRoutine(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) {
                const rtName = routines.find(rt => rt.id === id)?.name || '–®–∞–±–ª–æ–Ω';
                routines = routines.filter(rt => rt.id !== id);
                save();
                showToast('–£–¥–∞–ª–µ–Ω–æ', `–®–∞–±–ª–æ–Ω "${rtName}" —É–¥–∞–ª–µ–Ω`, 'error');
                render();
            }
        }

        function renderEditRoutine() {
            if (!selectedRoutineIdEdit) return go('routines');
            const rt = routines.find(r => r.id === selectedRoutineIdEdit);
            if (!rt) return go('routines');
            
            currentWorkout = JSON.parse(JSON.stringify(rt.exercises)); 

            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="cancelRoutineEdit()">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0; max-width: 240px; overflow: hidden; text-overflow: ellipsis;">${rt.name}</h2>
                        <button class="save-btn" onclick="saveRoutine()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <h3 class="header" style="font-size: 16px;">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
                        <input type="text" id="editRoutineName" value="${rt.name}" style="margin-bottom: 16px;">
                        <h3 class="header" style="font-size: 16px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–µ</h3>
                        <div id="routineExerciseList">`;

            if (currentWorkout.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"</div>`;
            } else {
                currentWorkout.forEach((ex, index) => {
                    h += `<div class="exercise-item fade-in" style="animation-delay: ${index * 0.05}s">
                        <div style="font-weight: 600; color: #f8fafc;">${ex.exerciseName}</div>
                        <button class="delete-btn" onclick="removeExFromRoutine('${ex.exerciseId}')">üóëÔ∏è</button>
                    </div>`;
                });
            }

            h += `</div>
                <button class="btn" style="width: 100%; padding: 14px; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.remove('hide')">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                <button class="btn btn-danger" style="width: 100%; padding: 14px; margin-top: 12px;" onclick="delRoutine('${rt.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
            </div>`;

            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 400px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); padding: 20px;">
                <h3 class="header" style="font-size: 18px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 8px;">`;
            
            if (!exercises.length) {
                h += `<div class="empty-state" style="padding: 10px;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>`;
            } else {
                exercises.forEach(ex => {
                    if (!currentWorkout.some(cw => cw.exerciseId === ex.id)) {
                        h += `<div class="exercise-item" onclick="addExToRoutine('${ex.id}', '${ex.name}')" style="padding: 12px; margin-bottom: 4px; background: rgba(255,255,255,0.1); cursor: pointer;">${ex.name}</div>`;
                    }
                });
                if (currentWorkout.length === exercises.length) {
                     h += `<div class="empty-state" style="padding: 10px;">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>`;
                }
            }
            
            h += `</div>
                <button class="btn btn-secondary" style="width: 100%; padding: 14px; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.add('hide')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>`;

            return h;
        }

        function addExToRoutine(exId, exName) {
            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName,
                sets: [] 
            });
            document.getElementById('addExModal').classList.add('hide');
            render(); 
        }

        function removeExFromRoutine(exId) {
            currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
            render();
        }

        function saveRoutine() {
            if (!selectedRoutineIdEdit) return;
            const rtIndex = routines.findIndex(r => r.id === selectedRoutineIdEdit);
            if (rtIndex === -1) return;

            const newName = document.getElementById('editRoutineName').value.trim();

            if (!newName) {
                showToast('–û—à–∏–±–∫–∞', '–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                return;
            }

            const exercisesToSave = currentWorkout.map(ex => ({
                exerciseId: ex.exerciseId,
                exerciseName: ex.exerciseName,
                sets: [] 
            }));
            
            routines[rtIndex].name = newName;
            routines[rtIndex].exercises = exercisesToSave;

            save();
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            showToast('–£—Å–ø–µ—Ö', '–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
            go('routines');
        }

        function cancelRoutineEdit() {
            currentWorkout = []; 
            selectedRoutineIdEdit = null;
            go('routines');
        }

        // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –®–ê–ë–õ–û–ù–û–í ---


        function renderNewWorkout() {
            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="cancelEdit()">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0;">${currentView === 'editWorkout' ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</h2>
                        <button class="save-btn" onclick="saveWorkout()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <h3 class="header" style="font-size: 16px;">–î–∞—Ç–∞</h3>
                        <input type="date" id="workoutDate" value="${selectedDate}" onchange="selectedDate = this.value; render()" style="margin-bottom: 16px;">
                        
                        ${routines.length > 0 ? `
                        <h3 class="header" style="font-size: 16px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                            ${routines.map(rt => `
                                <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 14px; flex-grow: 1; min-width: 100px;" onclick="loadRoutine('${rt.id}')">
                                    ${rt.name}
                                </button>
                            `).join('')}
                        </div>
                        ` : ''}
                        <h3 class="header" style="font-size: 16px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                        <div id="exerciseList">`;
            
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"</div>`;
            } else {
                currentWorkout.forEach((ex, index) => {
                    const eBase = exercises.find(e => e.id === ex.exerciseId);
                    const t = eBase ? eBase.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                    let d = '';
                    if (t === 'weight') {
                        const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                        d = ` (${ex.sets.length} –ø–æ–¥—Ö., ${Math.round(tw)} –∫–≥)`;
                    } else if (t === 'distance') d = ` (${ex.sets.length} –ø–æ–¥—Ö., ${totalReps.toFixed(1)} –∫–º)`;
                    else if (t === 'time') d = ` (${ex.sets.length} –ø–æ–¥—Ö., ${Math.round(totalReps)} –º–∏–Ω)`;
                    else d = ` (${ex.sets.length} –ø–æ–¥—Ö., ${totalReps} –ø–æ–≤—Ç)`;

                    h += `<div class="exercise-item fade-in" style="animation-delay: ${index * 0.05}s" onclick="viewWorkoutDetails('${ex.exerciseId}', currentView)">
                        <div>
                            <span style="font-weight: 600; color: #f8fafc;">${ex.exerciseName}</span>
                            <div style="font-size: 12px; color: #cbd5e1;">${d}</div>
                        </div>
                        <button class="delete-btn" onclick="event.stopPropagation(); removeExFromWorkout('${ex.exerciseId}')">üóëÔ∏è</button>
                    </div>`;
                });
            }

            h += `</div>
                <button class="btn" style="width: 100%; padding: 14px; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.remove('hide')">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>`;

            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 400px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); padding: 20px;">
                <h3 class="header" style="font-size: 18px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 8px;">`;
            
            if (!exercises.length) {
                h += `<div class="empty-state" style="padding: 10px;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>`;
            } else {
                exercises.forEach(ex => {
                    if (!currentWorkout.some(cw => cw.exerciseId === ex.id)) {
                        h += `<div class="exercise-item" onclick="addExToWorkout('${ex.id}', '${ex.name}')" style="padding: 12px; margin-bottom: 4px; background: rgba(255,255,255,0.1); cursor: pointer;">${ex.name}</div>`;
                    }
                });
                if (currentWorkout.length === exercises.length) {
                     h += `<div class="empty-state" style="padding: 10px;">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>`;
                }
            }
            
            h += `</div>
                <button class="btn btn-secondary" style="width: 100%; padding: 14px; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.add('hide')">–û—Ç–º–µ–Ω–∞</button>
            </div>`;

            return h;
        }

        function loadRoutine(routineId) {
            if (currentWorkout.length > 0) {
                if (!confirm('–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    return;
                }
            }
            const routine = routines.find(rt => rt.id === routineId);
            if (routine) {
                currentWorkout = routine.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: [] 
                })); 
                showToast('–£—Å–ø–µ—Ö', `–®–∞–±–ª–æ–Ω "${routine.name}" –∑–∞–≥—Ä—É–∂–µ–Ω`, 'success');
                render();
            }
        }

        function renderEditWorkout() {
            return renderNewWorkout(); 
        }

        function editToday() {
            const todayDateStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDateStr);
            if (wo) {
                selectedDate = todayDateStr;
                editWorkout(todayDateStr);
            } else {
                go('newWorkout');
            }
        }

        function editWorkout(dateStr) {
            selectedDate = dateStr;
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) {
                showToast('–û—à–∏–±–∫–∞', '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                return go('calendar'); 
            }
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            go('editWorkout');
        }

        function cancelEdit() {
            currentWorkout = [];
            go('home');
        }

        function saveWorkout() {
            if (currentWorkout.length === 0) {
                showToast('–û—à–∏–±–∫–∞', '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', 'error');
                return;
            }

            const validWorkout = currentWorkout.filter(ex => 
                ex.sets.some(set => (set.reps > 0) || (set.weight > 0))
            );

            if (validWorkout.length === 0) {
                 showToast('–û—à–∏–±–∫–∞', '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥', 'error');
                 return;
            }
            
            const newWorkout = {
                date: selectedDate,
                exercises: validWorkout 
            };
            
            const existingIndex = workouts.findIndex(w => w.date === selectedDate);
            if (existingIndex > -1) {
                workouts[existingIndex] = newWorkout;
            } else {
                workouts.push(newWorkout);
            }

            workouts.sort((a, b) => new Date(b.date) - new Date(a.date));

            save();
            currentWorkout = [];
            showToast('–£—Å–ø–µ—Ö', '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
            go('home');
        }

        function addExToWorkout(exId, exName) {
            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName,
                sets: [] 
            });
            document.getElementById('addExModal').classList.add('hide');
            render(); 
        }

        function removeExFromWorkout(exId) {
            currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
            render();
        }

        function viewWorkoutDetails(exId, backView = 'newWorkout') {
            selExId = exId;
            workoutBackView = backView;
            go('workoutDetails');
        }

        function handleWorkoutDetailsBack() {
            if (workoutBackView === 'home') {
                saveWorkout();
            } else {
                go(workoutBackView);
            }
        }

        function renderWorkoutDetails() {
            if (!selExId) return go('newWorkout');
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return go('newWorkout');
            
            const ex = currentWorkout[exIndex];
            const eBase = exercises.find(e => e.id === ex.exerciseId);
            const t = eBase ? eBase.type : 'reps';
            const maxVol = getMaxSetVolume(ex.exerciseId); 
            
            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="handleWorkoutDetailsBack()">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0; max-width: 240px; overflow: hidden; text-overflow: ellipsis;">${ex.exerciseName}</h2>
                        <div style="width: 40px;"></div>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <h3 class="header" style="font-size: 18px; margin-bottom: 16px;">–ü–æ–¥—Ö–æ–¥—ã</h3>`;
            
            // –•–µ–ª–ø–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è readonly-–∏–Ω–ø—É—Ç–æ–≤, –≤—ã–∑—ã–≤–∞—é—â–∏—Ö –Ω–∞–º–ø–∞–¥
            const makeInput = (index, key, val, placeholder, width = 'flex: 1') => {
                return `<input type="text" readonly value="${val || ''}" 
                        onclick="openNumpad(${index}, '${key}', '${val || 0}')" 
                        placeholder="${placeholder}" 
                        style="${width}; text-align: center; cursor: pointer; background: rgba(255,255,255,0.05); caret-color: transparent;">`;
            };

            ex.sets.forEach((set, index) => {
                const setVol = calculateSetVolume(set, t);
                const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01); 
                const prLabel = isPR ? ' <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>' : '';
                
                h += `<div class="set-row fade-in" style="animation-delay: ${index * 0.05}s">
                        <span class="set-label">–ü–æ–¥—Ö–æ–¥ ${index + 1}</span>`;
                
                if (t === 'weight') {
                    h += `${makeInput(index, 'weight', set.weight, '–í–µ—Å (–∫–≥)')}
                          <div style="width: 8px;"></div>
                          ${makeInput(index, 'reps', set.reps, '–ü–æ–≤—Ç', 'width: 80px')}
                          <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                          ${prLabel}`;
                } else if (t === 'distance') {
                     h += `${makeInput(index, 'distance', set.reps, '–ö–º')}
                           <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                           ${prLabel}`;
                } else if (t === 'time') {
                     h += `${makeInput(index, 'time', set.reps, '–ú–∏–Ω')}
                           <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                           ${prLabel}`;
                } else { // reps
                     h += `${makeInput(index, 'reps', set.reps, '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π')}
                           <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                           ${prLabel}`;
                }
                h += `</div>`;
            });
            
            h += `<button class="save-btn" style="width: 100%; padding: 14px; margin-top: 16px;" onclick="addSet()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
                     </div>`;
            return h;
        }

        function updateSet(index, key, value) {
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return;
            
            // –í –Ω–∞–º–ø–∞–¥–µ –º—ã —É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–ª–∏ —Å—Ç—Ä–æ–∫—É, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–∞—Ä—Å–∏–º
            const numVal = parseFloat(value);

            if (!currentWorkout[exIndex].sets[index]) {
                currentWorkout[exIndex].sets[index] = { setNumber: index + 1 };
                if (key === 'weight') currentWorkout[exIndex].sets[index].reps = 0;
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º distance/time –≤ –ø–æ–ª–µ reps, –∫–∞–∫ –∏ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ –≤ –ª–æ–≥–∏–∫–µ
            if(key === 'distance' || key === 'time') {
                currentWorkout[exIndex].sets[index].reps = isNaN(numVal) ? 0 : numVal;
            } else {
                currentWorkout[exIndex].sets[index][key] = isNaN(numVal) ? 0 : numVal;
            }
        }

        function addSet() {
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return;
            const setNumber = currentWorkout[exIndex].sets.length + 1;
            const newSet = { setNumber: setNumber, reps: 0 };
            const eBase = exercises.find(e => e.id === selExId);
            const t = eBase ? eBase.type : 'reps';
            if (t === 'weight') {
                newSet.weight = 0;
                newSet.reps = 0;
            }
            currentWorkout[exIndex].sets.push(newSet);
            render();
        }

        function deleteSet(index) {
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return;
            currentWorkout[exIndex].sets.splice(index, 1);
            currentWorkout[exIndex].sets.forEach((set, i) => {
                set.setNumber = i + 1;
            });
            render();
        }

        function renderStats() {
            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div style="width: 40px;"></div>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <h3 class="header" style="font-size: 18px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>`;
            
            if (!exercises.length) h += '<div class="empty-state" style="padding: 20px;">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</div>';
            else exercises.forEach((ex, index) => {
                const exWo = workouts.filter(w => w.exercises.some(e => e.exerciseId === ex.id));
                const totalWorkouts = exWo.length;
                
                let stats = '';
                if (totalWorkouts > 0) {
                    let maxVal = 0;
                    if (ex.type === 'weight') {
                        maxVal = exWo.map(w => w.exercises.find(e => e.exerciseId === ex.id).sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0)).reduce((a, b) => Math.max(a, b), 0);
                        stats = `–õ—É—á—à–∏–π –æ–±—ä–µ–º: ${Math.round(maxVal)} –∫–≥`;
                    } else if (ex.type === 'distance') {
                        maxVal = exWo.map(w => w.exercises.find(e => e.exerciseId === ex.id).sets.reduce((s, set) => s + (set.reps || 0), 0)).reduce((a, b) => Math.max(a, b), 0);
                        stats = `–ú–∞–∫—Å. –∑–∞ —Ç—Ä–µ–Ω.: ${maxVal.toFixed(1)} –∫–º`;
                    } else if (ex.type === 'time') {
                        maxVal = exWo.map(w => w.exercises.find(e => e.exerciseId === ex.id).sets.reduce((s, set) => s + (set.reps || 0), 0)).reduce((a, b) => Math.max(a, b), 0);
                        stats = `–ú–∞–∫—Å. –∑–∞ —Ç—Ä–µ–Ω.: ${Math.round(maxVal)} –º–∏–Ω`;
                    } else { // reps
                        maxVal = exWo.map(w => w.exercises.find(e => e.exerciseId === ex.id).sets.reduce((s, set) => s + (set.reps || 0), 0)).reduce((a, b) => Math.max(a, b), 0);
                        stats = `–ú–∞–∫—Å. –∑–∞ —Ç—Ä–µ–Ω.: ${Math.round(maxVal)} –ø–æ–≤—Ç`;
                    }
                    stats = `<div style="font-size: 12px; color: #8b5cf6; margin-top: 4px;">${stats}</div>`;
                } else {
                    stats = `<div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>`;
                }

                h += `<div class="exercise-item fade-in" style="animation-delay: ${index * 0.05 + 0.1}s" onclick="viewExStats('${ex.id}', 'stats')">
                    <div>
                        <span style="font-weight: 600; color: #f8fafc;">${ex.name}</span>
                        <div style="font-size: 12px; color: #cbd5e1; margin-top: 2px;">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: ${totalWorkouts}</div>
                        ${stats}
                    </div>
                    <span style="font-size: 24px; color: #94a3b8;">üìä</span>
                </div>`;
            });

            h += `</div>`;
            return h;
        }

        function viewExStats(exId, backView = 'stats') {
            selExId = exId;
            exStatsBackView = backView;
            go('exerciseStats');
        }

        function renderSettings() {
            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                        <div style="width: 40px;"></div>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.1s;">
                        <h3 class="header" style="font-size: 18px;">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                         <button onclick="exportData()" class="btn" style="width: 100%; padding: 14px; margin-bottom: 12px;">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (.json)</button>
                         <button onclick="importData()" class="btn" style="width: 100%; padding: 14px; margin-bottom: 24px;">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (.json)</button>
                        
                         <h3 class="header" style="font-size: 18px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                         <button onclick="resetRoutines()" class="btn btn-secondary" style="width: 100%; padding: 14px; margin-bottom: 12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã</button>
                         <button onclick="resetWo()" class="btn btn-secondary" style="width: 100%; padding: 14px; margin-bottom: 12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
                         <button onclick="resetEx()" class="btn btn-danger" style="width: 100%; padding: 14px; margin-bottom: 12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                         <button onclick="resetAll()" class="btn btn-danger" style="width: 100%; padding: 14px;">‚ö†Ô∏è –°–ë–†–û–°–ò–¢–¨ –í–°–Å</button>
                     </div>
                     <div class="card fade-in" style="animation-delay: 0.2s;">
                        <h3 class="header" style="font-size: 18px;">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                        <p style="color: #cbd5e1; font-size: 14px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ **v2.7** (Animations)<br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
                     </div>`;
            return h;
        }
        
        function resetRoutines() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —à–∞–±–ª–æ–Ω—ã?')) {
                routines = [];
                save();
                showToast('–£–¥–∞–ª–µ–Ω–æ', '–í—Å–µ —à–∞–±–ª–æ–Ω—ã —É–¥–∞–ª–µ–Ω—ã', 'error');
                render();
            }
        }

        function resetWo() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                workouts = [];
                save();
                showToast('–£–¥–∞–ª–µ–Ω–æ', '–í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —É–¥–∞–ª–µ–Ω—ã', 'error');
                render();
            }
        }

        function resetEx() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                showToast('–£–¥–∞–ª–µ–Ω–æ', '–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã —É–¥–∞–ª–µ–Ω—ã', 'error');
                render();
            }
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï?')) {
                if (confirm('–¢–æ—á–Ω–æ? –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    showToast('–°–±—Ä–æ—Å', '–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error', 5000);
                    render();
                }
            }
        }

        init();
    </script>
</body>
</html>
