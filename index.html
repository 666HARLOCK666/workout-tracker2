<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        /* –û–ë–ù–û–í–õ–ï–ù–û: 3 –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è 3 –º–µ—Ç—Ä–∏–∫ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 16px; }
        .stat-item p:first-child { font-size: 14px; opacity: 0.9; margin-bottom: 4px; }
        .stat-item p:last-child { font-size: 24px; font-weight: bold; }
        /* –ö–û–ù–ï–¶ –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ï–¢–ö–ò */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { padding: 20px; border-radius: 12px; border: none; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        .btn-blue { background: #3b82f6; }
        .btn-purple { background: #8b5cf6; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .back-btn, .save-btn { background: none; border: none; color: #3b82f6; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .save-btn { color: #10b981; }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .exercise-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 8px; }
        .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-weight: 600; width: 100px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day { aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; border: none; }
        .day-empty { background: #f0f0f0; }
        .day-workout { background: #10b981; color: white; font-weight: bold; }
        .day-today { box-shadow: 0 0 0 2px #3b82f6; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .hide { display: none; }
        /* –°—Ç–∏–ª–∏ –¥–ª—è Canvas, —á—Ç–æ–±—ã –æ–Ω–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å */
        canvas { max-width: 100%; height: 250px !important; } 
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    <script>
        let exercises = [];
        let workouts = [];
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:", e);
                exercises = [];
                workouts = [];
            }
            render();
        }

        function save() {
            localStorage.setItem('workout-exercises', JSON.stringify(exercises));
            localStorage.setItem('workout-logs', JSON.stringify(workouts));
        }

        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings
            };
            document.getElementById('view').innerHTML = views[currentView]();
            window.scrollTo(0, 0);
        }

        function go(view) {
            currentView = view;
            render();
        }
        
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –Ω–µ–¥–µ–ª–∏
        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É, —á—Ç–æ–±—ã —Å–¥–≤–∏–Ω—É—Ç—å—Å—è –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (1=–ü–Ω, 0=–í—Å)
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday.toISOString().split('T')[0];
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–¥—Å—á–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –Ω–µ–¥–µ–ª—å —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏
        function getWeeklyStreak() {
            if (!workouts.length) return 0;

            // 1. –°–æ–∑–¥–∞–µ–º –Ω–∞–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–æ–≤)
            const uniqueWeekIds = new Set(workouts.map(w => getMonday(w.date)));

            let streak = 0;
            let curr = new Date();
            curr.setHours(0, 0, 0, 0);

            // 2. –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞ –¢–ï–ö–£–©–ï–ô –Ω–µ–¥–µ–ª–∏
            let currentMonday = new Date(getMonday(curr));
            
            // 3. –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –Ω–∞–∑–∞–¥ –ø–æ –Ω–µ–¥–µ–ª—è–º
            while (true) {
                const id = currentMonday.toISOString().split('T')[0];

                if (uniqueWeekIds.has(id)) {
                    streak++;
                    // –ü–µ—Ä–µ–¥–≤–∏–≥–∞–µ–º—Å—è —Ä–æ–≤–Ω–æ –Ω–∞ 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
                    currentMonday.setDate(currentMonday.getDate() - 7);
                } else {
                    // –°—Ç—Ä–∏–∫ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
                    break;
                }
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫ (260 –Ω–µ–¥–µ–ª—å = 5 –ª–µ—Ç)
                if (streak > 260) break;
            }
            
            return streak;
        }


        function getStreak() {
            // ... (–°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –¥–Ω–µ–≤–Ω–æ–≥–æ —Å—Ç—Ä–∏–∫–∞) ...
            if (!workouts.length) return 0;
            const dates = new Set(workouts.map(w => w.date));
            let streak = 0;
            let curr = new Date();
            curr.setHours(0, 0, 0, 0);

            for (let i = 0; i < 365; i++) {
                const ds = curr.toISOString().split('T')[0];
                const isToday = i === 0 && dates.has(ds);
                const isYesterday = i > 0 && dates.has(ds);

                if (isToday || isYesterday) {
                    streak++;
                    curr.setDate(curr.getDate() - 1);
                } else if (i === 0) {
                    curr.setDate(curr.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }

        function renderHome() {
            const dayStreak = getStreak();
            const weekStreak = getWeeklyStreak(); // –ù–û–í–´–ô –°–¢–†–ò–ö
            const today = workouts.find(w => w.date === selectedDate);
            // –û–ë–ù–û–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ –≤ stat-grid
            let h = `
                <div class="header-card">
                    <h1 style="font-size: 24px; margin-bottom: 8px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <p>–°—Ç—Ä–∏–∫ (–¥–Ω–µ–π) üî•</p>
                            <p>${dayStreak}</p>
                        </div>
                        <div class="stat-item">
                            <p>–°—Ç—Ä–∏–∫ (–Ω–µ–¥–µ–ª—å) üóìÔ∏è</p>
                            <p>${weekStreak}</p>
                        </div>
                        <div class="stat-item">
                            <p>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                            <p>${workouts.length}</p>
                        </div>
                    </div>
                </div>
                <div class="btn-grid">
                    <button class="btn btn-green" onclick="go('newWorkout')"><span style="font-size: 32px;">‚ûï</span><span>–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span></button>
                    <button class="btn btn-orange" onclick="go('exercises')"><span style="font-size: 32px;">üèãÔ∏è</span><span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span></button>
                    <button class="btn btn-blue" onclick="go('calendar')"><span style="font-size: 32px;">üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
                    <button class="btn btn-purple" onclick="go('stats')"><span style="font-size: 32px;">üìä</span><span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span></button>
                </div>
                <button class="btn btn-blue" onclick="go('settings')" style="width: 100%; margin-top: 12px; background: #6b7280;">
                    <span style="font-size: 20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </button>
            `;
            // ... (–û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å renderHome –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
            if (today) {
                h += `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
                        <button onclick="editToday()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>`;
                today.exercises.forEach(ex => {
                    const e = exercises.find(e => e.id === ex.exerciseId);
                    const type = e ? e.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + set.reps, 0);
                    let description = '';
                    if (type === 'weight') {
                        const totalWeight = ex.sets.reduce((s, set) => s + (set.weight || 0) * set.reps, 0);
                        description = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(totalWeight)} –∫–≥`;
                    } else if (type === 'distance') description = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps.toFixed(1)} –∫–º`;
                    else if (type === 'time') description = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(totalReps)} –º–∏–Ω`;
                    else description = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;
                    h += `<div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                        <div style="font-weight: 600;">${ex.exerciseName}</div>
                        <div style="color: #666; font-size: 14px;">${description}</div>
                    </div>`;
                });
                h += '</div>';
            }
            return h;
        }
        // ... (–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç getMonday –∏ getWeeklyStreak)
        
        function renderExercises() {
            let h = `<div class="top-bar"><button class="back-btn" onclick="go('home')">‚Üê –ù–∞–∑–∞–¥</button><h2>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2><div style="width: 60px;"></div></div>
                <div class="card"><input type="text" id="newEx" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" style="margin-bottom: 12px;">
                <select id="exType" style="margin-bottom: 12px;"><option value="reps">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option><option value="weight">–í–µ—Å + –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                <option value="distance">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</option><option value="time">–í—Ä–µ–º—è (–º–∏–Ω)</option></select>
                <button class="btn btn-green" style="width: 100%; padding: 12px;" onclick="addEx()">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button></div>`;
            if (!exercises.length) h += '<div class="empty-state"><div style="font-size: 48px;">üèãÔ∏è</div><p>–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p></div>';
            else exercises.forEach(ex => {
                const tl = ex.type === 'weight' ? 'üèãÔ∏è –í–µ—Å' : ex.type === 'distance' ? 'üö¥ –ö–º' : ex.type === 'time' ? '‚è±Ô∏è –í—Ä–µ–º—è' : 'üî¢ –ü–æ–≤—Ç';
                h += `<div class="exercise-item"><div><span style="font-weight: 600;">${ex.name}</span>
                    <div style="font-size: 12px; color: #666; margin-top: 2px;">${tl}</div></div>
                    <button class="delete-btn" onclick="delEx('${ex.id}')">üóëÔ∏è</button></div>`;
            });
            return h;
        }

        function addEx() {
            const inp = document.getElementById('newEx');
            const typ = document.getElementById('exType');
            const name = inp.value.trim();
            if (name) {
                exercises.push({ id: Date.now().toString(), name: name, type: typ.value, createdAt: new Date().toISOString() });
                save();
                render();
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è!');
            }
        }

        function delEx(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ? –û–Ω–æ —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –∏–∑ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫!')) return;
            exercises = exercises.filter(e => e.id !== id);
            workouts.forEach(wo => {
                wo.exercises = wo.exercises.filter(ex => ex.exerciseId !== id);
            });
            workouts = workouts.filter(wo => wo.exercises.length > 0); 
            save();
            render();
        }

        function renderNewWorkout() {
            let h = `<div class="top-bar"><button class="back-btn" onclick="cancelEdit()">‚Üê –ù–∞–∑–∞–¥</button><h2>–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                <button class="save-btn" onclick="saveWo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚úì</button></div>
                <div class="card"><input type="date" id="woDate" value="${selectedDate}" onchange="selectedDate = this.value"></div>`;
            if (!exercises.length) h += '<div class="empty-state"><p>–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</p><button class="btn btn-orange" style="margin-top: 16px;" onclick="go(\'exercises\')">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button></div>';
            else {
                h += '<div class="card"><h3 style="margin-bottom: 12px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</h3>';
                exercises.forEach(ex => {
                    const tl = ex.type === 'weight' ? 'üèãÔ∏è' : ex.type === 'distance' ? 'üö¥' : ex.type === 'time' ? '‚è±Ô∏è' : 'üî¢';
                    h += `<button class="btn btn-blue" style="width: 100%; margin-bottom: 8px; padding: 12px;" onclick="addSet('${ex.id}')">${tl} ${ex.name}</button>`;
                });
                h += '</div>';
                if (currentWorkout.length) h += renderSets('newWorkout');
            }
            return h;
        }

        function renderSets(view) {
            let h = '';
            currentWorkout.forEach(w => {
                const e = exercises.find(e => e.id === w.exerciseId);
                const t = e ? e.type : 'reps';
                h += `<div class="card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0;">${w.exerciseName}</h4>
                    ${view === 'editWorkout' ? `<button onclick="delExWo('${w.exerciseId}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>` : ''}
                    </div><div>`;
                w.sets.forEach((set, i) => {
                    const repsValue = isNaN(set.reps) ? 0 : set.reps;
                    const weightValue = isNaN(set.weight) ? 0 : set.weight;
                    h += `<div class="set-row"><span class="set-label">–ü–æ–¥—Ö–æ–¥ ${set.setNumber}:</span>`;
                    if (t === 'weight') h += `<input type="number" value="${weightValue}" onchange="upW('${w.exerciseId}', ${i}, this.value)" placeholder="–í–µ—Å (–∫–≥)" style="flex: 0.5; margin-right: 4px;">
                        <input type="number" value="${repsValue}" onchange="upR('${w.exerciseId}', ${i}, this.value)" placeholder="–ü–æ–≤—Ç" style="flex: 0.5;">`;
                    else if (t === 'distance') h += `<input type="number" step="0.1" value="${repsValue}" onchange="upR('${w.exerciseId}', ${i}, this.value)" placeholder="–ö–º" style="flex: 1;">`;
                    else if (t === 'time') h += `<input type="number" value="${repsValue}" onchange="upR('${w.exerciseId}', ${i}, this.value)" placeholder="–ú–∏–Ω" style="flex: 1;">`;
                    else h += `<input type="number" value="${repsValue}" onchange="upR('${w.exerciseId}', ${i}, this.value)" placeholder="–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è" style="flex: 1;">`;
                    h += `<button class="delete-btn" onclick="delSet('${w.exerciseId}', ${i})">‚úï</button></div>`;
                });
                h += `</div><button class="btn btn-green" style="width: 100%; padding: 10px; margin-top: 8px;" onclick="addSet('${w.exerciseId}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button></div>`;
            });
            return h;
        }

        function addSet(exId) {
            const ex = exercises.find(e => e.id === exId);
            if (!ex) return;
            const existing = currentWorkout.find(w => w.exerciseId === exId);
            if (existing) existing.sets.push({ reps: 0, weight: 0, setNumber: existing.sets.length + 1 });
            else currentWorkout.push({ exerciseId: exId, exerciseName: ex.name, sets: [{ reps: 0, weight: 0, setNumber: 1 }] });
            render();
        }

        function upR(exId, idx, val) {
            const w = currentWorkout.find(w => w.exerciseId === exId);
            if (w) w.sets[idx].reps = parseFloat(val) || 0;
        }

        function upW(exId, idx, val) {
            const w = currentWorkout.find(w => w.exerciseId === exId);
            if (w) w.sets[idx].weight = parseFloat(val) || 0;
        }

        function delSet(exId, idx) {
            const w = currentWorkout.find(w => w.exerciseId === exId);
            if (w) {
                w.sets.splice(idx, 1);
                w.sets.forEach((s, i) => s.setNumber = i + 1);
                if (!w.sets.length) currentWorkout = currentWorkout.filter(cw => cw.exerciseId !== exId);
                render();
            }
        }

        function saveWo() {
            if (!currentWorkout.length) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏ –ø–æ–¥—Ö–æ–¥!');
                return;
            }
            currentWorkout.forEach(wo => wo.sets = wo.sets.filter(s => s.reps > 0 || s.weight > 0));
            currentWorkout = currentWorkout.filter(wo => wo.sets.length > 0);
            
            if (!currentWorkout.length) {
                alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã –ø—É—Å—Ç—ã.');
                return;
            }

            const wo = { id: Date.now().toString(), date: selectedDate, exercises: currentWorkout, timestamp: new Date().toISOString() };
            const idx = workouts.findIndex(w => w.date === selectedDate);
            if (idx >= 0) workouts[idx] = wo;
            else workouts.push(wo);
            save();
            currentWorkout = [];
            alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            go('home');
        }

        function editToday() {
            const today = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === today);
            if (wo) {
                selectedDate = today;
                currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
                go('editWorkout');
            }
        }

        function editWo(date) {
            const wo = workouts.find(w => w.date === date);
            if (wo) {
                selectedDate = date;
                currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
                go('editWorkout');
            }
        }

        function renderEditWorkout() {
            let h = `<div class="top-bar"><button class="back-btn" onclick="cancelEdit()">‚Üê –û—Ç–º–µ–Ω–∞</button><h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</h2>
                <button class="save-btn" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚úì</button></div>
                <div class="card"><div style="display: flex; justify-content: space-between; align-items: center;"><div>
                <p style="color: #666; font-size: 14px; margin-bottom: 4px;">–î–∞—Ç–∞:</p>
                <p style="font-size: 18px; font-weight: 600;">${new Date(selectedDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}</p></div>
                <button onclick="delWo()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button></div></div>`;
            if (exercises.length) {
                h += '<div class="card"><h3 style="margin-bottom: 12px;">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ:</h3>';
                exercises.forEach(ex => {
                    const tl = ex.type === 'weight' ? 'üèãÔ∏è' : ex.type === 'distance' ? 'üö¥' : ex.type === 'time' ? '‚è±Ô∏è' : 'üî¢';
                    h += `<button class="btn btn-blue" style="width: 100%; margin-bottom: 8px; padding: 12px;" onclick="addSet('${ex.id}')">${tl} ${ex.name}</button>`;
                });
                h += '</div>';
            }
            if (currentWorkout.length) {
                h += renderSets('editWorkout');
            } else {
                h += '<div class="empty-state"><p>–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤ —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</p></div>';
            }
            return h;
        }

        function cancelEdit()
