<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 8px;
            padding: 8px 0;
        }
        .stat-item p:first-child { 
            font-size: 11px; 
            opacity: 0.8; 
            margin-bottom: 2px; 
            line-height: 1.1;
        }
        .stat-item p:last-child { 
            font-size: 20px; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { padding: 20px; border-radius: 12px; border: none; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        .btn-blue { background: #3b82f6; }
        .btn-purple { background: #8b5cf6; }
        .card { 
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .back-btn { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            width: 36px;
            height: 36px;
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            line-height: 1; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
            padding-right: 2px;
        }
        .save-btn { 
            background: #10b981; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4); 
        }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .exercise-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #f9f9f9; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            cursor: pointer; 
        }
        .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-weight: 600; width: 100px; }
        .month-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .month-nav button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .month-nav h3 { 
            font-size: 20px; 
            color: #333; 
            text-transform: capitalize;
        }
        .calendar-header { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin-bottom: 8px; 
        }
        .calendar-header div { 
            font-weight: 600; 
            text-align: center; 
            color: #666; 
            font-size: 14px; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
        }
        .day-empty { background: #f0f0f0; }
        .day-padding { 
            background: #f9f9f9; 
            opacity: 0.8; 
        } 
        .day-workout { background: #10b981; color: white; font-weight: bold; }
        .day-today { box-shadow: 0 0 0 2px #3b82f6; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .hide { display: none; }
        canvas { max-width: 100%; height: 250px !important; }
        
        /* --- –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê --- */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.5); 
            z-index: 1000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 16px; 
            box-sizing: border-box;
        }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–• –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô (–û–°–¢–ê–í–õ–ï–ù–û) --- */
        .dynamic-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .dynamic-stat-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    <script>
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null; 
        let expandedExId = null; 
        let selectedExStatsId = null; 

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
                workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:", e);
                exercises = [];
                workouts = [];
                routines = [];
            }
            render();
        }

        function save() {
            try {
                localStorage.setItem('workout-exercises', JSON.stringify(exercises));
                localStorage.setItem('workout-logs', JSON.stringify(workouts));
                localStorage.setItem('workout-routines', JSON.stringify(routines)); 
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage:", e);
            }
        }
        
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `workout_tracker_data_${date}.json`;
            
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        }

        function importData() {
            if (!confirm('–í–Ω–∏–º–∞–Ω–∏–µ! –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –í–°–ï —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã). –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.exercises || !importedData.workouts || !importedData.routines) {
                            throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö. –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å exercises, workouts –∏ routines.");
                        }
                        
                        exercises = importedData.exercises;
                        workouts = importedData.workouts;
                        routines = importedData.routines;

                        save();
                        alert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                        go('home'); 
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message);
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }


        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines, 
                editRoutine: renderEditRoutine, 
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail, 
                editExercise: renderEditExercise,
            };
            document.getElementById('view').innerHTML = views[currentView]();
            window.scrollTo(0, 0); 
        }

        function go(view) {
            currentView = view;
            /* [–£–î–ê–õ–ï–ù –ù–ï–ö–û–†–†–ï–ö–¢–ù–´–ô –ö–û–î: –õ–æ–≥–∏–∫–∞ —Å–±—Ä–æ—Å–∞ –º–µ—Å—è—Ü–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∏–¥–∞. currentViewDate –¥–æ–ª–∂–Ω–∞ –º–µ–Ω—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ changeMonth] 
            if (view === 'calendar' || view === 'home') {
                 // –°–±—Ä–æ—Å –¥–∞—Ç—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –∏–ª–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            } else if (view !== 'calendar') {
                currentViewDate = new Date(); // –°–±—Ä–æ—Å –º–µ—Å—è—Ü–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            }
            */
            
            if (currentView !== 'editExercise') {
                selectedExIdEdit = null;
            }
            if (currentView !== 'editRoutine') {
                selectedRoutineIdEdit = null;
                // currentWorkout = []; // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ—Ç—Å—è –≤ cancelEditRoutine
            }
            if (currentView !== 'newWorkout' && currentView !== 'editWorkout') {
                expandedExId = null; // –°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
            }
            if (currentView !== 'exerciseStats') {
                selectedExStatsId = null; // –°–±—Ä–æ—Å ID —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            }
            render();
        }
        
        function changeMonth(offset) {
            currentViewDate.setDate(1); 
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            render(); 
        }

        function viewHomeExDetail(exId) {
            selExIdHome = exId;
            go('homeExDetail');
        }
        
        // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---
        function viewExerciseStats(exId) {
            if (exId === 'total') {
                selectedExStatsId = 'total';
            } else {
                const ex = exercises.find(e => e.id === exId);
                if (!ex) return;
                selectedExStatsId = exId;
            }
            go('exerciseStats');
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        function toggleExExpansion(exId) {
            expandedExId = expandedExId === exId ? null : exId;
            render();
        }

        function editEx(id) {
            selectedExIdEdit = id;
            go('editExercise');
        }

        function editRoutine(id) { 
            selectedRoutineIdEdit = id;
            go('editRoutine');
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–∞—Ç–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        function viewDetail(dateStr) {
            selectedDate = dateStr;
            go('detail');
        }

        // --- –î–û–ë–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –¢–†–ï–ù–ò–†–û–í–ö–ê–ú–ò (–§–ò–ö–°) ---
        function startNewWorkout() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—É—é
            selectedDate = new Date().toISOString().split('T')[0]; 
            currentWorkout = []; // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
            go('newWorkout');
        }

        function startNewWorkoutFromDate(dateStr) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É, –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è/–¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            selectedDate = dateStr; 
            currentWorkout = []; 
            go('newWorkout');
        }

        function editWorkout(dateStr) {
            const wo = workouts.find(w => w.date === dateStr);
            if (!wo) {
                alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                go('home');
                return;
            }
            selectedDate = dateStr;
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –±—É—Ñ–µ—Ä, —á—Ç–æ–±—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ –æ—Ä–∏–≥–∏–Ω–∞–ª
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises)); 
            go('editWorkout');
        }
        // -----------------------------------------------------------


        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(12, 0, 0, 0); 
            return monday.toISOString().split('T')[0];
        }

        function getWeeklyStreak() {
            if (!workouts.length) return 0;
            const uniqueWeekIds = new Set(workouts.map(w => getMonday(w.date)));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            let monday = getMonday(curr);

            while (uniqueWeekIds.has(monday)) {
                streak++;
                curr.setDate(curr.getDate() - 7); 
                monday = getMonday(curr);
            }
            return streak;
        }

        function calculateSetVolume(set, type) {
            // volume = (weight * reps) or (distance * time) or (reps)
            let volume = 0;
            const w = set.weight || 0;
            const r = set.reps || 0;

            if (type === 'weight') {
                volume = w * r;
            } else if (type === 'distance') { 
                volume = w * r; 
            } else if (type === 'time') { 
                volume = w * r;
            } else { // 'reps'
                volume = r;
            }
            return volume;
        }

        function calculateWorkoutVolume(workout) {
            let totalVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                ex.sets.forEach(set => {
                    totalVolume += calculateSetVolume(set, type);
                });
            });
            return Math.round(totalVolume);
        }

        function getMaxSetVolume(workout) {
            let maxVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                ex.sets.forEach(set => {
                    const volume = calculateSetVolume(set, type);
                    if (volume > maxVolume + 0.001) { // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–±–æ–ª—å—à–æ–≥–æ –∑–∞–ø–∞—Å–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —á–∏—Å–µ–ª —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π
                        maxVolume = volume;
                    }
                });
            });
            return maxVolume;
        }

        function numbForm(n, forms) {
            if (n % 10 === 1 && n % 100 !== 11) return forms[0];
            if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 12 || n % 100 > 14)) return forms[1];
            return forms[2];
        }

        // --- –î–û–ë–ê–í–õ–ï–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò ---

        function getTopVolumeExercises(count) {
            const exVolumes = {};
            workouts.forEach(w => {
                w.exercises.forEach(ex => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';
                    const volume = ex.sets.reduce((sum, set) => sum + calculateSetVolume(set, type), 0);
                    if (exVolumes[ex.exerciseId]) {
                        exVolumes[ex.exerciseId].volume += volume;
                    } else {
                        exVolumes[ex.exerciseId] = {
                            id: ex.exerciseId,
                            name: ex.exerciseName,
                            volume: volume,
                            type: type
                        };
                    }
                });
            });
            return Object.values(exVolumes)
                .filter(ex => ex.volume > 0)
                .sort((a, b) => b.volume - a.volume)
                .slice(0, count);
        }

        function getExerciseStatsData(exId, mode, days = 90) {
            const dataMap = new Map();
            const isTotal = exId === 'total';
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –¥–Ω–µ–π
            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dataMap.set(date.toISOString().split('T')[0], 0);
            }
            
            workouts.forEach(w => {
                let value = 0;
                if (isTotal) {
                    value = calculateWorkoutVolume(w);
                } else {
                    const ex = w.exercises.find(e => e.exerciseId === exId);
                    if (ex) {
                        const exBase = exercises.find(e => e.id === exId);
                        const type = exBase ? exBase.type : 'reps';
                        if (mode === 'volume') {
                            ex.sets.forEach(set => {
                                value += calculateSetVolume(set, type);
                            });
                            value = Math.round(value);
                        } else if (mode === 'maxSetVolume') {
                            ex.sets.forEach(set => {
                                const vol = calculateSetVolume(set, type);
                                if (vol > value) {
                                    value = Math.round(vol);
                                }
                            });
                        }
                    }
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Map, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç (–µ—Å–ª–∏ —Ç–∞–∫–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ)
                if (dataMap.has(w.date)) {
                    // –î–ª—è total volume —Å—É–º–º–∏—Ä—É–µ–º, –¥–ª—è maxSetVolume –±–µ—Ä–µ–º –º–∞–∫—Å–∏–º—É–º
                    if (isTotal) {
                        dataMap.set(w.date, dataMap.get(w.date) + value);
                    } else {
                        dataMap.set(w.date, Math.max(dataMap.get(w.date), value));
                    }
                    
                }
            });

            const sortedDates = Array.from(dataMap.keys()).sort((a, b) => new Date(a) - new Date(b));
            return sortedDates.map(date => ({ 
                date: date, 
                value: dataMap.get(date) 
            })).filter(d => new Date(d.date) >= new Date(today.getTime() - days * 24 * 60 * 60 * 1000));
        }

        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –ì–õ–ê–í–ù–û–ì–û –≠–ö–†–ê–ù–ê (HOME)
        // -----------------------------------------------------------

        function renderHome() {
            const todayStr = new Date().toISOString().split('T')[0];
            const today = workouts.find(w => w.date === todayStr);

            const totalWorkouts = workouts.length;
            const totalEx = new Set(workouts.flatMap(w => w.exercises.map(e => e.exerciseId))).size;
            
            const totalVolume = workouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
            const totalVolumeDisplay = (totalVolume / 1000).toFixed(1) + ' —Ç–æ–Ω–Ω';
            
            const maxVol = workouts.reduce((max, w) => {
                const currentMax = getMaxSetVolume(w);
                return currentMax > max ? currentMax : max;
            }, 0);
            
            const maxVolDisplay = maxVol > 0 ? (maxVol >= 1000 ? (maxVol / 1000).toFixed(1) + ' —Ç' : Math.round(maxVol) + ' –∫–≥') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            
            const weeklyStreak = getWeeklyStreak();
            
            // –¢–æ–ø-5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ –æ–±—ä–µ–º—É
            const exVolumes = {};
            workouts.forEach(w => {
                w.exercises.forEach(ex => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';
                    const volume = ex.sets.reduce((sum, set) => sum + calculateSetVolume(set, type), 0);
                    if (exVolumes[ex.exerciseId]) {
                        exVolumes[ex.exerciseId].volume += volume;
                    } else {
                        exVolumes[ex.exerciseId] = {
                            id: ex.exerciseId,
                            name: ex.exerciseName,
                            volume: volume,
                            type: type
                        };
                    }
                });
            });

            let topEx = Object.values(exVolumes)
                .sort((a, b) => b.volume - a.volume)
                .slice(0, 5);

            let otherVolume = Object.values(exVolumes)
                .slice(5)
                .reduce((sum, ex) => sum + ex.volume, 0);

            let chartData = topEx.map(ex => Math.round(ex.volume));
            let chartLabels = topEx.map(ex => ex.name);
            let chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#666'];

            if (otherVolume > 0) {
                chartData.push(Math.round(otherVolume));
                chartLabels.push('–ü—Ä–æ—á–µ–µ');
            }


            let h = `
                <div class="header-card">
                    <h2>üëã –ü—Ä–∏–≤–µ—Ç, —á–µ–º–ø–∏–æ–Ω!</h2>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <p>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                            <p>${totalWorkouts}</p>
                        </div>
                        <div class="stat-item">
                            <p>–û–±—ä–µ–º</p>
                            <p>${totalVolumeDisplay}</p>
                        </div>
                        <div class="stat-item">
                            <p>–°—Ç—Ä–∏–∫ (–Ω–µ–¥)</p>
                            <p>${weeklyStreak}</p>
                        </div>
                    </div>
                </div>
                
                <div class="btn-grid">
                    <button class="btn btn-green" onclick="${today ? `editWorkout('${todayStr}')` : `startNewWorkout()`}">
                        <span style="font-size: 24px;">${today ? '‚úèÔ∏è' : '‚ûï'}</span>
                        ${today ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è' : '–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É'}
                    </button>
                    <button class="btn btn-blue" onclick="go('calendar')">
                        <span style="font-size: 24px;">üìÖ</span>
                        –ö–∞–ª–µ–Ω–¥–∞—Ä—å
                    </button>
                </div>
                
                <div class="btn-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-top: 12px;">
                    <button class="btn btn-purple" onclick="go('routines')">
                        <span style="font-size: 24px;">üìã</span>
                        –®–∞–±–ª–æ–Ω—ã
                    </button>
                    <button class="btn btn-orange" onclick="go('stats')">
                        <span style="font-size: 24px;">üìä</span>
                        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </button>
                    <button class="btn btn-blue" onclick="go('settings')">
                        <span style="font-size: 24px;">‚öôÔ∏è</span>
                        –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>

            `;
            
            if (today) {
                h += `<div class="card" style="margin-top: 16px;">
                    <h3 style="margin-bottom: 12px;">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–µ–≥–æ–¥–Ω—è: ${new Date(todayStr).toLocaleDateString('ru-RU', { weekday: 'short' })}</h3>
                    ${today.exercises.map(ex => {
                        const baseEx = exercises.find(e => e.id === ex.exerciseId);
                        const type = baseEx ? baseEx.type : 'reps';
                        const volume = Math.round(ex.sets.reduce((sum, set) => sum + calculateSetVolume(set, type), 0));
                        return `
                            <div class="exercise-item" onclick="viewHomeExDetail('${ex.exerciseId}')" style="background: white; border-bottom: 1px solid #f0f0f0; margin-bottom: 0;">
                                <div style="font-weight: 600; flex-grow: 1;">${ex.exerciseName}</div>
                                <div style="color: #666; font-size: 14px;">–û–±—ä–µ–º: ${volume > 0 ? (volume >= 1000 ? (volume / 1000).toFixed(1) + ' —Ç' : volume + ' –∫–≥') : '‚Äî'}</div>
                            </div>
                        `;
                    }).join('')}
                    </div>`;
            }

            // –ì—Ä–∞—Ñ–∏–∫
            h += `
                <div class="card">
                    <h3 style="margin-bottom: 12px;">–û–±—ä–µ–º –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º</h3>
                    <div style="text-align: center; margin-bottom: 8px;">
                        <p style="font-size: 12px; color: #666;">–¢–æ–ø-5 –ø–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–º—É –æ–±—ä–µ–º—É –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è</p>
                    </div>
                    <canvas id="topExChart"></canvas>
                </div>
            `;
            
            // –°–∫—Ä—ã—Ç—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            h += renderAddExModal(false);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            setTimeout(() => {
                if (document.getElementById('topExChart')) {
                    new Chart(document.getElementById('topExChart'), {
                        type: 'doughnut',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                data: chartData,
                                backgroundColor: chartColors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                                title: {
                                    display: false,
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            let value = context.parsed;
                                            if (value >= 1000) {
                                                label += (value / 1000).toFixed(1) + ' —Ç';
                                            } else {
                                                label += value + ' –∫–≥';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 50);

            return h;
        }

        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –î–ï–¢–ê–õ–ï–ô –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø –ù–ê –ì–õ–ê–í–ù–û–ô
        // -----------------------------------------------------------

        function renderHomeExerciseDetail() {
            if (!selExIdHome) return go('home');
            
            const exBase = exercises.find(e => e.id === selExIdHome);
            if (!exBase) return go('home');

            const latestSets = workouts
                .flatMap(w => w.exercises)
                .filter(ex => ex.exerciseId === selExIdHome)
                .flatMap(ex => ex.sets)
                .sort((a, b) => new Date(b.date) - new Date(a.date)) // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–µ—Ç—ã
                .slice(0, 5); 

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>${exBase.name}</h2>
                        <button class="save-btn" onclick="viewExerciseStats('${selExIdHome}')">üìä</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–¢–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                        <p style="font-weight: 600; color: #3b82f6;">${exBase.type === 'weight' ? '–°–∏–ª–æ–≤–æ–µ (–í–µ—Å –∏ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è)' : exBase.type === 'time' ? '–ù–∞ –≤—Ä–µ–º—è (–í—Ä–µ–º—è –∏ –î–∏—Å—Ç–∞–Ω—Ü–∏—è)' : exBase.type === 'distance' ? '–ù–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é (–î–∏—Å—Ç–∞–Ω—Ü–∏—è –∏ –í—Ä–µ–º—è)' : '–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'}</p>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥—Ö–æ–¥—ã</h3>
                        ${latestSets.length === 0 
                            ? `<div class="empty-state"><p>–ü–æ–∫–∞ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤.</p></div>`
                            : latestSets.map((set, index) => {
                                let details = '';
                                if (exBase.type === 'weight') {
                                    details = `${set.weight || 0} –∫–≥ x ${set.reps || 0} –ø–æ–≤—Ç`;
                                } else if (exBase.type === 'time') {
                                    details = `${set.weight || 0} –º–∏–Ω x ${set.reps || 0} –∫–º`;
                                } else if (exBase.type === 'distance') {
                                    details = `${set.weight || 0} –∫–º x ${set.reps || 0} –º–∏–Ω`;
                                } else {
                                    details = `${set.reps || 0} –ø–æ–≤—Ç`;
                                }
                                return `<div class="dynamic-stat-row">
                                            <span>–ü–æ–¥—Ö–æ–¥ ${index + 1}</span>
                                            <span style="font-weight: 600;">${details}</span>
                                        </div>`;
                            }).join('')
                        }
                    </div>
                    `;
            return h;
        }


        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –°–ü–ò–°–ö–ê –£–ü–†–ê–ñ–ù–ï–ù–ò–ô
        // -----------------------------------------------------------

        function renderExercises() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2>
                        <button class="save-btn" onclick="editEx(null)">‚ûï</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–°–ø–∏—Å–æ–∫ (${exercises.length})</h3>`;
            
            if (exercises.length === 0) {
                h += `<div class="empty-state"><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</p></div>`;
            } else {
                exercises.forEach(ex => {
                    h += `<div class="exercise-item" onclick="editEx('${ex.id}')">
                            <div style="font-weight: 600;">${ex.name}</div>
                            <div style="color: #666; font-size: 14px;">${ex.type === 'weight' ? '–°–∏–ª–æ–≤–æ–µ' : ex.type === 'time' ? '–ù–∞ –≤—Ä–µ–º—è' : ex.type === 'distance' ? '–ù–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é' : '–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'}</div>
                            <button class="delete-btn" onclick="event.stopPropagation(); delEx('${ex.id}', true)">‚ùå</button>
                        </div>`;
                });
            }
            h += `</div>`;
            return h;
        }

        function renderEditExercise() {
            const isNew = !selectedExIdEdit;
            let ex = { id: Date.now().toString(), name: '', type: 'weight' };

            if (!isNew) {
                ex = exercises.find(e => e.id === selectedExIdEdit);
                if (!ex) return go('exercises');
            }

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('exercises')">‚Üê</button>
                        <h2>${isNew ? '–ù–æ–≤–æ–µ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'}</h2>
                        <button class="save-btn" onclick="saveEx()">‚úÖ</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
                        <input type="text" id="exName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" value="${ex.name}">
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–¢–∏–ø –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
                        <select id="exType">
                            <option value="weight" ${ex.type === 'weight' ? 'selected' : ''}>–°–∏–ª–æ–≤–æ–µ (–í–µ—Å –∏ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è)</option>
                            <option value="reps" ${ex.type === 'reps' ? 'selected' : ''}>–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–¢–æ–ª—å–∫–æ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è)</option>
                            <option value="time" ${ex.type === 'time' ? 'selected' : ''}>–ù–∞ –≤—Ä–µ–º—è (–í—Ä–µ–º—è –∏ –î–∏—Å—Ç–∞–Ω—Ü–∏—è)</option>
                            <option value="distance" ${ex.type === 'distance' ? 'selected' : ''}>–ù–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é (–î–∏—Å—Ç–∞–Ω—Ü–∏—è –∏ –í—Ä–µ–º—è)</option>
                        </select>
                    </div>`;
            
            if (!isNew) {
                 h += `<div class="card">
                            <button onclick="delEx('${ex.id}', false)" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                ‚ùå –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>`;
            }
            
            return h;
        }

        function saveEx() {
            const isNew = !selectedExIdEdit;
            const name = document.getElementById('exName').value.trim();
            const type = document.getElementById('exType').value;

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è!');
                return;
            }

            if (isNew) {
                exercises.push({
                    id: Date.now().toString(),
                    name: name,
                    type: type
                });
            } else {
                const ex = exercises.find(e => e.id === selectedExIdEdit);
                if (ex) {
                    ex.name = name;
                    ex.type = type;
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ —à–∞–±–ª–æ–Ω–∞—Ö
                    workouts.forEach(wo => {
                        wo.exercises.filter(e => e.exerciseId === ex.id).forEach(e => e.exerciseName = name);
                    });
                    routines.forEach(rt => {
                        rt.exercises.filter(e => e.exerciseId === ex.id).forEach(e => e.exerciseName = name);
                    });
                }
            }

            save();
            go('exercises');
        }

        function delEx(exId, confirmAll) {
            let msg = confirmAll 
                ? '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞? –û–Ω–æ —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –∏–∑ –í–°–ï–• —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —à–∞–±–ª–æ–Ω–æ–≤!'
                : '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ? –û–Ω–æ —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –∏–∑ –í–°–ï–• —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —à–∞–±–ª–æ–Ω–æ–≤!';

            if (confirm(msg)) {
                exercises = exercises.filter(ex => ex.id !== exId);
                // –£–¥–∞–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —à–∞–±–ª–æ–Ω–æ–≤
                workouts.forEach(wo => {
                    wo.exercises = wo.exercises.filter(ex => ex.exerciseId !== exId);
                });
                routines.forEach(rt => {
                    rt.exercises = rt.exercises.filter(ex => ex.exerciseId !== exId);
                });
                save();
                go('exercises');
            }
        }
        
        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –®–ê–ë–õ–û–ù–û–í (–†–£–¢–ò–ù)
        // -----------------------------------------------------------

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–¢–ú–ï–ù–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –®–ê–ë–õ–û–ù–ê –ò–ó –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê
        function cancelRoutineAdd() {
            document.getElementById('newRoutineName').value = '';
            document.getElementById('addRoutineModal').classList.add('hide');
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–¢–ú–ï–ù–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –®–ê–ë–õ–û–ù–ê
        function cancelEditRoutine() {
            selectedRoutineIdEdit = null;
            currentWorkout = []; // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞, –µ—Å–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏/–æ—Ç–º–µ–Ω–∏–ª–∏
            go('routines');
        }

        function addRoutine() {
            const name = document.getElementById('newRoutineName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞!');
                return;
            }

            routines.push({
                id: Date.now().toString(),
                name: name,
                exercises: []
            });
            save();
            document.getElementById('newRoutineName').value = '';
            document.getElementById('addRoutineModal').classList.add('hide');
            render();
        }

        function renderRoutines() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–®–∞–±–ª–æ–Ω—ã</h2>
                        <button class="save-btn" onclick="document.getElementById('addRoutineModal').classList.remove('hide')">‚ûï</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–ú–æ–∏ —à–∞–±–ª–æ–Ω—ã (${routines.length})</h3>`;
            
            if (routines.length === 0) {
                h += `<div class="empty-state"><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</p></div>`;
            } else {
                routines.forEach(rt => {
                    h += `<div class="exercise-item" onclick="editRoutine('${rt.id}')">
                            <div style="font-weight: 600; flex-grow: 1;">${rt.name}</div>
                            <div style="color: #666; font-size: 14px;">${rt.exercises.length} ${numbForm(rt.exercises.length, ['—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è', '—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π'])}</div>
                            <button class="delete-btn" onclick="event.stopPropagation(); delRoutine('${rt.id}')">‚ùå</button>
                        </div>`;
                });
            }
            h += `</div>`;

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
            h += `<div id="addRoutineModal" class="modal hide" onclick="if(event.target.id === 'addRoutineModal') cancelRoutineAdd()">
                <div class="card" style="width: 100%; max-width: 400px;">
                    <h3 style="margin-bottom: 12px;">–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω</h3>
                    <input type="text" id="newRoutineName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" style="margin-bottom: 12px;">
                    <button class="save-btn" style="width: 100%; margin-bottom: 8px;" onclick="addRoutine()">–°–æ–∑–¥–∞—Ç—å</button>
                    <button class="back-btn" style="width: 100%; background: #ccc; color: #333;" onclick="cancelRoutineAdd()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>`;

            return h;
        }

        function renderEditRoutine() {
            if (!selectedRoutineIdEdit) return go('routines');
            const rt = routines.find(r => r.id === selectedRoutineIdEdit);
            if (!rt) return go('routines');
            
            // –ï—Å–ª–∏ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –∑–∞–≥—Ä—É–∂–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ –≤ –±—É—Ñ–µ—Ä.
            if (currentWorkout.length === 0) {
                currentWorkout = JSON.parse(JSON.stringify(rt.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: [] // –®–∞–±–ª–æ–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–µ—Ç—ã
                }))));
            }

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="cancelEditRoutine()">‚Üê</button>
                        <h2>${rt.name}</h2>
                        <button class="save-btn" onclick="saveRoutine()">‚úÖ</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</h3>
                        <input type="text" id="editRoutineName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" value="${rt.name}">
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–µ (${currentWorkout.length})</h3>
                        <button class="save-btn" style="width: 100%; margin-bottom: 16px; background: #3b82f6;" onclick="document.getElementById('addExModal').classList.remove('hide')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                        ${currentWorkout.length === 0 
                            ? `<div class="empty-state"><p>–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω.</p></div>` 
                            : currentWorkout.map(ex => `
                                <div class="exercise-item" style="cursor: default;">
                                    <div style="font-weight: 600; flex-grow: 1;">${ex.exerciseName}</div>
                                    <button class="delete-btn" onclick="event.stopPropagation(); removeExFromWorkout('${ex.exerciseId}')">‚ùå</button>
                                </div>
                            `).join('')
                        }
                    </div>
                    <div class="card">
                        <button onclick="delRoutine('${rt.id}')" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            ‚ùå –£–¥–∞–ª–∏—Ç—å –®–∞–±–ª–æ–Ω
                        </button>
                    </div>
                    `;
            
            // –°–∫—Ä—ã—Ç—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            h += renderAddExModal(true); 

            return h;
        }

        function saveRoutine() {
            const rt = routines.find(r => r.id === selectedRoutineIdEdit);
            const newName = document.getElementById('editRoutineName').value.trim();

            if (!rt || !newName) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!');
                return;
            }

            rt.name = newName;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ –±—É—Ñ–µ—Ä–∞ –≤ —à–∞–±–ª–æ–Ω, –Ω–æ –±–µ–∑ —Å–µ—Ç–æ–≤
            rt.exercises = currentWorkout.map(ex => ({
                exerciseId: ex.exerciseId,
                exerciseName: ex.exerciseName
            }));
            
            save();
            currentWorkout = []; // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞
            go('routines');
        }

        function delRoutine(rtId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
                routines = routines.filter(r => r.id !== rtId);
                save();
                currentWorkout = []; // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞
                go('routines');
            }
        }


        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –ù–û–í–û–ô/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –¢–†–ï–ù–ò–†–û–í–ö–ò
        // -----------------------------------------------------------

        function renderNewWorkout() { return renderWorkoutScreen(false); }
        function renderEditWorkout() { return renderWorkoutScreen(true); }

        function renderWorkoutScreen(isEdit) {
            const title = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫—É' : '–ù–æ–≤–∞—è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
            const dateDisplay = new Date(selectedDate).toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go(isEdit ? 'detail' : 'home')">‚Üê</button>
                        <h2>${title}</h2>
                        <button class="save-btn" onclick="saveWorkout()">‚úÖ</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: ${dateDisplay}</h3>
                        <input type="date" id="workoutDate" value="${selectedDate}" onchange="selectedDate = this.value">
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω</h3>
                        <select id="loadRoutineSelect" onchange="loadRoutine(this.value)" style="margin-bottom: 16px;">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω...</option>
                            ${routines.map(rt => `<option value="${rt.id}">${rt.name}</option>`).join('')}
                        </select>
                        <button class="save-btn" style="width: 100%; background: #3b82f6;" onclick="document.getElementById('addExModal').classList.remove('hide')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ (${currentWorkout.length})</h3>`;
            
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state"><p>–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —à–∞–±–ª–æ–Ω.</p></div>`;
            } else {
                currentWorkout.forEach(ex => {
                    const isExpanded = expandedExId === ex.exerciseId;
                    const eBase = exercises.find(e => e.id === ex.exerciseId);
                    const t = eBase ? eBase.type : 'reps';

                    // Exercise header
                    h += `<div class="exercise-item" style="margin-bottom: ${isExpanded ? '8px' : '0'}; flex-wrap: wrap; cursor: pointer; border-bottom: ${isExpanded ? 'none' : '1px solid #f0f0f0'};" onclick="toggleExExpansion('${ex.exerciseId}')">
                            <div style="font-weight: 600; flex-grow: 1;">${ex.exerciseName}</div>
                            <div style="color: #666; font-size: 14px; margin-right: 12px;">${ex.sets.length} ${numbForm(ex.sets.length, ['–ø–æ–¥—Ö–æ–¥', '–ø–æ–¥—Ö–æ–¥–∞', '–ø–æ–¥—Ö–æ–¥–æ–≤'])}</div>
                            <button class="delete-btn" onclick="event.stopPropagation(); removeExFromWorkout('${ex.exerciseId}')" style="margin-top: -4px;">‚ùå</button>
                            <span style="font-size: 20px; line-height: 1; margin-top: -4px;">${isExpanded ? '‚ñ≤' : '‚ñº'}</span>
                        </div>`;

                    // Exercise sets detail (Expanded view)
                    if (isExpanded) {
                        h += `<div class="card" style="margin-top: 0; padding: 12px; background: #fff; border-top-left-radius: 0; border-top-right-radius: 0; box-shadow: none;">`;
                        ex.sets.forEach((set, index) => {
                            const setNumber = index + 1;
                            h += `<div class="set-row">
                                <span class="set-label">${setNumber}.</span>`;

                            if (t === 'weight') {
                                h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                            <span style="font-size: 12px; color: #666;">–í–µ—Å (–∫–≥)</span>
                                            <input type="number" inputmode="decimal" step="0.1" placeholder="–∫–≥" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                            <span style="font-size: 12px; color: #666;">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</span>
                                            <input type="number" inputmode="numeric" placeholder="–ø–æ–≤—Ç" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                        </div>`;
                            } else if (t === 'distance') {
                                h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                            <span style="font-size: 12px; color: #666;">–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</span>
                                            <input type="number" inputmode="decimal" step="0.1" placeholder="–∫–º" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                            <span style="font-size: 12px; color: #666;">–í—Ä–µ–º—è (–º–∏–Ω)</span>
                                            <input type="number" inputmode="decimal" step="0.1" placeholder="–º–∏–Ω" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                        </div>`;
                            } else if (t === 'time') {
                                h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                            <span style="font-size: 12px; color: #666;">–í—Ä–µ–º—è (–º–∏–Ω)</span>
                                            <input type="number" inputmode="decimal" step="0.1" placeholder="–º–∏–Ω" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                        </div>
                                        <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                            <span style="font-size: 12px; color: #666;">–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</span>
                                            <input type="number" inputmode="decimal" step="0.1" placeholder="–∫–º" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                        </div>`;
                            } else { // 'reps' only
                                h += `<div style="flex: 2; display: flex; flex-direction: column;">
                                            <span style="font-size: 12px; color: #666;">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</span>
                                            <input type="number" inputmode="numeric" placeholder="–ø–æ–≤—Ç" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                        </div>`;
                            }

                            h += `<button class="delete-btn" onclick="removeSetForEx('${ex.exerciseId}', ${index})" style="flex-shrink: 0; margin-left: 8px; margin-top: 10px;">üóëÔ∏è</button>
                            </div>`; // .set-row
                        });
                        h += `<button class="save-btn" style="width: 100%; margin-top: 12px; background: #8b5cf6;" onclick="addSetForEx('${ex.exerciseId}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>`;
                        h += `</div>`; // .card
                    }
                });
            }

            h += `</div>`;

            // –°–∫—Ä—ã—Ç—ã–π –º–æ–¥–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            h += renderAddExModal(false);

            return h;
        }

        function renderAddExModal(isRoutine) {
            return `<div id="addExModal" class="modal hide" onclick="if(event.target.id === 'addExModal') this.classList.add('hide')">
                <div class="card" style="width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 12px;">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                    <input type="text" id="exSearch" placeholder="–ü–æ–∏—Å–∫..." oninput="filterAddExList()" style="margin-bottom: 12px;">
                    <div id="exListContainer">
                        ${exercises.length === 0 
                            ? `<div class="empty-state"><p>–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è".</p></div>`
                            : exercises.map(ex => `
                                <div class="exercise-item add-ex-item" data-name="${ex.name.toLowerCase()}" onclick="addExToWorkout('${ex.id}', '${ex.name}', ${isRoutine})" style="margin-bottom: 8px; cursor: pointer;">
                                    <div style="font-weight: 600; flex-grow: 1;">${ex.name}</div>
                                    <div style="color: #666; font-size: 14px;">${ex.type === 'weight' ? '–°–∏–ª–æ–≤–æ–µ' : ex.type === 'time' ? '–ù–∞ –≤—Ä–µ–º—è' : ex.type === 'distance' ? '–ù–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é' : '–ù–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'}</div>
                                    <span style="font-size: 20px;">+</span>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            </div>`;
        }

        function saveWorkout() {
            const workoutDate = document.getElementById('workoutDate').value;
            if (!workoutDate) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!');
                return;
            }

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∏–º –ø–æ–¥—Ö–æ–¥–æ–º
            const filteredExercises = currentWorkout.map(ex => ({
                exerciseId: ex.exerciseId,
                exerciseName: ex.exerciseName,
                // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å–µ—Ç—ã (–≥–¥–µ reps –∏ weight/distance/time –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã)
                sets: ex.sets.filter(set => set.reps || set.weight) 
            })).filter(ex => ex.sets.length > 0);

            if (filteredExercises.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ!');
                return;
            }

            const workoutData = {
                id: Date.now().toString(),
                date: workoutDate,
                exercises: filteredExercises
            };

            const existingIndex = workouts.findIndex(w => w.date === workoutDate);

            if (existingIndex !== -1) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                workouts[existingIndex] = workoutData;
            } else {
                // –ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
                workouts.push(workoutData);
                workouts.sort((a, b) => new Date(b.date) - new Date(a.date)); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            }

            save();
            // –û—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–µ—Ç–∞–ª–∏
            currentWorkout = [];
            selectedDate = workoutDate; // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é
            go('detail');
        }

        function filterAddExList() {
            const query = document.getElementById('exSearch').value.toLowerCase();
            const items = document.querySelectorAll('.add-ex-item');
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                if (name.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function addExToWorkout(exId, exName, isRoutine) {
            const ex = currentWorkout.find(e => e.exerciseId === exId);
            if (ex) {
                alert('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
                return;
            }

            const newEx = {
                exerciseId: exId,
                exerciseName: exName,
                sets: isRoutine ? [] : [{ weight: null, reps: null }] // –í —à–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª—è–µ–º –±–µ–∑ —Å–µ—Ç–æ–≤, –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É - —Å –æ–¥–Ω–∏–º –ø—É—Å—Ç—ã–º
            };
            currentWorkout.push(newEx);
            document.getElementById('addExModal').classList.add('hide');

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            if (!isRoutine) {
                expandedExId = exId;
            }
            render();
        }

        function removeExFromWorkout(exId) {
            currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
            if (expandedExId === exId) {
                expandedExId = null;
            }
            render();
        }

        function loadRoutine(routineId) {
            const rt = routines.find(r => r.id === routineId);
            if (rt) {
                // –ö–ª–æ–Ω–∏—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ –≤ —Ç–µ–∫—É—â–∏–π –±—É—Ñ–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                currentWorkout = JSON.parse(JSON.stringify(rt.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: [] // –®–∞–±–ª–æ–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–µ—Ç—ã, –æ–Ω–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
                })))); 
                alert(`‚úÖ –®–∞–±–ª–æ–Ω "${rt.name}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
                document.getElementById('loadRoutineSelect').value = '';
                render();
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–õ–ê–ô–ù-–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---

        function addSetForEx(exId) {
            const ex = currentWorkout.find(e => e.exerciseId === exId);
            if (ex) {
                ex.sets.push({ weight: null, reps: null });
                render();
            }
        }

        function removeSetForEx(exId, index) {
            const ex = currentWorkout.find(e => e.exerciseId === exId);
            if (ex) {
                ex.sets.splice(index, 1);
                render();
            }
        }

        function updateSetForEx(exId, index, key, value) {
            const ex = currentWorkout.find(e => e.exerciseId === exId);
            if (ex && ex.sets[index]) {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ, –µ—Å–ª–∏ –Ω–µ –ø—É—Å—Ç–æ
                const numValue = (value === '' || value === null) ? null : Number(value);
                ex.sets[index][key] = numValue;
                // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º render() –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ñ–æ–∫—É—Å —Å –∏–Ω–ø—É—Ç–∞
            }
        }

        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –ö–ê–õ–ï–ù–î–ê–†–Ø (CALENDAR)
        // -----------------------------------------------------------

        function renderCalendar() {
            const todayStr = new Date().toISOString().split('T')[0];
            const currentYear = currentViewDate.getFullYear();
            const currentMonth = currentViewDate.getMonth();
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startDay = (firstDayOfMonth.getDay() + 6) % 7; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0
            
            const monthName = currentViewDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            const workoutDates = new Set(workouts.map(w => w.date));
            
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
                        <button class="save-btn" onclick="startNewWorkout()">‚ûï</button>
                    </div>
                    <div class="card">
                        <div class="month-nav">
                            <button onclick="changeMonth(-1)">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
                            <h3>${monthName}</h3>
                            <button onclick="changeMonth(1)">–°–ª–µ–¥—É—é—â–∏–π ‚Üí</button>
                        </div>
                        <div class="calendar-header">
                            <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
                        </div>
                        <div class="calendar-grid">`;

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ (–¥–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞)
            for (let i = 0; i < startDay; i++) {
                h += `<div class="calendar-day day-padding"></div>`;
            }

            // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isWorkout = workoutDates.has(dateStr);
                const isToday = dateStr === todayStr;
                let dayClass = 'day-empty';
                
                if (isWorkout) {
                    dayClass = 'day-workout';
                }
                if (isToday) {
                    dayClass += ' day-today';
                }

                h += `<button class="calendar-day ${dayClass}" onclick="viewDetail('${dateStr}')">${day}</button>`;
            }

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ (–¥–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞)
            const endDay = (startDay + daysInMonth) % 7;
            const remainingDays = endDay === 0 ? 0 : 7 - endDay;
            for (let i = 0; i < remainingDays; i++) {
                h += `<div class="calendar-day day-padding"></div>`;
            }

            h += `</div></div>`;
            return h;
        }

        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –î–ï–¢–ê–õ–ï–ô –î–ù–Ø (DETAIL)
        // -----------------------------------------------------------

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            const dateDisplay = new Date(selectedDate).toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });
            
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('calendar')">‚Üê</button>
                        <h2>${dateDisplay}</h2>
                        <button class="save-btn" onclick="${wo ? `editWorkout('${selectedDate}')` : `startNewWorkoutFromDate('${selectedDate}')`}">
                            ${wo ? '‚úèÔ∏è' : '‚ûï'}
                        </button>
                    </div>`;

            if (!wo) {
                h += `<div class="card">
                        <div class="empty-state">
                            <p style="margin-bottom: 16px;">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç.</p>
                            <button class="save-btn" style="background: #3b82f6;" onclick="startNewWorkoutFromDate('${selectedDate}')">
                                ‚ûï –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                            </button>
                        </div>
                    </div>`;
            } else {
                const totalVolume = calculateWorkoutVolume(wo);
                const maxVol = getMaxSetVolume(wo);
                
                const totalVolumeDisplay = (totalVolume / 1000).toFixed(1) + ' —Ç';
                const maxVolDisplay = maxVol > 0 ? (maxVol >= 1000 ? (maxVol / 1000).toFixed(1) + ' —Ç' : Math.round(maxVol) + ' –∫–≥') : '‚Äî';


                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–°–≤–æ–¥–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h3>
                    <div class="dynamic-stat-row">
                        <span>–û–±—ä–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</span>
                        <span style="font-weight: bold;">${totalVolumeDisplay}</span>
                    </div>
                    <div class="dynamic-stat-row">
                        <span>–ú–∞–∫—Å. –ø–æ–¥—Ö–æ–¥ (PR)</span>
                        <span style="font-weight: bold;">${maxVolDisplay}</span>
                    </div>
                    <div class="dynamic-stat-row" style="border-bottom: none;">
                        <span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                        <span style="font-weight: bold;">${wo.exercises.length}</span>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 12px;">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>`;
                
                wo.exercises.forEach(ex => {
                    const isExpanded = expandedExId === ex.exerciseId;
                    const eBase = exercises.find(e => e.id === ex.exerciseId);
                    const t = eBase ? eBase.type : 'reps';

                    // Exercise header
                    h += `<div class="exercise-item" style="margin-bottom: ${isExpanded ? '8px' : '0'}; flex-wrap: wrap; cursor: pointer; border-bottom: ${isExpanded ? 'none' : '1px solid #f0f0f0'};" onclick="toggleExExpansion('${ex.exerciseId}')">
                            <div style="font-weight: 600; flex-grow: 1;">${ex.exerciseName}</div>
                            <div style="color: #666; font-size: 14px; margin-right: 12px;">${ex.sets.length} ${numbForm(ex.sets.length, ['–ø–æ–¥—Ö–æ–¥', '–ø–æ–¥—Ö–æ–¥–∞', '–ø–æ–¥—Ö–æ–¥–æ–≤'])}</div>
                            <span style="font-size: 20px; line-height: 1; margin-top: -4px;">${isExpanded ? '‚ñ≤' : '‚ñº'}</span>
                        </div>`;

                    // Exercise sets detail (Expanded view)
                    if (isExpanded) {
                        h += `<div class="card" style="margin-top: 0; padding: 12px; background: #fff; border-top-left-radius: 0; border-top-right-radius: 0; box-shadow: none;">`;
                        ex.sets.forEach((set, index) => {
                            const setNumber = index + 1;
                            let details = '';
                            let volume = 0;
                            
                            if (t === 'weight') {
                                details = `${set.weight || 0} –∫–≥ x ${set.reps || 0} –ø–æ–≤—Ç`;
                            } else if (t === 'time') {
                                details = `${set.weight || 0} –º–∏–Ω x ${set.reps || 0} –∫–º`;
                            } else if (t === 'distance') {
                                details = `${set.weight || 0} –∫–º x ${set.reps || 0} –º–∏–Ω`;
                            } else {
                                details = `${set.reps || 0} –ø–æ–≤—Ç`;
                            }

                            volume = Math.round(calculateSetVolume(set, t));
                            const volumeDisplay = volume > 0 ? (volume >= 1000 ? (volume / 1000).toFixed(1) + ' —Ç' : volume + ' –∫–≥') : '‚Äî';


                            h += `<div class="dynamic-stat-row">
                                    <span>–ü–æ–¥—Ö–æ–¥ ${setNumber} (${details})</span>
                                    <span style="font-weight: 600;">–û–±—ä–µ–º: ${volumeDisplay}</span>
                                </div>`;
                        });
                        h += `</div>`; // .card
                    }
                });
                h += `</div>`;
                
            }
            return h;
        }

        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –°–¢–ê–¢–ò–°–¢–ò–ö–ò (STATS)
        // -----------------------------------------------------------

        function renderStats() {
            const totalWorkouts = workouts.length;
            const totalEx = new Set(workouts.flatMap(w => w.exercises.map(e => e.exerciseId))).size;
            
            const totalVolume = workouts.reduce((sum, w) => sum + calculateWorkoutVolume(w), 0);
            const totalVolumeDisplay = (totalVolume / 1000).toFixed(1) + ' —Ç–æ–Ω–Ω';
            
            const maxVol = workouts.reduce((max, w) => {
                const currentMax = getMaxSetVolume(w);
                return currentMax > max ? currentMax : max;
            }, 0);
            
            const maxVolDisplay = maxVol > 0 ? (maxVol >= 1000 ? (maxVol / 1000).toFixed(1) + ' —Ç' : Math.round(maxVol) + ' –∫–≥') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            
            // –ù–û–í–´–ï –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–ò–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò
            const avgWorkoutVolume = totalWorkouts > 0 ? Math.round(totalVolume / totalWorkouts) : 0;
            const avgVolumeDisplay = avgWorkoutVolume > 0 ? (avgWorkoutVolume >= 1000 ? (avgWorkoutVolume / 1000).toFixed(1) + ' —Ç' : avgWorkoutVolume + ' –∫–≥') : '‚Äî';
            
            const totalExCount = workouts.reduce((sum, w) => sum + w.exercises.length, 0);
            const avgExPerWorkout = totalWorkouts > 0 ? (totalExCount / totalWorkouts).toFixed(1) : '‚Äî';
            
            const weeklyStreak = getWeeklyStreak(); 

            const firstWorkout = workouts.length > 0 ? workouts[workouts.length - 1] : null; 
            const firstWorkoutDate = firstWorkout ? new Date(firstWorkout.date).toLocaleDateString('ru-RU') : '‚Äî';
            // –ö–û–ù–ï–¶ –ù–û–í–´–• –°–¢–ê–¢–ò–°–¢–ò–ß–ï–°–ö–ò–• –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô

            const topEx = getTopVolumeExercises(5); 
            let chartData = topEx.map(ex => Math.round(ex.volume));
            let chartLabels = topEx.map(ex => ex.name);
            let chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#666'];

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ "–ü—Ä–æ—á–µ–µ" –¥–ª—è –ø–æ–Ω—á–∏–∫–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
            let otherVolume = Object.values(exVolumes)
                .slice(5)
                .reduce((sum, ex) => sum + ex.volume, 0);
            if (otherVolume > 0) {
                chartData.push(Math.round(otherVolume));
                chartLabels.push('–ü—Ä–æ—á–µ–µ');
            }


            // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–∏ –æ–±—ä–µ–º–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
            const volumeData = getExerciseStatsData('total', 'volume', 30);
            const volumeChartData = volumeData.map(d => d.value);
            const volumeChartLabels = volumeData.map(d => new Date(d.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div style="width: 36px;"></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
                        <div class="dynamic-stat-row"> <span>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span> <span style="font-weight: bold;">${totalWorkouts}</span> </div>
                        <div class="dynamic-stat-row"> <span>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</span> <span style="font-weight: bold;">${totalEx}</span> </div>
                        <div class="dynamic-stat-row"> <span>–°—Ç—Ä–∏–∫ (–Ω–µ–¥–µ–ª—å)</span> <span style="font-weight: bold;">${weeklyStreak}</span> </div>
                        <div class="dynamic-stat-row"> <span>–û–±—â–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –æ–±—ä–µ–º</span> <span style="font-weight: bold;">${totalVolumeDisplay}</span> </div>
                        <div class="dynamic-stat-row"> <span>–°—Ä–µ–¥–Ω–∏–π –æ–±—ä–µ–º/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span> <span style="font-weight: bold;">${avgVolumeDisplay}</span> </div>
                        <div class="dynamic-stat-row"> <span>–ú–∞–∫—Å. –ø–æ–¥—Ö–æ–¥ (PR)</span> <span style="font-weight: bold;">${maxVolDisplay}</span> </div>
                        <div class="dynamic-stat-row"> <span>–°—Ä–µ–¥–Ω–µ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π/—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span> <span style="font-weight: bold;">${avgExPerWorkout}</span> </div>
                        <div class="dynamic-stat-row" style="border-bottom: none;"> <span>–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</span> <span style="font-weight: bold;">${firstWorkoutDate}</span> </div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–î–∏–Ω–∞–º–∏–∫–∞ –æ–±—â–µ–≥–æ –æ–±—ä–µ–º–∞ (30 –¥–Ω)</h3>
                        <canvas id="totalVolumeChart"></canvas>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–û–±—ä–µ–º –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º (–¢–æ–ø-5)</h3>
                        <canvas id="statsDoughnutChart"></canvas>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º</h3>
                        ${exercises.length === 0 
                            ? `<div class="empty-state"><p>–£ –≤–∞—Å –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p></div>`
                            : exercises.map(ex => `
                                <div class="exercise-item" onclick="viewExerciseStats('${ex.id}')" style="background: white; border-bottom: 1px solid #f0f0f0; margin-bottom: 0;">
                                    <div style="font-weight: 600; flex-grow: 1;">${ex.name}</div>
                                    <span style="font-size: 20px; color: #3b82f6;">‚Üí</span>
                                </div>
                            `).join('')
                        }
                    </div>
                    `;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
            setTimeout(() => {
                // –ì—Ä–∞—Ñ–∏–∫ –æ–±—â–µ–π –¥–∏–Ω–∞–º–∏–∫–∏ –æ–±—ä–µ–º–∞
                if (document.getElementById('totalVolumeChart')) {
                    new Chart(document.getElementById('totalVolumeChart'), {
                        type: 'line',
                        data: {
                            labels: volumeChartLabels,
                            datasets: [{
                                label: '–û–±—ä–µ–º (–∫–≥)',
                                data: volumeChartData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            let value = context.parsed.y;
                                            if (value >= 1000) {
                                                label += (value / 1000).toFixed(1) + ' —Ç';
                                            } else {
                                                label += value + ' –∫–≥';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // –ü–æ–Ω—á–∏–∫–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º
                if (document.getElementById('statsDoughnutChart')) {
                    new Chart(document.getElementById('statsDoughnutChart'), {
                        type: 'doughnut',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                data: chartData,
                                backgroundColor: chartColors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                                title: {
                                    display: false,
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            let value = context.parsed;
                                            if (value >= 1000) {
                                                label += (value / 1000).toFixed(1) + ' —Ç';
                                            } else {
                                                label += value + ' –∫–≥';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 50);

            return h;
        }

        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –£–ü–†–ê–ñ–ù–ï–ù–ò–Æ (EXERCISE STATS)
        // -----------------------------------------------------------

        function renderExerciseStats() {
            if (!selectedExStatsId) return go('stats');
            
            const isTotal = selectedExStatsId === 'total';
            let exBase = null;
            let title = '–û–±—â–∞—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞';

            if (!isTotal) {
                exBase = exercises.find(e => e.id === selectedExStatsId);
                if (!exBase) return go('stats');
                title = exBase.name;
            }

            const exType = exBase ? exBase.type : 'weight';
            const isRepsType = exType === 'reps';
            let unit = '–∫–≥';
            
            if (exType === 'time') {
                unit = '–º–∏–Ω';
            } else if (exType === 'distance') {
                unit = '–∫–º';
            } else if (exType === 'reps') {
                unit = '–ø–æ–≤—Ç';
            }


            // PR Data (–ú–∞–∫—Å. –ø–æ–¥—Ö–æ–¥)
            const prData = getExerciseStatsData(selectedExStatsId, 'maxSetVolume', 90);
            const prChartData = prData.map(d => d.value);
            const prChartLabels = prData.map(d => new Date(d.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
            
            // Volume Data (–û–±—â–∏–π –æ–±—ä–µ–º), –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
            let volumeChartData = [];
            if (!isRepsType) {
                const volumeData = getExerciseStatsData(selectedExStatsId, 'volume', 90);
                volumeChartData = volumeData.map(d => d.value);
            }

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('stats')">‚Üê</button>
                        <h2>${title}</h2>
                        <div style="width: 36px;"></div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–î–∏–Ω–∞–º–∏–∫–∞ –ú–∞–∫—Å. –ü–æ–¥—Ö–æ–¥–∞ (90 –¥–Ω)</h3>
                        <canvas id="prChart"></canvas>
                    </div>`;
            
            if (!isRepsType) {
                h += `<div class="card">
                        <h3 style="margin-bottom: 12px;">–î–∏–Ω–∞–º–∏–∫–∞ –û–±—â–µ–≥–æ –û–±—ä–µ–º–∞ (90 –¥–Ω)</h3>
                        <canvas id="volumeChart"></canvas>
                    </div>`;
            }
            
            h += `<div class="card">
                        <button onclick="go('stats')" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                    </div>`;

            setTimeout(() => {
                // PR Chart (–ú–∞–∫—Å. –ø–æ–¥—Ö–æ–¥)
                if (document.getElementById('prChart')) {
                    new Chart(document.getElementById('prChart'), {
                        type: 'line',
                        data: {
                            labels: prChartLabels,
                            datasets: [{
                                label: `–ú–∞–∫—Å. –ø–æ–¥—Ö–æ–¥ (${unit})`,
                                data: prChartData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            let value = context.parsed.y;
                                            // –¢–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Å–∞/–æ–±—ä–µ–º–∞
                                            if (exType === 'weight' && value >= 1000) {
                                                label += (value / 1000).toFixed(1) + ' —Ç';
                                            } else {
                                                label += value + ' ' + unit;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Volume Chart (–û–±—â–∏–π –æ–±—ä–µ–º)
                if (!isRepsType && document.getElementById('volumeChart')) {
                    new Chart(document.getElementById('volumeChart'), {
                        type: 'line',
                        data: {
                            labels: prChartLabels, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –º–µ—Ç–∫–∏
                            datasets: [{
                                label: `–û–±—â–∏–π –æ–±—ä–µ–º (${unit})`,
                                data: volumeChartData,
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                                tension: 0.2,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            let value = context.parsed.y;
                                            if (value >= 1000) {
                                                label += (value / 1000).toFixed(1) + ' —Ç';
                                            } else {
                                                label += value + ' ' + unit;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 50);

            return h;
        }


        // -----------------------------------------------------------
        // –†–ï–ù–î–ï–†–ò–ù–ì –ù–ê–°–¢–†–û–ï–ö (SETTINGS)
        // -----------------------------------------------------------

        function renderSettings() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                        <div style="width: 36px;"></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                        <button class="save-btn" style="width: 100%; background: #3b82f6; margin-bottom: 8px;" onclick="exportData()">
                            üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (.json)
                        </button>
                        <button class="save-btn" style="width: 100%; background: #f59e0b;" onclick="importData()">
                            ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (.json)
                        </button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</h3>
                        <button style="width: 100%; padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px;" onclick="resetRoutines()">
                            üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –®–∞–±–ª–æ–Ω—ã
                        </button>
                        <button style="width: 100%; padding: 12px; background: #8b5cf6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px;" onclick="resetWo()">
                            üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                        </button>
                        <button style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px;" onclick="resetEx()">
                            ‚ö†Ô∏è –°–±—Ä–æ—Å–∏—Ç—å –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ)
                        </button>
                        <button style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;" onclick="resetAll()">
                            üî•üî•üî• –°–±—Ä–æ—Å–∏—Ç—å –í–°–ï –î–ê–ù–ù–´–ï
                        </button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                        <p style="color: #666; font-size: 14px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ **v2.3** (–í—Å–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)<br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
                    </div>`;
            return h;
        }
        
        function resetRoutines() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —à–∞–±–ª–æ–Ω—ã?')) {
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetWo() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                workouts = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetEx() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï?')) {
                if (confirm('–¢–æ—á–Ω–æ? –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('üî• –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    render();
                }
            }
        }

        init();
    </script>
</body>
</html>
