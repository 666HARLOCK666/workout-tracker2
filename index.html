<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 90px; }
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 8px;
            padding: 8px 0;
        }
        .stat-item p:first-child { 
            font-size: 11px; 
            opacity: 0.8; 
            margin-bottom: 2px; 
            line-height: 1.1;
        }
        .stat-item p:last-child { 
            font-size: 20px; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { padding: 20px; border-radius: 12px; border: none; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        .btn-blue { background: #3b82f6; }
        .btn-purple { background: #8b5cf6; }
        .card { 
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .back-btn { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            width: 36px;
            height: 36px;
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            line-height: 1; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
            padding-right: 2px;
        }
        .save-btn { 
            background: #10b981; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4); 
        }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .exercise-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #f9f9f9; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            cursor: pointer; 
        }
        .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-weight: 600; width: 100px; }
        .month-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .month-nav button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .month-nav h3 { 
            font-size: 20px; 
            color: #333; 
            text-transform: capitalize;
        }
        .calendar-header { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin-bottom: 8px; 
        }
        .calendar-header div { 
            font-weight: 600; 
            text-align: center; 
            color: #666; 
            font-size: 14px; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
        }
        .day-empty { background: #f0f0f0; }
        .day-padding { 
            background: #f9f9f9; 
            opacity: 0.8; 
        } 
        .day-workout { background: #10b981; color: white; font-weight: bold; }
        .day-today { box-shadow: 0 0 0 2px #3b82f6; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .hide { display: none; }
        canvas { max-width: 100%; height: 250px !important; }
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    <script>
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null; 

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:", e);
                exercises = [];
                workouts = [];
                routines = [];
            }
            render();
        }

        function save() {
            try {
                localStorage.setItem('workout-exercises', JSON.stringify(exercises));
                localStorage.setItem('workout-logs', JSON.stringify(workouts));
                localStorage.setItem('workout-routines', JSON.stringify(routines)); 
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage:", e);
            }
        }
        
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `workout_tracker_data_${date}.json`;
            
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        }

        function importData() {
            if (!confirm('–í–Ω–∏–º–∞–Ω–∏–µ! –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –í–°–ï —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã). –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.exercises || !importedData.workouts || !importedData.routines) {
                            throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö. –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å exercises, workouts –∏ routines.");
                        }
                        
                        exercises = importedData.exercises;
                        workouts = importedData.workouts;
                        routines = importedData.routines;

                        save();
                        alert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                        go('home'); 
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message);
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }


        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines, 
                editRoutine: renderEditRoutine, 
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail, 
                editExercise: renderEditExercise,
                workoutDetails: renderWorkoutDetails
            };
            document.getElementById('view').innerHTML = views[currentView]();
            window.scrollTo(0, 0); 
        }

        function go(view) {
            currentView = view;
            if (view === 'calendar' || view === 'home') {
                 currentViewDate = new Date();
                 selectedDate = new Date().toISOString().split('T')[0]; 
            }
            if (currentView !== 'editExercise') {
                selectedExIdEdit = null;
            }
            if (currentView !== 'editRoutine') {
                selectedRoutineIdEdit = null;
            }
            render();
        }
        
        function changeMonth(offset) {
            currentViewDate.setDate(1); 
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            render(); 
        }

        function viewHomeExDetail(exId) {
            selExIdHome = exId;
            go('homeExDetail');
        }

        function editEx(id) {
            selectedExIdEdit = id;
            go('editExercise');
        }

        function editRoutine(id) { 
            selectedRoutineIdEdit = id;
            go('editRoutine');
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–∞—Ç–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        function viewDetail(dateStr) {
            selectedDate = dateStr;
            go('detail');
        }

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(12, 0, 0, 0); 
            return monday.toISOString().split('T')[0];
        }

        function getWeeklyStreak() {
            if (!workouts.length) return 0;
            const uniqueWeekIds = new Set(workouts.map(w => getMonday(w.date)));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            let currentMonday = new Date(getMonday(curr));
            
            while (true) {
                const id = currentMonday.toISOString().split('T')[0];
                if (uniqueWeekIds.has(id)) {
                    streak++;
                    currentMonday.setDate(currentMonday.getDate() - 7);
                } else {
                    break;
                }
                if (streak > 260) break; 
            }
            return streak;
        }

        function getStreak() {
            if (!workouts.length) return 0;
            const dates = new Set(workouts.map(w => w.date));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 

            for (let i = 0; i < 365; i++) {
                const ds = curr.toISOString().split('T')[0];
                const isToday = i === 0 && dates.has(ds);
                const isYesterday = i > 0 && dates.has(ds);

                if (isToday || isYesterday) {
                    streak++;
                    curr.setDate(curr.getDate() - 1);
                } else if (i === 0) {
                    curr.setDate(curr.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }

        function calculateSetVolume(set, type) {
            const reps = parseFloat(set.reps || 0);
            if (type === 'weight') {
                const weight = parseFloat(set.weight || 0);
                return weight * reps; 
            } else if (type === 'distance' || type === 'time' || type === 'reps') {
                return reps; 
            }
            return 0;
        }

        function calculateWorkoutVolume(workout) {
            let totalVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                
                ex.sets.forEach(set => {
                    // –î–ª—è —Å–∏–ª–æ–≤—ã—Ö —ç—Ç–æ –í–µ—Å*–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è, –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è/–î–∏—Å—Ç–∞–Ω—Ü–∏—è/–í—Ä–µ–º—è.
                    totalVolume += calculateSetVolume(set, type); 
                });
            });
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ —á–∏—Å–ª–æ - –¥–ª—è –≤–µ—Å–æ–≤—ã—Ö —ç—Ç–æ —Ç–æ–Ω–Ω–∞–∂ (–∫–≥), –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - –æ–±—â–∞—è —Å—É–º–º–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π/–∫–º/–º–∏–Ω.
            return Math.round(totalVolume); 
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ renderDetail –∏ renderHomeExerciseDetail –¥–ª—è –º–µ—Ç–∫–∏ "üî• PR"
        function getMaxSetVolume(exerciseId) {
            let maxVolume = 0;
            workouts.forEach(w => {
                const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                if (ex) {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';

                    ex.sets.forEach(set => {
                        const volume = calculateSetVolume(set, type);
                        if (volume > maxVolume + 0.001) { 
                            maxVolume = volume;
                        }
                    });
                }
            });
            return maxVolume;
        }
        
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ PR –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        function getExerciseRecords(exerciseId) {
            const baseEx = exercises.find(e => e.id === exerciseId);
            const type = baseEx ? baseEx.type : 'reps';
            
            let maxVolumeSet = { value: 0, set: null, date: null, displayValue: '' }; 
            let maxWorkoutVolume = { value: 0, date: null, displayValue: '', title: '' }; 
            let maxWeight = { value: 0, set: null, date: null, displayValue: '' }; 

            workouts.forEach(w => {
                const exInWo = w.exercises.find(e => e.exerciseId === exerciseId);
                if (exInWo) {
                    exInWo.sets.forEach(set => {
                        const volume = calculateSetVolume(set, type);
                        
                        // 1. Max Volume Set (Max Effective PR)
                        if (volume > maxVolumeSet.value + 0.001) {
                            maxVolumeSet = { 
                                value: volume, 
                                set: set, 
                                date: w.date,
                                displayValue: (type === 'weight' ? `${set.weight || 0} –∫–≥ √ó ${set.reps || 0} –ø–æ–≤—Ç` : (type === 'distance' ? `${(set.reps || 0).toFixed(1)} –∫–º` : `${set.reps || 0} ${type === 'time' ? '–º–∏–Ω' : '–ø–æ–≤—Ç'}`))
                            };
                        }
                        
                        // 3. Max Weight (Max Weight PR) - –¢–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Å–æ–≤—ã—Ö
                        if (type === 'weight') {
                            const weight = parseFloat(set.weight || 0);
                            if (weight > maxWeight.value + 0.001) {
                                maxWeight = {
                                    value: weight,
                                    set: set, 
                                    date: w.date,
                                    displayValue: `${weight} –∫–≥ √ó ${set.reps} –ø–æ–≤—Ç`
                                };
                            }
                        }
                    });
                    
                    // 2. Max Total Reps/Distance/Time in a single Workout (Total Volume PR)
                    let actualWorkoutVolume = exInWo.sets.reduce((s, set) => s + (set.reps || 0), 0);
                    if (type === 'weight') {
                        actualWorkoutVolume = calculateWorkoutVolume({exercises: [exInWo]}); // Use full volume for weight
                    }

                    if (actualWorkoutVolume > maxWorkoutVolume.value + 0.001) {
                        maxWorkoutVolume = {
                            value: actualWorkoutVolume,
                            date: w.date
                        };
                    }
                }
            });
            
            // Finalize display value for Max Workout Volume (Total Volume PR)
            let totalVolUs = '';
            let totalVolType = '';
            if (type === 'weight') { 
                totalVolUs = '–µ–¥. –æ–±—ä–µ–º–∞'; 
                totalVolType = '–û–±—ä–µ–º';
            } else if (type === 'distance') { 
                totalVolUs = '–∫–º'; 
                totalVolType = '–î–∏—Å—Ç–∞–Ω—Ü–∏—è';
            } else if (type === 'time') { 
                totalVolUs = '–º–∏–Ω'; 
                totalVolType = '–í—Ä–µ–º—è';
            } else { 
                totalVolUs = '–ø–æ–≤—Ç'; 
                totalVolType = '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π';
            }
            maxWorkoutVolume.displayValue = (type === 'distance' ? maxWorkoutVolume.value.toFixed(1) : Math.round(maxWorkoutVolume.value)) + ' ' + totalVolUs;
            maxWorkoutVolume.title = `–ú–∞–∫—Å. ${totalVolType} –∑–∞ —Ç—Ä–µ–Ω.`;
            
            return { maxVolumeSet, maxWorkoutVolume, maxWeight };
        }
        
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ù–∞—Ö–æ–¥–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        function getMaxWorkoutVolume() {
            if (!workouts.length) return { volume: 0, date: null };
            let maxVolume = 0;
            let maxDate = null;

            workouts.forEach(w => {
                const vol = calculateWorkoutVolume(w);
                if (vol > maxVolume) {
                    maxVolume = vol;
                    maxDate = w.date;
                }
            });

            return { volume: Math.round(maxVolume), date: maxDate };
        }


        function renderHome() {
            const dayStreak = getStreak();
            const weekStreak = getWeeklyStreak(); 
            const todayDateStr = new Date().toISOString().split('T')[0]; 
            const today = workouts.find(w => w.date === todayDateStr); 
            let h = `
                <div class="header-card">
                    <h1 style="font-size: 24px; margin-bottom: 8px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <p>–°—Ç—Ä–∏–∫</p>
                            <p>(–î–Ω–∏) üî•</p>
                            <p>${dayStreak}</p>
                        </div>
                        <div class="stat-item">
                            <p>–°—Ç—Ä–∏–∫</p>
                            <p>(–ù–µ–¥–µ–ª–∏) üóìÔ∏è</p>
                            <p>${weekStreak}</p>
                        </div>
                        <div class="stat-item">
                            <p>–í—Å–µ–≥–æ</p>
                            <p>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                            <p>${workouts.length}</p>
                        </div>
                    </div>
                </div>
                <div class="btn-grid">
                    <button class="btn btn-green" onclick="go('newWorkout')"><span style="font-size: 32px;">‚ûï</span><span>–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span></button>
                    <button class="btn btn-orange" onclick="go('exercises')"><span style="font-size: 32px;">üèãÔ∏è</span><span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span></button>
                    <button class="btn btn-purple" onclick="go('routines')"><span style="font-size: 32px;">üìã</span><span>–®–∞–±–ª–æ–Ω—ã</span></button>
                    <button class="btn btn-blue" onclick="go('calendar')"><span style="font-size: 32px;">üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
                </div>
                <button class="btn btn-purple" onclick="go('stats')" style="width: 100%; margin-top: 12px; background: #8b5cf6;">
                    <span style="font-size: 20px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                </button>
                <button class="btn btn-blue" onclick="go('settings')" style="width: 100%; margin-top: 12px; background: #6b7280; margin-bottom: 16px;">
                    <span style="font-size: 20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </button>
            `;
            if (today) {
                h += `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">–°–µ–≥–æ–¥–Ω—è—à–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
                        <button onclick="editToday()" class="save-btn" style="background: #3b82f6; box-shadow: none; padding: 8px 12px; font-size: 16px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>`;
                today.exercises.forEach(ex => {
                    const e = exercises.find(e => e.id === ex.exerciseId);
                    const t = e ? e.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                    let d = '';
                    if (t === 'weight') {
                        const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                        d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥`;
                    } else if (t === 'distance') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps.toFixed(1)} –∫–º`;
                    else if (t === 'time') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(totalReps)} –º–∏–Ω`;
                    else d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;
                    
                    h += `<div style="padding: 12px 0; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="viewHomeExDetail('${ex.exerciseId}')">
                        <div>
                            <div style="font-weight: 600;">${ex.exerciseName}</div>
                            <div style="color: #666; font-size: 14px;">${d}</div>
                        </div>
                        <span style="font-size: 24px; color: #bbb;">‚Ä∫</span>
                    </div>`;
                });
                h += '</div>';
            }
            return h;
        }

        function renderHomeExerciseDetail() {
            if (!selExIdHome) return go('home'); 
            const todayDate = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDate);
            if (!wo) { selExIdHome = null; return go('home'); } 
            const ex = wo.exercises.find(e => e.exerciseId === selExIdHome);
            if (!ex) { selExIdHome = null; return go('home'); } 
            const eBase = exercises.find(e => e.id === ex.exerciseId);
            const t = eBase ? eBase.type : 'reps';
            
            const maxVol = getMaxSetVolume(ex.exerciseId);

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.exerciseName}</h2>
                        <div style="width: 36px;"></div>
                     </div>`;
            h += `<div class="card">`;
            ex.sets.forEach(set => {
                const setVol = calculateSetVolume(set, t);
                const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01); 
                const prLabel = isPR ? ' <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>' : '';

                h += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 4px; border-bottom: 1px solid #eee;">
                    <span style="font-weight: 600; color: #555;">–ü–æ–¥—Ö–æ–¥ ${set.setNumber}</span>
                    <span style="color: #000; font-size: 16px; font-weight: 500;">`;
                if (t === 'weight') h += `${set.weight || 0} –∫–≥ √ó ${set.reps || 0} –ø–æ–≤—Ç${prLabel}`;
                else if (t === 'distance') h += `${(set.reps || 0).toFixed(1)} –∫–º${prLabel}`;
                else if (t === 'time') h += `${set.reps || 0} –º–∏–Ω${prLabel}`;
                else h += `${set.reps || 0} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π${prLabel}`;
                h += `</span></div>`;
            });
            let sum = '';
            if (t === 'weight') {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥ –æ–±—â–∏–π`;
            } else if (t === 'distance') {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr.toFixed(1)} –∫–º –≤—Å–µ–≥–æ`;
            } else if (t === 'time') {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(tr)} –º–∏–Ω –≤—Å–µ–≥–æ`;
            } else {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;
            }
            h += `<div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #ddd; color: #333; font-weight: 600; text-align: right; font-size: 14px;">–í—Å–µ–≥–æ: ${sum}</div></div>`;
            return h;
        }

        function renderCalendar() {
            const workoutDates = new Set(workouts.map(w => w.date));
            const todayStr = new Date().toISOString().split('T')[0];
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth(); 
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startDayOfWeek = firstDayOfMonth.getDay(); 
            if (startDayOfWeek === 0) startDayOfWeek = 7; 
            const paddingDays = startDayOfWeek - 1; 
            const monthName = currentViewDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
                        <div style="width: 36px;"></div>
                     </div>
                     <div class="card">
                        <div class="month-nav">
                            <button onclick="changeMonth(-1)">‚Äπ –ü—Ä–µ–¥.</button>
                            <h3>${monthName}</h3>
                            <button onclick="changeMonth(1)">–°–ª–µ–¥. ‚Ä∫</button>
                        </div>
                        <div class="calendar-header">
                            <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
                        </div>
                        <div class="calendar-grid">`;
            for (let i = 0; i < paddingDays; i++) {
                h += `<div class="calendar-day day-padding"></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(year, month, day, 12); 
                const ds = d.toISOString().split('T')[0];
                const hasWorkout = workoutDates.has(ds);
                const isToday = (ds === todayStr);
                let classes = 'calendar-day';
                if (hasWorkout) classes += ' day-workout';
                else classes += ' day-empty';
                if (isToday) classes += ' day-today';
                
                const action = hasWorkout ? `onclick="viewDetail('${ds}')"` : 'disabled';
                
                h += `<button class="${classes}" ${action}>${day}</button>`;
            }
            h += '</div></div>';
            return h;
        }

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) return go('calendar');

            const totalVolume = calculateWorkoutVolume(wo);

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('calendar')">‚Üê</button>
                        <h2>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${new Date(selectedDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}</h2>
                        <button onclick="editWorkout('${selectedDate}')" class="save-btn" style="background: #3b82f6; box-shadow: none; padding: 8px 12px; font-size: 16px;">‚úèÔ∏è</button>
                     </div>
                     <div class="card header-card" style="background: #3b82f6;">
                        <h3 style="margin-bottom: 8px; font-size: 18px;">–û–±—ä–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:</h3>
                        <p style="font-size: 32px; font-weight: bold;">${totalVolume} –µ–¥. –æ–±—ä–µ–º–∞</p>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>`;
            
            wo.exercises.forEach(ex => {
                const eBase = exercises.find(e => e.id === ex.exerciseId);
                const t = eBase ? eBase.type : 'reps';
                const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                let d = '';
                if (t === 'weight') {
                    const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                    d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥`;
                } else if (t === 'distance') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps.toFixed(1)} –∫–º`;
                else if (t === 'time') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(totalReps)} –º–∏–Ω`;
                else d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;

                let setsHTML = '';
                const maxVol = getMaxSetVolume(ex.exerciseId); 
                
                ex.sets.forEach(set => {
                    const setVol = calculateSetVolume(set, t);
                    const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01); 
                    const prLabel = isPR ? ' <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>' : '';
                    
                    setsHTML += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 4px; border-bottom: 1px solid #eee;">
                        <span style="font-weight: 600; color: #555;">–ü–æ–¥—Ö–æ–¥ ${set.setNumber}</span>
                        <span style="color: #000; font-size: 16px; font-weight: 500;">`;
                    if (t === 'weight') setsHTML += `${set.weight || 0} –∫–≥ √ó ${set.reps || 0} –ø–æ–≤—Ç${prLabel}`;
                    else if (t === 'distance') setsHTML += `${(set.reps || 0).toFixed(1)} –∫–º${prLabel}`;
                    else if (t === 'time') setsHTML += `${set.reps || 0} –º–∏–Ω${prLabel}`;
                    else setsHTML += `${set.reps || 0} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π${prLabel}`;
                    setsHTML += `</span></div>`;
                });

                h += `<div style="padding: 12px 0; border-bottom: 2px solid #ddd; margin-bottom: 16px;" onclick="toggleVisibility('exDetail${ex.exerciseId}')">
                        <div style="font-weight: 600; font-size: 18px; display: flex; justify-content: space-between;">
                            ${ex.exerciseName}
                            <span style="color: #666; font-size: 16px;">${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤</span>
                        </div>
                        <div style="color: #666; font-size: 14px; margin-top: 4px; margin-bottom: 8px;">${d}</div>
                        <div id="exDetail${ex.exerciseId}" class="hide">
                            ${setsHTML}
                        </div>
                    </div>`;
            });
            h += '</div>';
            return h;
        }

        // –ó–ê–ú–ï–ù–ê –§–£–ù–ö–¶–ò–ò: –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å PR
        function renderStats() {
            const maxWorkoutVol = getMaxWorkoutVolume();
            const workoutData = workouts.map(w => ({
                date: new Date(w.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }),
                volume: calculateWorkoutVolume(w)
            })).sort((a, b) => new Date(workouts.find(w => new Date(w.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }) === a.date).date) - new Date(workouts.find(w => new Date(w.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }) === b.date).date));
            
            // Group by month
            const monthlyData = {};
            workouts.forEach(w => {
                const date = new Date(w.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { volume: 0, label: date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' }) };
                }
                monthlyData[monthKey].volume += calculateWorkoutVolume(w);
            });
            const monthlyWorkoutData = Object.values(monthlyData);
            
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div style="width: 36px;"></div>
                     </div>`;
            
            // 1. Overall Stats Card
            h += `<div class="card header-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h3 style="font-size: 20px; margin-bottom: 12px;">–û–±—â–∞—è —Å–≤–æ–¥–∫–∞</h3>
                    <div class="stat-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="stat-item">
                            <p>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                            <p>${workouts.length}</p>
                        </div>
                        <div class="stat-item">
                            <p>–ú–∞–∫—Å. –û–±—ä–µ–º —Ç—Ä–µ–Ω. üî•</p>
                            <p style="font-size: 16px;">${maxWorkoutVol.volume} –µ–¥.</p>
                            <p style="font-size: 10px; opacity: 0.8; margin-top: 2px;">${maxWorkoutVol.date ? new Date(maxWorkoutVol.date).toLocaleDateString('ru-RU') : ''}</p>
                        </div>
                    </div>
                </div>`;

            // 2. Exercise List with PRs (NEW)
            h += `<div class="card">
                    <h3 style="margin-bottom: 16px; color: #8b5cf6;">–†–µ–∫–æ—Ä–¥—ã –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º</h3>`;
            
            if (exercises.length === 0) {
                h += `<div class="empty-state" style="padding: 20px 0;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</div>`;
            } else {
                exercises.forEach(ex => {
                    const records = getExerciseRecords(ex.id);
                    const bestSet = records.maxVolumeSet;

                    let prInfo = `‚Äî`;
                    if (bestSet.value > 0) {
                        let prValue = ex.type === 'distance' ? bestSet.value.toFixed(1) : Math.round(bestSet.value);
                        let unit = ex.type === 'weight' ? '–∫–≥' : (ex.type === 'distance' ? '–∫–º' : (ex.type === 'time' ? '–º–∏–Ω' : '–ø–æ–≤—Ç'));
                        
                        if (ex.type === 'weight') {
                            prInfo = `${bestSet.set.weight || 0} –∫–≥ x ${bestSet.set.reps || 0} –ø–æ–≤—Ç`;
                        } else {
                            prInfo = `${prValue} ${unit}`;
                        }

                        prInfo += bestSet.date ? `<span style="font-size: 11px; color: #666; margin-left: 8px;">(${new Date(bestSet.date).toLocaleDateString('ru-RU')})</span>` : '';
                    }

                    h += `<div class="exercise-item" onclick="viewExStats('${ex.id}')">
                            <div>
                                <div style="font-weight: 600;">${ex.name}</div>
                                <div style="color: #f59e0b; font-size: 14px; font-weight: 600;">PR –ø–æ–¥—Ö–æ–¥–∞: ${prInfo}</div>
                            </div>
                            <span style="font-size: 24px; color: #bbb;">‚Ä∫</span>
                        </div>`;
                });
            }
            h += `</div>`;

            // 3. Chart - Volume Over Time (Monthly)
            h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–û–±—ä–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
                    <canvas id="monthlyVolumeChart"></canvas>
                </div>`;
            
            // 4. Exercise Chart - Volume Over Time (All exercises combined)
            h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–û–±—ä–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ –¥–∞—Ç–∞–º</h3>
                    <canvas id="workoutVolumeChart"></canvas>
                </div>`;

            h += renderSettingsFooter('v2.5.1 (–ü–æ–ª–Ω–∞—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)');
            
            setTimeout(() => {
                if (workoutData.length > 0) {
                    drawChart('workoutVolumeChart', workoutData.map(d=>d.volume), workoutData.map(d=>d.date), 'line', '#3b82f6', '–µ–¥. –æ–±—ä–µ–º–∞');
                }
                if (monthlyWorkoutData.length > 0) {
                    drawChart('monthlyVolumeChart', monthlyWorkoutData.map(d=>d.volume), monthlyWorkoutData.map(d=>d.label), 'bar', '#059669', '–µ–¥. –æ–±—ä–µ–º–∞');
                }
            }, 100);
            
            return h;
        }

        // –ó–ê–ú–ï–ù–ê –§–£–ù–ö–¶–ò–ò: –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é —Å PR
        function renderExerciseStats() {
            if (!selExId) return '';
            const ex = exercises.find(e => e.id === selExId);
            if (!ex) return '';
            const exWo = workouts.filter(w => w.exercises.some(e => e.exerciseId === ex.id));
            const records = getExerciseRecords(ex.id);
            
            let ts = 0, tr = 0, tw = 0;
            exWo.forEach(w => {
                const e = w.exercises.find(e => e.exerciseId === ex.id);
                if (e) {
                    ts += e.sets.length;
                    e.sets.forEach(s => {
                        const reps = s.reps || 0;
                        const weight = s.weight || 0;
                        tr += reps;
                        if (ex.type === 'weight') {
                            tw += weight * reps;
                        }
                    });
                }
            });
            
            let ul = '', us = '';
            if (ex.type === 'distance') { ul = '–ö–∏–ª–æ–º–µ—Ç—Ä—ã'; us = '–∫–º'; } 
            else if (ex.type === 'time') { ul = '–ú–∏–Ω—É—Ç—ã'; us = '–º–∏–Ω'; } 
            else if (ex.type === 'weight') { ul = '–û–±—ä–µ–º (–∫–≥)'; us = '–∫–≥'; }
            else { ul = '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'; us = '–ø–æ–≤—Ç'; }

            let h = `<div class="top-bar"><button class="back-btn" onclick="go('stats')">‚Üê</button> 
                     <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${ex.name}</h2>
                     <div style="width: 36px;"></div></div> 
                     <div class="header-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                         <h3 style="margin-bottom: 16px; font-size: 18px;">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                         <div class="stat-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                             <div class="stat-item">
                                 <p>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                                 <p>${exWo.length}</p>
                             </div>
                             <div class="stat-item">
                                 <p>–í—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–æ–≤</p>
                                 <p>${ts}</p>
                             </div>
                             <div class="stat-item">
                                 <p>–°—É–º–º–∞—Ä–Ω—ã–µ ${ul.split(' ')[0]}</p>
                                 <p style="font-size: 16px;">${ex.type === 'weight' ? Math.round(tw) : (ex.type === 'distance' ? tr.toFixed(1) : Math.round(tr))} ${us}</p>
                             </div>
                         </div>
                     </div>`;

            // NEW: Personal Records Card
            if (exWo.length > 0) {
                h += `<div class="card">
                        <h3 style="margin-bottom: 16px; color: #f59e0b;">üèÜ –õ–∏—á–Ω—ã–µ –†–µ–∫–æ—Ä–¥—ã (PR)</h3>`;
                
                // 1. Max Volume Set
                const bestSet = records.maxVolumeSet;
                if (bestSet.value > 0) {
                    h += `<div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="font-weight: 600; color: #333;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç. –ø–æ–¥—Ö–æ–¥</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                <span style="font-size: 16px; color: #000;">${bestSet.displayValue}</span>
                                <span style="font-size: 12px; color: #666;">${new Date(bestSet.date).toLocaleDateString('ru-RU')}</span>
                            </div>
                        </div>`;
                }

                // 2. Max Workout Volume
                const maxWoVol = records.maxWorkoutVolume;
                if (maxWoVol.value > 0) {
                    h += `<div style="padding: 8px 0; border-bottom: ${ex.type === 'weight' ? '1px solid #eee' : 'none'};">
                            <div style="font-weight: 600; color: #333;">${maxWoVol.title}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                <span style="font-size: 16px; color: #000;">${maxWoVol.displayValue}</span>
                                <span style="font-size: 12px; color: #666;">${new Date(maxWoVol.date).toLocaleDateString('ru-RU')}</span>
                            </div>
                        </div>`;
                }

                // 3. Max Weight (for weight exercises only)
                if (ex.type === 'weight' && records.maxWeight.value > 0) {
                    const maxW = records.maxWeight;
                     h += `<div style="padding: 8px 0;">
                            <div style="font-weight: 600; color: #333;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å –∑–∞ –ø–æ–¥—Ö–æ–¥</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                <span style="font-size: 16px; color: #000;">${maxW.value} –∫–≥ (${maxW.set.reps} –ø–æ–≤—Ç)</span>
                                <span style="font-size: 12px; color: #666;">${new Date(maxW.date).toLocaleDateString('ru-RU')}</span>
                            </div>
                        </div>`;
                }
                
                h += `</div>`;
            }

            // Chart - Volume by Date (Last 30 days)
            const dateData = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                const wo = workouts.find(w => w.date === ds);
                let volume = 0;
                if (wo) {
                    const e = wo.exercises.find(e => e.exerciseId === ex.id);
                    if (e) {
                        volume = calculateWorkoutVolume({exercises: [e]});
                    }
                }
                dateData.push({ 
                    day: d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }), 
                    volume: Math.round(volume)
                });
            }
            
            h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–û–±—ä–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</h3>
                    <canvas id="exVolumeChart"></canvas>
                 </div>`;

            // Chart - Volume by Month (Last 12 months)
            const monthlyData = [];
            for (let i = 11; i >= 0; i--) {
                const md = new Date();
                md.setMonth(md.getMonth() - i);
                md.setDate(1); 
                const ms = md;
                const me = new Date(md.getFullYear(), md.getMonth() + 1, 0); 
                let volume = 0;
                
                workouts.forEach(w => {
                    const d = new Date(w.date);
                    if (d >= ms && d <= me) {
                        const e = w.exercises.find(e => e.exerciseId === ex.id);
                        if (e) {
                            volume += calculateWorkoutVolume({exercises: [e]});
                        }
                    }
                });
                
                monthlyData.push({ 
                    month: md.toLocaleDateString('ru-RU', { month: 'short' }), 
                    volume: Math.round(volume)
                });
            }
            
            h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–û–±—ä–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤</h3>
                    <canvas id="exMonthlyVolumeChart"></canvas>
                 </div>`;
                 
            setTimeout(() => { 
                // –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
                const chartLabel = ex.type === 'weight' ? '–∫–≥' : (ex.type === 'distance' ? '–∫–º' : (ex.type === 'time' ? '–º–∏–Ω' : '–ø–æ–≤—Ç'));
                drawChart('exVolumeChart', dateData.map(d=>d.volume), dateData.map(d=>d.day), 'line', '#3b82f6', chartLabel);
                drawChart('exMonthlyVolumeChart', monthlyData.map(d=>d.volume), monthlyData.map(d=>d.month), 'bar', '#1d4ed8', chartLabel);
            }, 100);
            
            return h;
        }

        // --- –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (drawChart, renderExercises, renderRoutines –∏ —Ç.–¥.) ---

        function drawChart(id, data, labels, type, color, unitLabel) {
            const ctx = document.getElementById(id);
            if (!ctx) return; 

            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–û–±—ä–µ–º',
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 2,
                        fill: type === 'line' ? 'start' : false,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: unitLabel || '–ï–¥. –û–±—ä–µ–º'
                            }
                        },
                        x: { 
                            grid: { display: false } 
                        }
                    }
                }
            });
        }
        
        function viewExStats(exId) {
            selExId = exId;
            go('exerciseStats');
        }

        function renderExercises() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2>
                        <div style="width: 36px;"></div>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                        <input type="text" id="newEx" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" style="margin-bottom: 8px;">
                        <select id="exType" style="margin-bottom: 12px;">
                            <option value="reps">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ–µ)</option>
                            <option value="weight">–í–µ—Å (–∫–≥) + –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                            <option value="distance">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</option>
                            <option value="time">–í—Ä–µ–º—è (–º–∏–Ω)</option>
                        </select>
                        <button class="btn btn-green" style="width: 100%; padding: 12px;" onclick="addEx()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (${exercises.length})</h3>`;
            if (exercises.length === 0) {
                h += `<div class="empty-state" style="padding: 20px 0;">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</div>`;
            } else {
                exercises.forEach(ex => {
                    let typeLabel = '';
                    if (ex.type === 'weight') typeLabel = '–í–µ—Å/–ü–æ–≤—Ç';
                    else if (ex.type === 'distance') typeLabel = '–î–∏—Å—Ç–∞–Ω—Ü–∏—è';
                    else if (ex.type === 'time') typeLabel = '–í—Ä–µ–º—è';
                    else typeLabel = '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è';

                    h += `<div class="exercise-item" onclick="editEx('${ex.id}')">
                            <div style="font-weight: 600;">${ex.name}</div>
                            <div style="color: #666; font-size: 14px;">${typeLabel}</div>
                        </div>`;
                });
            }
            h += `</div>`;
            return h;
        }

        function renderEditExercise() {
            if (!selectedExIdEdit) return go('exercises');
            const ex = exercises.find(e => e.id === selectedExIdEdit);
            if (!ex) return go('exercises');

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('exercises')">‚Üê</button>
                        <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${ex.name}</h2>
                        <button class="save-btn" onclick="saveEditEx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
                        <input type="text" id="editExName" value="${ex.name}" style="margin-bottom: 16px;">
                        
                        <h3 style="margin-bottom: 12px;">–¢–∏–ø –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
                        <select id="editExType" style="margin-bottom: 20px;">
                            <option value="reps" ${ex.type === 'reps' ? 'selected' : ''}>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ–µ)</option>
                            <option value="weight" ${ex.type === 'weight' ? 'selected' : ''}>–í–µ—Å (–∫–≥) + –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</option>
                            <option value="distance" ${ex.type === 'distance' ? 'selected' : ''}>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</option>
                            <option value="time" ${ex.type === 'time' ? 'selected' : ''}>–í—Ä–µ–º—è (–º–∏–Ω)</option>
                        </select>
                        <button class="btn btn-green" style="width: 100%; padding: 12px; background: #ef4444;" onclick="delEx('${ex.id}', true)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                     </div>`;
            return h;
        }

        function saveEditEx() {
            if (!selectedExIdEdit) return;
            const exIndex = exercises.findIndex(e => e.id === selectedExIdEdit);
            if (exIndex === -1) return;
            const newName = document.getElementById('editExName').value.trim();
            const newType = document.getElementById('editExType').value;
            if (!newName) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }
            exercises[exIndex] = { ...exercises[exIndex], name: newName, type: newType };
            workouts.forEach(wo => {
                wo.exercises.forEach(woEx => {
                    if (woEx.exerciseId === selectedExIdEdit) {
                        woEx.exerciseName = newName;
                    }
                });
            });
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ —à–∞–±–ª–æ–Ω–∞—Ö
            routines.forEach(rt => {
                rt.exercises.forEach(rtEx => {
                    if (rtEx.exerciseId === selectedExIdEdit) {
                        rtEx.exerciseName = newName;
                    }
                });
            });
            save();
            selectedExIdEdit = null;
            alert('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            go('exercises');
        }

        function delEx(id, isEditView = false) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –µ–≥–æ –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —à–∞–±–ª–æ–Ω–æ–≤!')) {
                exercises = exercises.filter(e => e.id !== id);
                workouts = workouts.map(wo => ({ ...wo, exercises: wo.exercises.filter(ex => ex.exerciseId !== id) })).filter(wo => wo.exercises.length > 0);
                routines = routines.map(rt => ({ ...rt, exercises: rt.exercises.filter(ex => ex.exerciseId !== id) })).filter(rt => rt.exercises.length > 0); 
                // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤
                save();
                if (isEditView) {
                    selectedExIdEdit = null;
                    go('exercises');
                } else {
                    render();
                }
            }
        }

        function addEx() {
            const inp = document.getElementById('newEx');
            const typ = document.getElementById('exType');
            if (inp.value.trim()) {
                exercises.push({
                    id: Date.now().toString(),
                    name: inp.value.trim(),
                    type: typ.value,
                    createdAt: new Date().toISOString()
                });
                save();
                render();
            }
        }

        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –®–ê–ë–õ–û–ù–û–í ---
        function renderRoutines() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–®–∞–±–ª–æ–Ω—ã (Routines)</h2>
                        <div style="width: 36px;"></div>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω</h3>
                        <input type="text" id="newRoutineName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–∞–ø—Ä. –ü–ª–µ—á–∏)" style="margin-bottom: 12px;">
                        <button class="btn btn-green" style="width: 100%; padding: 12px;" onclick="addRoutine()">‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–°–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤ (${routines.length})</h3>`;
            if (routines.length === 0) {
                h += `<div class="empty-state" style="padding: 20px 0;">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤.</div>`;
            } else {
                routines.forEach(rt => {
                    h += `<div class="exercise-item" onclick="editRoutine('${rt.id}')">
                            <div style="font-weight: 600;">${rt.name}</div>
                            <div style="color: #666; font-size: 14px;">${rt.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>
                        </div>`;
                });
            }
            h += `</div>`;
            h += renderSettingsFooter();
            return h;
        }

        function addRoutine() {
            const nameInput = document.getElementById('newRoutineName');
            const name = nameInput.value.trim();
            if (name) {
                const newRoutine = {
                    id: Date.now().toString(),
                    name: name,
                    exercises: [] 
                };
                routines.push(newRoutine);
                save();
                selectedRoutineIdEdit = newRoutine.id;
                go('editRoutine'); 
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞.');
            }
        }

        function renderEditRoutine() {
            if (!selectedRoutineIdEdit) return go('routines');
            const rt = routines.find(r => r.id === selectedRoutineIdEdit);
            if (!rt) return go('routines');
            // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ –≤ currentWorkout –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (currentView !== 'editRoutine') {
                currentWorkout = JSON.parse(JSON.stringify(rt.exercises)); 
            }

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="cancelRoutineEdit()">‚Üê</button>
                        <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ${rt.name}</h2>
                        <button class="save-btn" onclick="saveRoutine()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
                        <input type="text" id="editRoutineName" value="${rt.name}" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–µ</h3>
                        <div id="routineExerciseList">`;
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"</div>`;
            } else {
                currentWorkout.forEach(ex => {
                    h += `<div class="exercise-item">
                            <div style="font-weight: 600;">${ex.exerciseName}</div>
                            <button class="delete-btn" onclick="removeExFromRoutine('${ex.exerciseId}')">üóëÔ∏è</button>
                        </div>`;
                });
            }
            h += `</div>
                        <button class="btn btn-blue" style="width: 100%; padding: 12px; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.remove('hide')">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                        <button class="btn btn-orange" style="width: 100%; padding: 12px; margin-top: 12px; background: #ef4444;" onclick="delRoutine('${rt.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
                     </div>`;

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 400px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); padding-bottom: 8px;">
                        <h3 style="margin-bottom: 12px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                        <div style="max-height: 200px; overflow-y: scroll; border: 1px solid #ddd; border-radius: 8px; padding: 8px;">`;
            
            if (exercises.length === 0) {
                h += `<div class="empty-state" style="padding: 10px 0;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div>`;
            } else {
                exercises.forEach(ex => {
                    const isInRoutine = currentWorkout.some(wEx => wEx.exerciseId === ex.id);
                    h += `<button class="btn" style="width: 100%; padding: 10px; margin-bottom: 8px; font-weight: 500; background: ${isInRoutine ? '#ccc' : '#f0f0f0'}; color: ${isInRoutine ? '#666' : '#333'};" ${isInRoutine ? 'disabled' : ''} onclick="addExToRoutine('${ex.id}', '${ex.name}')">${ex.name} ${isInRoutine ? ' (–î–æ–±–∞–≤–ª–µ–Ω–æ)' : ''}</button>`;
                });
            }
            
            h += `</div>
                        <button class="btn btn-blue" style="width: 100%; padding: 12px; margin-top: 16px; background: #ef4444;" onclick="document.getElementById('addExModal').classList.add('hide')">–û—Ç–º–µ–Ω–∞</button>
                    </div>`;

            return h;
        }

        function addExToRoutine(exId, exName) {
            if (!currentWorkout.some(ex => ex.exerciseId === exId)) {
                currentWorkout.push({
                    exerciseId: exId,
                    exerciseName: exName,
                    sets: [] // –í —à–∞–±–ª–æ–Ω–µ –ø–æ–¥—Ö–æ–¥—ã –ø—É—Å—Ç—ã–µ
                });
                render(); 
            }
            document.getElementById('addExModal').classList.add('hide');
        }

        function removeExFromRoutine(exId) {
            currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
            render();
        }

        function saveRoutine() {
            if (!selectedRoutineIdEdit) return;
            const rtIndex = routines.findIndex(r => r.id === selectedRoutineIdEdit);
            if (rtIndex === -1) return;

            const newName = document.getElementById('editRoutineName').value.trim();
            if (!newName) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            routines[rtIndex] = {
                ...routines[rtIndex],
                name: newName,
                exercises: currentWorkout.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: []
                }))
            };

            save();
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            alert('‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            go('routines');
        }

        function delRoutine(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) {
                routines = routines.filter(rt => rt.id !== id);
                save();
                currentWorkout = [];
                selectedRoutineIdEdit = null;
                go('routines');
            }
        }

        function cancelRoutineEdit() {
            currentWorkout = []; 
            selectedRoutineIdEdit = null;
            go('routines');
        }

        // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –®–ê–ë–õ–û–ù–û–í ---

        function renderNewWorkout() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="cancelEdit()">‚Üê</button>
                        <h2>${workouts.some(w => w.date === selectedDate) ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–ù–æ–≤–∞—è'} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                        <button class="save-btn" onclick="saveWorkout()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–î–∞—Ç–∞</h3>
                        <input type="date" id="workoutDate" value="${selectedDate}" onchange="selectedDate = this.value; render()" style="margin-bottom: 16px;">
                        ${routines.length > 0 ? ` 
                        <h3 style="margin-bottom: 12px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω (Routine)</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                        ${routines.map(rt => ` 
                            <button class="btn btn-blue" style="padding: 8px 12px; font-size: 14px; background: #8b5cf6; flex-grow: 1; min-width: 100px;" onclick="loadRoutine('${rt.id}')"> 
                                ${rt.name} 
                            </button> 
                        `).join('')}
                        </div> 
                        ` : ''}
                        <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                        <div id="exerciseList">`;
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"</div>`;
            } else {
                currentWorkout.forEach((ex, index) => {
                    const eBase = exercises.find(e => e.id === ex.exerciseId);
                    const t = eBase ? eBase.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                    let d = '';
                    if (t === 'weight') {
                        const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                        d = ` (${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤, ${Math.round(tw)} –∫–≥)`;
                    } else if (t === 'distance') d = ` (${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤, ${totalReps.toFixed(1)} –∫–º)`;
                    else if (t === 'time') d = ` (${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤, ${Math.round(totalReps)} –º–∏–Ω)`;
                    else d = ` (${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤, ${totalReps} –ø–æ–≤—Ç)`;

                    h += `<div class="exercise-item" onclick="viewSets('${ex.exerciseId}')">
                            <div style="font-weight: 600;">${ex.exerciseName}</div>
                            <div style="color: #666; font-size: 14px;">${d}</div>
                            <button class="delete-btn" onclick="removeExFromWorkout(event, '${ex.exerciseId}')">üóëÔ∏è</button>
                        </div>`;
                });
            }
            h += `</div>
                        <button class="btn btn-blue" style="width: 100%; padding: 12px; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.remove('hide')">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                     </div>`;
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 400px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); padding-bottom: 8px;">
                        <h3 style="margin-bottom: 12px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                        <div style="max-height: 200px; overflow-y: scroll; border: 1px solid #ddd; border-radius: 8px; padding: 8px;">`;
            
            if (exercises.length === 0) {
                h += `<div class="empty-state" style="padding: 10px 0;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</div>`;
            } else {
                exercises.forEach(ex => {
                    const isInWorkout = currentWorkout.some(wEx => wEx.exerciseId === ex.id);
                    h += `<button class="btn" style="width: 100%; padding: 10px; margin-bottom: 8px; font-weight: 500; background: ${isInWorkout ? '#ccc' : '#f0f0f0'}; color: ${isInWorkout ? '#666' : '#333'};" ${isInWorkout ? 'disabled' : ''} onclick="addExToWorkout('${ex.id}', '${ex.name}')">${ex.name} ${isInWorkout ? ' (–î–æ–±–∞–≤–ª–µ–Ω–æ)' : ''}</button>`;
                });
            }
            
            h += `</div>
                        <button class="btn btn-blue" style="width: 100%; padding: 12px; margin-top: 16px; background: #ef4444;" onclick="document.getElementById('addExModal').classList.add('hide')">–û—Ç–º–µ–Ω–∞</button>
                    </div>`;

            h += renderSetsView();
            return h;
        }

        function loadRoutine(routineId) {
            if (currentWorkout.length > 0) {
                if (!confirm('–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    return;
                }
            }
            const routine = routines.find(rt => rt.id === routineId);
            if (routine) {
                currentWorkout = routine.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: []
                }));
                alert(`‚úÖ –®–∞–±–ª–æ–Ω "${routine.name}" –∑–∞–≥—Ä—É–∂–µ–Ω.`);
                render();
            }
        }

        function renderEditWorkout() {
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) return go('calendar');
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            return renderNewWorkout();
        }

        function editToday() {
            const todayDateStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDateStr);
            if (wo) {
                selectedDate = todayDateStr;
                editWorkout(todayDateStr);
            } else {
                go('newWorkout');
            }
        }

        function editWorkout(dateStr) {
            selectedDate = dateStr;
            go('editWorkout');
        }

        function cancelEdit() {
            currentWorkout = [];
            go('home');
        }

        function saveWorkout() {
            if (currentWorkout.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ.');
                return;
            }
            const validWorkout = currentWorkout.filter(ex => ex.sets.some(set => (set.reps > 0) || (set.weight > 0)) );
            if (validWorkout.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥ —Å –≤–µ—Å–æ–º –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏.');
                return;
            }
            const newWorkout = {
                date: selectedDate,
                exercises: validWorkout
            };
            const existingIndex = workouts.findIndex(w => w.date === selectedDate);
            if (existingIndex > -1) {
                workouts[existingIndex] = newWorkout;
            } else {
                workouts.push(newWorkout);
            }
            workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            save();
            currentWorkout = [];
            alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            go('home');
        }

        function addExToWorkout(exId, exName) {
            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName,
                sets: []
            });
            document.getElementById('addExModal').classList.add('hide');
            render();
        }

        function removeExFromWorkout(event, exId) {
            event.stopPropagation();
            if (confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
                render();
            }
        }

        function viewSets(exId) {
            selExId = exId;
            document.getElementById('setsView').classList.remove('hide');
            window.scrollTo(0, 0); 
        }

        function renderSetsView() {
            if (!selExId) return `<div id="setsView" class="card hide"></div>`; 

            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return `<div id="setsView" class="card hide"></div>`; 

            const ex = currentWorkout[exIndex];
            const eBase = exercises.find(e => e.id === ex.exerciseId);
            const t = eBase ? eBase.type : 'reps';
            
            const maxVol = getMaxSetVolume(ex.exerciseId);

            let setsHTML = '';
            ex.sets.forEach((set, index) => {
                const setVol = calculateSetVolume(set, t);
                const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01); 
                const prLabel = isPR ? ' <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>' : '';

                setsHTML += `<div class="set-row">
                    <span class="set-label">–ü–æ–¥—Ö–æ–¥ ${index + 1}</span>
                    `;
                if (t === 'weight') {
                    setsHTML += `<input type="number" value="${set.weight || ''}" onchange="updateSet(${index}, 'weight', this.value)" placeholder="–í–µ—Å (–∫–≥)" style="flex: 1;">
                        <input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–ü–æ–≤—Ç" style="width: 80px;">
                        <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                        ${prLabel}
                        `;
                } else if (t === 'distance') {
                    setsHTML += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–ö–º" step="0.1" style="flex: 1;">
                        <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                        ${prLabel}
                        `;
                } else if (t === 'time') {
                    setsHTML += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–ú–∏–Ω" style="flex: 1;">
                        <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                        ${prLabel}
                        `;
                } else { // reps
                    setsHTML += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π" style="flex: 1;">
                        <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                        ${prLabel}
                        `;
                }
                setsHTML += `</div>`;
            });

            const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
            let summary = '';
            if (t === 'weight') {
                const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                summary = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥ –æ–±—â–∏–π`;
            } else if (t === 'distance') summary = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps.toFixed(1)} –∫–º –≤—Å–µ–≥–æ`;
            else if (t === 'time') summary = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(totalReps)} –º–∏–Ω –≤—Å–µ–≥–æ`;
            else summary = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;


            let h = `<div id="setsView" class="card" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; z-index: 999; overflow-y: scroll;">
                        <div class="container">
                            <div class="top-bar">
                                <button class="back-btn" onclick="closeSetsView()">‚Üê</button>
                                <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.exerciseName}</h2>
                                <div style="width: 36px;"></div>
                            </div>
                            <div class="card">
                                <h3 style="margin-bottom: 12px;">–ü–æ–¥—Ö–æ–¥—ã</h3>
                                <div id="setList">${setsHTML}</div>
                                <button class="btn btn-green" style="width: 100%; padding: 12px; margin-top: 16px;" onclick="addSet()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
                                <div style="margin-top: 20px; padding-top: 16px; border-top: 2px solid #ddd; color: #333; font-weight: 600; text-align: right; font-size: 14px;">–í—Å–µ–≥–æ: ${summary}</div>
                            </div>
                        </div>
                    </div>`;
            return h;
        }

        function closeSetsView() {
            selExId = null;
            document.getElementById('setsView').classList.add('hide');
            render(); 
        }

        function updateSet(index, field, value) {
            if (!selExId) return;
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return;
            
            const numValue = parseFloat(value) || 0; 
            currentWorkout[exIndex].sets[index][field] = numValue;
            
            // Re-render sets view to update PR labels and totals
            document.getElementById('setsView').outerHTML = renderSetsView();
        }

        function addSet() {
            if (!selExId) return;
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return;

            const newSetNumber = currentWorkout[exIndex].sets.length + 1;
            
            // –ü–æ–ø—ã—Ç–∫–∞ –≤–∑—è—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
            const lastSet = currentWorkout[exIndex].sets[currentWorkout[exIndex].sets.length - 1];
            let newSet = { setNumber: newSetNumber, reps: lastSet ? lastSet.reps : 0 };
            if (lastSet && lastSet.weight !== undefined) {
                newSet.weight = lastSet.weight;
            }

            currentWorkout[exIndex].sets.push(newSet);
            
            // Re-render sets view
            document.getElementById('setsView').outerHTML = renderSetsView();
        }

        function deleteSet(index) {
            if (!selExId) return;
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === selExId);
            if (exIndex === -1) return;

            currentWorkout[exIndex].sets.splice(index, 1);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º setNumber –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            currentWorkout[exIndex].sets.forEach((set, i) => set.setNumber = i + 1);

            // Re-render sets view
            document.getElementById('setsView').outerHTML = renderSetsView();
        }

        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ù–ê–°–¢–†–û–ï–ö ---
        function renderSettings() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                        <div style="width: 36px;"></div>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                        <button onclick="exportData()" class="btn btn-blue" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #3b82f6;">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON)</button>
                        <button onclick="importData()" class="btn btn-orange" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #f59e0b;">üì§ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON)</button>
                     </div>
                     <div class="card">
                        <h3 style="margin-bottom: 12px;">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</h3>
                        <button onclick="resetWo()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
                        <button onclick="resetRoutines()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï —à–∞–±–ª–æ–Ω—ã</button>
                        <button onclick="resetEx()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                        <button onclick="resetAll()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ</button>
                     </div>`;
            h += renderSettingsFooter('v2.5.1 (–ü–æ–ª–Ω–∞—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)');
            return h;
        }

        function renderSettingsFooter(version = 'v2.5.1') {
            return `<div style="text-align: center; margin-top: 20px;">
                <p style="color: #999; font-size: 14px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ **${version}**<br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
            </div>`;
        }
        
        function resetRoutines() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —à–∞–±–ª–æ–Ω—ã?')) {
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetWo() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                workouts = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetEx() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                go('home'); 
            }
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï?')) {
                if (confirm('–¢–æ—á–Ω–æ? –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('üî• –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    go('home'); 
                }
            }
        }

        function toggleVisibility(id) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.toggle('hide');
            }
        }


        init();
    </script>
</body>
</html>
