<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –û–°–ù–û–í–ê –î–õ–Ø –¢–ï–ú–ù–û–ì–û –†–ï–ñ–ò–ú–ê --- */
        :root {
            /* –°–≤–µ—Ç–ª–∞—è –¢–µ–º–∞ */
            --bg-color: #f8f8f8;
            --card-bg: white;
            --text-color: #1f2937;
            --secondary-text: #6b7280;
            --accent-color: #4f46e5; /* –ò–Ω–¥–∏–≥–æ */
            --accent-light: #6366f1;
            --shadow-color-main: rgba(0, 0, 0, 0.05);
            --shadow-color-accent: rgba(79, 70, 229, 0.3);
            --border-color: #e5e7eb;
        }

        .dark-mode {
            /* –¢–µ–º–Ω–∞—è –¢–µ–º–∞ */
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f9fafb;
            --secondary-text: #9ca3af;
            --accent-color: #818cf8; /* –°–≤–µ—Ç–ª—ã–π –ò–Ω–¥–∏–≥–æ */
            --accent-light: #a5b4fc;
            --shadow-color-main: rgba(255, 255, 255, 0.05);
            --shadow-color-accent: rgba(129, 140, 248, 0.3);
            --border-color: #374151;
        }

        /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s; /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è Dark Mode */
        }
        
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }

        /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ .header-card --- */
        .header-card { 
            /* –ù–æ–≤—ã–π, –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%); 
            border-radius: 16px; /* –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
            padding: 24px; 
            color: white; 
            margin-bottom: 20px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø */
            box-shadow: 0 10px 15px -3px var(--shadow-color-accent); /* –Ø—Ä–∫–∞—è —Ç–µ–Ω—å */
            transition: background 0.3s, box-shadow 0.3s;
        }

        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π/—Å–≤–µ—Ç–ª—ã–π –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ */
            border-radius: 8px;
            padding: 8px 0;
        }
        .stat-item p:first-child { 
            font-size: 11px; 
            opacity: 0.8; 
            margin-bottom: 2px; 
            line-height: 1.1;
        }
        .stat-item p:last-child { 
            font-size: 20px; 
            font-weight: bold; 
            line-height: 1.2;
        }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ö–ù–û–ü–ö–ò --- */
        button, .btn { 
            padding: 12px 18px; 
            border-radius: 10px; /* –ë–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ */
            border: none; 
            color: white; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
            transition: background-color 0.2s, opacity 0.2s, box-shadow 0.2s;
        }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        .btn-blue { background: var(--accent-color); } /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç */
        .btn-purple { background: #8b5cf6; }
        
        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏—è */
        button:active, .btn:active {
            opacity: 0.85;
        }

        /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–¢–ò–õ–¨ .card --- */
        .card { 
            background: var(--card-bg); /* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π */
            border-radius: 16px; /* –ß—É—Ç—å –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
            padding: 20px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –≤–æ–∑–¥—É—Ö–∞ */
            margin-bottom: 16px;
            /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è "—Å–ª–æ–∏—Å—Ç–∞—è" —Ç–µ–Ω—å */
            box-shadow: 
                0 1px 3px 0 var(--shadow-color-main),
                0 6px 16px -4px var(--shadow-color-main);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
        .back-btn { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            width: 36px;
            height: 36px;
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            line-height: 1; 
            box-shadow: 0 2px 4px var(--shadow-color-accent);
            padding-right: 2px;
        }
        .save-btn { 
            background: #10b981; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4); 
        }
        
        /* --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï INPUTS --- */
        input[type="text"], input[type="date"], input[type="number"], select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é */
            border-radius: 8px; 
            font-size: 16px; 
            background: var(--card-bg); /* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–µ */
            color: var(--text-color); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
            border-color: var(--accent-color); /* –ê–∫—Ü–µ–Ω—Ç –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
            outline: none;
        }

        .exercise-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: var(--bg-color); /* –ß—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ, —á–µ–º card-bg */
            border-radius: 8px; 
            margin-bottom: 8px; 
            cursor: pointer; 
            transition: background-color 0.3s;
        }
        .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-weight: 600; width: 100px; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        .month-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .month-nav button { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .month-nav h3 { 
            font-size: 20px; 
            color: var(--text-color); 
            text-transform: capitalize;
        }
        .calendar-header { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin-bottom: 8px; 
        }
        .calendar-header div { 
            font-weight: 600; 
            text-align: center; 
            color: var(--secondary-text); 
            font-size: 14px; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
        }
        .day-empty { background: var(--border-color); }
        .day-padding { 
            background: var(--bg-color); 
            opacity: 0.8; 
        } 
        .day-workout { background: #10b981; color: white; font-weight: bold; }
        .day-today { box-shadow: 0 0 0 2px var(--accent-color); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--secondary-text); }
        .hide { display: none; }
        canvas { max-width: 100%; height: 250px !important; }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–Ø (SWITCH/TOGGLE) --- */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    <script>
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null; 

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ï–ú–´ ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞, –µ—Å–ª–∏ –º—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.checked = isDark;
        }
        // ---------------------------------------------


        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:", e);
                exercises = [];
                workouts = [];
                routines = [];
            }
            
            // --- –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –¢–ï–ú–´ ---
            const storedTheme = localStorage.getItem('darkMode');
            let shouldBeDark = storedTheme === 'enabled';
            
            if (window.Telegram?.WebApp) {
                // –ï—Å–ª–∏ Telegram –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–∫–ª—é—á–∏–ª –µ–µ —è–≤–Ω–æ
                if (Telegram.WebApp.colorScheme === 'dark' && storedTheme !== 'disabled') {
                    shouldBeDark = true;
                }
            }
            
            if (shouldBeDark) {
                document.body.classList.add('dark-mode');
            }
            // --------------------------------------------
            
            render();
        }

        function save() {
            try {
                localStorage.setItem('workout-exercises', JSON.stringify(exercises));
                localStorage.setItem('workout-logs', JSON.stringify(workouts));
                localStorage.setItem('workout-routines', JSON.stringify(routines)); 
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ localStorage:", e);
            }
        }
        
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `workout_tracker_data_${date}.json`;
            
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        }

        function importData() {
            if (!confirm('–í–Ω–∏–º–∞–Ω–∏–µ! –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –í–°–ï —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (—É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã). –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.exercises || !importedData.workouts || !importedData.routines) {
                            throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –¥–∞–Ω–Ω—ã—Ö. –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å exercises, workouts –∏ routines.");
                        }
                        
                        exercises = importedData.exercises;
                        workouts = importedData.workouts;
                        routines = importedData.routines;

                        save();
                        alert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                        go('home'); 
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + error.message);
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }


        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines, 
                editRoutine: renderEditRoutine, 
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail, 
                editExercise: renderEditExercise,
                workoutDetails: renderWorkoutDetails
            };
            document.getElementById('view').innerHTML = views[currentView]();
            window.scrollTo(0, 0); 
        }

        function go(view) {
            currentView = view;
            if (view === 'calendar' || view === 'home') {
                 currentViewDate = new Date();
                 selectedDate = new Date().toISOString().split('T')[0]; 
            }
            if (currentView !== 'editExercise') {
                selectedExIdEdit = null;
            }
            if (currentView !== 'editRoutine') {
                selectedRoutineIdEdit = null;
            }
            render();
        }
        
        function changeMonth(offset) {
            currentViewDate.setDate(1); 
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            render(); 
        }

        function viewHomeExDetail(exId) {
            selExIdHome = exId;
            go('homeExDetail');
        }

        function editEx(id) {
            selectedExIdEdit = id;
            go('editExercise');
        }

        function editRoutine(id) { 
            selectedRoutineIdEdit = id;
            go('editRoutine');
        }

        function viewDetail(dateStr) {
            selectedDate = dateStr;
            go('detail');
        }

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(12, 0, 0, 0); 
            return monday.toISOString().split('T')[0];
        }

        function getWeeklyStreak() {
            if (!workouts.length) return 0;
            const uniqueWeekIds = new Set(workouts.map(w => getMonday(w.date)));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            let currentMonday = new Date(getMonday(curr));
            
            while (true) {
                const id = currentMonday.toISOString().split('T')[0];
                if (uniqueWeekIds.has(id)) {
                    streak++;
                    currentMonday.setDate(currentMonday.getDate() - 7);
                } else {
                    const now = new Date();
                    now.setHours(12, 0, 0, 0); 
                    const diff = currentMonday.getTime() - new Date(getMonday(now)).getTime();
                    if (diff === 0) { 
                        const thisWeekWorkouts = workouts.filter(w => w.date >= id);
                        if (thisWeekWorkouts.length > 0) {
                            streak++; 
                        }
                    } 
                    break;
                }
            }
            
            return streak;
        }


        function getDailyStreak() {
            if (!workouts.length) return 0;
            const dates = new Set(workouts.map(w => w.date));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            
            for (let i = 0; i < 365; i++) {
                const ds = curr.toISOString().split('T')[0];
                const isToday = i === 0 && dates.has(ds);
                const isYesterday = i > 0 && dates.has(ds);
                
                if (isToday || isYesterday) {
                    streak++;
                    curr.setDate(curr.getDate() - 1);
                } else if (i === 0) {
                    curr.setDate(curr.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }

        function calculateSetVolume(set, type) {
            const reps = parseFloat(set.reps || 0);
            if (type === 'weight') {
                const weight = parseFloat(set.weight || 0);
                return weight * reps;
            } else if (type === 'distance' || type === 'time' || type === 'reps') {
                return reps;
            }
            return 0;
        }

        function calculateWorkoutVolume(workout) {
            let totalVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                ex.sets.forEach(set => {
                    totalVolume += calculateSetVolume(set, type);
                });
            });
            // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª—ã—Ö –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            return totalVolume > 1000 ? Math.round(totalVolume) : totalVolume.toFixed(1); 
        }

        function getWorkoutCount() {
            return workouts.length;
        }

        function getPersonalRecord(exId, type) {
            let maxVal = 0;
            let bestSet = null;

            workouts.forEach(wo => {
                const ex = wo.exercises.find(e => e.exerciseId === exId);
                if (ex) {
                    ex.sets.forEach(set => {
                        let val = 0;
                        if (type === 'weight') {
                            val = (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)); 
                        } else { 
                            val = parseFloat(set.reps || 0); 
                        }

                        if (val > maxVal) {
                            maxVal = val;
                            bestSet = set;
                        }
                    });
                }
            });

            return bestSet; 
        }

        function getPrDisplay(pr, type) {
            if (!pr) return '–ù–µ—Ç PR';
            if (type === 'weight') return `${pr.weight} –∫–≥ x ${pr.reps} –ø–æ–≤—Ç`;
            if (type === 'distance') return `${pr.reps} –∫–º`;
            if (type === 'time') return `${pr.reps} –º–∏–Ω`;
            return `${pr.reps} –ø–æ–≤—Ç`;
        }
        
        function renderHome() {
            const woCount = getWorkoutCount();
            const lastWo = workouts.length > 0 ? workouts[workouts.length - 1] : null;
            const streak = getDailyStreak(); 
            const wStreak = getWeeklyStreak();

            let h = `<div class="header-card">
                <h1>üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
                <p style="opacity: 0.8; margin-top: 4px;">–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –¥–µ–Ω—å</p>
                <div class="stat-grid">
                    <div class="stat-item">
                        <p>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                        <p>${woCount}</p>
                    </div>
                    <div class="stat-item">
                        <p>–î–Ω–µ–≤–Ω–æ–π –°—Ç—Ä–∏–∫</p>
                        <p>${streak}</p>
                    </div>
                    <div class="stat-item">
                        <p>–ù–µ–¥–µ–ª—å–Ω—ã–π –°—Ç—Ä–∏–∫</p>
                        <p>${wStreak}</p>
                    </div>
                </div>
            </div>`;

            h += `<div class="btn-grid" style="margin-bottom: 20px;">
                <button class="btn btn-green" onclick="editToday()">
                    <span>üî•</span>
                    <span>–ù–æ–≤–∞—è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
                </button>
                <button class="btn btn-orange" onclick="go('calendar')">
                    <span>üìÖ</span>
                    <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
                </button>
            </div>`;

            if (lastWo) {
                 const totalVolume = calculateWorkoutVolume(lastWo);
                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:</h3>
                    <p style="font-size: 14px; color: var(--secondary-text);">${lastWo.date} | ${totalVolume} –µ–¥. –æ–±—ä–µ–º–∞</p>
                    <button onclick="go('detail')" style="margin-top: 10px; width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                    </button>
                </div>`;
            } else {
                h += '<div class="empty-state"><div style="font-size: 48px;">üèãÔ∏è</div><p>–ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</p></div>';
            }
            
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">–ë—ã—Å—Ç—Ä—ã–π –î–æ—Å—Ç—É–ø</h3>
                <div class="btn-grid">
                    <button class="btn btn-blue" style="padding: 12px 18px;" onclick="go('exercises')">
                        <span>üìù</span>
                        <span>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</span>
                    </button>
                    <button class="btn btn-purple" style="padding: 12px 18px;" onclick="go('routines')">
                        <span>üìã</span>
                        <span>–®–∞–±–ª–æ–Ω—ã</span>
                    </button>
                    <button class="btn btn-blue" style="padding: 12px 18px;" onclick="go('stats')">
                        <span>üìä</span>
                        <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                    </button>
                    <button class="btn btn-purple" style="padding: 12px 18px;" onclick="go('settings')">
                        <span>‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </button>
                </div>
            </div>`;

            if (exercises.length > 0) {
                 h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –†–µ–∫–æ—Ä–¥—ã (PR)</h3>`;
                    
                exercises.slice(0, 5).forEach(ex => {
                    const pr = getPersonalRecord(ex.id, ex.type);
                    h += `<div class="exercise-item" onclick="viewHomeExDetail('${ex.id}')">
                        <span style="font-weight: 600;">${ex.name}</span>
                        <span style="color: var(--accent-color); font-weight: 600;">${getPrDisplay(pr, ex.type)} ‚Üí</span>
                    </div>`;
                });
                
                h += `<button onclick="go('exercises')" style="margin-top: 10px; width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        –í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                    </button>`;
                h += `</div>`;
            }

            return h;
        }

        function renderExercises() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">‚Üê</button>
                <h2>üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2>
                <button class="save-btn" onclick="addNewEx()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>`;

            if (exercises.length === 0) {
                h += '<div class="empty-state"><div style="font-size: 48px;">üèãÔ∏è</div><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</p><p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!</p></div>';
            } else {
                h += '<div class="card">';
                exercises.forEach(ex => {
                    const pr = getPersonalRecord(ex.id, ex.type);
                    h += `<div class="exercise-item" onclick="viewHomeExDetail('${ex.id}')">
                        <span style="font-weight: 600;">${ex.name}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--accent-color); font-weight: 600; font-size: 14px;">${getPrDisplay(pr, ex.type)}</span>
                            <button class="delete-btn" onclick="editEx('${ex.id}')" style="color: #3b82f6;">‚úèÔ∏è</button>
                        </div>
                    </div>`;
                });
                h += '</div>';
            }
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 16px;">–ù–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <input type="text" id="newExName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ñ–∏–º –ª–µ–∂–∞)" style="margin-bottom: 12px;">
                <select id="newExType" style="margin-bottom: 16px;">
                    <option value="weight">–í–µ—Å + –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–∫–≥/–ø–æ–≤—Ç)</option>
                    <option value="reps">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–ø–æ–≤—Ç)</option>
                    <option value="distance">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</option>
                    <option value="time">–í—Ä–µ–º—è (–º–∏–Ω)</option>
                </select>
                <button class="btn btn-green" style="width: 100%;" onclick="saveNewEx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" style="width: 100%; margin-top: 10px; background: #9ca3af;" onclick="document.getElementById('addExModal').classList.add('hide')">–û—Ç–º–µ–Ω–∞</button>
            </div>`;

            return h;
        }

        function addNewEx() {
            document.getElementById('addExModal').classList.remove('hide');
        }

        function saveNewEx() {
            const name = document.getElementById('newExName').value.trim();
            const type = document.getElementById('newExType').value;
            if (!name) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            const newEx = {
                id: Date.now().toString(),
                name: name,
                type: type
            };
            exercises.push(newEx);
            save();
            document.getElementById('addExModal').classList.add('hide');
            render();
        }

        function renderEditExercise() {
            if (!selectedExIdEdit) return go('exercises');
            const ex = exercises.find(e => e.id === selectedExIdEdit);
            if (!ex) return go('exercises');

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('exercises')">‚Üê</button>
                <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">‚úèÔ∏è ${ex.name}</h2>
                <button class="save-btn" onclick="saveEditEx()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">–ù–∞–∑–≤–∞–Ω–∏–µ</h3>
                <input type="text" id="editExName" value="${ex.name}" style="margin-bottom: 16px;">
                <h3 style="margin-bottom: 12px;">–¢–∏–ø</h3>
                <select id="editExType" style="margin-bottom: 20px;">
                    <option value="weight" ${ex.type === 'weight' ? 'selected' : ''}>–í–µ—Å + –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–∫–≥/–ø–æ–≤—Ç)</option>
                    <option value="reps" ${ex.type === 'reps' ? 'selected' : ''}>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–ø–æ–≤—Ç)</option>
                    <option value="distance" ${ex.type === 'distance' ? 'selected' : ''}>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)</option>
                    <option value="time" ${ex.type === 'time' ? 'selected' : ''}>–í—Ä–µ–º—è (–º–∏–Ω)</option>
                </select>
                <button class="btn btn-green" style="width: 100%; padding: 12px; background: #ef4444;" onclick="delEx('${ex.id}', true)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>`;
            return h;
        }

        function saveEditEx() {
            if (!selectedExIdEdit) return;
            const exIndex = exercises.findIndex(e => e.id === selectedExIdEdit);
            if (exIndex === -1) return;
            
            const newName = document.getElementById('editExName').value.trim();
            const newType = document.getElementById('editExType').value;
            
            if (!newName) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            exercises[exIndex] = { ...exercises[exIndex], name: newName, type: newType };
            
            // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            workouts.forEach(wo => {
                wo.exercises.forEach(woEx => {
                    if (woEx.exerciseId === selectedExIdEdit) {
                        woEx.exerciseName = newName;
                    }
                });
            });
            
            // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —à–∞–±–ª–æ–Ω–∞—Ö
            routines.forEach(rt => {
                rt.exercises.forEach(rtEx => {
                    if (rtEx.exerciseId === selectedExIdEdit) {
                        rtEx.exerciseName = newName;
                    }
                });
            });

            save();
            go('exercises');
        }


        function delEx(id, confirmDelete = false) {
            if (confirmDelete && !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –Ω–æ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è!')) {
                return;
            }

            exercises = exercises.filter(ex => ex.id !== id);
            
            // –£–¥–∞–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤
            routines.forEach(rt => {
                rt.exercises = rt.exercises.filter(ex => ex.exerciseId !== id);
            });
            
            // –£–¥–∞–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö (—á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)
            workouts.forEach(wo => {
                 wo.exercises = wo.exercises.map(ex => {
                    if (ex.exerciseId === id) {
                        return { ...ex, exerciseName: '–£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' };
                    }
                    return ex;
                });
            });

            save();
            go('exercises');
        }
        
        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –®–ê–ë–õ–û–ù–û–í (ROUTINES) ---
        function renderRoutines() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">‚Üê</button>
                <h2>üìã –®–∞–±–ª–æ–Ω—ã</h2>
                <button class="save-btn" onclick="startNewRoutine()">+ –°–æ–∑–¥–∞—Ç—å</button>
            </div>`;

            if (routines.length === 0) {
                 h += '<div class="empty-state"><div style="font-size: 48px;">üìã</div><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤.</p><p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —à–∞–±–ª–æ–Ω!</p></div>';
            } else {
                h += '<div class="card">';
                routines.forEach(rt => {
                    const exCount = rt.exercises.length;
                    h += `<div class="exercise-item" onclick="editRoutine('${rt.id}')">
                        <span style="font-weight: 600;">${rt.name}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                             <span style="color: var(--secondary-text); font-weight: 600; font-size: 14px;">${exCount} —É–ø—Ä.</span>
                            <button class="delete-btn" onclick="delRoutine('${rt.id}')" style="color: #ef4444;">üóëÔ∏è</button>
                        </div>
                    </div>`;
                });
                h += '</div>';
            }
            return h;
        }

        function startNewRoutine() {
            selectedRoutineIdEdit = null;
            currentWorkout = [];
            go('editRoutine');
        }
        
        function delRoutine(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) {
                routines = routines.filter(rt => rt.id !== id);
                save();
                render();
            }
        }

        function renderEditRoutine() {
            const isNew = !selectedRoutineIdEdit;
            let rt = isNew ? { name: '', exercises: [] } : routines.find(r => r.id === selectedRoutineIdEdit);
            
            if (!rt && !isNew) return go('routines');
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ –≤ currentWorkout
            if (!isNew && currentWorkout.length === 0) {
                currentWorkout = JSON.parse(JSON.stringify(rt.exercises)); 
            }
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω, currentWorkout —É–∂–µ –ø—É—Å—Ç.
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="cancelRoutineEdit()">‚Üê</button>
                <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${isNew ? '–ù–æ–≤—ã–π –®–∞–±–ª–æ–Ω' : `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ${rt.name}`}</h2>
                <button class="save-btn" onclick="saveRoutine()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</h3>
                <input type="text" id="editRoutineName" value="${rt.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" style="margin-bottom: 16px;">
                <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω–µ</h3>
                <div id="routineExerciseList">`;

            if (currentWorkout.length > 0) {
                currentWorkout.forEach((ex, index) => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    h += `<div class="exercise-item" style="cursor: default;">
                        <span style="font-weight: 600;">${ex.exerciseName}</span>
                        <button class="delete-btn" onclick="removeExFromRoutine(${index})">üóëÔ∏è</button>
                    </div>`;
                });
            } else {
                h += '<div class="empty-state" style="padding: 10px 0;"><p>–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p></div>';
            }

            h += `</div>
                <button class="btn btn-blue" style="width: 100%; margin-top: 16px;" onclick="document.getElementById('addExModalRoutine').classList.remove('hide')">+ –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>`;
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            h += `<div id="addExModalRoutine" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 16px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;">`;

            if (exercises.length === 0) {
                h += '<p style="color: var(--secondary-text);">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è".</p>';
            } else {
                exercises.forEach(ex => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â–µ–º —à–∞–±–ª–æ–Ω–µ
                    const exists = currentWorkout.some(cwEx => cwEx.exerciseId === ex.id);
                    if (!exists) {
                        h += `<button style="width: 100%; text-align: left; padding: 10px; margin-bottom: 4px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); cursor: pointer; color: var(--text-color);" onclick="addExToRoutine('${ex.id}', '${ex.name}')">${ex.name}</button>`;
                    }
                });
            }

            h += `</div>
                <button class="btn" style="width: 100%; margin-top: 16px; background: #9ca3af;" onclick="document.getElementById('addExModalRoutine').classList.add('hide')">–û—Ç–º–µ–Ω–∞</button>
            </div>`;
            
            return h;
        }

        function saveRoutine() {
            const name = document.getElementById('editRoutineName').value.trim();
            if (!name) {
                alert('–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!');
                return;
            }

            const isNew = !selectedRoutineIdEdit;
            
            const routineData = {
                id: selectedRoutineIdEdit || Date.now().toString(),
                name: name,
                exercises: currentWorkout.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName 
                }))
            };

            if (isNew) {
                routines.push(routineData);
            } else {
                const index = routines.findIndex(r => r.id === selectedRoutineIdEdit);
                if (index !== -1) {
                    routines[index] = routineData;
                }
            }

            save();
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            go('routines');
        }

        function addExToRoutine(exId, exName) {
            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName
            });
            document.getElementById('addExModalRoutine').classList.add('hide');
            render(); 
        }

        function removeExFromRoutine(index) {
            currentWorkout.splice(index, 1);
            render(); 
        }

        function cancelRoutineEdit() {
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            go('routines');
        }
        // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –®–ê–ë–õ–û–ù–û–í ---

        function renderNewWorkout() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="cancelEdit()">‚Üê</button>
                <h2>${workouts.some(w => w.date === selectedDate) ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–ù–æ–≤–∞—è'} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                <button class="save-btn" onclick="saveWorkout()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">–î–∞—Ç–∞</h3>
                <input type="date" id="workoutDate" value="${selectedDate}" onchange="selectedDate = this.value; render()" style="margin-bottom: 16px;">
                ${routines.length > 0 ? `
                <h3 style="margin-bottom: 12px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω (Routine)</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    ${routines.map(rt => `
                        <button class="btn btn-blue" style="padding: 8px 12px; background: #6366f1;" onclick="loadRoutine('${rt.id}')">
                            ${rt.name}
                        </button>
                    `).join('')}
                </div>
                ` : ''}
                
                <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>
                <div id="exerciseList">`;

            if (currentWorkout.length > 0) {
                currentWorkout.forEach((ex, index) => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const isWeight = baseEx && baseEx.type === 'weight';
                    const totalSets = ex.sets.length;
                    const totalReps = ex.sets.reduce((s, set) => s + (parseFloat(set.reps) || 0), 0);
                    let summary = `${totalSets} –ø–æ–¥—Ö. | ${totalReps} –ø–æ–≤—Ç.`;
                    
                    if (isWeight) {
                        const totalVolume = ex.sets.reduce((s, set) => s + (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)), 0);
                        summary += ` | ${Math.round(totalVolume)} –∫–≥`;
                    } else if (baseEx && baseEx.type === 'distance') {
                         summary = `${totalSets} –ø–æ–¥—Ö. | ${totalReps.toFixed(1)} –∫–º`;
                    } else if (baseEx && baseEx.type === 'time') {
                         summary = `${totalSets} –ø–æ–¥—Ö. | ${Math.round(totalReps)} –º–∏–Ω`;
                    }


                    h += `<div class="exercise-item" onclick="selectEx(${index})">
                        <div style="flex-grow: 1;">
                            <span style="font-weight: 600; display: block;">${ex.exerciseName}</span>
                            <span style="font-size: 12px; color: var(--secondary-text); display: block; margin-top: 2px;">${summary}</span>
                        </div>
                        <button class="delete-btn" onclick="deleteEx(${index})">üóëÔ∏è</button>
                    </div>`;
                });
            } else {
                h += '<div class="empty-state" style="padding: 10px 0;"><p>–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p></div>';
            }
            
            h += `</div>
                <button class="btn btn-blue" style="width: 100%; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.remove('hide')">+ –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>`;
            
            if (selExId !== null && currentWorkout[selExId]) {
                const ex = currentWorkout[selExId];
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                const exName = ex.exerciseName;

                h += `<div class="card">
                    <div class="top-bar" style="margin-bottom: 12px;">
                         <h3 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${exName}</h3>
                        <button class="save-btn" onclick="selectEx(null)">–°–∫—Ä—ã—Ç—å</button>
                    </div>
                    <h4 style="margin-bottom: 12px;">–ü–æ–¥—Ö–æ–¥—ã:</h4>`;

                ex.sets.forEach((set, index) => {
                    const pr = getPersonalRecord(ex.exerciseId, type);
                    const isPR = pr && pr.weight == set.weight && pr.reps == set.reps; 

                    let prLabel = isPR ? `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>` : '';
                    
                    h += `<div class="set-row">
                        <span class="set-label">–ü–æ–¥—Ö–æ–¥ ${index + 1}</span>
                        `; 
                        
                    if (type === 'weight') {
                        h += `<input type="number" value="${set.weight || ''}" onchange="updateSet(${index}, 'weight', this.value)" placeholder="–í–µ—Å (–∫–≥)" style="flex: 1;">
                            <input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–ü–æ–≤—Ç" style="width: 80px;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                            ${prLabel}
                        `;
                    } else if (type === 'distance') {
                        h += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)" style="flex: 1;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                            ${prLabel}
                        `;
                    } else if (type === 'time') {
                        h += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–í—Ä–µ–º—è (–º–∏–Ω)" style="flex: 1;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                            ${prLabel}
                        `;
                    } else { // reps
                        h += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è" style="flex: 1;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">üóëÔ∏è</button>
                            ${prLabel}
                        `;
                    }

                    h += `</div>`;
                });

                h += `<button class="btn btn-green" style="width: 100%; margin-top: 10px;" onclick="addSet('${type}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
                </div>`;
            }

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 16px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h3>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;">`;

            if (exercises.length === 0) {
                 h += '<p style="color: var(--secondary-text);">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è".</p>';
            } else {
                exercises.forEach(ex => {
                    const exists = currentWorkout.some(cwEx => cwEx.exerciseId === ex.id);
                    if (!exists) {
                        h += `<button style="width: 100%; text-align: left; padding: 10px; margin-bottom: 4px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-color); cursor: pointer;" onclick="addExToWorkout('${ex.id}', '${ex.name}')">${ex.name}</button>`;
                    }
                });
            }

            h += `</div>
                <button class="btn" style="width: 100%; margin-top: 16px; background: #9ca3af;" onclick="document.getElementById('addExModal').classList.add('hide')">–û—Ç–º–µ–Ω–∞</button>
            </div>`;
            return h;
        }

        function loadRoutine(routineId) {
            if (currentWorkout.length > 0) {
                if (!confirm('–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    return;
                }
            }
            const routine = routines.find(rt => rt.id === routineId);
            if (routine) {
                currentWorkout = routine.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: []
                }));
                alert(`‚úÖ –®–∞–±–ª–æ–Ω "${routine.name}" –∑–∞–≥—Ä—É–∂–µ–Ω.`);
                render();
            }
        }

        function renderEditWorkout() {
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) return go('calendar');
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            return renderNewWorkout(); 
        }

        function editToday() {
            const todayDateStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDateStr);
            selectedDate = todayDateStr;
            
            if (wo) {
                currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
                go('editWorkout');
            } else {
                currentWorkout = [];
                go('newWorkout');
            }
        }

        function cancelEdit() {
            currentWorkout = [];
            selExId = null;
            go('home');
        }

        function addExToWorkout(exId, exName) {
            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName,
                sets: []
            });
            document.getElementById('addExModal').classList.add('hide');
            render();
            selectEx(currentWorkout.length - 1); 
        }
        
        function deleteEx(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                 currentWorkout.splice(index, 1);
                 selExId = null; 
                 render();
            }
        }

        function selectEx(index) {
            selExId = index;
            render();
        }

        function addSet(type) {
            if (selExId === null) return;
            const newSet = {};
            if (type === 'weight') {
                newSet.weight = '';
                newSet.reps = '';
            } else { 
                newSet.reps = '';
            }
            currentWorkout[selExId].sets.push(newSet);
            render();
        }
        
        function updateSet(setIndex, field, value) {
            if (selExId === null) return;
            currentWorkout[selExId].sets[setIndex][field] = parseFloat(value) || 0;
            // –û–±–Ω–æ–≤–ª—è–µ–º view, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, PR)
            render(); 
        }
        
        function deleteSet(setIndex) {
            if (selExId === null) return;
            currentWorkout[selExId].sets.splice(setIndex, 1);
            render();
        }

        function saveWorkout() {
            const date = document.getElementById('workoutDate').value;
            if (!date) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É!');
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å–µ—Ç—ã –∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            const cleanedWorkout = currentWorkout
                .map(ex => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';
                    
                    ex.sets = ex.sets.filter(set => {
                        if (type === 'weight') {
                            return (parseFloat(set.weight) > 0 || parseFloat(set.reps) > 0);
                        }
                        return (parseFloat(set.reps) > 0);
                    });
                    return ex;
                })
                .filter(ex => ex.sets.length > 0);
            
            if (cleanedWorkout.length === 0) {
                if (workouts.some(w => w.date === date)) {
                     // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –∏ –≤—Å–µ —É–¥–∞–ª–∏–ª–∏, —Ç–æ —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å
                    if (confirm('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—É—Å—Ç–∞. –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ —ç—Ç—É –¥–∞—Ç—É?')) {
                         workouts = workouts.filter(w => w.date !== date);
                         save();
                         currentWorkout = [];
                         go('calendar');
                         return;
                    }
                } else {
                    alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥!');
                    return;
                }
            }
            
            const newWorkout = {
                date: date,
                exercises: cleanedWorkout
            };

            const existingIndex = workouts.findIndex(w => w.date === date);

            if (existingIndex !== -1) {
                workouts[existingIndex] = newWorkout;
            } else {
                workouts.push(newWorkout);
                workouts.sort((a, b) => new Date(a.date) - new Date(b.date));
            }

            save();
            currentWorkout = [];
            selExId = null;
            go('calendar');
        }

        function renderCalendar() {
            const todayStr = new Date().toISOString().split('T')[0];
            const displayDate = currentViewDate;
            const monthName = displayDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">‚Üê</button>
                <h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;
            
            h += `<div class="card">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">‚Üê</button>
                    <h3>${monthName}</h3>
                    <button onclick="changeMonth(1)">‚Üí</button>
                </div>
                <div class="calendar-header">
                    <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div><div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
                </div>
                <div class="calendar-grid">`;

            // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–Ω–µ–π
            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            let startDay = firstDayOfMonth.getDay(); // 0-–í—Å, 1-–ü–Ω, ..., 6-–°–±
            startDay = startDay === 0 ? 7 : startDay; // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –í—Å (0) –≤ 7
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ –≤ –Ω–∞—á–∞–ª–µ
            for (let i = 1; i < startDay; i++) {
                h += `<button class="calendar-day day-padding" disabled></button>`;
            }

            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–Ω–µ–π –º–µ—Å—è—Ü–∞
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isWorkout = workouts.some(w => w.date === dateStr);
                const isToday = dateStr === todayStr;
                
                let classes = 'calendar-day';
                if (isWorkout) classes += ' day-workout';
                else classes += ' day-empty';
                if (isToday) classes += ' day-today';

                h += `<button class="${classes}" onclick="viewDetail('${dateStr}')">${day}</button>`;
            }
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ –≤ –∫–æ–Ω—Ü–µ (–¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Å–µ—Ç–∫–∏)
            const totalCells = startDay - 1 + daysInMonth;
            const rows = Math.ceil(totalCells / 7);
            const remainingCells = (rows * 7) - totalCells;
            
            for (let i = 0; i < remainingCells; i++) {
                 h += `<button class="calendar-day day-padding" disabled></button>`;
            }
            
            h += `</div></div>`;
            return h;
        }

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('calendar')">‚Üê</button>
                <h2>${selectedDate}</h2>`;
                
            if (wo) {
                 h += `<button class="back-btn" style="background: #3b82f6;" onclick="go('editWorkout')">‚úèÔ∏è</button>`;
            } else {
                 h += `<button class="back-btn" style="background: #10b981;" onclick="go('newWorkout')">+</button>`;
            }
            h += `</div>`;

            if (wo) {
                const totalVolume = calculateWorkoutVolume(wo);
                h += `<div class="card header-card" style="background: #3b82f6;">
                    <h3 style="margin-bottom: 8px; font-size: 18px;">–û–±—ä–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:</h3>
                    <p style="font-size: 32px; font-weight: bold;">${totalVolume} –µ–¥. –æ–±—ä–µ–º–∞</p>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h3>`;
                
                wo.exercises.forEach(ex => {
                    const eBase = exercises.find(e => e.id === ex.exerciseId);
                    const t = eBase ? eBase.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + (parseFloat(set.reps) || 0), 0);
                    
                    let d = '';
                    if (t === 'weight') {
                        const tw = ex.sets.reduce((s, set) => s + (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)), 0);
                        d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥`;
                    } else if (t === 'distance') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps.toFixed(1)} –∫–º`;
                    else if (t === 'time') d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(totalReps)} –º–∏–Ω`;
                    else d = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;

                    h += `<div style="padding: 12px 0; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="viewWorkoutDetails('${wo.date}', '${ex.exerciseId}')">
                        <span style="font-weight: 600;">${ex.exerciseName}</span>
                        <span style="color: var(--secondary-text); font-size: 14px;">${d} ‚Üí</span>
                    </div>`;
                });

                h += `</div>
                <div class="card">
                    <button onclick="deleteWorkout('${selectedDate}')" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
                </div>`;

            } else {
                h += '<div class="empty-state"><div style="font-size: 48px;">üò¥</div><p>–í —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.</p></div>';
            }
            return h;
        }
        
        function viewWorkoutDetails(date, exId) {
            selectedDate = date;
            selExId = exId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º selExId –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            go('workoutDetails');
        }

        function renderWorkoutDetails() {
            const wo = workouts.find(w => w.date === selectedDate);
            const ex = wo ? wo.exercises.find(e => e.exerciseId === selExId) : null;
            const baseEx = ex ? exercises.find(e => e.id === ex.exerciseId) : null;
            const type = baseEx ? baseEx.type : 'reps';
            
            if (!wo || !ex || !baseEx) return go('detail');

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('detail')">‚Üê</button>
                <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.exerciseName}</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;
            
             h += `<div class="card">
                <h3 style="margin-bottom: 12px;">–ü–æ–¥—Ö–æ–¥—ã –∑–∞ ${selectedDate}</h3>`;

            ex.sets.forEach((set, index) => {
                const pr = getPersonalRecord(ex.exerciseId, type);
                const isPR = pr && pr.weight == set.weight && pr.reps == set.reps; 
                let prLabel = isPR ? `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">üî• PR</span>` : '';
                
                let details = '';
                if (type === 'weight') {
                     details = `${set.weight || 0} –∫–≥ x ${set.reps || 0} –ø–æ–≤—Ç`;
                } else if (type === 'distance') {
                    details = `${set.reps || 0} –∫–º`;
                } else if (type === 'time') {
                    details = `${set.reps || 0} –º–∏–Ω`;
                } else {
                    details = `${set.reps || 0} –ø–æ–≤—Ç`;
                }
                
                 h += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="font-weight: 600;">–ü–æ–¥—Ö–æ–¥ ${index + 1}</span>
                    <span style="display: flex; gap: 8px; align-items: center;">
                        <span style="color: var(--accent-color);">${details}</span>
                        ${prLabel}
                    </span>
                </div>`;
            });
            
            let totalVolume = 0;
            let sum = '';
            if (type === 'weight') {
                 const tw = ex.sets.reduce((s, set) => s + (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)), 0);
                 const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                 totalVolume = tw;
                 sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr} –ø–æ–≤—Ç ‚Ä¢ ${Math.round(tw)} –∫–≥ –æ–±—â–∏–π`;
            } else if (type === 'distance') {
                const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                totalVolume = tr;
                sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr.toFixed(1)} –∫–º –≤—Å–µ–≥–æ`;
            } else if (type === 'time') {
                 const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                 totalVolume = tr;
                 sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${Math.round(tr)} –º–∏–Ω –≤—Å–µ–≥–æ`;
            } else {
                 const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                 totalVolume = tr;
                 sum = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${tr} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π`;
            }
            
            h += `<p style="margin-top: 16px; font-style: italic; color: var(--secondary-text); border-top: 1px solid var(--border-color); padding-top: 12px; font-size: 14px;">–ò—Ç–æ–≥–æ: ${sum}</p>
            </div>`;
            
            h += `<div class="card">
                <button class="btn btn-blue" onclick="viewHomeExDetail('${ex.exerciseId}')" style="width: 100%;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
            </div>`;
            
            return h;
        }

        function deleteWorkout(date) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∑–∞ ${date}?`)) {
                workouts = workouts.filter(w => w.date !== date);
                save();
                go('calendar');
            }
        }
        
        function renderStats() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">‚Üê</button>
                <h2>üìä –û–±—â–∞—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;

            const woCount = getWorkoutCount();
            if (woCount === 0) {
                 h += '<div class="empty-state"><div style="font-size: 48px;">ü§∑‚Äç‚ôÇÔ∏è</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p></div>';
                 return h;
            }

            const dates = workouts.map(w => w.date);
            const oldestDate = dates.length > 0 ? dates[0] : null;
            const streak = getDailyStreak();
            const wStreak = getWeeklyStreak();

            h += `<div class="card header-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h3 style="margin-bottom: 8px;">–û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <p>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                        <p>${woCount}</p>
                    </div>
                    <div class="stat-item">
                        <p>–î–Ω–µ–≤–Ω–æ–π –°—Ç—Ä–∏–∫</p>
                        <p>${streak}</p>
                    </div>
                    <div class="stat-item">
                        <p>–ù–µ–¥–µ–ª—å–Ω—ã–π –°—Ç—Ä–∏–∫</p>
                        <p>${wStreak}</p>
                    </div>
                </div>
                ${oldestDate ? `<p style="opacity: 0.8; font-size: 12px; margin-top: 12px; text-align: center;">–ù–∞—á–∞–ª–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è: ${oldestDate}</p>` : ''}
            </div>`;

            // –û–±—â–∏–π –æ–±—ä–µ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (–ì—Ä–∞—Ñ–∏–∫)
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">–û–±—â–∏–π –æ–±—ä–µ–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)</h3>
                <canvas id="volChart"></canvas>
            </div>`;
            
            // –°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Å PR
             h += `<div class="card">
                <h3 style="margin-bottom: 12px;">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –†–µ–∫–æ—Ä–¥—ã (PR)</h3>`;
                
            exercises.forEach(ex => {
                const pr = getPersonalRecord(ex.id, ex.type);
                h += `<div class="exercise-item" onclick="viewHomeExDetail('${ex.id}')">
                    <span style="font-weight: 600;">${ex.name}</span>
                    <span style="color: var(--accent-color); font-weight: 600;">${getPrDisplay(pr, ex.type)} ‚Üí</span>
                </div>`;
            });
            h += `</div>`;


            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º (–ì—Ä–∞—Ñ–∏–∫)
            const volumeData = [];
            const labels = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                const ds = d.toISOString().split('T')[0];
                const wo = workouts.find(w => w.date === ds);
                labels.push(d.toLocaleDateString('ru-RU', { weekday: 'short' }));
                
                if (wo) {
                    volumeData.push(parseFloat(calculateWorkoutVolume(wo)));
                } else {
                    volumeData.push(0);
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            setTimeout(() => {
                initChart('volChart', labels, volumeData, '–û–±—ä–µ–º', 'bar', '#4f46e5');
            }, 50); 
            

            return h;
        }

        function renderHomeExerciseDetail() {
            selExId = selExIdHome;
            return renderExerciseStats();
        }

        function renderExerciseStats() {
            if (!selExId) return '';
            const ex = exercises.find(e => e.id === selExId);
            if (!ex) return '';

            const exWo = workouts.filter(w => w.exercises.some(e => e.exerciseId === ex.id));
            const totalWorkouts = exWo.length;

            // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            let ts = 0, tr = 0, tw = 0, mr = 0, mw = 0; // totalSets, totalReps, totalWeightVolume, maxReps, maxWeightRep
            
            exWo.forEach(w => {
                const e = w.exercises.find(e => e.exerciseId === ex.id);
                if (e) {
                    ts += e.sets.length;
                    e.sets.forEach(set => {
                        const reps = parseFloat(set.reps || 0);
                        tr += reps;
                        if (ex.type === 'weight') {
                            const weight = parseFloat(set.weight || 0);
                            tw += weight * reps;
                            
                            // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏ PR
                            const volume = weight * reps;
                            if (volume > mw) mw = Math.round(volume); 

                        } else {
                             if (reps > mr) mr = Math.round(reps);
                        }
                    });
                }
            });
            
            const pr = getPersonalRecord(ex.id, ex.type);
            const prDisplay = getPrDisplay(pr, ex.type);

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">‚Üê</button>
                <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">üìä ${ex.name}</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;
            
            // –ë–ª–æ–∫ —Å PR
            h += `<div class="card header-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h3 style="margin-bottom: 8px; font-size: 16px;">üî• –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –†–µ–∫–æ—Ä–¥ (PR):</h3>
                <p style="font-size: 28px; font-weight: bold;">${prDisplay}</p>
                <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –∑–∞ –ø–æ–¥—Ö–æ–¥</div>
            </div>`;
            
            // –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            let volTypeLabel = '–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π';
            let volValue = Math.round(tr);
            if (ex.type === 'weight') {
                volTypeLabel = '–û–±—â–∏–π –û–±—ä–µ–º (–∫–≥)';
                volValue = Math.round(tw);
            } else if (ex.type === 'distance') {
                volTypeLabel = '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–∫–º)';
                volValue = tr.toFixed(1);
            } else if (ex.type === 'time') {
                volTypeLabel = '–í—Ä–µ–º—è (–º–∏–Ω)';
                volValue = Math.round(tr);
            }
            
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">–°–≤–æ–¥–∫–∞ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è:</h3>
                <div class="stat-grid">
                     <div class="stat-item" style="background: var(--bg-color); color: var(--text-color);">
                        <p style="color: var(--secondary-text);">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                        <p style="font-size: 20px; font-weight: bold;">${totalWorkouts}</p>
                    </div>
                    <div class="stat-item" style="background: var(--bg-color); color: var(--text-color);">
                        <p style="color: var(--secondary-text);">–ü–æ–¥—Ö–æ–¥–æ–≤</p>
                        <p style="font-size: 20px; font-weight: bold;">${ts}</p>
                    </div>
                    <div class="stat-item" style="background: var(--bg-color); color: var(--text-color);">
                        <p style="color: var(--secondary-text);">${volTypeLabel}</p>
                        <p style="font-size: 20px; font-weight: bold;">${volValue}</p>
                    </div>
                </div>
            </div>`;

            if (!exWo.length) {
                h += '<div class="empty-state"><div style="font-size: 48px;">üìä</div><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.</p></div>';
            } else {
                 // --- –î–∏–Ω–∞–º–∏–∫–∞ PR –∑–∞ –≥–æ–¥ (–ì—Ä–∞—Ñ–∏–∫) ---
                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–î–∏–Ω–∞–º–∏–∫–∞ PR –ø–æ –æ–±—ä–µ–º—É (–ü–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å)</h3>
                    <canvas id="prYearChart"></canvas>
                </div>`;
                
                const prData = [];
                const prLabels = [];
                const yearStart = new Date();
                yearStart.setDate(1); 
                yearStart.setMonth(yearStart.getMonth() - 11);
                
                for(let i = 0; i < 12; i++) {
                    const monthStart = new Date(yearStart.getFullYear(), yearStart.getMonth() + i, 1);
                    const monthEnd = new Date(yearStart.getFullYear(), yearStart.getMonth() + i + 1, 0);

                    let maxValInMonth = 0;
                    
                    exWo.forEach(w => {
                        const wDate = new Date(w.date);
                        if (wDate >= monthStart && wDate <= monthEnd) {
                            const e = w.exercises.find(ex => ex.exerciseId === selExId);
                            if (e) {
                                e.sets.forEach(set => {
                                    let val = 0;
                                    if (ex.type === 'weight') {
                                        val = (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)); 
                                    } else { 
                                        val = parseFloat(set.reps || 0); 
                                    }
                                    if (val > maxValInMonth) maxValInMonth = val;
                                });
                            }
                        }
                    });
                    
                    prLabels.push(monthStart.toLocaleDateString('ru-RU', { month: 'short' }));
                    prData.push(Math.round(maxValInMonth)); 
                }
                
                setTimeout(() => {
                    initChart('prYearChart', prLabels, prData, '–û–±—ä–µ–º', 'line', '#f59e0b');
                }, 50);
                
                 // --- –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π (–ì—Ä–∞—Ñ–∏–∫) ---
                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ 7 –¥–Ω–µ–π (–ü–æ–¥—Ö–æ–¥—ã)</h3>
                    <canvas id="weekChart"></canvas>
                </div>`;

                const wd = []; // weekly data
                const wLabels = [];
                const today = new Date(); 

                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const ds = d.toISOString().split('T')[0];
                    const wo = workouts.find(w => w.date === ds);
                    wLabels.push(d.toLocaleDateString('ru-RU', { weekday: 'short' }));
                    
                    let s = 0; // sets
                    if (wo) {
                        const e = wo.exercises.find(e => e.exerciseId === ex.id);
                        if (e) {
                            s = e.sets.length;
                        }
                    }
                    wd.push(s);
                }
                
                setTimeout(() => {
                    initChart('weekChart', wLabels, wd, '–ü–æ–¥—Ö–æ–¥—ã', 'bar', '#4f46e5');
                }, 50); 
                
            }
            
            h += `<div class="card">
                 <button class="btn btn-green" onclick="editEx('${ex.id}')" style="width: 100%;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
            </div>`;

            return h;
        }


        function renderSettings() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">‚Üê</button>
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <div></div>
            </div>`;

            // --- –ë–õ–û–ö: –ù–ê–°–¢–†–û–ô–ö–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø (–° –¢–ï–ú–ù–´–ú –†–ï–ñ–ò–ú–û–ú) ---
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-color);">üåì –¢–µ–º–Ω—ã–π —Ä–µ–∂–∏–º</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()" ${document.body.classList.contains('dark-mode') ? 'checked' : ''}>
                        <span class="slider round"></span>
                    </label>
                </div>
                <div style="padding-top: 12px; font-size: 14px; color: var(--secondary-text);">
                    –¢–µ–º–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∏–ª–∏ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –µ–µ –≤—Ä—É—á–Ω—É—é.
                </div>
            </div>`;
            // -------------------------------------------------------------
            
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">–î–∞–Ω–Ω—ã–µ</h3>
                <button onclick="exportData()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON)</button>
                <button onclick="importData()" style="width: 100%; padding: 12px; margin-bottom: 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (JSON)</button>
                <button onclick="resetRoutines()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —à–∞–±–ª–æ–Ω—ã</button>
                <button onclick="resetWo()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
                <button onclick="resetEx()" style="width: 100%; padding: 12px; margin-bottom: 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                <button onclick="resetAll()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚ö†Ô∏è –°–ë–†–û–°–ò–¢–¨ –í–°–Å</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                <p style="color: var(--secondary-text); font-size: 14px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ v2.3 (–¢–µ–º–Ω—ã–π –†–µ–∂–∏–º)<br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
            </div>`;
            return h;
        }

        function resetRoutines() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —à–∞–±–ª–æ–Ω—ã?')) {
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetWo() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                workouts = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetEx() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï?')) {
                if (confirm('–¢–æ—á–Ω–æ? –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('üî• –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    render();
                }
            }
        }
        
        // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–†–ê–§–ò–ö–û–í ---
        let chartInstance = {}; 
        function initChart(canvasId, labels, data, label, type, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (chartInstance[canvasId]) {
                 chartInstance[canvasId].destroy();
            }
            
            const isDark = document.body.classList.contains('dark-mode');

            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        tension: type === 'line' ? 0.4 : 0, 
                        fill: type === 'line' ? 'start' : false,
                        borderRadius: type === 'bar' ? 6 : 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? 'white' : 'black' } },
                        x: { grid: { display: false }, ticks: { color: isDark ? 'white' : 'black' } }
                    },
                    color: isDark ? 'white' : 'black'
                }
            };

            chartInstance[canvasId] = new Chart(ctx, chartConfig);
        }

        init();
    </script>
</body>
</html>
