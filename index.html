<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Трекер Тренировок</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 8px;
            padding: 8px 0;
        }
        .stat-item p:first-child { 
            font-size: 11px; 
            opacity: 0.8; 
            margin-bottom: 2px; 
            line-height: 1.1;
        }
        .stat-item p:last-child { 
            font-size: 20px; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { padding: 20px; border-radius: 12px; border: none; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        .btn-blue { background: #3b82f6; }
        .btn-purple { background: #8b5cf6; }
        .card { 
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .back-btn { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            width: 36px;
            height: 36px;
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            line-height: 1; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
            padding-right: 2px;
        }
        .save-btn { 
            background: #10b981; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4); 
        }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .exercise-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #f9f9f9; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            cursor: pointer; 
        }
        .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-weight: 600; width: 100px; }
        .month-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .month-nav button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .month-nav h3 { 
            font-size: 20px; 
            color: #333; 
            text-transform: capitalize;
        }
        .calendar-header { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin-bottom: 8px; 
        }
        .calendar-header div { 
            font-weight: 600; 
            text-align: center; 
            color: #666; 
            font-size: 14px; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
        }
        .day-empty { background: #f0f0f0; }
        .day-padding { 
            background: #f9f9f9; 
            opacity: 0.8; 
        } 
        .day-workout { background: #10b981; color: white; font-weight: bold; }
        .day-today { box-shadow: 0 0 0 2px #3b82f6; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .hide { display: none; }
        canvas { max-width: 100%; height: 250px !important; }
        
        /* --- НОВЫЕ СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА --- */
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.5); 
            z-index: 1000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 16px; 
            box-sizing: border-box;
        }

        /* --- СТИЛИ ДЛЯ ДИНАМИЧЕСКИХ ПОКАЗАТЕЛЕЙ (ОСТАВЛЕНО) --- */
        .dynamic-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .dynamic-stat-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    <script>
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null; 
        let expandedExId = null; 
        let selectedExStatsId = null; 

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
                workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            } catch (e) {
                console.error("Ошибка загрузки данных из localStorage:", e);
                exercises = [];
                workouts = [];
                routines = [];
            }
            render();
        }

        function save() {
            try {
                localStorage.setItem('workout-exercises', JSON.stringify(exercises));
                localStorage.setItem('workout-logs', JSON.stringify(workouts));
                localStorage.setItem('workout-routines', JSON.stringify(routines)); 
            } catch (e) {
                console.error("Ошибка сохранения данных в localStorage:", e);
            }
        }
        
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `workout_tracker_data_${date}.json`;
            
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ Данные экспортированы!');
        }

        function importData() {
            if (!confirm('Внимание! Импорт заменит ВСЕ текущие данные (упражнения, тренировки и шаблоны). Продолжить?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.exercises || !importedData.workouts || !importedData.routines) {
                            throw new Error("Неверный формат файла данных. Должен содержать exercises, workouts и routines.");
                        }
                        
                        exercises = importedData.exercises;
                        workouts = importedData.workouts;
                        routines = importedData.routines;

                        save();
                        alert('✅ Данные успешно импортированы!');
                        go('home'); 
                    } catch (error) {
                        alert('❌ Ошибка импорта: ' + error.message);
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }


        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines, 
                editRoutine: renderEditRoutine, 
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail, 
                editExercise: renderEditExercise,
            };
            document.getElementById('view').innerHTML = views[currentView]();
            // ПРОВЕРКА: обновляем список упражнений для модального окна при каждом рендере.
            if (['newWorkout', 'editWorkout', 'editRoutine'].includes(currentView)) {
                renderExerciseListForModal();
            }
            window.scrollTo(0, 0); 
        }

        function go(view) {
            currentView = view;
            if (view === 'calendar' || view === 'home') {
                 // Сброс даты только при переходе на главную или в календарь
            } else if (view !== 'calendar') {
                currentViewDate = new Date(); // Сброс месяца при выходе из календаря
            }
            
            if (currentView !== 'editExercise') {
                selectedExIdEdit = null;
            }
            if (currentView !== 'editRoutine') {
                selectedRoutineIdEdit = null;
                // currentWorkout = []; // Очистка буфера теперь делается в cancelEditRoutine
            }
            if (currentView !== 'newWorkout' && currentView !== 'editWorkout') {
                expandedExId = null; // Сброс статуса раскрытия
            }
            if (currentView !== 'exerciseStats') {
                selectedExStatsId = null; // Сброс ID статистики
            }
            render();
        }
        
        function changeMonth(offset) {
            currentViewDate.setDate(1); 
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            render(); 
        }

        function viewHomeExDetail(exId) {
            selExIdHome = exId;
            go('homeExDetail');
        }
        
        // --- ФУНКЦИЯ ДЛЯ СТАТИСТИКИ ---
        function viewExerciseStats(exId) {
            if (exId === 'total') {
                selectedExStatsId = 'total';
            } else {
                const ex = exercises.find(e => e.id === exId);
                if (!ex) return;
                selectedExStatsId = exId;
            }
            go('exerciseStats');
        }

        // НОВАЯ ФУНКЦИЯ: Переключение раскрытия упражнения
        function toggleExExpansion(exId) {
            expandedExId = expandedExId === exId ? null : exId;
            render();
        }

        function editEx(id) {
            selectedExIdEdit = id;
            go('editExercise');
        }

        function editRoutine(id) { 
            selectedRoutineIdEdit = id;
            go('editRoutine');
        }

        // НОВАЯ ФУНКЦИЯ: Обработчик клика по дате в календаре
        function viewDetail(dateStr) {
            selectedDate = dateStr;
            go('detail');
        }

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0); 
            return monday;
        }

        // --- ХЕЛПЕРЫ ДЛЯ РАСЧЕТОВ ---
        function calculateSetVolume(set, type) {
            if (type === 'weight') {
                return (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
            } else if (type === 'distance') {
                // Допускаем, что 'weight' - это дистанция (км), а 'reps' - время (мин)
                return (parseFloat(set.weight) || 0); // Объем = дистанция
            } else if (type === 'time') {
                // Допускаем, что 'weight' - это время (мин), а 'reps' - дистанция (км)
                return (parseFloat(set.weight) || 0); // Объем = время
            }
            return (parseInt(set.reps) || 0);
        }

        function calculateWorkoutVolume(workout) {
            let totalVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                ex.sets.forEach(set => {
                    totalVolume += calculateSetVolume(set, type);
                });
            });
            return Math.round(totalVolume);
        }

        function getMaxSetVolume(workout) {
            let maxVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                ex.sets.forEach(set => {
                    const volume = calculateSetVolume(set, type);
                    if (volume > maxVolume + 0.001) { // Добавление небольшого запаса для сравнения чисел с плавающей точкой
                        maxVolume = volume;
                    }
                });
            });
            return maxVolume;
        }
        
        function numbForm(n, forms) {
            if (n % 10 === 1 && n % 100 !== 11) return forms[0];
            if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20)) return forms[1];
            return forms[2];
        }

        // **********************************************
        // ФУНКЦИЯ ДЛЯ ГЕНЕРАЦИИ СПИСКА УПРАЖНЕНИЙ В МОДАЛЬНОМ ОКНЕ
        // **********************************************
        function renderExerciseListForModal() {
            const listEl = document.getElementById('exerciseListForModal');
            if (!listEl) return;
            
            if (exercises.length === 0) {
                 listEl.innerHTML = `<div class="empty-state"><p>Упражнений пока нет. Создайте их во вкладке "Упражнения".</p></div>`;
                 return;
            }

            listEl.innerHTML = exercises.map(ex => `
                <div class="exercise-item" onclick="addExToWorkout('${ex.id}', '${ex.name.replace(/'/g, "\\'")}')" style="cursor: pointer; background: #e0e7ff; margin-bottom: 8px; flex-direction: column; align-items: flex-start;">
                    <div style="font-weight: 600;">${ex.name}</div>
                    <div style="color: #666; font-size: 14px;">${ex.type === 'weight' ? 'Силовое' : ex.type === 'time' ? 'На время' : ex.type === 'distance' ? 'На дистанцию' : 'На повторения'}</div>
                </div>
            `).join('');
        }

        // **********************************************
        // РЕНДЕРИНГ ГЛАВНОГО ЭКРАНА (ИСПРАВЛЕНО)
        // **********************************************
        function renderHome() {
            const todayStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayStr);
            const totalWorkouts = workouts.length;
            const totalEx = new Set(workouts.flatMap(w => w.exercises.map(e => e.exerciseId))).size;
            const totalVolume = totalWorkouts > 0 ? workouts.map(calculateWorkoutVolume).reduce((a, b) => a + b, 0) : 0;
            const maxSetVolume = workouts.length > 0 ? Math.max(...workouts.map(getMaxSetVolume)) : 0;
            const maxVolDisplay = maxSetVolume > 0 ? (maxSetVolume >= 1000 ? (maxSetVolume / 1000).toFixed(1) + ' т' : maxSetVolume) + ' кг/повт' : 'Нет данных';

            let h = `
                <div class="header-card">
                    <h1>Трекер Тренировок</h1>
                    <p>Привет!</p>
                    <div class="stat-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-top: 16px;">
                        <div class="stat-item">
                            <p>Тренировок</p>
                            <p>${totalWorkouts}</p>
                        </div>
                        <div class="stat-item">
                            <p>Объем</p>
                            <p>${totalWorkouts > 0 ? Math.round(totalVolume).toLocaleString('ru-RU') : '0'} кг</p>
                        </div>
                        <div class="stat-item">
                            <p>PR</p>
                            <p>${maxVolDisplay}</p>
                        </div>
                    </div>
                </div>

                <div class="btn-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 0;">
                    <button class="btn btn-green" style="padding: 20px;" onclick="${wo ? `viewDetail('${todayStr}')` : `go('newWorkout')`}">
                        <span style="font-size: 24px;">${wo ? '📝' : '🚀'}</span> ${wo ? 'Редактировать сегодня' : 'Начать тренировку'}
                    </button>
                    <button class="btn btn-blue" style="padding: 20px;" onclick="go('calendar')">
                        <span style="font-size: 24px;">📅</span> Календарь
                    </button>
                    <button class="btn btn-orange" style="padding: 20px;" onclick="go('exercises')">
                        <span style="font-size: 24px;">🏋️</span> Упражнения
                    </button>
                    <button class="btn btn-purple" style="padding: 20px;" onclick="go('routines')">
                        <span style="font-size: 24px;">📋</span> Шаблоны
                    </button>
                    <button class="btn btn-orange" style="padding: 20px;" onclick="go('stats')">
                        <span style="font-size: 24px;">📊</span> Статистика
                    </button>
                    <button class="btn btn-blue" style="padding: 20px;" onclick="go('settings')">
                        <span style="font-size: 24px;">⚙️</span> Настройки
                    </button>
                </div>
            `;
            
            if (exercises.length > 0) {
                // ... (logic for last workout/top exercise, assumed to be here, but omitting for brevity and focus on fix)
            }
            
            return h;
        }

        // -----------------------------------------------------------
        // РЕНДЕРИНГ УПРАЖНЕНИЙ 
        // -----------------------------------------------------------
        function renderExercises() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>Упражнения (${exercises.length})</h2>
                <button class="save-btn" onclick="editEx(null)">➕</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Список упражнений</h3>
            `;
            if (exercises.length === 0) {
                h += `<div class="empty-state"><p>Упражнений пока нет. Создайте первое, нажав на ➕.</p></div>`;
            } else {
                exercises.forEach(ex => {
                    h += `<div class="exercise-item" onclick="editEx('${ex.id}')">
                        <div style="font-weight: 600;">${ex.name}</div>
                        <div style="color: #666; font-size: 14px;">${ex.type === 'weight' ? 'Силовое' : ex.type === 'time' ? 'На время' : ex.type === 'distance' ? 'На дистанцию' : 'На повторения'}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); delEx('${ex.id}', true)">❌</button>
                    </div>`;
                });
            }
            h += `</div>`;
            return h;
        }

        function renderEditExercise() {
            const isNew = !selectedExIdEdit;
            let ex = { id: Date.now().toString(), name: '', type: 'weight' };
            if (!isNew) {
                ex = exercises.find(e => e.id === selectedExIdEdit);
                if (!ex) return go('exercises');
            }
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('exercises')">←</button>
                <h2>${isNew ? 'Новое упражнение' : ex.name}</h2>
                <button class="save-btn" onclick="saveEx()">✅</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Название</h3>
                <input type="text" id="exName" placeholder="Название упражнения" value="${ex.name}">
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Тип</h3>
                <select id="exType">
                    <option value="weight" ${ex.type === 'weight' ? 'selected' : ''}>Силовое (Вес x Повторения)</option>
                    <option value="reps" ${ex.type === 'reps' ? 'selected' : ''}>На повторения (Повторения)</option>
                    <option value="distance" ${ex.type === 'distance' ? 'selected' : ''}>На дистанцию (Дистанция x Время)</option>
                    <option value="time" ${ex.type === 'time' ? 'selected' : ''}>На время (Время x Дистанция)</option>
                </select>
            </div>
            <div class="card">
                <button class="save-btn" style="width: 100%; background: #3b82f6;" onclick="viewExerciseStats('${ex.id}')">📊 Статистика упражнения</button>
            </div>
            ${!isNew ? `<div class="card">
                <button class="save-btn" style="width: 100%; background: #ef4444;" onclick="delEx('${ex.id}', false)">❌ Удалить упражнение</button>
            </div>` : ''}
            `;
            return h;
        }

        function saveEx() {
            const name = document.getElementById('exName').value.trim();
            const type = document.getElementById('exType').value;
            if (!name) {
                alert('Введите название упражнения!');
                return;
            }

            const isNew = !selectedExIdEdit;
            if (isNew) {
                const newEx = { id: Date.now().toString(), name: name, type: type };
                exercises.push(newEx);
            } else {
                const index = exercises.findIndex(e => e.id === selectedExIdEdit);
                if (index !== -1) {
                    exercises[index].name = name;
                    exercises[index].type = type;
                    // Обновляем название во всех тренировках и шаблонах
                    workouts.forEach(wo => {
                        wo.exercises.filter(ex => ex.exerciseId === selectedExIdEdit).forEach(ex => ex.exerciseName = name);
                    });
                    routines.forEach(rt => {
                        rt.exercises.filter(ex => ex.exerciseId === selectedExIdEdit).forEach(ex => ex.exerciseName = name);
                    });
                }
            }

            save();
            go('exercises');
        }

        function delEx(exId, goBack) {
            if (confirm('Удалить это упражнение? Оно также будет удалено из всех тренировок и шаблонов!')) {
                exercises = exercises.filter(e => e.id !== exId);
                workouts.forEach(wo => {
                    wo.exercises = wo.exercises.filter(ex => ex.exerciseId !== exId);
                });
                routines.forEach(rt => {
                    rt.exercises = rt.exercises.filter(ex => ex.exerciseId !== exId);
                });
                save();
                if (goBack) go('exercises');
                else go('home'); // Если удалили из детального просмотра
            }
        }
        
        // -----------------------------------------------------------
        // РЕНДЕРИНГ ШАБЛОНОВ (РУТИН) (ИСПРАВЛЕНО - нет авто-модала)
        // -----------------------------------------------------------

        // НОВАЯ ФУНКЦИЯ: ОТМЕНА ДОБАВЛЕНИЯ ШАБЛОНА ИЗ МОДАЛЬНОГО ОКНА
        function cancelRoutineAdd() {
            document.getElementById('newRoutineName').value = '';
            document.getElementById('addRoutineModal').classList.add('hide');
        }

        // НОВАЯ ФУНКЦИЯ: ОТМЕНА РЕДАКТИРОВАНИЯ ШАБЛОНА
        function cancelEditRoutine() {
            selectedRoutineIdEdit = null;
            currentWorkout = []; // Очистка буфера, если не сохранили/отменили
            go('routines');
        }

        function addRoutine() {
            const name = document.getElementById('newRoutineName').value.trim();
            if (!name) {
                alert('Введите название шаблона!');
                return;
            }
            routines.push({
                id: Date.now().toString(),
                name: name,
                exercises: []
            });
            save();
            cancelRoutineAdd();
            go('routines');
        }

        function delRoutine(id) {
            if (confirm('Удалить этот шаблон?')) {
                routines = routines.filter(r => r.id !== id);
                save();
                go('routines');
            }
        }

        function renderRoutines() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>Шаблоны (${routines.length})</h2>
                <button class="save-btn" onclick="document.getElementById('addRoutineModal').classList.remove('hide')">➕</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Сохраненные шаблоны</h3>
            `;
            if (routines.length === 0) {
                h += `<div class="empty-state"><p>Шаблонов пока нет. Создайте первый, нажав на ➕.</p></div>`;
            } else {
                routines.forEach(rt => {
                    const exCount = rt.exercises.length;
                    h += `<div class="exercise-item" onclick="editRoutine('${rt.id}')">
                        <div style="font-weight: 600;">${rt.name}</div>
                        <div style="color: #666; font-size: 14px;">${exCount} ${numbForm(exCount, ['упражнение', 'упражнения', 'упражнений'])}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); delRoutine('${rt.id}')">❌</button>
                    </div>`;
                });
            }
            h += `</div>`;
            return h;
        }

        function saveRoutine() {
            const name = document.getElementById('editRoutineName').value.trim();
            if (!name) {
                alert('Введите название шаблона!');
                return;
            }

            const rt = routines.find(r => r.id === selectedRoutineIdEdit);
            if (!rt) return;

            rt.name = name;
            // Копируем упражнения из буфера в шаблон, но удаляем сеты (шаблоны их не хранят)
            rt.exercises = currentWorkout.map(ex => ({
                exerciseId: ex.exerciseId,
                exerciseName: ex.exerciseName
            }));

            save();
            cancelEditRoutine();
        }

        function renderEditRoutine() {
            if (!selectedRoutineIdEdit) return go('routines');
            const rt = routines.find(r => r.id === selectedRoutineIdEdit);
            if (!rt) return go('routines');
            
            // Если мы только что перешли на страницу, загружаем упражнения шаблона в буфер.
            if (currentWorkout.length === 0) {
                currentWorkout = JSON.parse(JSON.stringify(rt.exercises.map(ex => ({ 
                    exerciseId: ex.exerciseId, 
                    exerciseName: ex.exerciseName, 
                    sets: [] // Шаблон не хранит сеты
                }))));
            }
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="cancelEditRoutine()">←</button>
                <h2>${rt.name}</h2>
                <button class="save-btn" onclick="saveRoutine()">✅</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Название шаблона</h3>
                <input type="text" id="editRoutineName" placeholder="Название шаблона" value="${rt.name}">
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Упражнения в шаблоне (${currentWorkout.length})</h3>
                <button class="save-btn" style="width: 100%; margin-bottom: 16px; background: #3b82f6;" onclick="renderExerciseListForModal(); document.getElementById('addExModal').classList.remove('hide')">➕ Добавить упражнение</button>
                `; 
                
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state"><p>Добавьте упражнения в шаблон.</p></div>`;
            } else {
                currentWorkout.forEach(ex => {
                    // Exercise header
                    h += `<div class="exercise-item" style="margin-bottom: 8px;">
                        <div style="font-weight: 600;">${ex.exerciseName}</div>
                        <button class="delete-btn" onclick="removeExFromWorkout('${ex.exerciseId}', false)">❌</button>
                    </div>`;
                });
            }
            h += `</div>`;
            return h;
        }

        // -----------------------------------------------------------
        // РЕНДЕРИНГ НОВОЙ ТРЕНИРОВКИ 
        // -----------------------------------------------------------
        function startNewWorkoutFromDate(dateStr) {
            selectedDate = dateStr;
            currentWorkout = [];
            go('newWorkout');
        }

        function goBackFromWorkout() {
            // Если пришли с главной, вернуться на главную
            const todayStr = new Date().toISOString().split('T')[0];
            if (selectedDate === todayStr) {
                go('home');
            } else {
                go('detail');
            }
            // Очистка буфера происходит при выходе из newWorkout/editWorkout в go()
        }

        function saveWorkout() {
            if (currentWorkout.length === 0) {
                alert('Добавьте хотя бы одно упражнение!');
                return;
            }

            const cleanedWorkout = {
                date: selectedDate,
                exercises: currentWorkout.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: ex.sets.filter(set => parseFloat(set.weight) > 0 || parseInt(set.reps) > 0)
                })).filter(ex => ex.sets.length > 0)
            };

            if (cleanedWorkout.exercises.length === 0) {
                alert('Заполните хотя бы один подход в одном упражнении!');
                return;
            }

            const existingIndex = workouts.findIndex(w => w.date === selectedDate);
            if (existingIndex !== -1) {
                workouts[existingIndex] = cleanedWorkout;
            } else {
                workouts.push(cleanedWorkout);
                workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            save();
            goBackFromWorkout();
        }

        function addExToWorkout(exId, exName) {
            // Проверка на дубликат (для простоты)
            if (currentWorkout.some(ex => ex.exerciseId === exId)) {
                alert('Это упражнение уже добавлено!');
                return;
            }

            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName,
                sets: [{ weight: '', reps: '' }] // Добавляем сразу один пустой подход
            });
            document.getElementById('addExModal').classList.add('hide');

            // Раскрываем только что добавленное упражнение
            expandedExId = exId;
            render();
        }

        function removeExFromWorkout(exId, isWorkoutView) {
            if (isWorkoutView && !confirm('Удалить упражнение из тренировки?')) {
                return;
            }
            if (!isWorkoutView && !confirm('Удалить упражнение из шаблона?')) {
                return;
            }

            currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
            expandedExId = null; 
            render();
        }

        function loadRoutine(routineId) {
            if (!routineId) return;

            const rt = routines.find(r => r.id === routineId);
            if (!rt) return;

            // Добавляем упражнения из шаблона в текущую тренировку
            rt.exercises.forEach(ex => {
                if (!currentWorkout.some(cwEx => cwEx.exerciseId === ex.exerciseId)) {
                    currentWorkout.push({
                        exerciseId: ex.exerciseId,
                        exerciseName: ex.exerciseName,
                        sets: [{ weight: '', reps: '' }] // Шаблоны добавляют с одним пустым сетом
                    });
                }
            });

            alert(`Шаблон "${rt.name}" загружен!`);
            document.getElementById('loadRoutineSelect').value = '';
            render();
        }

        // --- ФУНКЦИИ ДЛЯ ИНЛАЙН-РЕДАКТИРОВАНИЯ ---
        function addSetForEx(exId) {
            const ex = currentWorkout.find(e => e.exerciseId === exId);
            if (ex) {
                ex.sets.push({ weight: '', reps: '' });
                render();
            }
        }

        function removeSetForEx(exId, index) {
            const ex = currentWorkout.find(e => e.exerciseId === exId);
            if (ex) {
                ex.sets.splice(index, 1);
                // Если сетов не осталось, добавим пустой, чтобы не сломать логику
                if (ex.sets.length === 0) {
                     ex.sets.push({ weight: '', reps: '' });
                }
                render();
            }
        }

        function updateSetForEx(exId, index, field, value) {
            const ex = currentWorkout.find(e => e.exerciseId === exId);
            if (ex && ex.sets[index]) {
                ex.sets[index][field] = value;
            }
        }

        function renderNewWorkout() {
            selectedDate = new Date().toISOString().split('T')[0];
            return renderWorkoutView(selectedDate, false);
        }

        function editWorkout(dateStr) {
            selectedDate = dateStr;
            return renderWorkoutView(selectedDate, true);
        }

        function renderWorkoutView(dateStr, isEdit) {
            const wo = isEdit ? workouts.find(w => w.date === dateStr) : null;
            if (isEdit && !wo) return go('calendar'); // Если редактируем, но тренировки нет
            
            // Если редактируем, загружаем тренировку в буфер
            if (isEdit && currentWorkout.length === 0) {
                currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            } else if (!isEdit && currentWorkout.length === 0) {
                 // Если новая тренировка, currentWorkout уже пуст, но не будем его трогать.
            }

            const dateDisplay = new Date(dateStr).toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const todayStr = new Date().toISOString().split('T')[0];
            const isToday = dateStr === todayStr;

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="goBackFromWorkout()">←</button>
                <h2>${isEdit ? 'Редактирование' : 'Новая тренировка'}</h2>
                <button class="save-btn" onclick="saveWorkout()">✅</button>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">Дата</h3>
                <input type="date" id="workoutDate" value="${dateStr}" onchange="changeWorkoutDate(this.value)">
            </div>

            <div class="card">
                <h3 style="margin-bottom: 12px;">Загрузить шаблон</h3>
                <select id="loadRoutineSelect" onchange="loadRoutine(this.value)" style="margin-bottom: 16px;">
                    <option value="">Выберите шаблон...</option>
                    ${routines.map(rt => `<option value="${rt.id}">${rt.name}</option>`).join('')}
                </select>
                <button class="save-btn" style="width: 100%; margin-bottom: 16px; background: #3b82f6;" onclick="renderExerciseListForModal(); document.getElementById('addExModal').classList.remove('hide')">➕ Добавить упражнение</button>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">Упражнения в тренировке (${currentWorkout.length})</h3>
            `;
            
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state"><p>Добавьте упражнения или загрузите шаблон.</p></div>`;
            } else {
                currentWorkout.forEach(ex => {
                    const isExpanded = expandedExId === ex.exerciseId;
                    const eBase = exercises.find(e => e.id === ex.exerciseId);
                    const t = eBase ? eBase.type : 'reps';
                    
                    // Exercise header
                    h += `<div class="exercise-item" style="margin-bottom: ${isExpanded ? '8px' : '0'}; flex-wrap: wrap; cursor: pointer; border-bottom: ${isExpanded ? 'none' : '1px solid #f0f0f0'};" onclick="toggleExExpansion('${ex.exerciseId}')">
                        <div style="font-weight: 600;">${ex.exerciseName}</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="delete-btn" onclick="event.stopPropagation(); removeExFromWorkout('${ex.exerciseId}', true)">❌</button>
                        </div>
                    </div>`;

                    // Exercise details (Sets)
                    if (isExpanded) {
                        h += `<div style="padding: 0 8px 8px 8px; background: #fafafa; border-radius: 0 0 8px 8px;">`;
                        
                        ex.sets.forEach((set, index) => {
                            const setNumber = index + 1;
                            h += `<div class="set-row">
                                <div class="set-label">${setNumber}.</div>
                                `;

                            if (t === 'weight') {
                                h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Вес (кг)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="кг" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Повторения</span>
                                    <input type="number" inputmode="numeric" placeholder="повт" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                            } else if (t === 'distance') {
                                h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Дистанция (км)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="км" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Время (мин)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="мин" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                            } else if (t === 'time') {
                                h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Время (мин)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="мин" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Дистанция (км)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="км" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                            } else { // 'reps' only
                                h += `<div style="flex: 2; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Повторения</span>
                                    <input type="number" inputmode="numeric" placeholder="повт" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                            }
                            
                            h += `<button class="delete-btn" style="color: #666; font-size: 16px; align-self: flex-end; padding: 4px;" onclick="removeSetForEx('${ex.exerciseId}', ${index})">
                                🗑️
                            </button></div>`;
                        });

                        // Add set button
                        h += `<button class="save-btn" style="width: 100%; background: #4f46e5; margin-top: 8px; padding: 6px 16px; font-size: 14px;" onclick="addSetForEx('${ex.exerciseId}')">
                            + Подход
                        </button>`;
                        
                        h += `</div>`; // Close details div
                    }
                });
            }
            h += `</div>`;
            
            // Если тренировка уже существует и мы ее редактируем, добавляем кнопку удаления
            if (isEdit) {
                h += `<div class="card">
                    <button class="save-btn" style="width: 100%; background: #ef4444;" onclick="deleteWorkout()">❌ Удалить тренировку</button>
                </div>`;
            }

            return h;
        }

        function changeWorkoutDate(newDate) {
            if (newDate === selectedDate) return;
            // Проверка на наличие тренировки в новой дате
            const existingWo = workouts.find(w => w.date === newDate);
            if (existingWo) {
                if (!confirm(`На ${newDate} уже есть тренировка. Продолжить редактирование текущей и перезаписать ее?`)) {
                    document.getElementById('workoutDate').value = selectedDate; // Откатываем выбор
                    return;
                }
            }

            // Удаляем старую запись, если она была (при переименовании даты)
            const oldIndex = workouts.findIndex(w => w.date === selectedDate);
            if (oldIndex !== -1) {
                workouts.splice(oldIndex, 1);
            }
            
            selectedDate = newDate;
            // Вся работа по сохранению будет выполнена в saveWorkout()
        }

        function deleteWorkout() {
            if (confirm(`Удалить тренировку за ${selectedDate}?`)) {
                workouts = workouts.filter(w => w.date !== selectedDate);
                save();
                go('calendar');
            }
        }

        // -----------------------------------------------------------
        // РЕНДЕРИНГ КАЛЕНДАРЯ
        // -----------------------------------------------------------
        function renderCalendar() {
            const today = new Date();
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            
            // Находим день недели первого числа (0 - Вс, 1 - Пн)
            let startDay = firstDayOfMonth.getDay();
            if (startDay === 0) startDay = 7; // Делаем Воскресенье последним днем (7)
            
            const monthName = new Date(year, month).toLocaleDateString('ru-RU', { month: 'long' });
            
            const workoutDates = new Set(workouts.map(w => w.date));
            const todayStr = today.toISOString().split('T')[0];

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>Календарь</h2>
                <div style="width: 36px;"></div>
            </div>
            
            <div class="card">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">← Предыдущий</button>
                    <h3>${monthName} ${year}</h3>
                    <button onclick="changeMonth(1)">Следующий →</button>
                </div>
                
                <div class="calendar-header">
                    <div>Пн</div>
                    <div>Вт</div>
                    <div>Ср</div>
                    <div>Чт</div>
                    <div>Пт</div>
                    <div>Сб</div>
                    <div>Вс</div>
                </div>
                
                <div class="calendar-grid">`;

            // Заполнители для дней перед первым числом
            for (let i = 1; i < startDay; i++) {
                h += `<div class="calendar-day day-padding"></div>`;
            }

            // Дни месяца
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isWorkout = workoutDates.has(dateStr);
                const isToday = dateStr === todayStr;
                
                let dayClass = '';
                if (isWorkout) {
                    dayClass += ' day-workout';
                } else {
                    dayClass += ' day-empty';
                }
                if (isToday) {
                    dayClass += ' day-today';
                }
                
                h += `<button class="calendar-day${dayClass}" onclick="viewDetail('${dateStr}')">${day}</button>`;
            }

            // Заполнители для дней после последнего числа
            let endDay = (startDay + daysInMonth - 1) % 7;
            if (endDay === 0) endDay = 7;
            for (let i = endDay; i < 7; i++) {
                h += `<div class="calendar-day day-padding"></div>`;
            }
            h += `</div></div>`;
            return h;
        }

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            const dateDisplay = new Date(selectedDate).toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const todayStr = new Date().toISOString().split('T')[0];
            const isToday = selectedDate === todayStr;
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('calendar')">←</button>
                <h2>${dateDisplay}</h2>
                <button class="save-btn" onclick="${wo ? `editWorkout('${selectedDate}')` : `startNewWorkoutFromDate('${selectedDate}')`}">
                    ${wo ? '✏️' : '🚀'}
                </button>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">${wo ? 'Статистика тренировки' : 'Тренировка отсутствует'}</h3>`;
                
            if (wo) {
                const totalVolume = calculateWorkoutVolume(wo);
                const maxSetVolume = getMaxSetVolume(wo);
                const maxVolDisplay = maxSetVolume > 0 ? (maxSetVolume >= 1000 ? (maxSetVolume / 1000).toFixed(1) + ' т' : maxSetVolume) + ' кг/повт' : 'Нет данных';

                h += `<div class="stat-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 0;">
                    <div class="stat-item" style="background: #e0f2f1; color: #004d40;">
                        <p>Объем (кг)</p>
                        <p style="font-weight: bold;">${totalVolume.toLocaleString('ru-RU')}</p>
                    </div>
                    <div class="stat-item" style="background: #e3f2fd; color: #0d47a1;">
                        <p>PR (Макс. подход)</p>
                        <p style="font-weight: bold;">${maxVolDisplay}</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 16px; margin-bottom: 12px;">Упражнения</h3>
                `;

                wo.exercises.forEach(ex => {
                    const exBase = exercises.find(e => e.id === ex.exerciseId);
                    const type = exBase ? exBase.type : 'reps';
                    
                    let setsDetail = ex.sets.map((set, index) => {
                        if (type === 'weight') {
                            return `${set.weight || 0}кг x ${set.reps || 0} повт`;
                        } else if (type === 'time') {
                            return `${set.weight || 0}мин x ${set.reps || 0}км`;
                        } else if (type === 'distance') {
                            return `${set.weight || 0}км x ${set.reps || 0}мин`;
                        } else {
                            return `${set.reps || 0} повт`;
                        }
                    }).join(' | ');
                    
                    h += `<div class="exercise-item" onclick="viewHomeExDetail('${ex.exerciseId}')" style="align-items: flex-start; flex-direction: column;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${ex.exerciseName}</div>
                        <div style="color: #666; font-size: 14px; text-align: left; width: 100%; white-space: normal; line-height: 1.3;">${setsDetail}</div>
                    </div>`;
                });
            } else {
                h += `<div class="empty-state"><p>Вы можете ${isToday ? 'начать тренировку сегодня' : 'добавить тренировку'} в этот день, нажав на кнопку 🚀.</p></div>`;
            }
            
            h += `</div>`;
            return h;
        }
        
        function renderHomeExerciseDetail() {
            if (!selExIdHome) return go('home');
            const exBase = exercises.find(e => e.id === selExIdHome);
            if (!exBase) return go('home');
            
            const recentWorkouts = workouts
                .filter(w => w.exercises.some(ex => ex.exerciseId === selExIdHome))
                .slice(0, 5); 
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>${exBase.name}</h2>
                <button class="save-btn" onclick="editEx('${selExIdHome}')">✏️</button>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">Последние 5 тренировок</h3>
                `;
            
            if (recentWorkouts.length === 0) {
                h += `<div class="empty-state"><p>Нет данных по этому упражнению.</p></div>`;
            } else {
                recentWorkouts.forEach(wo => {
                    const ex = wo.exercises.find(e => e.exerciseId === selExIdHome);
                    if (!ex) return;
                    
                    let setsDetail = ex.sets.map(set => {
                        const type = exBase.type;
                        if (type === 'weight') {
                            return `${set.weight || 0}кг x ${set.reps || 0} повт`;
                        } else if (type === 'time') {
                            return `${set.weight || 0}мин x ${set.reps || 0}км`;
                        } else if (type === 'distance') {
                            return `${set.weight || 0}км x ${set.reps || 0}мин`;
                        } else {
                            return `${set.reps || 0} повт`;
                        }
                    }).join(' | ');

                    h += `<div class="exercise-item" onclick="viewDetail('${wo.date}')" style="align-items: flex-start; flex-direction: column;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${new Date(wo.date).toLocaleDateString('ru-RU')}</div>
                        <div style="color: #666; font-size: 14px; text-align: left; width: 100%; white-space: normal; line-height: 1.3;">${setsDetail}</div>
                    </div>`;
                });
            }
            h += `</div>
            
            <div class="card">
                <button class="save-btn" style="width: 100%; background: #3b82f6;" onclick="viewExerciseStats('${selExIdHome}')">📊 Динамика и PR</button>
            </div>`;
            
            return h;
        }

        // -----------------------------------------------------------
        // РЕНДЕРИНГ СТАТИСТИКИ
        // -----------------------------------------------------------
        function renderStats() {
            const totalWorkouts = workouts.length;
            const totalEx = new Set(exercises.map(e => e.id)).size;
            const totalVolume = totalWorkouts > 0 ? workouts.map(calculateWorkoutVolume).reduce((a, b) => a + b, 0) : 0;
            const maxSetVolume = workouts.length > 0 ? Math.max(...workouts.map(getMaxSetVolume)) : 0;
            const maxVolDisplay = maxSetVolume > 0 ? (maxSetVolume >= 1000 ? (maxSetVolume / 1000).toFixed(1) + ' т' : maxSetVolume) + ' кг/повт' : 'Нет данных';

            // Расчет топ-5 упражнений по объему
            const exVolumes = {};
            workouts.forEach(w => {
                w.exercises.forEach(ex => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';
                    let volume = 0;
                    ex.sets.forEach(set => {
                        volume += calculateSetVolume(set, type);
                    });
                    if (!exVolumes[ex.exerciseId]) {
                        exVolumes[ex.exerciseId] = {
                            name: ex.exerciseName,
                            volume: 0
                        };
                    }
                    exVolumes[ex.exerciseId].volume += volume;
                });
            });

            let sortedEx = Object.values(exVolumes).sort((a, b) => b.volume - a.volume);
            const topEx = sortedEx.slice(0, 5);
            const otherVolume = sortedEx.slice(5).reduce((sum, ex) => sum + ex.volume, 0);

            let chartData = topEx.map(ex => Math.round(ex.volume));
            let chartLabels = topEx.map(ex => ex.name);
            let chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#666'];
            
            if (otherVolume > 0) {
                chartData.push(Math.round(otherVolume));
                chartLabels.push('Прочее');
            }

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>Статистика</h2>
                <div style="width: 36px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">Общие показатели</h3>
                <p>Всего тренировок: <span style="font-weight: bold;">${totalWorkouts}</span></p>
                <p>Уникальных упражнений: <span style="font-weight: bold;">${totalEx}</span></p>
                <p>Общий выполненный объем: <span style="font-weight: bold;">${Math.round(totalVolume).toLocaleString('ru-RU')} кг</span></p>
                
                <div class="stat-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
                    <div class="stat-item" style="background: #e0f2f1; color: #004d40;">
                        <p>Макс. объем за трен.</p>
                        <p style="font-weight: bold;">${totalWorkouts > 0 ? Math.round(Math.max(...workouts.map(calculateWorkoutVolume))).toLocaleString('ru-RU') + ' кг' : 'Нет данных'}</p>
                    </div>
                    <div class="stat-item" style="background: #e3f2fd; color: #0d47a1;">
                        <p>Макс. подход (PR)</p>
                        <p style="font-weight: bold;">${maxVolDisplay}</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 12px;">Объем по упражнениям (Топ-5)</h3>
                ${totalWorkouts > 0 ? `<canvas id="volumeChart"></canvas>` : `<div class="empty-state"><p>Нет данных для графика.</p></div>`}
                
                <ul style="list-style: none; padding: 0; margin-top: 16px;">
                    ${topEx.map((ex, index) => `<li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: ${chartColors[index]};"></span>
                            <span>${ex.name}</span>
                        </div>
                        <span style="font-weight: bold;">${Math.round(ex.volume).toLocaleString('ru-RU')} кг</span>
                    </li>`).join('')}
                    ${otherVolume > 0 ? `<li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; color: #666;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="width: 10px; height: 10px; border-radius: 50%; background: #666;"></span>
                            <span>Прочее</span>
                        </div>
                        <span style="font-weight: bold;">${Math.round(otherVolume).toLocaleString('ru-RU')} кг</span>
                    </li>` : ''}
                </ul>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">Статистика по упражнениям</h3>
                <button class="save-btn" style="width: 100%; background: #3b82f6;" onclick="viewExerciseStats('total')">Общая динамика объема</button>
                <div style="margin-top: 12px;">
                    ${exercises.map(ex => `<button class="save-btn" style="width: 100%; background: #f59e0b; margin-top: 8px;" onclick="viewExerciseStats('${ex.id}')">Динамика: ${ex.name}</button>`).join('')}
                </div>
            </div>
            `;

            if (totalWorkouts > 0) {
                setTimeout(() => {
                    new Chart(document.getElementById('volumeChart'), {
                        type: 'doughnut',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                data: chartData,
                                backgroundColor: chartColors.slice(0, chartLabels.length),
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += Math.round(context.parsed).toLocaleString('ru-RU') + ' кг';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }, 0);
            }
            
            return h;
        }

        function renderExerciseStats() {
            if (!selectedExStatsId) return go('stats');
            
            const isTotal = selectedExStatsId === 'total';
            const exBase = isTotal ? null : exercises.find(e => e.id === selectedExStatsId);
            const title = isTotal ? 'Общая динамика объема' : `Динамика: ${exBase ? exBase.name : 'Упражнение'}`;
            
            const chartData = {
                volume: [],
                maxSetVolume: []
            };
            
            const processWorkouts = (mode) => {
                const dataMap = new Map(); 
                workouts.forEach(w => {
                    let value = 0;
                    if (isTotal) {
                        value = calculateWorkoutVolume(w);
                    } else {
                        const ex = w.exercises.find(e => e.exerciseId === selectedExStatsId);
                        if (ex) {
                            const exBase = exercises.find(e => e.id === selectedExStatsId);
                            const type = exBase ? exBase.type : 'reps';
                            if (mode === 'volume') {
                                ex.sets.forEach(set => {
                                    value += calculateSetVolume(set, type);
                                });
                                value = Math.round(value);
                            } else if (mode === 'maxSetVolume') {
                                ex.sets.forEach(set => {
                                    const vol = calculateSetVolume(set, type);
                                    if (vol > value) {
                                        value = Math.round(vol);
                                    }
                                });
                            }
                        }
                    }
                    // Используем Map, чтобы избежать дублирования дат (если такое возможно)
                    dataMap.set(w.date, value);
                });

                const sortedDates = Array.from(dataMap.keys()).sort((a, b) => new Date(a) - new Date(b));
                return {
                    labels: sortedDates.map(d => new Date(d).toLocaleDateString('ru-RU', { month: 'numeric', day: 'numeric' })),
                    data: sortedDates.map(d => dataMap.get(d))
                };
            };
            
            const volumeData = processWorkouts('volume');
            const maxSetVolumeData = processWorkouts('maxSetVolume');

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('stats')">←</button>
                <h2>${title}</h2>
                <div style="width: 36px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">Динамика общего объема</h3>
                ${volumeData.data.length > 0 ? `<canvas id="volumeHistoryChart"></canvas>` : `<div class="empty-state"><p>Нет данных для графика.</p></div>`}
            </div>`;
            
            if (!isTotal) {
                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">Динамика максимального подхода (PR)</h3>
                    ${maxSetVolumeData.data.length > 0 ? `<canvas id="maxVolumeHistoryChart"></canvas>` : `<div class="empty-state"><p>Нет данных для графика.</p></div>`}
                </div>`;
            }

            if (volumeData.data.length > 0) {
                setTimeout(() => {
                    new Chart(document.getElementById('volumeHistoryChart'), {
                        type: 'line',
                        data: {
                            labels: volumeData.labels,
                            datasets: [{
                                label: isTotal ? 'Общий объем (кг)' : 'Объем упражнения (кг)',
                                data: volumeData.data,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                fill: true,
                                tension: 0.2,
                                pointRadius: 5,
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: true,
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU') + ' кг';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    if (!isTotal && maxSetVolumeData.data.length > 0) {
                        new Chart(document.getElementById('maxVolumeHistoryChart'), {
                            type: 'line',
                            data: {
                                labels: maxSetVolumeData.labels,
                                datasets: [{
                                    label: 'Макс. подход (PR) (кг/повт)',
                                    data: maxSetVolumeData.data,
                                    borderColor: '#f59e0b',
                                    backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                    fill: true,
                                    tension: 0.2,
                                    pointRadius: 5,
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: true,
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU') + ' кг/повт';
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }
                }, 0);
            }

            return h;
        }
        
        function renderSettings() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>Настройки</h2>
                <div style="width: 36px;"></div>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">Управление данными</h3>
                <button onclick="exportData()" style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">💾 Экспорт данных</button>
                <button onclick="importData()" style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 16px;">📥 Импорт данных</button>

                <button onclick="resetRoutines()" style="width: 100%; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">❌ Удалить ВСЕ шаблоны</button>
                <button onclick="resetWo()" style="width: 100%; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">❌ Удалить ВСЕ тренировки</button>
                <button onclick="resetEx()" style="width: 100%; padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 8px;">❌ Удалить ВСЕ упражнения</button>
                <button onclick="resetAll()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">⚠️ СБРОСИТЬ ВСЁ</button>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 12px;">О приложении</h3>
                <p style="color: #666; font-size: 14px;">💪 Трекер Тренировок **v2.2** (Шаблоны Fix + Подробная Статистика)<br>Все данные хранятся локально</p>
            </div>`;
            return h;
        }
        
        function resetRoutines() {
            if (confirm('Удалить ВСЕ шаблоны?')) {
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetWo() {
            if (confirm('Удалить ВСЕ тренировки?')) {
                workouts = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetEx() {
            if (confirm('Удалить ВСЕ упражнения, тренировки и шаблоны?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetAll() {
            if (confirm('⚠️ УДАЛИТЬ ВСЕ ДАННЫЕ?')) {
                if (confirm('Точно? Последнее предупреждение!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('🔥 Все данные сброшены. Перезагрузите страницу.');
                    render();
                }
            }
        }

        init();
    </script>

    <div id="addExModal" class="modal hide" onclick="if(event.target.id === 'addExModal') document.getElementById('addExModal').classList.add('hide')">
        <div class="card" style="width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 12px;">Выберите упражнение</h3>
            <div id="exerciseListForModal">
                </div>
            <button class="save-btn" style="width: 100%; background: #666; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.add('hide')">Отмена</button>
        </div>
    </div>

    <div id="addRoutineModal" class="modal hide" onclick="if(event.target.id === 'addRoutineModal') cancelRoutineAdd()">
        <div class="card" style="width: 100%; max-width: 400px;">
            <h3 style="margin-bottom: 16px;">Новый шаблон</h3>
            <input type="text" id="newRoutineName" placeholder="Название шаблона" style="margin-bottom: 16px;">
            <button class="save-btn" style="width: 100%; margin-bottom: 8px;" onclick="addRoutine()">Создать</button>
            <button class="save-btn" style="width: 100%; background: #666;" onclick="cancelRoutineAdd()">Отмена</button>
        </div>
    </div>
</body>
</html>
