<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Трекер Тренировок</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ И ОСНОВА ДЛЯ ТЕМНОГО РЕЖИМА --- */
        :root {
            /* Светлая Тема */
            --bg-color: #f8f8f8;
            --card-bg: white;
            --text-color: #1f2937;
            --secondary-text: #6b7280;
            --accent-color: #4f46e5; /* Индиго */
            --accent-light: #6366f1;
            --shadow-color-main: rgba(0, 0, 0, 0.05);
            --shadow-color-accent: rgba(79, 70, 229, 0.3);
            --border-color: #e5e7eb;
        }

        .dark-mode {
            /* Темная Тема */
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-color: #f9fafb;
            --secondary-text: #9ca3af;
            --accent-color: #818cf8; /* Светлый Индиго */
            --accent-light: #a5b4fc;
            --shadow-color-main: rgba(255, 255, 255, 0.05);
            --shadow-color-accent: rgba(129, 140, 248, 0.3);
            --border-color: #374151;
        }

        /* --- ОБНОВЛЕННЫЕ ГЛОБАЛЬНЫЕ СТИЛИ --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s; /* Плавный переход для Dark Mode */
        }
        
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }

        /* --- ОБНОВЛЕННЫЙ СТИЛЬ .header-card --- */
        .header-card { 
            /* Новый, более насыщенный и современный градиент */
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%); 
            border-radius: 16px; /* Чуть крупнее */
            padding: 24px; 
            color: white; 
            margin-bottom: 20px; /* Чуть больше отступ */
            box-shadow: 0 10px 15px -3px var(--shadow-color-accent); /* Яркая тень */
            transition: background 0.3s, box-shadow 0.3s;
        }

        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15); /* Используем прозрачный белый/светлый для градиента */
            border-radius: 8px;
            padding: 8px 0;
        }
        .stat-item p:first-child { 
            font-size: 11px; 
            opacity: 0.8; 
            margin-bottom: 2px; 
            line-height: 1.1;
        }
        .stat-item p:last-child { 
            font-size: 20px; 
            font-weight: bold; 
            line-height: 1.2;
        }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* --- ОБНОВЛЕННЫЕ КНОПКИ --- */
        button, .btn { 
            padding: 12px 18px; 
            border-radius: 10px; /* Более скругленные */
            border: none; 
            color: white; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
            transition: background-color 0.2s, opacity 0.2s, box-shadow 0.2s;
        }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        .btn-blue { background: var(--accent-color); } /* Используем акцентный цвет */
        .btn-purple { background: #8b5cf6; }
        
        /* Состояние нажатия */
        button:active, .btn:active {
            opacity: 0.85;
        }

        /* --- ОБНОВЛЕННЫЙ СТИЛЬ .card --- */
        .card { 
            background: var(--card-bg); /* Использование переменной */
            border-radius: 16px; /* Чуть более крупные скругления */
            padding: 20px; /* Чуть больше воздуха */
            margin-bottom: 16px;
            /* Современная "слоистая" тень */
            box-shadow: 
                0 1px 3px 0 var(--shadow-color-main),
                0 6px 16px -4px var(--shadow-color-main);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        
        /* Кнопки возврата/сохранения */
        .back-btn { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            width: 36px;
            height: 36px;
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            line-height: 1; 
            box-shadow: 0 2px 4px var(--shadow-color-accent);
            padding-right: 2px;
        }
        .save-btn { 
            background: #10b981; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4); 
        }
        
        /* --- ОБНОВЛЕННЫЕ INPUTS --- */
        input[type="text"], input[type="date"], input[type="number"], select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); /* Используем переменную */
            border-radius: 8px; 
            font-size: 16px; 
            background: var(--card-bg); /* Соответствует карточке */
            color: var(--text-color); /* Цвет текста */
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
            border-color: var(--accent-color); /* Акцент при фокусе */
            outline: none;
        }

        .exercise-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: var(--bg-color); /* Чуть светлее, чем card-bg */
            border-radius: 8px; 
            margin-bottom: 8px; 
            cursor: pointer; 
            transition: background-color 0.3s;
        }
        .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-weight: 600; width: 100px; }
        
        /* Навигация календаря */
        .month-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .month-nav button { 
            background: var(--accent-color); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .month-nav h3 { 
            font-size: 20px; 
            color: var(--text-color); 
            text-transform: capitalize;
        }
        .calendar-header { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin-bottom: 8px; 
        }
        .calendar-header div { 
            font-weight: 600; 
            text-align: center; 
            color: var(--secondary-text); 
            font-size: 14px; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
        }
        .day-empty { background: var(--border-color); }
        .day-padding { 
            background: var(--bg-color); 
            opacity: 0.8; 
        } 
        .day-workout { background: #10b981; color: white; font-weight: bold; }
        .day-today { box-shadow: 0 0 0 2px var(--accent-color); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--secondary-text); }
        .hide { display: none; }
        canvas { max-width: 100%; height: 250px !important; }

        /* --- СТИЛИ ДЛЯ ПЕРЕКЛЮЧАТЕЛЯ (SWITCH/TOGGLE) --- */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    <script>
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null; 

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // --- НОВАЯ ФУНКЦИЯ: ПЕРЕКЛЮЧЕНИЕ ТЕМЫ ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            // Обновление чекбокса, если мы в настройках
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) toggle.checked = isDark;
        }
        // ---------------------------------------------


        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
            } catch (e) {
                console.error("Ошибка загрузки данных из localStorage:", e);
                exercises = [];
                workouts = [];
                routines = [];
            }
            
            // --- МОДИФИКАЦИЯ: ЗАГРУЗКА СОСТОЯНИЯ ТЕМЫ ---
            const storedTheme = localStorage.getItem('darkMode');
            let shouldBeDark = storedTheme === 'enabled';
            
            if (window.Telegram?.WebApp) {
                // Если Telegram в темной теме и пользователь не отключил ее явно
                if (Telegram.WebApp.colorScheme === 'dark' && storedTheme !== 'disabled') {
                    shouldBeDark = true;
                }
            }
            
            if (shouldBeDark) {
                document.body.classList.add('dark-mode');
            }
            // --------------------------------------------
            
            render();
        }

        function save() {
            try {
                localStorage.setItem('workout-exercises', JSON.stringify(exercises));
                localStorage.setItem('workout-logs', JSON.stringify(workouts));
                localStorage.setItem('workout-routines', JSON.stringify(routines)); 
            } catch (e) {
                console.error("Ошибка сохранения данных в localStorage:", e);
            }
        }
        
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `workout_tracker_data_${date}.json`;
            
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ Данные экспортированы!');
        }

        function importData() {
            if (!confirm('Внимание! Импорт заменит ВСЕ текущие данные (упражнения, тренировки и шаблоны). Продолжить?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.exercises || !importedData.workouts || !importedData.routines) {
                            throw new Error("Неверный формат файла данных. Должен содержать exercises, workouts и routines.");
                        }
                        
                        exercises = importedData.exercises;
                        workouts = importedData.workouts;
                        routines = importedData.routines;

                        save();
                        alert('✅ Данные успешно импортированы!');
                        go('home'); 
                    } catch (error) {
                        alert('❌ Ошибка импорта: ' + error.message);
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }


        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines, 
                editRoutine: renderEditRoutine, 
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail, 
                editExercise: renderEditExercise,
                workoutDetails: renderWorkoutDetails
            };
            document.getElementById('view').innerHTML = views[currentView]();
            window.scrollTo(0, 0); 
        }

        function go(view) {
            currentView = view;
            if (view === 'calendar' || view === 'home') {
                 currentViewDate = new Date();
                 selectedDate = new Date().toISOString().split('T')[0]; 
            }
            if (currentView !== 'editExercise') {
                selectedExIdEdit = null;
            }
            if (currentView !== 'editRoutine') {
                selectedRoutineIdEdit = null;
            }
            render();
        }
        
        function changeMonth(offset) {
            currentViewDate.setDate(1); 
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            render(); 
        }

        function viewHomeExDetail(exId) {
            selExIdHome = exId;
            go('homeExDetail');
        }

        function editEx(id) {
            selectedExIdEdit = id;
            go('editExercise');
        }

        function editRoutine(id) { 
            selectedRoutineIdEdit = id;
            go('editRoutine');
        }

        function viewDetail(dateStr) {
            selectedDate = dateStr;
            go('detail');
        }

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(12, 0, 0, 0); 
            return monday.toISOString().split('T')[0];
        }

        function getWeeklyStreak() {
            if (!workouts.length) return 0;
            const uniqueWeekIds = new Set(workouts.map(w => getMonday(w.date)));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            let currentMonday = new Date(getMonday(curr));
            
            while (true) {
                const id = currentMonday.toISOString().split('T')[0];
                if (uniqueWeekIds.has(id)) {
                    streak++;
                    currentMonday.setDate(currentMonday.getDate() - 7);
                } else {
                    const now = new Date();
                    now.setHours(12, 0, 0, 0); 
                    const diff = currentMonday.getTime() - new Date(getMonday(now)).getTime();
                    if (diff === 0) { 
                        const thisWeekWorkouts = workouts.filter(w => w.date >= id);
                        if (thisWeekWorkouts.length > 0) {
                            streak++; 
                        }
                    } 
                    break;
                }
            }
            
            return streak;
        }


        function getDailyStreak() {
            if (!workouts.length) return 0;
            const dates = new Set(workouts.map(w => w.date));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            
            for (let i = 0; i < 365; i++) {
                const ds = curr.toISOString().split('T')[0];
                const isToday = i === 0 && dates.has(ds);
                const isYesterday = i > 0 && dates.has(ds);
                
                if (isToday || isYesterday) {
                    streak++;
                    curr.setDate(curr.getDate() - 1);
                } else if (i === 0) {
                    curr.setDate(curr.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }

        function calculateSetVolume(set, type) {
            const reps = parseFloat(set.reps || 0);
            if (type === 'weight') {
                const weight = parseFloat(set.weight || 0);
                return weight * reps;
            } else if (type === 'distance' || type === 'time' || type === 'reps') {
                return reps;
            }
            return 0;
        }

        function calculateWorkoutVolume(workout) {
            let totalVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                ex.sets.forEach(set => {
                    totalVolume += calculateSetVolume(set, type);
                });
            });
            // Округляем до целых для больших значений
            return totalVolume > 1000 ? Math.round(totalVolume) : totalVolume.toFixed(1); 
        }

        function getWorkoutCount() {
            return workouts.length;
        }

        function getPersonalRecord(exId, type) {
            let maxVal = 0;
            let bestSet = null;

            workouts.forEach(wo => {
                const ex = wo.exercises.find(e => e.exerciseId === exId);
                if (ex) {
                    ex.sets.forEach(set => {
                        let val = 0;
                        if (type === 'weight') {
                            val = (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)); 
                        } else { 
                            val = parseFloat(set.reps || 0); 
                        }

                        if (val > maxVal) {
                            maxVal = val;
                            bestSet = set;
                        }
                    });
                }
            });

            return bestSet; 
        }

        function getPrDisplay(pr, type) {
            if (!pr) return 'Нет PR';
            if (type === 'weight') return `${pr.weight} кг x ${pr.reps} повт`;
            if (type === 'distance') return `${pr.reps} км`;
            if (type === 'time') return `${pr.reps} мин`;
            return `${pr.reps} повт`;
        }
        
        function renderHome() {
            const woCount = getWorkoutCount();
            const lastWo = workouts.length > 0 ? workouts[workouts.length - 1] : null;
            const streak = getDailyStreak(); 
            const wStreak = getWeeklyStreak();

            let h = `<div class="header-card">
                <h1>💪 Трекер Тренировок</h1>
                <p style="opacity: 0.8; margin-top: 4px;">Ваш прогресс за день</p>
                <div class="stat-grid">
                    <div class="stat-item">
                        <p>Тренировок</p>
                        <p>${woCount}</p>
                    </div>
                    <div class="stat-item">
                        <p>Дневной Стрик</p>
                        <p>${streak}</p>
                    </div>
                    <div class="stat-item">
                        <p>Недельный Стрик</p>
                        <p>${wStreak}</p>
                    </div>
                </div>
            </div>`;

            h += `<div class="btn-grid" style="margin-bottom: 20px;">
                <button class="btn btn-green" onclick="editToday()">
                    <span>🔥</span>
                    <span>Новая Тренировка</span>
                </button>
                <button class="btn btn-orange" onclick="go('calendar')">
                    <span>📅</span>
                    <span>Календарь</span>
                </button>
            </div>`;

            if (lastWo) {
                 const totalVolume = calculateWorkoutVolume(lastWo);
                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">Последняя тренировка:</h3>
                    <p style="font-size: 14px; color: var(--secondary-text);">${lastWo.date} | ${totalVolume} ед. объема</p>
                    <button onclick="go('detail')" style="margin-top: 10px; width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        Подробнее
                    </button>
                </div>`;
            } else {
                h += '<div class="empty-state"><div style="font-size: 48px;">🏋️</div><p>Начните свою первую тренировку!</p></div>';
            }
            
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">Быстрый Доступ</h3>
                <div class="btn-grid">
                    <button class="btn btn-blue" style="padding: 12px 18px;" onclick="go('exercises')">
                        <span>📝</span>
                        <span>Упражнения</span>
                    </button>
                    <button class="btn btn-purple" style="padding: 12px 18px;" onclick="go('routines')">
                        <span>📋</span>
                        <span>Шаблоны</span>
                    </button>
                    <button class="btn btn-blue" style="padding: 12px 18px;" onclick="go('stats')">
                        <span>📊</span>
                        <span>Статистика</span>
                    </button>
                    <button class="btn btn-purple" style="padding: 12px 18px;" onclick="go('settings')">
                        <span>⚙️</span>
                        <span>Настройки</span>
                    </button>
                </div>
            </div>`;

            if (exercises.length > 0) {
                 h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">Персональные Рекорды (PR)</h3>`;
                    
                exercises.slice(0, 5).forEach(ex => {
                    const pr = getPersonalRecord(ex.id, ex.type);
                    h += `<div class="exercise-item" onclick="viewHomeExDetail('${ex.id}')">
                        <span style="font-weight: 600;">${ex.name}</span>
                        <span style="color: var(--accent-color); font-weight: 600;">${getPrDisplay(pr, ex.type)} →</span>
                    </div>`;
                });
                
                h += `<button onclick="go('exercises')" style="margin-top: 10px; width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        Все упражнения
                    </button>`;
                h += `</div>`;
            }

            return h;
        }

        function renderExercises() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>📝 Упражнения</h2>
                <button class="save-btn" onclick="addNewEx()">+ Добавить</button>
            </div>`;

            if (exercises.length === 0) {
                h += '<div class="empty-state"><div style="font-size: 48px;">🏋️</div><p>У вас пока нет упражнений.</p><p>Добавьте первое, чтобы начать!</p></div>';
            } else {
                h += '<div class="card">';
                exercises.forEach(ex => {
                    const pr = getPersonalRecord(ex.id, ex.type);
                    h += `<div class="exercise-item" onclick="viewHomeExDetail('${ex.id}')">
                        <span style="font-weight: 600;">${ex.name}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--accent-color); font-weight: 600; font-size: 14px;">${getPrDisplay(pr, ex.type)}</span>
                            <button class="delete-btn" onclick="editEx('${ex.id}')" style="color: #3b82f6;">✏️</button>
                        </div>
                    </div>`;
                });
                h += '</div>';
            }
            
            // Модальное окно для добавления
            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 16px;">Новое упражнение</h3>
                <input type="text" id="newExName" placeholder="Название (например, Жим лежа)" style="margin-bottom: 12px;">
                <select id="newExType" style="margin-bottom: 16px;">
                    <option value="weight">Вес + Повторения (кг/повт)</option>
                    <option value="reps">Повторения (повт)</option>
                    <option value="distance">Расстояние (км)</option>
                    <option value="time">Время (мин)</option>
                </select>
                <button class="btn btn-green" style="width: 100%;" onclick="saveNewEx()">Сохранить</button>
                <button class="btn" style="width: 100%; margin-top: 10px; background: #9ca3af;" onclick="document.getElementById('addExModal').classList.add('hide')">Отмена</button>
            </div>`;

            return h;
        }

        function addNewEx() {
            document.getElementById('addExModal').classList.remove('hide');
        }

        function saveNewEx() {
            const name = document.getElementById('newExName').value.trim();
            const type = document.getElementById('newExType').value;
            if (!name) {
                alert('Название не может быть пустым');
                return;
            }

            const newEx = {
                id: Date.now().toString(),
                name: name,
                type: type
            };
            exercises.push(newEx);
            save();
            document.getElementById('addExModal').classList.add('hide');
            render();
        }

        function renderEditExercise() {
            if (!selectedExIdEdit) return go('exercises');
            const ex = exercises.find(e => e.id === selectedExIdEdit);
            if (!ex) return go('exercises');

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('exercises')">←</button>
                <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">✏️ ${ex.name}</h2>
                <button class="save-btn" onclick="saveEditEx()">Сохранить</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Название</h3>
                <input type="text" id="editExName" value="${ex.name}" style="margin-bottom: 16px;">
                <h3 style="margin-bottom: 12px;">Тип</h3>
                <select id="editExType" style="margin-bottom: 20px;">
                    <option value="weight" ${ex.type === 'weight' ? 'selected' : ''}>Вес + Повторения (кг/повт)</option>
                    <option value="reps" ${ex.type === 'reps' ? 'selected' : ''}>Повторения (повт)</option>
                    <option value="distance" ${ex.type === 'distance' ? 'selected' : ''}>Расстояние (км)</option>
                    <option value="time" ${ex.type === 'time' ? 'selected' : ''}>Время (мин)</option>
                </select>
                <button class="btn btn-green" style="width: 100%; padding: 12px; background: #ef4444;" onclick="delEx('${ex.id}', true)">🗑️ Удалить упражнение</button>
            </div>`;
            return h;
        }

        function saveEditEx() {
            if (!selectedExIdEdit) return;
            const exIndex = exercises.findIndex(e => e.id === selectedExIdEdit);
            if (exIndex === -1) return;
            
            const newName = document.getElementById('editExName').value.trim();
            const newType = document.getElementById('editExType').value;
            
            if (!newName) {
                alert('Название не может быть пустым');
                return;
            }

            // 1. Обновление в списке упражнений
            exercises[exIndex] = { ...exercises[exIndex], name: newName, type: newType };
            
            // 2. Обновление в логах тренировок
            workouts.forEach(wo => {
                wo.exercises.forEach(woEx => {
                    if (woEx.exerciseId === selectedExIdEdit) {
                        woEx.exerciseName = newName;
                    }
                });
            });
            
            // 3. Обновление в шаблонах
            routines.forEach(rt => {
                rt.exercises.forEach(rtEx => {
                    if (rtEx.exerciseId === selectedExIdEdit) {
                        rtEx.exerciseName = newName;
                    }
                });
            });

            save();
            go('exercises');
        }


        function delEx(id, confirmDelete = false) {
            if (confirmDelete && !confirm('Удалить это упражнение? Все связанные записи о тренировках останутся, но без названия!')) {
                return;
            }

            exercises = exercises.filter(ex => ex.id !== id);
            
            // Удаляем упражнение из шаблонов
            routines.forEach(rt => {
                rt.exercises = rt.exercises.filter(ex => ex.exerciseId !== id);
            });
            
            // Удаляем название упражнения в логах (чтобы не сломать исторические данные)
            workouts.forEach(wo => {
                 wo.exercises = wo.exercises.map(ex => {
                    if (ex.exerciseId === id) {
                        return { ...ex, exerciseName: 'Удаленное упражнение' };
                    }
                    return ex;
                });
            });

            save();
            go('exercises');
        }
        
        // --- ФУНКЦИИ ДЛЯ ШАБЛОНОВ (ROUTINES) ---
        function renderRoutines() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>📋 Шаблоны</h2>
                <button class="save-btn" onclick="startNewRoutine()">+ Создать</button>
            </div>`;

            if (routines.length === 0) {
                 h += '<div class="empty-state"><div style="font-size: 48px;">📋</div><p>У вас пока нет шаблонов.</p><p>Создайте свой первый шаблон!</p></div>';
            } else {
                h += '<div class="card">';
                routines.forEach(rt => {
                    const exCount = rt.exercises.length;
                    h += `<div class="exercise-item" onclick="editRoutine('${rt.id}')">
                        <span style="font-weight: 600;">${rt.name}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                             <span style="color: var(--secondary-text); font-weight: 600; font-size: 14px;">${exCount} упр.</span>
                            <button class="delete-btn" onclick="delRoutine('${rt.id}')" style="color: #ef4444;">🗑️</button>
                        </div>
                    </div>`;
                });
                h += '</div>';
            }
            return h;
        }

        function startNewRoutine() {
            selectedRoutineIdEdit = null;
            currentWorkout = [];
            go('editRoutine');
        }
        
        function delRoutine(id) {
            if (confirm('Удалить шаблон?')) {
                routines = routines.filter(rt => rt.id !== id);
                save();
                render();
            }
        }

        function renderEditRoutine() {
            const isNew = !selectedRoutineIdEdit;
            let rt = isNew ? { name: '', exercises: [] } : routines.find(r => r.id === selectedRoutineIdEdit);
            
            if (!rt && !isNew) return go('routines');
            
            // Если это редактирование, загружаем упражнения шаблона в currentWorkout
            if (!isNew && currentWorkout.length === 0) {
                currentWorkout = JSON.parse(JSON.stringify(rt.exercises)); 
            }
            // Если это новый шаблон, currentWorkout уже пуст.
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="cancelRoutineEdit()">←</button>
                <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${isNew ? 'Новый Шаблон' : `Редактировать: ${rt.name}`}</h2>
                <button class="save-btn" onclick="saveRoutine()">Сохранить</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Название шаблона</h3>
                <input type="text" id="editRoutineName" value="${rt.name}" placeholder="Название шаблона" style="margin-bottom: 16px;">
                <h3 style="margin-bottom: 12px;">Упражнения в шаблоне</h3>
                <div id="routineExerciseList">`;

            if (currentWorkout.length > 0) {
                currentWorkout.forEach((ex, index) => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    h += `<div class="exercise-item" style="cursor: default;">
                        <span style="font-weight: 600;">${ex.exerciseName}</span>
                        <button class="delete-btn" onclick="removeExFromRoutine(${index})">🗑️</button>
                    </div>`;
                });
            } else {
                h += '<div class="empty-state" style="padding: 10px 0;"><p>Нет упражнений</p></div>';
            }

            h += `</div>
                <button class="btn btn-blue" style="width: 100%; margin-top: 16px;" onclick="document.getElementById('addExModalRoutine').classList.remove('hide')">+ Добавить упражнение</button>
            </div>`;
            
            // Модальное окно для добавления упражнения
            h += `<div id="addExModalRoutine" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 16px;">Выберите упражнение</h3>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;">`;

            if (exercises.length === 0) {
                h += '<p style="color: var(--secondary-text);">Нет доступных упражнений. Сначала добавьте их в разделе "Упражнения".</p>';
            } else {
                exercises.forEach(ex => {
                    // Проверяем, есть ли уже это упражнение в текущем шаблоне
                    const exists = currentWorkout.some(cwEx => cwEx.exerciseId === ex.id);
                    if (!exists) {
                        h += `<button style="width: 100%; text-align: left; padding: 10px; margin-bottom: 4px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); cursor: pointer; color: var(--text-color);" onclick="addExToRoutine('${ex.id}', '${ex.name}')">${ex.name}</button>`;
                    }
                });
            }

            h += `</div>
                <button class="btn" style="width: 100%; margin-top: 16px; background: #9ca3af;" onclick="document.getElementById('addExModalRoutine').classList.add('hide')">Отмена</button>
            </div>`;
            
            return h;
        }

        function saveRoutine() {
            const name = document.getElementById('editRoutineName').value.trim();
            if (!name) {
                alert('Название шаблона не может быть пустым!');
                return;
            }

            const isNew = !selectedRoutineIdEdit;
            
            const routineData = {
                id: selectedRoutineIdEdit || Date.now().toString(),
                name: name,
                exercises: currentWorkout.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName 
                }))
            };

            if (isNew) {
                routines.push(routineData);
            } else {
                const index = routines.findIndex(r => r.id === selectedRoutineIdEdit);
                if (index !== -1) {
                    routines[index] = routineData;
                }
            }

            save();
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            go('routines');
        }

        function addExToRoutine(exId, exName) {
            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName
            });
            document.getElementById('addExModalRoutine').classList.add('hide');
            render(); 
        }

        function removeExFromRoutine(index) {
            currentWorkout.splice(index, 1);
            render(); 
        }

        function cancelRoutineEdit() {
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            go('routines');
        }
        // --- КОНЕЦ ФУНКЦИЙ ДЛЯ ШАБЛОНОВ ---

        function renderNewWorkout() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="cancelEdit()">←</button>
                <h2>${workouts.some(w => w.date === selectedDate) ? 'Редактировать' : 'Новая'} тренировка</h2>
                <button class="save-btn" onclick="saveWorkout()">Сохранить</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">Дата</h3>
                <input type="date" id="workoutDate" value="${selectedDate}" onchange="selectedDate = this.value; render()" style="margin-bottom: 16px;">
                ${routines.length > 0 ? `
                <h3 style="margin-bottom: 12px;">Загрузить шаблон (Routine)</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                    ${routines.map(rt => `
                        <button class="btn btn-blue" style="padding: 8px 12px; background: #6366f1;" onclick="loadRoutine('${rt.id}')">
                            ${rt.name}
                        </button>
                    `).join('')}
                </div>
                ` : ''}
                
                <h3 style="margin-bottom: 12px;">Упражнения</h3>
                <div id="exerciseList">`;

            if (currentWorkout.length > 0) {
                currentWorkout.forEach((ex, index) => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const isWeight = baseEx && baseEx.type === 'weight';
                    const totalSets = ex.sets.length;
                    const totalReps = ex.sets.reduce((s, set) => s + (parseFloat(set.reps) || 0), 0);
                    let summary = `${totalSets} подх. | ${totalReps} повт.`;
                    
                    if (isWeight) {
                        const totalVolume = ex.sets.reduce((s, set) => s + (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)), 0);
                        summary += ` | ${Math.round(totalVolume)} кг`;
                    } else if (baseEx && baseEx.type === 'distance') {
                         summary = `${totalSets} подх. | ${totalReps.toFixed(1)} км`;
                    } else if (baseEx && baseEx.type === 'time') {
                         summary = `${totalSets} подх. | ${Math.round(totalReps)} мин`;
                    }


                    h += `<div class="exercise-item" onclick="selectEx(${index})">
                        <div style="flex-grow: 1;">
                            <span style="font-weight: 600; display: block;">${ex.exerciseName}</span>
                            <span style="font-size: 12px; color: var(--secondary-text); display: block; margin-top: 2px;">${summary}</span>
                        </div>
                        <button class="delete-btn" onclick="deleteEx(${index})">🗑️</button>
                    </div>`;
                });
            } else {
                h += '<div class="empty-state" style="padding: 10px 0;"><p>Нет упражнений</p></div>';
            }
            
            h += `</div>
                <button class="btn btn-blue" style="width: 100%; margin-top: 16px;" onclick="document.getElementById('addExModal').classList.remove('hide')">+ Добавить упражнение</button>
            </div>`;
            
            if (selExId !== null && currentWorkout[selExId]) {
                const ex = currentWorkout[selExId];
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                const exName = ex.exerciseName;

                h += `<div class="card">
                    <div class="top-bar" style="margin-bottom: 12px;">
                         <h3 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${exName}</h3>
                        <button class="save-btn" onclick="selectEx(null)">Скрыть</button>
                    </div>
                    <h4 style="margin-bottom: 12px;">Подходы:</h4>`;

                ex.sets.forEach((set, index) => {
                    const pr = getPersonalRecord(ex.exerciseId, type);
                    const isPR = pr && pr.weight == set.weight && pr.reps == set.reps; 

                    let prLabel = isPR ? `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">🔥 PR</span>` : '';
                    
                    h += `<div class="set-row">
                        <span class="set-label">Подход ${index + 1}</span>
                        `; 
                        
                    if (type === 'weight') {
                        h += `<input type="number" value="${set.weight || ''}" onchange="updateSet(${index}, 'weight', this.value)" placeholder="Вес (кг)" style="flex: 1;">
                            <input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="Повт" style="width: 80px;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">🗑️</button>
                            ${prLabel}
                        `;
                    } else if (type === 'distance') {
                        h += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="Расстояние (км)" style="flex: 1;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">🗑️</button>
                            ${prLabel}
                        `;
                    } else if (type === 'time') {
                        h += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="Время (мин)" style="flex: 1;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">🗑️</button>
                            ${prLabel}
                        `;
                    } else { // reps
                        h += `<input type="number" value="${set.reps || ''}" onchange="updateSet(${index}, 'reps', this.value)" placeholder="Повторения" style="flex: 1;">
                            <button class="delete-btn" onclick="deleteSet(${index})" style="width: 36px; padding: 0;">🗑️</button>
                            ${prLabel}
                        `;
                    }

                    h += `</div>`;
                });

                h += `<button class="btn btn-green" style="width: 100%; margin-top: 10px;" onclick="addSet('${type}')">+ Добавить подход</button>
                </div>`;
            }

            // Модальное окно для добавления упражнения (используется существующий код)
            h += `<div id="addExModal" class="card hide" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                <h3 style="margin-bottom: 16px;">Выберите упражнение</h3>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 8px;">`;

            if (exercises.length === 0) {
                 h += '<p style="color: var(--secondary-text);">Нет доступных упражнений. Сначала добавьте их в разделе "Упражнения".</p>';
            } else {
                exercises.forEach(ex => {
                    const exists = currentWorkout.some(cwEx => cwEx.exerciseId === ex.id);
                    if (!exists) {
                        h += `<button style="width: 100%; text-align: left; padding: 10px; margin-bottom: 4px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--card-bg); color: var(--text-color); cursor: pointer;" onclick="addExToWorkout('${ex.id}', '${ex.name}')">${ex.name}</button>`;
                    }
                });
            }

            h += `</div>
                <button class="btn" style="width: 100%; margin-top: 16px; background: #9ca3af;" onclick="document.getElementById('addExModal').classList.add('hide')">Отмена</button>
            </div>`;
            return h;
        }

        function loadRoutine(routineId) {
            if (currentWorkout.length > 0) {
                if (!confirm('Текущая тренировка будет очищена. Продолжить?')) {
                    return;
                }
            }
            const routine = routines.find(rt => rt.id === routineId);
            if (routine) {
                currentWorkout = routine.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: []
                }));
                alert(`✅ Шаблон "${routine.name}" загружен.`);
                render();
            }
        }

        function renderEditWorkout() {
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) return go('calendar');
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            return renderNewWorkout(); 
        }

        function editToday() {
            const todayDateStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDateStr);
            selectedDate = todayDateStr;
            
            if (wo) {
                currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
                go('editWorkout');
            } else {
                currentWorkout = [];
                go('newWorkout');
            }
        }

        function cancelEdit() {
            currentWorkout = [];
            selExId = null;
            go('home');
        }

        function addExToWorkout(exId, exName) {
            currentWorkout.push({
                exerciseId: exId,
                exerciseName: exName,
                sets: []
            });
            document.getElementById('addExModal').classList.add('hide');
            render();
            selectEx(currentWorkout.length - 1); 
        }
        
        function deleteEx(index) {
            if (confirm('Удалить упражнение из тренировки?')) {
                 currentWorkout.splice(index, 1);
                 selExId = null; 
                 render();
            }
        }

        function selectEx(index) {
            selExId = index;
            render();
        }

        function addSet(type) {
            if (selExId === null) return;
            const newSet = {};
            if (type === 'weight') {
                newSet.weight = '';
                newSet.reps = '';
            } else { 
                newSet.reps = '';
            }
            currentWorkout[selExId].sets.push(newSet);
            render();
        }
        
        function updateSet(setIndex, field, value) {
            if (selExId === null) return;
            currentWorkout[selExId].sets[setIndex][field] = parseFloat(value) || 0;
            // Обновляем view, чтобы видеть текущий статус (например, PR)
            render(); 
        }
        
        function deleteSet(setIndex) {
            if (selExId === null) return;
            currentWorkout[selExId].sets.splice(setIndex, 1);
            render();
        }

        function saveWorkout() {
            const date = document.getElementById('workoutDate').value;
            if (!date) {
                alert('Выберите дату!');
                return;
            }

            // Фильтруем пустые сеты и упражнения
            const cleanedWorkout = currentWorkout
                .map(ex => {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';
                    
                    ex.sets = ex.sets.filter(set => {
                        if (type === 'weight') {
                            return (parseFloat(set.weight) > 0 || parseFloat(set.reps) > 0);
                        }
                        return (parseFloat(set.reps) > 0);
                    });
                    return ex;
                })
                .filter(ex => ex.sets.length > 0);
            
            if (cleanedWorkout.length === 0) {
                if (workouts.some(w => w.date === date)) {
                     // Если редактировали и все удалили, то удаляем запись
                    if (confirm('Тренировка пуста. Удалить запись за эту дату?')) {
                         workouts = workouts.filter(w => w.date !== date);
                         save();
                         currentWorkout = [];
                         go('calendar');
                         return;
                    }
                } else {
                    alert('Добавьте хотя бы один подход!');
                    return;
                }
            }
            
            const newWorkout = {
                date: date,
                exercises: cleanedWorkout
            };

            const existingIndex = workouts.findIndex(w => w.date === date);

            if (existingIndex !== -1) {
                workouts[existingIndex] = newWorkout;
            } else {
                workouts.push(newWorkout);
                workouts.sort((a, b) => new Date(a.date) - new Date(b.date));
            }

            save();
            currentWorkout = [];
            selExId = null;
            go('calendar');
        }

        function renderCalendar() {
            const todayStr = new Date().toISOString().split('T')[0];
            const displayDate = currentViewDate;
            const monthName = displayDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>📅 Календарь</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;
            
            h += `<div class="card">
                <div class="month-nav">
                    <button onclick="changeMonth(-1)">←</button>
                    <h3>${monthName}</h3>
                    <button onclick="changeMonth(1)">→</button>
                </div>
                <div class="calendar-header">
                    <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
                </div>
                <div class="calendar-grid">`;

            // Логика отображения дней
            const year = displayDate.getFullYear();
            const month = displayDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            let startDay = firstDayOfMonth.getDay(); // 0-Вс, 1-Пн, ..., 6-Сб
            startDay = startDay === 0 ? 7 : startDay; // Превращаем Вс (0) в 7
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Заполнение пустых ячеек в начале
            for (let i = 1; i < startDay; i++) {
                h += `<button class="calendar-day day-padding" disabled></button>`;
            }

            // Заполнение дней месяца
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isWorkout = workouts.some(w => w.date === dateStr);
                const isToday = dateStr === todayStr;
                
                let classes = 'calendar-day';
                if (isWorkout) classes += ' day-workout';
                else classes += ' day-empty';
                if (isToday) classes += ' day-today';

                h += `<button class="${classes}" onclick="viewDetail('${dateStr}')">${day}</button>`;
            }
            
            // Заполнение пустых ячеек в конце (для выравнивания сетки)
            const totalCells = startDay - 1 + daysInMonth;
            const rows = Math.ceil(totalCells / 7);
            const remainingCells = (rows * 7) - totalCells;
            
            for (let i = 0; i < remainingCells; i++) {
                 h += `<button class="calendar-day day-padding" disabled></button>`;
            }
            
            h += `</div></div>`;
            return h;
        }

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('calendar')">←</button>
                <h2>${selectedDate}</h2>`;
                
            if (wo) {
                 h += `<button class="back-btn" style="background: #3b82f6;" onclick="go('editWorkout')">✏️</button>`;
            } else {
                 h += `<button class="back-btn" style="background: #10b981;" onclick="go('newWorkout')">+</button>`;
            }
            h += `</div>`;

            if (wo) {
                const totalVolume = calculateWorkoutVolume(wo);
                h += `<div class="card header-card" style="background: #3b82f6;">
                    <h3 style="margin-bottom: 8px; font-size: 18px;">Объем тренировки:</h3>
                    <p style="font-size: 32px; font-weight: bold;">${totalVolume} ед. объема</p>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 12px;">Упражнения</h3>`;
                
                wo.exercises.forEach(ex => {
                    const eBase = exercises.find(e => e.id === ex.exerciseId);
                    const t = eBase ? eBase.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + (parseFloat(set.reps) || 0), 0);
                    
                    let d = '';
                    if (t === 'weight') {
                        const tw = ex.sets.reduce((s, set) => s + (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)), 0);
                        d = `${ex.sets.length} подходов • ${totalReps} повт • ${Math.round(tw)} кг`;
                    } else if (t === 'distance') d = `${ex.sets.length} подходов • ${totalReps.toFixed(1)} км`;
                    else if (t === 'time') d = `${ex.sets.length} подходов • ${Math.round(totalReps)} мин`;
                    else d = `${ex.sets.length} подходов • ${totalReps} повторений`;

                    h += `<div style="padding: 12px 0; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="viewWorkoutDetails('${wo.date}', '${ex.exerciseId}')">
                        <span style="font-weight: 600;">${ex.exerciseName}</span>
                        <span style="color: var(--secondary-text); font-size: 14px;">${d} →</span>
                    </div>`;
                });

                h += `</div>
                <div class="card">
                    <button onclick="deleteWorkout('${selectedDate}')" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">🗑️ Удалить тренировку</button>
                </div>`;

            } else {
                h += '<div class="empty-state"><div style="font-size: 48px;">😴</div><p>В этот день нет тренировки.</p></div>';
            }
            return h;
        }
        
        function viewWorkoutDetails(date, exId) {
            selectedDate = date;
            selExId = exId; // Используем selExId для временного хранения ID упражнения
            go('workoutDetails');
        }

        function renderWorkoutDetails() {
            const wo = workouts.find(w => w.date === selectedDate);
            const ex = wo ? wo.exercises.find(e => e.exerciseId === selExId) : null;
            const baseEx = ex ? exercises.find(e => e.id === ex.exerciseId) : null;
            const type = baseEx ? baseEx.type : 'reps';
            
            if (!wo || !ex || !baseEx) return go('detail');

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('detail')">←</button>
                <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.exerciseName}</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;
            
             h += `<div class="card">
                <h3 style="margin-bottom: 12px;">Подходы за ${selectedDate}</h3>`;

            ex.sets.forEach((set, index) => {
                const pr = getPersonalRecord(ex.exerciseId, type);
                const isPR = pr && pr.weight == set.weight && pr.reps == set.reps; 
                let prLabel = isPR ? `<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">🔥 PR</span>` : '';
                
                let details = '';
                if (type === 'weight') {
                     details = `${set.weight || 0} кг x ${set.reps || 0} повт`;
                } else if (type === 'distance') {
                    details = `${set.reps || 0} км`;
                } else if (type === 'time') {
                    details = `${set.reps || 0} мин`;
                } else {
                    details = `${set.reps || 0} повт`;
                }
                
                 h += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="font-weight: 600;">Подход ${index + 1}</span>
                    <span style="display: flex; gap: 8px; align-items: center;">
                        <span style="color: var(--accent-color);">${details}</span>
                        ${prLabel}
                    </span>
                </div>`;
            });
            
            let totalVolume = 0;
            let sum = '';
            if (type === 'weight') {
                 const tw = ex.sets.reduce((s, set) => s + (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)), 0);
                 const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                 totalVolume = tw;
                 sum = `${ex.sets.length} подходов • ${tr} повт • ${Math.round(tw)} кг общий`;
            } else if (type === 'distance') {
                const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                totalVolume = tr;
                sum = `${ex.sets.length} подходов • ${tr.toFixed(1)} км всего`;
            } else if (type === 'time') {
                 const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                 totalVolume = tr;
                 sum = `${ex.sets.length} подходов • ${Math.round(tr)} мин всего`;
            } else {
                 const tr = ex.sets.reduce((s, set) => s + (parseFloat(set.reps || 0)), 0);
                 totalVolume = tr;
                 sum = `${ex.sets.length} подходов • ${tr} повторений`;
            }
            
            h += `<p style="margin-top: 16px; font-style: italic; color: var(--secondary-text); border-top: 1px solid var(--border-color); padding-top: 12px; font-size: 14px;">Итого: ${sum}</p>
            </div>`;
            
            h += `<div class="card">
                <button class="btn btn-blue" onclick="viewHomeExDetail('${ex.exerciseId}')" style="width: 100%;">📊 Статистика упражнения</button>
            </div>`;
            
            return h;
        }

        function deleteWorkout(date) {
            if (confirm(`Удалить тренировку за ${date}?`)) {
                workouts = workouts.filter(w => w.date !== date);
                save();
                go('calendar');
            }
        }
        
        function renderStats() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>📊 Общая Статистика</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;

            const woCount = getWorkoutCount();
            if (woCount === 0) {
                 h += '<div class="empty-state"><div style="font-size: 48px;">🤷‍♂️</div><p>Нет данных для статистики.</p></div>';
                 return h;
            }

            const dates = workouts.map(w => w.date);
            const oldestDate = dates.length > 0 ? dates[0] : null;
            const streak = getDailyStreak();
            const wStreak = getWeeklyStreak();

            h += `<div class="card header-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h3 style="margin-bottom: 8px;">Общие показатели:</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <p>Тренировок</p>
                        <p>${woCount}</p>
                    </div>
                    <div class="stat-item">
                        <p>Дневной Стрик</p>
                        <p>${streak}</p>
                    </div>
                    <div class="stat-item">
                        <p>Недельный Стрик</p>
                        <p>${wStreak}</p>
                    </div>
                </div>
                ${oldestDate ? `<p style="opacity: 0.8; font-size: 12px; margin-top: 12px; text-align: center;">Начало отслеживания: ${oldestDate}</p>` : ''}
            </div>`;

            // Общий объем за последние 7 дней (График)
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">Общий объем (последние 7 дней)</h3>
                <canvas id="volChart"></canvas>
            </div>`;
            
            // Список упражнений с PR
             h += `<div class="card">
                <h3 style="margin-bottom: 12px;">Персональные Рекорды (PR)</h3>`;
                
            exercises.forEach(ex => {
                const pr = getPersonalRecord(ex.id, ex.type);
                h += `<div class="exercise-item" onclick="viewHomeExDetail('${ex.id}')">
                    <span style="font-weight: 600;">${ex.name}</span>
                    <span style="color: var(--accent-color); font-weight: 600;">${getPrDisplay(pr, ex.type)} →</span>
                </div>`;
            });
            h += `</div>`;


            // Статистика по упражнениям (График)
            const volumeData = [];
            const labels = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                const ds = d.toISOString().split('T')[0];
                const wo = workouts.find(w => w.date === ds);
                labels.push(d.toLocaleDateString('ru-RU', { weekday: 'short' }));
                
                if (wo) {
                    volumeData.push(parseFloat(calculateWorkoutVolume(wo)));
                } else {
                    volumeData.push(0);
                }
            }
            
            // Инициализация графика
            setTimeout(() => {
                initChart('volChart', labels, volumeData, 'Объем', 'bar', '#4f46e5');
            }, 50); 
            

            return h;
        }

        function renderHomeExerciseDetail() {
            selExId = selExIdHome;
            return renderExerciseStats();
        }

        function renderExerciseStats() {
            if (!selExId) return '';
            const ex = exercises.find(e => e.id === selExId);
            if (!ex) return '';

            const exWo = workouts.filter(w => w.exercises.some(e => e.exerciseId === ex.id));
            const totalWorkouts = exWo.length;

            // Расчет общей статистики
            let ts = 0, tr = 0, tw = 0, mr = 0, mw = 0; // totalSets, totalReps, totalWeightVolume, maxReps, maxWeightRep
            
            exWo.forEach(w => {
                const e = w.exercises.find(e => e.exerciseId === ex.id);
                if (e) {
                    ts += e.sets.length;
                    e.sets.forEach(set => {
                        const reps = parseFloat(set.reps || 0);
                        tr += reps;
                        if (ex.type === 'weight') {
                            const weight = parseFloat(set.weight || 0);
                            tw += weight * reps;
                            
                            // Максимальное значение для графика динамики PR
                            const volume = weight * reps;
                            if (volume > mw) mw = Math.round(volume); 

                        } else {
                             if (reps > mr) mr = Math.round(reps);
                        }
                    });
                }
            });
            
            const pr = getPersonalRecord(ex.id, ex.type);
            const prDisplay = getPrDisplay(pr, ex.type);

            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2 style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">📊 ${ex.name}</h2>
                <div style="width: 36px; height: 36px;"></div>
            </div>`;
            
            // Блок с PR
            h += `<div class="card header-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h3 style="margin-bottom: 8px; font-size: 16px;">🔥 Персональный Рекорд (PR):</h3>
                <p style="font-size: 28px; font-weight: bold;">${prDisplay}</p>
                <div style="font-size: 12px; opacity: 0.9; margin-top: 4px;">Максимальный объем за подход</div>
            </div>`;
            
            // Общие данные
            let volTypeLabel = 'Повторений';
            let volValue = Math.round(tr);
            if (ex.type === 'weight') {
                volTypeLabel = 'Общий Объем (кг)';
                volValue = Math.round(tw);
            } else if (ex.type === 'distance') {
                volTypeLabel = 'Расстояние (км)';
                volValue = tr.toFixed(1);
            } else if (ex.type === 'time') {
                volTypeLabel = 'Время (мин)';
                volValue = Math.round(tr);
            }
            
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">Сводка за все время:</h3>
                <div class="stat-grid">
                     <div class="stat-item" style="background: var(--bg-color); color: var(--text-color);">
                        <p style="color: var(--secondary-text);">Тренировок</p>
                        <p style="font-size: 20px; font-weight: bold;">${totalWorkouts}</p>
                    </div>
                    <div class="stat-item" style="background: var(--bg-color); color: var(--text-color);">
                        <p style="color: var(--secondary-text);">Подходов</p>
                        <p style="font-size: 20px; font-weight: bold;">${ts}</p>
                    </div>
                    <div class="stat-item" style="background: var(--bg-color); color: var(--text-color);">
                        <p style="color: var(--secondary-text);">${volTypeLabel}</p>
                        <p style="font-size: 20px; font-weight: bold;">${volValue}</p>
                    </div>
                </div>
            </div>`;

            if (!exWo.length) {
                h += '<div class="empty-state"><div style="font-size: 48px;">📊</div><p>Нет данных для этого упражнения.</p></div>';
            } else {
                 // --- Динамика PR за год (График) ---
                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">Динамика PR по объему (Последние 12 мес)</h3>
                    <canvas id="prYearChart"></canvas>
                </div>`;
                
                const prData = [];
                const prLabels = [];
                const yearStart = new Date();
                yearStart.setDate(1); 
                yearStart.setMonth(yearStart.getMonth() - 11);
                
                for(let i = 0; i < 12; i++) {
                    const monthStart = new Date(yearStart.getFullYear(), yearStart.getMonth() + i, 1);
                    const monthEnd = new Date(yearStart.getFullYear(), yearStart.getMonth() + i + 1, 0);

                    let maxValInMonth = 0;
                    
                    exWo.forEach(w => {
                        const wDate = new Date(w.date);
                        if (wDate >= monthStart && wDate <= monthEnd) {
                            const e = w.exercises.find(ex => ex.exerciseId === selExId);
                            if (e) {
                                e.sets.forEach(set => {
                                    let val = 0;
                                    if (ex.type === 'weight') {
                                        val = (parseFloat(set.weight || 0) * parseFloat(set.reps || 0)); 
                                    } else { 
                                        val = parseFloat(set.reps || 0); 
                                    }
                                    if (val > maxValInMonth) maxValInMonth = val;
                                });
                            }
                        }
                    });
                    
                    prLabels.push(monthStart.toLocaleDateString('ru-RU', { month: 'short' }));
                    prData.push(Math.round(maxValInMonth)); 
                }
                
                setTimeout(() => {
                    initChart('prYearChart', prLabels, prData, 'Объем', 'line', '#f59e0b');
                }, 50);
                
                 // --- Динамика за 7 дней (График) ---
                h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">Активность за 7 дней (Подходы)</h3>
                    <canvas id="weekChart"></canvas>
                </div>`;

                const wd = []; // weekly data
                const wLabels = [];
                const today = new Date(); 

                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const ds = d.toISOString().split('T')[0];
                    const wo = workouts.find(w => w.date === ds);
                    wLabels.push(d.toLocaleDateString('ru-RU', { weekday: 'short' }));
                    
                    let s = 0; // sets
                    if (wo) {
                        const e = wo.exercises.find(e => e.exerciseId === ex.id);
                        if (e) {
                            s = e.sets.length;
                        }
                    }
                    wd.push(s);
                }
                
                setTimeout(() => {
                    initChart('weekChart', wLabels, wd, 'Подходы', 'bar', '#4f46e5');
                }, 50); 
                
            }
            
            h += `<div class="card">
                 <button class="btn btn-green" onclick="editEx('${ex.id}')" style="width: 100%;">✏️ Редактировать упражнение</button>
            </div>`;

            return h;
        }


        function renderSettings() {
            let h = `<div class="top-bar">
                <button class="back-btn" onclick="go('home')">←</button>
                <h2>⚙️ Настройки</h2>
                <div></div>
            </div>`;

            // --- БЛОК: НАСТРОЙКИ ОТОБРАЖЕНИЯ (С ТЕМНЫМ РЕЖИМОМ) ---
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">Отображение</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-color);">🌓 Темный режим</span>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()" ${document.body.classList.contains('dark-mode') ? 'checked' : ''}>
                        <span class="slider round"></span>
                    </label>
                </div>
                <div style="padding-top: 12px; font-size: 14px; color: var(--secondary-text);">
                    Тема загружается автоматически, или вы можете выбрать ее вручную.
                </div>
            </div>`;
            // -------------------------------------------------------------
            
            h += `<div class="card">
                <h3 style="margin-bottom: 12px;">Данные</h3>
                <button onclick="exportData()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">⬇️ Экспорт данных (JSON)</button>
                <button onclick="importData()" style="width: 100%; padding: 12px; margin-bottom: 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">⬆️ Импорт данных (JSON)</button>
                <button onclick="resetRoutines()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">🗑️ Удалить все шаблоны</button>
                <button onclick="resetWo()" style="width: 100%; padding: 12px; margin-bottom: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">🗑️ Удалить все тренировки</button>
                <button onclick="resetEx()" style="width: 100%; padding: 12px; margin-bottom: 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">🗑️ Удалить все упражнения</button>
                <button onclick="resetAll()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">⚠️ СБРОСИТЬ ВСЁ</button>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 12px;">О приложении</h3>
                <p style="color: var(--secondary-text); font-size: 14px;">💪 Трекер Тренировок v2.3 (Темный Режим)<br>Все данные хранятся локально</p>
            </div>`;
            return h;
        }

        function resetRoutines() {
            if (confirm('Удалить ВСЕ шаблоны?')) {
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetWo() {
            if (confirm('Удалить ВСЕ тренировки?')) {
                workouts = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetEx() {
            if (confirm('Удалить ВСЕ упражнения, тренировки и шаблоны?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetAll() {
            if (confirm('⚠️ УДАЛИТЬ ВСЕ ДАННЫЕ?')) {
                if (confirm('Точно? Последнее предупреждение!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('🔥 Все данные сброшены. Перезагрузите страницу.');
                    render();
                }
            }
        }
        
        // --- ФУНКЦИЯ ДЛЯ ГРАФИКОВ ---
        let chartInstance = {}; 
        function initChart(canvasId, labels, data, label, type, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // Уничтожаем старый экземпляр, если он существует
            if (chartInstance[canvasId]) {
                 chartInstance[canvasId].destroy();
            }
            
            const isDark = document.body.classList.contains('dark-mode');

            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        tension: type === 'line' ? 0.4 : 0, 
                        fill: type === 'line' ? 'start' : false,
                        borderRadius: type === 'bar' ? 6 : 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }, ticks: { color: isDark ? 'white' : 'black' } },
                        x: { grid: { display: false }, ticks: { color: isDark ? 'white' : 'black' } }
                    },
                    color: isDark ? 'white' : 'black'
                }
            };

            chartInstance[canvasId] = new Chart(ctx, chartConfig);
        }

        init();
    </script>
</body>
</html>
