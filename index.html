<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
        }
        /* –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: —É–≤–µ–ª–∏—á–µ–Ω–æ –Ω–∏–∂–Ω–µ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è Web App */
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 90px; } 
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
        }
        .stat-item { 
            background: rgba(255, 255, 255, 0.2); 
            padding: 12px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .stat-value { font-size: 1.5em; font-weight: bold; }
        .stat-label { font-size: 0.8em; opacity: 0.8; margin-top: 4px; }
        
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        .title { font-size: 1.2em; font-weight: bold; margin-bottom: 12px; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }
        .btn-primary { background-color: #764ba2; color: white; }
        .btn-secondary { background-color: #e0e0e0; color: #333; }
        .btn-danger { background-color: #ff4d4d; color: white; }
        .btn-add { background-color: #28a745; color: white; }
        
        /* –°–ø–∏—Å–æ–∫ */
        .list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
        }
        .list-item:last-child { border-bottom: none; }
        .item-details { flex-grow: 1; }
        .item-details small { color: #666; display: block; }
        .item-actions { display: flex; gap: 8px; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            background: white;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            padding: 5px 0;
            z-index: 1000;
        }
        .nav-item {
            text-align: center;
            padding: 8px;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
            font-size: 0.9em;
            flex-grow: 1;
        }
        .nav-item.active {
            color: #764ba2;
            font-weight: bold;
        }
        .nav-icon { font-size: 1.2em; margin-bottom: 3px; }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            resize: vertical;
        }

        /* –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ */
        .set-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 6px;
        }
        .set-row input { margin-bottom: 0; }
        .set-row .set-number { font-weight: bold; width: 30px; text-align: center; }
        .set-row .kg-input { flex: 2; }
        .set-row .reps-input { flex: 2; }
        .set-row .delete-set-btn { flex: 0 0 30px; background: none; color: #ff4d4d; font-size: 1.2em; padding: 0; border: none; cursor: pointer; }
        
        .routine-item .list-item { 
            display: block; 
            cursor: pointer; 
        }
        .routine-item .item-details { 
            margin-bottom: 8px; 
            font-weight: bold; 
        }
        .routine-item small { 
            color: #666; 
            line-height: 1.4; 
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        </div>

    <div class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="go('home')">
            <div class="nav-icon">üè†</div>
            <div>–ì–ª–∞–≤–Ω–∞—è</div>
        </div>
        <div class="nav-item" id="nav-new" onclick="go('new_workout')">
            <div class="nav-icon">üèãÔ∏è</div>
            <div>–ù–æ–≤–∞—è</div>
        </div>
        <div class="nav-item" id="nav-routines" onclick="go('routines')">
            <div class="nav-icon">üìù</div>
            <div>–®–∞–±–ª–æ–Ω—ã</div>
        </div>
        <div class="nav-item" id="nav-stats" onclick="go('stats')">
            <div class="nav-icon">üìà</div>
            <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        </div>
        <div class="nav-item" id="nav-settings" onclick="go('settings')">
            <div class="nav-icon">‚öôÔ∏è</div>
            <div>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        const app = document.getElementById('app');
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
        let workouts = JSON.parse(localStorage.getItem('workouts')) || [];
        let exercises = JSON.parse(localStorage.getItem('exercises')) || [];
        let routines = JSON.parse(localStorage.getItem('routines')) || [];
        let currentWorkout = JSON.parse(localStorage.getItem('currentWorkout')) || [];
        let isEditingWorkout = JSON.parse(localStorage.getItem('isEditingWorkout')) || false;
        let currentPage = 'home';
        
        // –°–¢–ï–ö –ö–û–ù–¢–ï–ö–°–¢–ê –î–õ–Ø –û–ë–†–ê–¢–ù–û–ô –ù–ê–í–ò–ì–ê–¶–ò–ò (FIX V2.3)
        window.contextStack = [];

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

        function save() {
            localStorage.setItem('workouts', JSON.stringify(workouts));
            localStorage.setItem('exercises', JSON.stringify(exercises));
            localStorage.setItem('routines', JSON.stringify(routines));
            localStorage.setItem('currentWorkout', JSON.stringify(currentWorkout));
            localStorage.setItem('isEditingWorkout', JSON.stringify(isEditingWorkout));
        }

        function getExerciseName(id) {
            const ex = exercises.find(e => e.id === id);
            return ex ? ex.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
        }

        function getWorkoutDuration(startTime, endTime) {
            if (!startTime || !endTime) return '00:00:00';
            const diff = new Date(endTime).getTime() - new Date(startTime).getTime();
            const totalSeconds = Math.floor(diff / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => String(num).padStart(2, '0');

            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        // --- –†–æ—É—Ç–∏–Ω–≥ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ ---

        function go(page, data = null) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            if (currentPage && currentPage !== 'select_exercise' && currentPage !== 'add_exercise') {
                contextStack.push({ page: currentPage, data: data });
            }

            currentPage = page;
            tg.HapticFeedback.impactOccurred('light');
            render(data);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navItem = document.getElementById(`nav-${page.split('_')[0]}`);
            if (navItem) navItem.classList.add('active');
        }

        function goBack() {
            tg.HapticFeedback.impactOccurred('light');
            if (contextStack.length > 0) {
                const prevContext = contextStack.pop();
                currentPage = prevContext.page;
                render(prevContext.data);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                const navItem = document.getElementById(`nav-${currentPage.split('_')[0]}`);
                if (navItem) navItem.classList.add('active');
            } else {
                // –ï—Å–ª–∏ —Å—Ç–µ–∫ –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                go('home');
            }
        }


        function render(data = null) {
            app.innerHTML = '';
            tg.MainButton.hide();
            tg.BackButton.hide();
            tg.setHeaderColor('secondary_bg_color');

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
            if (currentPage !== 'home' && currentPage !== 'start_workout') {
                 tg.BackButton.show().onClick(goBack);
            }


            switch (currentPage) {
                case 'home':
                    renderHome();
                    break;
                case 'new_workout':
                    renderNewWorkout();
                    break;
                case 'start_workout':
                    renderStartWorkout(data);
                    break;
                case 'edit_workout':
                    renderEditWorkout(data);
                    break;
                case 'routines':
                    renderRoutines();
                    break;
                case 'add_routine':
                    renderAddRoutine(data);
                    break;
                case 'view_workout':
                    renderViewWorkout(data);
                    break;
                case 'settings':
                    renderSettings();
                    break;
                case 'exercises':
                    renderExercises();
                    break;
                case 'add_exercise':
                    renderAddExercise(data);
                    break;
                case 'stats':
                    renderStats();
                    break;
                case 'select_exercise':
                    renderSelectExercise(data); // data = { from: 'workout'/'routine', routineId: null/id }
                    break;
            }
        }
        
        // --- Render Functions ---

        function renderHome() {
            let h = `
                <div class="header-card">
                    <h2>–ü—Ä–∏–≤–µ—Ç, ${tg.initDataUnsafe.first_name || '–°–ø–æ—Ä—Ç—Å–º–µ–Ω'}!</h2>
                    ${getStatGrid()}
                    <div class="btn-group" style="margin-top: 24px;">
                        <button class="btn btn-add" onclick="go('new_workout')">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
                    </div>
                </div>

                <div class="card">
                    <div class="title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div>
                    ${workouts.length === 0 ? '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.</p>' : ''}
                    ${workouts.slice(0, 5).map(w => `
                        <div class="list-item" onclick="go('view_workout', ${w.id})">
                            <div class="item-details">
                                ${formatDate(w.date)}
                                <small>${w.name || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'} (${getWorkoutDuration(w.startTime, w.endTime)})</small>
                            </div>
                            <div class="item-actions">
                                <span style="color: #764ba2;">‚Üí</span>
                            </div>
                        </div>
                    `).join('')}
                    ${workouts.length > 5 ? `<div class="btn-group"><button class="btn btn-secondary" onclick="go('history')">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button></div>` : ''}
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
            tg.BackButton.hide(); // –ù–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –Ω–µ –Ω—É–∂–Ω–∞
            contextStack = []; // –û—á–∏—â–∞–µ–º —Å—Ç–µ–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
        }

        function getStatGrid() {
            const totalWorkouts = workouts.length;
            const totalSets = workouts.reduce((sum, w) => sum + w.exercises.reduce((s, e) => s + e.sets.length, 0), 0);
            const totalVolume = workouts.reduce((sum, w) => sum + w.exercises.reduce((s, e) => s + e.sets.reduce((v, set) => v + (set.kg * set.reps), 0), 0), 0);
            
            return `
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">${totalWorkouts}</div>
                        <div class="stat-label">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${totalSets}</div>
                        <div class="stat-label">–ü–æ–¥—Ö–æ–¥–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${(totalVolume / 1000).toFixed(1)}K</div>
                        <div class="stat-label">–û–±—ä–µ–º (–∫–≥)</div>
                    </div>
                </div>
            `;
        }

        function renderStats() {
            let h = `
                <div class="header-card">
                    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    ${getStatGrid()}
                </div>
                
                <div class="card">
                    <div class="title">–î–∏–Ω–∞–º–∏–∫–∞ –æ–±—ä–µ–º–∞</div>
                    <canvas id="volumeChart"></canvas>
                </div>
                
                <div class="card">
                    <div class="title">–û–±—ä–µ–º –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º (–¢–æ–ø 5)</div>
                    <canvas id="exerciseVolumeChart"></canvas>
                </div>

                <div class="card">
                    <div class="title">–°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
                    ${getMostFrequentExercises().map(item => `
                        <div class="list-item">
                            <div class="item-details">
                                ${getExerciseName(item.id)}
                                <small>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${item.count} —Ä–∞–∑</small>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="card" style="text-align: center;">
                    <p style="color: #666; font-size: 14px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ **v2.3** (FIX –ù–∞–≤–∏–≥–∞—Ü–∏–∏)</p>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º –≥—Ä–∞—Ñ–∏–∫–æ–≤
            if (workouts.length > 0) {
                 renderVolumeChart();
                 renderExerciseVolumeChart();
            } else {
                 document.getElementById('volumeChart').closest('.card').innerHTML += '<p style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞.</p>';
                 document.getElementById('exerciseVolumeChart').closest('.card').innerHTML += '<p style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞.</p>';
            }
        }

        function getVolumeData() {
            const data = {};
            workouts.forEach(w => {
                const date = formatDate(w.date); // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
                const volume = w.exercises.reduce((sum, e) => sum + e.sets.reduce((v, set) => v + (set.kg * set.reps), 0), 0);
                if (data[date]) {
                    data[date] += volume;
                } else {
                    data[date] = volume;
                }
            });
            return data;
        }
        
        function renderVolumeChart() {
            const data = getVolumeData();
            const labels = Object.keys(data);
            const volumes = labels.map(label => data[label]);

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
            const sortedData = labels.map((label, index) => ({ date: new Date(workouts.find(w => formatDate(w.date) === label)?.date || label), label, volume: volumes[index] }))
                                     .sort((a, b) => a.date - b.date);

            const sortedLabels = sortedData.map(d => d.label);
            const sortedVolumes = sortedData.map(d => d.volume);


            const ctx = document.getElementById('volumeChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedLabels,
                    datasets: [{
                        label: '–û–±—â–∏–π –æ–±—ä–µ–º (–∫–≥)',
                        data: sortedVolumes,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function getExerciseVolumeData() {
            const data = {};
            workouts.forEach(w => {
                w.exercises.forEach(e => {
                    const volume = e.sets.reduce((v, set) => v + (set.kg * set.reps), 0);
                    const name = getExerciseName(e.id);
                    if (data[name]) {
                        data[name] += volume;
                    } else {
                        data[name] = volume;
                    }
                });
            });
            
            const sorted = Object.entries(data)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);
                
            return {
                labels: sorted.map(item => item[0]),
                volumes: sorted.map(item => item[1])
            };
        }
        
        function renderExerciseVolumeChart() {
            const { labels, volumes } = getExerciseVolumeData();

            const ctx = document.getElementById('exerciseVolumeChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–û–±—ä–µ–º (–∫–≥)',
                        data: volumes,
                        backgroundColor: '#764ba2',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        function getMostFrequentExercises() {
            const counts = {};
            workouts.forEach(w => {
                w.exercises.forEach(e => {
                    counts[e.id] = (counts[e.id] || 0) + 1;
                });
            });

            return Object.entries(counts)
                .map(([id, count]) => ({ id: parseInt(id), count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
        }
        
        function renderNewWorkout() {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
            if (currentWorkout.length > 0) {
                go('start_workout', { restore: true });
                return;
            }

            let h = `
                <div class="card">
                    <div class="title">–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>
                    <input type="text" id="workoutName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="startWorkout()">–ù–∞—á–∞—Ç—å —Å –Ω—É–ª—è</button>
                    </div>
                </div>

                <div class="card">
                    <div class="title">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω</div>
                    ${routines.length === 0 ? '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤.</p>' : ''}
                    ${routines.map(r => `
                        <div class="list-item" onclick="startWorkoutFromRoutine(${r.id})">
                            <div class="item-details">
                                ${r.name}
                                <small>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: ${r.exercises.length}</small>
                            </div>
                            <div class="item-actions">
                                <span style="color: #764ba2;">‚Üí</span>
                            </div>
                        </div>
                    `).join('')}
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="go('routines')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏</button>
                    </div>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }
        
        function startWorkout() {
            const name = document.getElementById('workoutName').value.trim();
            const newWorkoutData = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString(),
                startTime: new Date().toISOString(),
                endTime: null,
                exercises: []
            };
            currentWorkout = newWorkoutData;
            isEditingWorkout = false;
            save();
            go('start_workout');
        }

        function startWorkoutFromRoutine(routineId) {
            const routine = routines.find(r => r.id === routineId);
            if (!routine) return;

            const name = document.getElementById('workoutName').value.trim() || routine.name;
            const newWorkoutData = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString(),
                startTime: new Date().toISOString(),
                endTime: null,
                exercises: routine.exercises.map(e => ({
                    id: e.id,
                    sets: e.sets.map(s => ({
                        kg: s.kg || 0,
                        reps: s.reps || 0
                    }))
                }))
            };
            currentWorkout = newWorkoutData;
            isEditingWorkout = false;
            save();
            go('start_workout');
        }

        function renderStartWorkout(data = {}) {
            if (currentWorkout.length === 0 && !data.restore) {
                go('new_workout');
                return;
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" (–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ –æ–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é, —Å–±—Ä–∞—Å—ã–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É)
            tg.BackButton.show().onClick(() => {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ—Ä–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é? –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                    currentWorkout = [];
                    isEditingWorkout = false;
                    save();
                    if (window.workoutTimer) clearInterval(window.workoutTimer);
                    go('home');
                }
            });

            tg.setHeaderColor('secondary_bg_color');
            tg.MainButton.setText('–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É').show().onClick(finishWorkout);

            let h = `
                <div class="header-card" style="background: #333;">
                    <h2 id="currentWorkoutName">${currentWorkout.name || '–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</h2>
                    <p style="opacity: 0.8; margin-top: 5px;">–ù–∞—á–∞–ª–æ: ${new Date(currentWorkout.startTime).toLocaleTimeString('ru-RU')}</p>
                    <p style="opacity: 0.8; margin-top: 5px;">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <span id="timer">00:00:00</span></p>
                </div>

                <div class="card" id="exercisesList">
                    ${currentWorkout.exercises.map((e, exIndex) => renderWorkoutExercise(e, exIndex)).join('')}
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="go('select_exercise', { from: 'workout' })">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                    </div>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
            
            // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
            if (window.workoutTimer) clearInterval(window.workoutTimer);
            window.workoutTimer = setInterval(updateTimer, 1000);
        }

        function renderWorkoutExercise(ex, exIndex) {
            return `
                <div class="card" id="ex-${exIndex}">
                    <div class="title" style="display: flex; justify-content: space-between; align-items: center;">
                        ${getExerciseName(ex.id)}
                        <button class="btn-danger" style="padding: 5px 10px; font-size: 0.9em; flex-grow: 0;" onclick="deleteExerciseFromWorkout(${exIndex})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    
                    ${ex.sets.map((set, setIndex) => `
                        <div class="set-row">
                            <div class="set-number">${setIndex + 1}</div>
                            <input class="kg-input" type="number" value="${set.kg}" onchange="updateSet(${exIndex}, ${setIndex}, 'kg', this.value)" placeholder="–ö–≥">
                            <input class="reps-input" type="number" value="${set.reps}" onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)" placeholder="–ü–æ–≤—Ç">
                            <button class="delete-set-btn" onclick="deleteSet(${exIndex}, ${setIndex})">üóëÔ∏è</button>
                        </div>
                    `).join('')}

                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="addSet(${exIndex})">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
                    </div>
                </div>
            `;
        }
        
        function updateSet(exIndex, setIndex, field, value) {
            currentWorkout.exercises[exIndex].sets[setIndex][field] = parseFloat(value) || 0;
            save();
        }

        function addSet(exIndex) {
            currentWorkout.exercises[exIndex].sets.push({ kg: 0, reps: 0 });
            save();
            renderStartWorkout({ restore: true });
        }

        function deleteSet(exIndex, setIndex) {
            currentWorkout.exercises[exIndex].sets.splice(setIndex, 1);
            save();
            renderStartWorkout({ restore: true });
        }

        function deleteExerciseFromWorkout(exIndex) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${getExerciseName(currentWorkout.exercises[exIndex].id)}"?`)) {
                currentWorkout.exercises.splice(exIndex, 1);
                save();
                renderStartWorkout({ restore: true });
            }
        }

        function finishWorkout() {
            if (confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?')) {
                // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö —Å–µ—Ç–æ–≤
                currentWorkout.exercises = currentWorkout.exercises
                    .map(e => ({
                        id: e.id,
                        sets: e.sets.filter(s => s.kg > 0 || s.reps > 0)
                    }))
                    .filter(e => e.sets.length > 0);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                if (currentWorkout.exercises.length === 0) {
                    alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—É—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
                    currentWorkout = [];
                    isEditingWorkout = false;
                    save();
                    if (window.workoutTimer) clearInterval(window.workoutTimer);
                    go('home');
                    return;
                }

                currentWorkout.endTime = new Date().toISOString();
                workouts.unshift(currentWorkout); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
                
                // –°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                currentWorkout = [];
                isEditingWorkout = false;
                save();
                
                if (window.workoutTimer) clearInterval(window.workoutTimer);
                tg.MainButton.hide();
                tg.BackButton.hide();
                alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                go('home');
            }
        }

        // --- View Workout ---
        function renderViewWorkout(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) {
                alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                go('home');
                return;
            }

            let h = `
                <div class="header-card">
                    <h2>${workout.name || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}</h2>
                    <p style="opacity: 0.8; margin-top: 5px;">–î–∞—Ç–∞: ${formatDate(workout.date)}</p>
                    <p style="opacity: 0.8; margin-top: 5px;">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${getWorkoutDuration(workout.startTime, workout.endTime)}</p>
                </div>

                <div class="card">
                    <div class="title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
                    ${workout.exercises.map(e => `
                        <div class="card" style="padding: 10px; margin-bottom: 8px; background: #fafafa;">
                            <div class="title" style="margin-bottom: 5px;">${getExerciseName(e.id)}</div>
                            <small>
                                ${e.sets.map(s => `${s.kg}–∫–≥ x ${s.reps}`).join(', ')}
                            </small>
                        </div>
                    `).join('')}
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="editWorkout(${workout.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-danger" onclick="deleteWorkout(${workout.id})">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }

        function editWorkout(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) return;
            
            currentWorkout = JSON.parse(JSON.stringify(workout)); // –ö–æ–ø–∏—Ä—É–µ–º –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            isEditingWorkout = true;
            save();
            go('edit_workout', { workoutId });
        }

        function renderEditWorkout(data) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º currentWorkout –∫–∞–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –æ–±—ä–µ–∫—Ç
            if (currentWorkout.length === 0) { go('home'); return; }

            tg.setHeaderColor('secondary_bg_color');
            tg.MainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è').show().onClick(() => saveEditedWorkout(data.workoutId));
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            tg.BackButton.show().onClick(() => { 
                currentWorkout = []; // –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                isEditingWorkout = false;
                save();
                go('view_workout', data.workoutId); 
            });


            let h = `
                <div class="header-card" style="background: #333;">
                    <input type="text" id="editWorkoutName" value="${currentWorkout.name || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞'}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏" style="color: white; background: rgba(255, 255, 255, 0.2); border: none;">
                    <p style="opacity: 0.8; margin-top: 5px;">–î–∞—Ç–∞: ${formatDate(currentWorkout.date)}</p>
                </div>

                <div class="card" id="exercisesList">
                    ${currentWorkout.exercises.map((e, exIndex) => renderWorkoutExercise(e, exIndex)).join('')}
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-secondary" onclick="go('select_exercise', { from: 'edit', originalId: data.workoutId })">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                    </div>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }

        function saveEditedWorkout(originalId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è
            currentWorkout.name = document.getElementById('editWorkoutName').value.trim();
            
            // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö —Å–µ—Ç–æ–≤
            currentWorkout.exercises = currentWorkout.exercises
                .map(e => ({
                    id: e.id,
                    sets: e.sets.filter(s => s.kg > 0 || s.reps > 0)
                }))
                .filter(e => e.sets.length > 0);

            if (currentWorkout.exercises.length === 0) {
                alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—É—Å—Ç–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –£–¥–∞–ª–∏—Ç–µ –µ–µ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ.');
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º –∏ –∑–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
            const index = workouts.findIndex(w => w.id === originalId);
            if (index !== -1) {
                workouts[index] = JSON.parse(JSON.stringify(currentWorkout));
            }

            currentWorkout = [];
            isEditingWorkout = false;
            save();
            alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            go('view_workout', originalId);
        }

        function deleteWorkout(workoutId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) {
                workouts = workouts.filter(w => w.id !== workoutId);
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                go('home');
            }
        }

        // --- Routines ---

        function renderRoutines() {
            let h = `
                <div class="header-card">
                    <h2>–®–∞–±–ª–æ–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>
                    <p style="opacity: 0.8;">–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞.</p>
                    <div class="btn-group" style="margin-top: 24px;">
                        <button class="btn btn-add" onclick="go('add_routine')">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω</button>
                    </div>
                </div>

                <div class="card">
                    <div class="title">–°–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤</div>
                    ${routines.length === 0 ? '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤.</p>' : ''}
                    ${routines.map(r => `
                        <div class="routine-item card" style="margin-bottom: 8px;">
                            <div class="list-item" onclick="go('add_routine', ${r.id})">
                                <div class="item-details">
                                    ${r.name}
                                    <small>
                                        ${r.exercises.map(e => getExerciseName(e.id)).join(', ')}
                                    </small>
                                </div>
                            </div>
                            <div class="btn-group" style="margin-top: 0; padding-top: 10px; border-top: 1px solid #eee;">
                                <button class="btn btn-secondary" onclick="startWorkoutFromRoutine(${r.id})">–ù–∞—á–∞—Ç—å</button>
                                <button class="btn btn-danger" onclick="deleteRoutine(${r.id})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }

        function renderAddRoutine(routineId) {
            let routine = routineId ? routines.find(r => r.id === routineId) : { id: null, name: '', exercises: [] };
            
            tg.MainButton.setText(routineId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω' : '–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω').show().onClick(() => saveRoutine(routineId));

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            window.currentEditingRoutine = routine;

            let h = `
                <div class="header-card">
                    <h2>${routineId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–°–æ–∑–¥–∞–Ω–∏–µ'} —à–∞–±–ª–æ–Ω–∞</h2>
                </div>

                <div class="card">
                    <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</div>
                    <input type="text" id="routineName" value="${routine.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–í–µ—Ä—Ö —Ç–µ–ª–∞')">
                </div>

                <div class="card">
                    <div class="title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
                    <div id="routineExercisesList">
                        ${routine.exercises.map((e, index) => renderRoutineExercise(e, index)).join('')}
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="go('select_exercise', { from: 'routine', routineId: routineId })">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                    </div>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
            
        }

        function renderRoutineExercise(ex, exIndex) {
            return `
                <div class="card" style="padding: 10px; margin-bottom: 8px; background: #fafafa;">
                    <div class="title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        ${getExerciseName(ex.id)}
                        <button class="btn-danger" style="padding: 5px 10px; font-size: 0.9em; flex-grow: 0;" onclick="deleteExerciseFromRoutine(${exIndex})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    
                    <small>
                        –ë–∞–∑–æ–≤—ã–µ –ø–æ–¥—Ö–æ–¥—ã: ${ex.sets.map(s => `${s.kg}–∫–≥ x ${s.reps}`).join(', ')}
                    </small>
                    
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="editRoutineSets(${exIndex})">–†–µ–¥. –ø–æ–¥—Ö–æ–¥—ã</button>
                    </div>
                    <div id="routineSetsEdit-${exIndex}" style="display:none; margin-top: 10px;">
                        ${ex.sets.map((set, setIndex) => `
                            <div class="set-row">
                                <div class="set-number">${setIndex + 1}</div>
                                <input class="kg-input" type="number" value="${set.kg}" onchange="updateRoutineSet(${exIndex}, ${setIndex}, 'kg', this.value)" placeholder="–ö–≥">
                                <input class="reps-input" type="number" value="${set.reps}" onchange="updateRoutineSet(${exIndex}, ${setIndex}, 'reps', this.value)" placeholder="–ü–æ–≤—Ç">
                                <button class="delete-set-btn" onclick="deleteRoutineSet(${exIndex}, ${setIndex})">üóëÔ∏è</button>
                            </div>
                        `).join('')}
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="addRoutineSet(${exIndex})">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function editRoutineSets(exIndex) {
            const el = document.getElementById(`routineSetsEdit-${exIndex}`);
            if (el.style.display === 'none') {
                el.style.display = 'block';
            } else {
                el.style.display = 'none';
            }
        }
        
        function updateRoutineSet(exIndex, setIndex, field, value) {
            window.currentEditingRoutine.exercises[exIndex].sets[setIndex][field] = parseFloat(value) || 0;
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω"
        }
        
        function addRoutineSet(exIndex) {
            window.currentEditingRoutine.exercises[exIndex].sets.push({ kg: 0, reps: 0 });
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            go('add_routine', window.currentEditingRoutine.id); 
        }
        
        function deleteRoutineSet(exIndex, setIndex) {
            window.currentEditingRoutine.exercises[exIndex].sets.splice(setIndex, 1);
            go('add_routine', window.currentEditingRoutine.id);
        }

        function deleteExerciseFromRoutine(exIndex) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${getExerciseName(window.currentEditingRoutine.exercises[exIndex].id)}" –∏–∑ —à–∞–±–ª–æ–Ω–∞?`)) {
                window.currentEditingRoutine.exercises.splice(exIndex, 1);
                go('add_routine', window.currentEditingRoutine.id);
            }
        }
        
        function saveRoutine(originalId) {
            const name = document.getElementById('routineName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞!');
                return;
            }
            if (window.currentEditingRoutine.exercises.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ!');
                return;
            }

            // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö —Å–µ—Ç–æ–≤
            window.currentEditingRoutine.exercises = window.currentEditingRoutine.exercises
                .map(e => ({
                    id: e.id,
                    sets: e.sets.filter(s => s.kg > 0 || s.reps > 0)
                }))
                .filter(e => e.sets.length > 0);
            
            if (window.currentEditingRoutine.exercises.length === 0) {
                alert('–®–∞–±–ª–æ–Ω –ø—É—Å—Ç –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏. –î–æ–±–∞–≤—å—Ç–µ —Å–µ—Ç—ã!');
                return;
            }

            const newRoutine = {
                id: originalId || Date.now(),
                name: name,
                exercises: window.currentEditingRoutine.exercises
            };

            if (originalId) {
                const index = routines.findIndex(r => r.id === originalId);
                if (index !== -1) {
                    routines[index] = newRoutine;
                }
            } else {
                routines.push(newRoutine);
            }

            window.currentEditingRoutine = null;
            save();
            alert('‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            go('routines');
        }

        function deleteRoutine(routineId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
                routines = routines.filter(r => r.id !== routineId);
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                renderRoutines();
            }
        }
        
        // --- Exercises ---

        function renderExercises() {
            let h = `
                <div class="header-card">
                    <h2>–ë–∞–∑–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</h2>
                    <p style="opacity: 0.8;">–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</p>
                    <div class="btn-group" style="margin-top: 24px;">
                        <button class="btn btn-add" onclick="go('add_exercise')">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ</button>
                    </div>
                </div>

                <div class="card">
                    <div class="title">–°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>
                    ${exercises.length === 0 ? '<p>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</p>' : ''}
                    ${exercises.map(e => `
                        <div class="list-item" onclick="go('add_exercise', ${e.id})">
                            <div class="item-details">
                                ${e.name}
                                <small>${e.isCustom ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ' : ''}</small>
                            </div>
                            <div class="item-actions">
                                <button class="btn-danger" style="padding: 5px 10px; font-size: 0.9em;" onclick="event.stopPropagation(); deleteExercise(${e.id})">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }

        function renderAddExercise(exerciseId) {
            let exercise = exerciseId ? exercises.find(e => e.id === exerciseId) : { id: null, name: '' };
            
            tg.MainButton.setText(exerciseId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ–∑–¥–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ').show().onClick(() => saveExercise(exerciseId));

            let h = `
                <div class="header-card">
                    <h2>${exerciseId ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–ù–æ–≤–æ–µ'} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</h2>
                </div>

                <div class="card">
                    <div class="title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                    <input type="text" id="exerciseName" value="${exercise.name}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, '–ñ–∏–º –ª–µ–∂–∞'">
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }

        function saveExercise(originalId) {
            const name = document.getElementById('exerciseName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è!');
                return;
            }

            const newExercise = {
                id: originalId || Date.now(),
                name: name,
                isCustom: true
            };

            if (originalId) {
                const index = exercises.findIndex(e => e.id === originalId);
                if (index !== -1) {
                    exercises[index] = newExercise;
                }
            } else {
                if (exercises.some(e => e.name.toLowerCase() === name.toLowerCase())) {
                    alert('–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                    return;
                }
                exercises.push(newExercise);
            }

            save();
            alert('‚úÖ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const prevContext = contextStack.pop();
            if (prevContext && prevContext.page === 'select_exercise') {
                // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –≤—ã–±–æ—Ä–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≤—ã–±–æ—Ä, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                go('select_exercise', prevContext.data);
            } else {
                 go('exercises');
            }
        }

        function deleteExercise(exerciseId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ? –û–Ω–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –∏–∑ –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫!')) {
                exercises = exercises.filter(e => e.id !== exerciseId);
                
                // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤
                routines.forEach(r => {
                    r.exercises = r.exercises.filter(e => e.id !== exerciseId);
                });

                // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
                workouts.forEach(w => {
                    w.exercises = w.exercises.filter(e => e.id !== exerciseId);
                });

                // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∏–¥–µ—Ç
                if (currentWorkout.exercises) {
                    currentWorkout.exercises = currentWorkout.exercises.filter(e => e.id !== exerciseId);
                }
                
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                renderExercises();
            }
        }
        
        // --- Add Exercise to Workout/Routine ---

        function renderSelectExercise(context) {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É/—à–∞–±–ª–æ–Ω
            tg.BackButton.show().onClick(() => {
                if (context.from === 'workout') {
                    go('start_workout', { restore: true });
                } else if (context.from === 'edit') {
                    go('edit_workout', { workoutId: context.originalId });
                } else if (context.from === 'routine') {
                    go('add_routine', context.routineId);
                } else {
                    goBack(); // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                }
            });

            // –ù—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ —Å–æ–∑–¥–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            contextStack.push({ page: 'select_exercise', data: context });


            let h = `
                <div class="header-card">
                    <h2>–í—ã–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</h2>
                    <p style="opacity: 0.8;">–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.</p>
                </div>

                <div class="card">
                    <div class="title">–î–æ—Å—Ç—É–ø–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
                    <input type="text" id="searchEx" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterExercises(this.value)">
                    <div id="exerciseSelectionList">
                        ${exercises.map(e => `
                            <div class="list-item" onclick="addSelectedExercise(${e.id}, ${JSON.stringify(context).replace(/"/g, "'")})">
                                <div class="item-details">${e.name}</div>
                                <div class="item-actions">
                                    <span style="color: #764ba2;">+</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="go('add_exercise', null)">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }

        function filterExercises(query) {
            const list = document.getElementById('exerciseSelectionList');
            const items = list.getElementsByClassName('list-item');
            const q = query.toLowerCase();

            for (let i = 0; i < items.length; i++) {
                const text = items[i].querySelector('.item-details').textContent.toLowerCase();
                if (text.includes(q)) {
                    items[i].style.display = 'flex';
                } else {
                    items[i].style.display = 'none';
                }
            }
        }

        function addSelectedExercise(exId, context) {
            const newExData = {
                id: exId,
                sets: [{ kg: 0, reps: 0 }]
            };

            // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç select_exercise –∏–∑ —Å—Ç–µ–∫–∞, —Ç.–∫. –º—ã —É—Ö–æ–¥–∏–º –¥–∞–ª—å—à–µ
            contextStack.pop(); 

            if (context.from === 'workout' || context.from === 'edit') {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —Ç–µ–∫—É—â—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                currentWorkout.exercises.push(newExData);
                save();
                go(context.from === 'edit' ? 'edit_workout' : 'start_workout', context.from === 'edit' ? { workoutId: context.originalId } : { restore: true });
            } else if (context.from === 'routine') {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —à–∞–±–ª–æ–Ω
                if (window.currentEditingRoutine.exercises.some(e => e.id === exId)) {
                    alert('–≠—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ —à–∞–±–ª–æ–Ω–µ!');
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
                    go('select_exercise', context); 
                    return;
                }
                window.currentEditingRoutine.exercises.push(newExData);
                go('add_routine', context.routineId);
            }
        }
        
        // --- Settings ---
        function renderSettings() {
            let h = `
                <div class="header-card">
                    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                </div>

                <div class="card">
                    <div class="title">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="go('exercises')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="go('routines')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏</button>
                    </div>
                </div>

                <div class="card">
                    <div class="title">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</div>
                    <div class="btn-group">
                        <button class="btn btn-danger" onclick="resetAll()">–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ</button>
                    </div>
                </div>

                <div class="card" style="text-align: center;">
                    <p style="color: #666; font-size: 14px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ **v2.3** (FIX –ù–∞–≤–∏–≥–∞—Ü–∏–∏)<br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
                </div>
            `;
            app.innerHTML = h;
            tg.expand();
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï?')) {
                if (confirm('–¢–æ—á–Ω–æ? –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    isEditingWorkout = false;
                    localStorage.clear();
                    alert('üî• –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    go('home'); // Rerender from home
                }
            }
        }
        
        // --- Timer Functions ---

        function updateTimer() {
            const timerEl = document.getElementById('timer');
            if (timerEl && currentWorkout.startTime) {
                timerEl.textContent = getWorkoutDuration(currentWorkout.startTime, new Date().toISOString());
            }
        }

        // --- Initialization ---

        function init() {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è MainButton
            tg.onEvent('mainButtonClicked', finishWorkout);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–µ
            if (currentWorkout.startTime) {
                go('start_workout', { restore: true });
            } else {
                go('home');
            }
        }

        init();
    </script>
</body>
</html>
