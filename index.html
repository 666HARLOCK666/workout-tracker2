<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Трекер Тренировок</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 8px;
            padding: 8px 0;
        }
        .stat-item p:first-child { 
            font-size: 11px; 
            opacity: 0.8; 
            margin-bottom: 2px; 
            line-height: 1.1;
        }
        .stat-item p:last-child { 
            font-size: 20px; 
            font-weight: bold; 
            line-height: 1.2;
        }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { padding: 20px; border-radius: 12px; border: none; color: white; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-green { background: #10b981; }
        .btn-orange { background: #f59e0b; }
        .btn-blue { background: #3b82f6; }
        .btn-purple { background: #8b5cf6; }
        .card { 
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .back-btn { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            width: 36px;
            height: 36px;
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            line-height: 1; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.4);
            padding-right: 2px;
        }
        .save-btn { 
            background: #10b981; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4); 
        }
        input[type="text"], input[type="date"], input[type="number"], select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .exercise-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #f9f9f9; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            cursor: pointer; 
        }
        .delete-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .set-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .set-label { font-weight: 600; width: 100px; }
        .month-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px; 
        }
        .month-nav button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .month-nav h3 { 
            font-size: 20px; 
            color: #333; 
            text-transform: capitalize;
        }
        .calendar-header { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin-bottom: 8px; 
        }
        .calendar-header div { 
            font-weight: 600; 
            text-align: center; 
            color: #666; 
            font-size: 14px; 
        }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            cursor: pointer; 
            border: none; 
        }
        .day-empty { background: #f0f0f0; }
        .day-padding { 
            background: #f9f9f9; 
            opacity: 0.8; 
        } 
        .day-workout { background: #10b981; color: white; font-weight: bold; }
        .day-today { box-shadow: 0 0 0 2px #3b82f6; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .hide { display: none; }
        canvas { max-width: 100%; height: 250px !important; }

        /* --- НОВЫЕ СТИЛИ ДЛЯ ДИНАМИЧЕСКИХ ПОКАЗАТЕЛЕЙ --- */
        .dynamic-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        .dynamic-stat-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>
    <script>
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null; 
        let expandedExId = null; // <<< СТАТУС ДЛЯ ИНЛАЙН-РЕДАКТИРОВАНИЯ
        let selectedExStatsId = null; // <<< НОВЫЙ СТАТУС ДЛЯ СТАТИСТИКИ

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
                workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            } catch (e) {
                console.error("Ошибка загрузки данных из localStorage:", e);
                exercises = [];
                workouts = [];
                routines = [];
            }
            render();
        }

        function save() {
            try {
                localStorage.setItem('workout-exercises', JSON.stringify(exercises));
                localStorage.setItem('workout-logs', JSON.stringify(workouts));
                localStorage.setItem('workout-routines', JSON.stringify(routines)); 
            } catch (e) {
                console.error("Ошибка сохранения данных в localStorage:", e);
            }
        }
        
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `workout_tracker_data_${date}.json`;
            
            a.click();
            URL.revokeObjectURL(url);
            
            alert('✅ Данные экспортированы!');
        }

        function importData() {
            if (!confirm('Внимание! Импорт заменит ВСЕ текущие данные (упражнения, тренировки и шаблоны). Продолжить?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.exercises || !importedData.workouts || !importedData.routines) {
                            throw new Error("Неверный формат файла данных. Должен содержать exercises, workouts и routines.");
                        }
                        
                        exercises = importedData.exercises;
                        workouts = importedData.workouts;
                        routines = importedData.routines;

                        save();
                        alert('✅ Данные успешно импортированы!');
                        go('home'); 
                    } catch (error) {
                        alert('❌ Ошибка импорта: ' + error.message);
                        console.error('Import Error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }


        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines, 
                editRoutine: renderEditRoutine, 
                newWorkout: renderNewWorkout,
                editWorkout: renderEditWorkout,
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail, 
                editExercise: renderEditExercise,
            };
            document.getElementById('view').innerHTML = views[currentView]();
            window.scrollTo(0, 0); 
        }

        function go(view) {
            currentView = view;
            if (view === 'calendar' || view === 'home') {
                 // Сброс даты только при переходе на главную или в календарь
            } else if (view !== 'calendar') {
                currentViewDate = new Date(); // Сброс месяца при выходе из календаря
            }
            
            if (currentView !== 'editExercise') {
                selectedExIdEdit = null;
            }
            if (currentView !== 'editRoutine') {
                selectedRoutineIdEdit = null;
                currentWorkout = []; // Очистка буфера, если не сохранили/отменили
            }
            if (currentView !== 'newWorkout' && currentView !== 'editWorkout') {
                expandedExId = null; // Сброс статуса раскрытия
            }
            if (currentView !== 'exerciseStats') {
                selectedExStatsId = null; // Сброс ID статистики
            }
            render();
        }
        
        function changeMonth(offset) {
            currentViewDate.setDate(1); 
            currentViewDate.setMonth(currentViewDate.getMonth() + offset);
            render(); 
        }

        function viewHomeExDetail(exId) {
            selExIdHome = exId;
            go('homeExDetail');
        }
        
        // --- НОВАЯ ФУНКЦИЯ ДЛЯ СТАТИСТИКИ ---
        function viewExerciseStats(exId) {
            if (exId === 'total') {
                selectedExStatsId = 'total';
            } else {
                const ex = exercises.find(e => e.id === exId);
                if (!ex) return;
                selectedExStatsId = exId;
            }
            go('exerciseStats');
        }

        // НОВАЯ ФУНКЦИЯ: Переключение раскрытия упражнения
        function toggleExExpansion(exId) {
            expandedExId = expandedExId === exId ? null : exId;
            render();
        }

        function editEx(id) {
            selectedExIdEdit = id;
            go('editExercise');
        }

        function editRoutine(id) { 
            selectedRoutineIdEdit = id;
            go('editRoutine');
        }

        // НОВАЯ ФУНКЦИЯ: Обработчик клика по дате в календаре
        function viewDetail(dateStr) {
            selectedDate = dateStr;
            go('detail');
        }

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            const monday = new Date(d.setDate(diff));
            monday.setHours(12, 0, 0, 0); 
            return monday.toISOString().split('T')[0];
        }

        function getWeeklyStreak() {
            if (!workouts.length) return 0;
            const uniqueWeekIds = new Set(workouts.map(w => getMonday(w.date)));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 
            let currentMonday = new Date(getMonday(curr));
            
            while (true) {
                const id = currentMonday.toISOString().split('T')[0];
                if (uniqueWeekIds.has(id)) {
                    streak++;
                    currentMonday.setDate(currentMonday.getDate() - 7);
                } else {
                    break;
                }
                if (streak > 260) break; 
            }
            return streak;
        }

        function getStreak() {
            if (!workouts.length) return 0;
            const dates = new Set(workouts.map(w => w.date));
            let streak = 0;
            let curr = new Date();
            curr.setHours(12, 0, 0, 0); 

            for (let i = 0; i < 365; i++) {
                const ds = curr.toISOString().split('T')[0];
                const isToday = i === 0 && dates.has(ds);
                const isYesterday = i > 0 && dates.has(ds);

                if (isToday || isYesterday) {
                    streak++;
                    curr.setDate(curr.getDate() - 1);
                } else if (i === 0 && dates.has(ds) === false) { // Сегодня не было тренировки, стрик прерывается (если не вчера)
                    break;
                } else {
                    break;
                }
            }
            return streak;
        }

        function calculateSetVolume(set, type) {
            const reps = parseFloat(set.reps || 0);
            const weight = parseFloat(set.weight || 0);
            if (type === 'weight') {
                return weight * reps; 
            } else if (type === 'distance') {
                return weight * 1000 + reps; // Вес = дистанция, Повт = время. Дистанция важнее.
            } else if (type === 'time') {
                return weight * 1000 + reps; // Вес = время, Повт = дистанция. Время важнее.
            } else if (type === 'reps') {
                return reps; 
            }
            return 0;
        }

        function calculateWorkoutVolume(workout) {
            let totalVolume = 0;
            workout.exercises.forEach(ex => {
                const baseEx = exercises.find(e => e.id === ex.exerciseId);
                const type = baseEx ? baseEx.type : 'reps';
                
                ex.sets.forEach(set => {
                    totalVolume += calculateSetVolume(set, type);
                });
            });
            return Math.round(totalVolume); 
        }
        
        function getMaxSetVolume(exerciseId) {
            let maxVolume = 0;
            workouts.forEach(w => {
                const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                if (ex) {
                    const baseEx = exercises.find(e => e.id === ex.exerciseId);
                    const type = baseEx ? baseEx.type : 'reps';

                    ex.sets.forEach(set => {
                        const volume = calculateSetVolume(set, type);
                        if (volume > maxVolume + 0.001) { 
                            maxVolume = volume;
                        }
                    });
                }
            });
            return maxVolume;
        }

        function renderHome() {
            const dayStreak = getStreak();
            const weekStreak = getWeeklyStreak(); 
            const todayDateStr = new Date().toISOString().split('T')[0]; 
            const today = workouts.find(w => w.date === todayDateStr); 
            let h = `
                <div class="header-card">
                    <h1 style="font-size: 24px; margin-bottom: 8px;">💪 Трекер Тренировок</h1>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <p>Стрик</p>
                            <p>(Дни) 🔥</p>
                            <p>${dayStreak}</p>
                        </div>
                        <div class="stat-item">
                            <p>Стрик</p>
                            <p>(Недели) 🗓️</p>
                            <p>${weekStreak}</p>
                        </div>
                        <div class="stat-item">
                            <p>Всего</p>
                            <p>Тренировок</p>
                            <p>${workouts.length}</p>
                        </div>
                    </div>
                </div>
                <div class="btn-grid">
                    <button class="btn btn-green" onclick="go('newWorkout')"><span style="font-size: 32px;">➕</span><span>Новая тренировка</span></button>
                    <button class="btn btn-orange" onclick="go('exercises')"><span style="font-size: 32px;">🏋️</span><span>Упражнения</span></button>
                    <button class="btn btn-purple" onclick="go('routines')"><span style="font-size: 32px;">📋</span><span>Шаблоны</span></button>
                    <button class="btn btn-blue" onclick="go('calendar')"><span style="font-size: 32px;">📅</span><span>Календарь</span></button>
                </div>
                <button class="btn btn-purple" onclick="go('stats')" style="width: 100%; margin-top: 12px; background: #8b5cf6;">
                    <span style="font-size: 20px;">📊 Статистика</span>
                </button>
                <button class="btn btn-blue" onclick="go('settings')" style="width: 100%; margin-top: 12px; background: #6b7280; margin-bottom: 16px;">
                    <span style="font-size: 20px;">⚙️ Настройки</span>
                </button>
            `;
            if (today) {
                h += `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">Сегодняшняя тренировка</h3>
                        <button onclick="editToday()" class="save-btn" style="background: #3b82f6; box-shadow: none; padding: 8px 12px; font-size: 16px;">✏️ Редактировать</button>
                    </div>`;
                today.exercises.forEach(ex => {
                    const e = exercises.find(e => e.id === ex.exerciseId);
                    const t = e ? e.type : 'reps';
                    const totalReps = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                    let d = '';
                    if (t === 'weight') {
                        const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                        d = `${ex.sets.length} подходов • ${totalReps} повт • ${Math.round(tw)} кг`;
                    } else if (t === 'distance') {
                        const td = ex.sets.reduce((s, set) => s + (set.weight || 0), 0); // weight field used for distance
                        d = `${ex.sets.length} подходов • ${td.toFixed(1)} км`;
                    } else if (t === 'time') {
                        const tt = ex.sets.reduce((s, set) => s + (set.weight || 0), 0); // weight field used for time
                        d = `${ex.sets.length} подходов • ${Math.round(tt)} мин`;
                    } else { // reps
                        d = `${ex.sets.length} подходов • ${totalReps} повторений`;
                    }
                    
                    h += `<div style="padding: 12px 0; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="viewHomeExDetail('${ex.exerciseId}')">
                        <div>
                            <div style="font-weight: 600;">${ex.exerciseName}</div>
                            <div style="color: #666; font-size: 14px;">${d}</div>
                        </div>
                        <span style="font-size: 24px; color: #bbb;">›</span>
                    </div>`;
                });
                h += '</div>';
            }
            return h;
        }

        function renderHomeExerciseDetail() {
            if (!selExIdHome) return go('home'); 
            const todayDate = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayDate);
            if (!wo) { selExIdHome = null; return go('home'); } 
            const ex = wo.exercises.find(e => e.exerciseId === selExIdHome);
            if (!ex) { selExIdHome = null; return go('home'); } 
            const eBase = exercises.find(e => e.id === ex.exerciseId);
            const t = eBase ? eBase.type : 'reps';
            
            const maxVol = getMaxSetVolume(ex.exerciseId);

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">←</button>
                        <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.exerciseName}</h2>
                        <div style="width: 36px;"></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Подходы</h3>`;

            ex.sets.forEach((set, index) => {
                const setVol = calculateSetVolume(set, t);
                const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01);
                const prLabel = isPR ? ' <span style="font-size: 10px; color: white; background: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: bold; margin-left: 4px;">PR</span>' : '';

                let setDetails = '';
                if (t === 'weight') {
                    setDetails = `${set.weight || '?'} кг x ${set.reps || '?'} повт`;
                } else if (t === 'distance') {
                    setDetails = `${set.weight || '?'} км за ${set.reps || '?'} мин`;
                } else if (t === 'time') {
                    setDetails = `${set.weight || '?'} мин за ${set.reps || '?'} км`;
                } else { // reps
                    setDetails = `${set.reps || '?'} повт`;
                }
                
                h += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                        <div style="font-weight: 600;">${index + 1}. ${setDetails}${prLabel}</div>
                        <div style="font-size: 14px; color: #666;">Объем: ${Math.round(setVol)} ед.</div>
                    </div>`;
            });
            h += `</div>`;
            
            let sum = '';
            if (t === 'weight') {
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                const tw = ex.sets.reduce((s, set) => s + (set.weight || 0) * (set.reps || 0), 0);
                sum = `${ex.sets.length} подходов • ${tr} повт • ${Math.round(tw)} кг общий`;
            } else if (t === 'distance') {
                const td = ex.sets.reduce((s, set) => s + (set.weight || 0), 0); 
                const tt = ex.sets.reduce((s, set) => s + (set.reps || 0), 0); 
                sum = `${ex.sets.length} подходов • ${td.toFixed(1)} км • ${Math.round(tt)} мин`;
            } else if (t === 'time') {
                const tt = ex.sets.reduce((s, set) => s + (set.weight || 0), 0); 
                const td = ex.sets.reduce((s, set) => s + (set.reps || 0), 0); 
                sum = `${ex.sets.length} подходов • ${Math.round(tt)} мин • ${td.toFixed(1)} км`;
            } else { // reps
                const tr = ex.sets.reduce((s, set) => s + (set.reps || 0), 0);
                sum = `${ex.sets.length} подходов • ${tr} повторений`;
            }
            h += `<div class="card"><p style="font-weight: 600;">Итог:</p> ${sum}</div>`;
            
            return h;
        }

        function renderExercises() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">←</button>
                        <h2>Упражнения</h2>
                        <button class="save-btn" onclick="go('editExercise')">➕</button>
                    </div>
                    <div class="card">`;
            if (exercises.length === 0) {
                h += `<div class="empty-state">Нет добавленных упражнений. Нажмите ➕ чтобы добавить.</div>`;
            }
            exercises.forEach(ex => {
                h += `<div class="exercise-item" onclick="editEx('${ex.id}')"> 
                    <div style="font-weight: 600;">${ex.name}</div>
                    <span style="font-size: 24px; color: #bbb;">›</span>
                </div>`;
            });
            h += `</div>`;
            return h;
        }

        function renderEditExercise() {
            const isNew = !selectedExIdEdit;
            let ex = { id: Date.now().toString(), name: '', type: 'reps' };
            if (!isNew) {
                const foundEx = exercises.find(e => e.id === selectedExIdEdit);
                if (foundEx) { ex = foundEx; } else { go('exercises'); return ''; }
            }

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('exercises')">←</button>
                        <h2>${isNew ? 'Новое упражнение' : 'Редактировать'}</h2>
                        <button class="save-btn" onclick="saveEditEx()">✅</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Название</h3>
                        <input type="text" id="editExName" placeholder="Название упражнения" value="${ex.name}">
                        
                        <h3 style="margin-top: 16px; margin-bottom: 12px;">Тип данных</h3>
                        <select id="editExType">
                            <option value="reps" ${ex.type === 'reps' ? 'selected' : ''}>Повторения</option>
                            <option value="weight" ${ex.type === 'weight' ? 'selected' : ''}>Вес + Повторения</option>
                            <option value="distance" ${ex.type === 'distance' ? 'selected' : ''}>Расстояние (км) + Время (мин)</option>
                            <option value="time" ${ex.type === 'time' ? 'selected' : ''}>Время (мин) + Расстояние (км)</option>
                        </select>
                    </div>`;
            
            if (!isNew) {
                h += `<div class="card">
                        <button class="btn btn-green" style="width: 100%; padding: 12px; background: #ef4444;" onclick="delEx('${ex.id}', true)">🗑️ Удалить упражнение</button>
                    </div>`;
            }
            return h;
        }

        function saveEditEx() {
            const isNew = !selectedExIdEdit;
            let exId = isNew ? Date.now().toString() : selectedExIdEdit;
            const exIndex = exercises.findIndex(e => e.id === exId);
            
            const newName = document.getElementById('editExName').value.trim();
            const newType = document.getElementById('editExType').value;

            if (!newName) { alert('Название не может быть пустым'); return; }

            if (isNew) {
                exercises.push({ id: exId, name: newName, type: newType });
            } else {
                exercises[exIndex] = { ...exercises[exIndex], name: newName, type: newType };
                // Обновляем имя в логах тренировок
                workouts.forEach(wo => {
                    wo.exercises.forEach(woEx => {
                        if (woEx.exerciseId === exId) { woEx.exerciseName = newName; }
                    });
                });
                // Обновляем имя в шаблонах
                routines.forEach(rt => {
                    rt.exercises.forEach(rtEx => {
                        if (rtEx.exerciseId === exId) { rtEx.exerciseName = newName; }
                    });
                });
            }
            save();
            go('exercises');
        }

        function delEx(exId, confirmDelete = false) {
            if (!confirmDelete || confirm(`Вы уверены, что хотите удалить упражнение "${exercises.find(e => e.id === exId)?.name}"? Все записи о нем в тренировках также будут удалены.`)) {
                exercises = exercises.filter(ex => ex.id !== exId);
                workouts.forEach(wo => {
                    wo.exercises = wo.exercises.filter(ex => ex.exerciseId !== exId);
                });
                routines.forEach(rt => {
                    rt.exercises = rt.exercises.filter(ex => ex.exerciseId !== exId);
                });
                save();
                go('exercises');
            }
        }
        
        function renderRoutines() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">←</button>
                        <h2>Шаблоны</h2>
                        <button class="save-btn" onclick="document.getElementById('addRoutineModal').classList.remove('hide')">➕</button>
                    </div>
                    <div class="card">`;
            
            if (routines.length === 0) {
                h += `<div class="empty-state">Нет добавленных шаблонов. Нажмите ➕ чтобы добавить.</div>`;
            }
            
            routines.forEach(rt => {
                const exCount = rt.exercises.length;
                h += `<div class="exercise-item" onclick="editRoutine('${rt.id}')"> 
                    <div>
                        <div style="font-weight: 600;">${rt.name}</div>
                        <div style="color: #666; font-size: 14px;">${exCount} ${numbForm(exCount, ['упражнение', 'упражнения', 'упражнений'])}</div>
                    </div>
                    <span style="font-size: 24px; color: #bbb;">›</span>
                </div>`;
            });
            
            h += `</div>`;
            h += renderAddRoutineModal();
            return h;
        }

        function renderAddRoutineModal() {
            let h = `<div id="addRoutineModal" class="hide" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 100; display: flex; justify-content: center; align-items: center;">
                        <div class="card" style="max-width: 400px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); padding: 20px;">
                            <h3 style="margin-bottom: 16px;">Новый шаблон</h3>
                            <input type="text" id="newRoutineName" placeholder="Название шаблона" style="margin-bottom: 16px;">
                            <button class="btn btn-green" style="width: 100%; padding: 12px; margin-bottom: 8px;" onclick="addRoutine()">Создать</button>
                            <button class="btn btn-orange" style="width: 100%; padding: 12px; background: #ef4444;" onclick="document.getElementById('addRoutineModal').classList.add('hide')">Отмена</button>
                        </div>
                    </div>`;
            return h;
        }

        function numbForm(number, titles) {
            number = Math.abs(number);
            const cases = [2, 0, 1, 1, 1, 2];
            if (number % 100 > 4 && number % 100 < 20) return titles[2];
            if (number % 100 !== 11) return titles[cases[number % 10 < 5 ? number % 10 : 5]];
            return titles[2];
        }

        function addRoutine() {
            const inp = document.getElementById('newRoutineName');
            const name = inp.value.trim();
            if (name) {
                routines.push({ id: Date.now().toString(), name: name, exercises: [] });
                save();
                document.getElementById('addRoutineModal').classList.add('hide');
                editRoutine(routines[routines.length - 1].id); // Переходим сразу к редактированию
            } else {
                alert('Введите название шаблона.');
            }
        }
        
        // --- ИСПРАВЛЕНИЕ: Функция для отмены редактирования шаблона ---
        function cancelEditRoutine() {
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            go('routines');
        }
        // -----------------------------------------------------------

        function renderEditRoutine() { 
            if (!selectedRoutineIdEdit) return go('routines');
            const rt = routines.find(r => r.id === selectedRoutineIdEdit);
            if (!rt) return go('routines');
            
            // Если мы только что перешли на страницу, загружаем упражнения шаблона в буфер.
            if (currentWorkout.length === 0) {
                currentWorkout = JSON.parse(JSON.stringify(rt.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: [] // Шаблон не хранит сеты, только список упражнений
                }))));
            }

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="cancelEditRoutine()">←</button>
                        <h2>${rt.name}</h2>
                        <button class="save-btn" onclick="saveRoutine()">✅</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Название шаблона</h3>
                        <input type="text" id="editRoutineName" placeholder="Название шаблона" value="${rt.name}">
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Упражнения в шаблоне</h3>`;
            
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">Нажмите "Добавить упражнение"</div>`;
            }
            
            currentWorkout.forEach(ex => {
                h += `<div class="exercise-item"> 
                    <div style="font-weight: 600;">${ex.exerciseName}</div>
                    <button class="delete-btn" onclick="removeExFromRoutine('${ex.exerciseId}')">❌</button>
                </div>`;
            });
            
            h += `</div>
                    <div class="btn-grid" style="grid-template-columns: 1fr;">
                        <button class="btn btn-blue" onclick="showAddExModal('routine')">➕ Добавить упражнение</button>
                        <button class="btn btn-orange" onclick="delRoutine('${rt.id}')" style="background: #ef4444;">🗑️ Удалить шаблон</button>
                    </div>`;

            h += renderAddExModal('routine');
            return h;
        }
        
        function saveRoutine() {
            if (!selectedRoutineIdEdit) return;
            const rtIndex = routines.findIndex(r => r.id === selectedRoutineIdEdit);
            if (rtIndex === -1) return;
            
            const newName = document.getElementById('editRoutineName').value.trim();
            if (!newName) { alert('Название не может быть пустым'); return; }
            
            // Сохраняем только exerciseId и exerciseName
            const routineExercises = currentWorkout.map(ex => ({
                exerciseId: ex.exerciseId,
                exerciseName: ex.exerciseName 
            }));

            routines[rtIndex] = { 
                ...routines[rtIndex], 
                name: newName, 
                exercises: routineExercises
            };
            
            save();
            currentWorkout = [];
            selectedRoutineIdEdit = null;
            alert('✅ Шаблон сохранен!');
            go('routines');
        }

        function delRoutine(routineId) {
            if (confirm(`Удалить шаблон "${routines.find(r => r.id === routineId)?.name}"?`)) {
                routines = routines.filter(rt => rt.id !== routineId);
                save();
                currentWorkout = [];
                go('routines');
            }
        }
        
        function addExToRoutine(exId, exName) {
            currentWorkout.push({ exerciseId: exId, exerciseName: exName, sets: [] }); 
            document.getElementById('addExModal').classList.add('hide');
            render();
        }
        
        function removeExFromRoutine(exId) {
            currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
            render();
        }

        function renderNewWorkout() {
            const today = new Date().toISOString().split('T')[0];
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">←</button>
                        <h2>Новая тренировка</h2>
                        <button class="save-btn" onclick="saveWorkout()">💾</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Дата</h3>
                        <input type="date" id="workoutDate" value="${selectedDate}">
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Упражнения в тренировке</h3>`;
            
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">Нажмите "Добавить упражнение"</div>`;
            }
            
            currentWorkout.forEach(ex => {
                const eBase = exercises.find(e => e.id === ex.exerciseId);
                const t = eBase ? eBase.type : 'reps';
                const isExpanded = ex.exerciseId === expandedExId;
                const maxVol = getMaxSetVolume(ex.exerciseId);
                
                // Exercise header
                h += `<div class="exercise-item" style="margin-bottom: ${isExpanded ? '8px' : '0'}; flex-wrap: wrap; cursor: pointer; border-bottom: ${isExpanded ? 'none' : '1px solid #f0f0f0'};" onclick="toggleExExpansion('${ex.exerciseId}')"> 
                    <div style="font-weight: 600; flex-grow: 1;">${ex.exerciseName}</div>
                    <div style="color: #666; font-size: 14px; margin-right: 8px;">${ex.sets.length} ${numbForm(ex.sets.length, ['подход', 'подхода', 'подходов'])}</div>
                    <span style="font-size: 20px; color: #bbb;">${isExpanded ? '▼' : '›'}</span>
                    <button class="delete-btn" style="color: #ef4444; font-size: 16px; margin-left: 8px;" onclick="event.stopPropagation(); removeExFromWorkout('${ex.exerciseId}');">❌</button>
                </div>`;
                
                if (isExpanded) {
                    h += `<div style="padding: 8px 0; border-top: 1px solid #ddd; margin-bottom: 8px; padding-bottom: 12px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px; font-style: italic;">Нажмите на строку упражнения, чтобы свернуть.</div>`;

                    // Sets list - Inline Editing
                    ex.sets.forEach((set, index) => { 
                        const setVol = calculateSetVolume(set, t);
                        const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01);
                        const prLabel = isPR ? ' <span style="font-size: 10px; color: white; background: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: bold; margin-left: 4px;">PR</span>' : '';
                        
                        h += `<div class="set-row" style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; align-items: stretch; flex-wrap: wrap;">
                                <div style="font-weight: 600; width: 30px; margin-right: 8px; display: flex; align-items: center; justify-content: flex-start;">
                                    ${index + 1}.${prLabel}
                                </div>`;
                        
                        if (t === 'weight') {
                            // Weight and Reps
                            h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Вес (кг)</span>
                                    <input type="number" inputmode="decimal" step="0.5" placeholder="кг" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Повт</span>
                                    <input type="number" inputmode="numeric" placeholder="повт" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        } else if (t === 'distance') {
                            // Distance and Time
                            h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Дистанция (км)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="км" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Время (мин)</span>
                                    <input type="number" inputmode="numeric" step="1" placeholder="мин" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        } else if (t === 'time') {
                            // Time and Distance
                            h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Время (мин)</span>
                                    <input type="number" inputmode="numeric" step="1" placeholder="мин" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Дистанция (км)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="км" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        } else { // 'reps'
                            // Reps only (using the reps field)
                            h += `<div style="flex: 2; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Повторения</span>
                                    <input type="number" inputmode="numeric" placeholder="повт" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        }

                        h += `<button class="delete-btn" style="color: #ef4444; margin-left: 8px; padding: 0 4px;" onclick="deleteSetForEx('${ex.exerciseId}', ${index})">❌</button>
                            </div>`;

                    }); // End sets loop

                    h += `<button class="btn btn-green" style="width: 100%; padding: 8px; margin-top: 8px;" onclick="addSetForEx('${ex.exerciseId}')">➕ Добавить подход</button>`;
                    
                    h += `</div>`; // Close expanded content div
                } else {
                    h += `<div style="height: 1px; background: #f0f0f0;"></div>`; // Separator if not expanded
                }
            }); // End exercises loop
            h += `</div>
                    <div class="btn-grid" style="grid-template-columns: 1fr;">
                        <button class="btn btn-blue" onclick="showAddExModal('workout')">➕ Добавить упражнение</button>
                    </div>`;

            if (routines.length > 0) {
                h += `<div class="card">
                        <h3 style="margin-bottom: 12px;">Загрузить шаблон</h3>
                        <select id="loadRoutineSelect" onchange="loadRoutine(this.value)" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
                            <option value="">Выберите шаблон...</option>`;
                routines.forEach(rt => {
                    h += `<option value="${rt.id}">${rt.name}</option>`;
                });
                h += `</select></div>`;
            }

            h += renderAddExModal('workout');
            return h;
        }
        
        function saveWorkout() {
            const date = document.getElementById('workoutDate').value;
            if (!date) { alert('Укажите дату!'); return; }
            if (currentWorkout.length === 0) { alert('Добавьте хотя бы одно упражнение!'); return; }
            
            // Фильтрация пустых сетов
            const exercisesToSave = currentWorkout.map(ex => ({
                ...ex,
                sets: ex.sets.filter(set => set.weight !== '' || set.reps !== '')
            })).filter(ex => ex.sets.length > 0);

            if (exercisesToSave.length === 0) {
                alert('Необходимо заполнить хотя бы один подход в упражнении.');
                return;
            }
            
            const newWorkout = {
                id: Date.now().toString(),
                date: date,
                exercises: exercisesToSave
            };

            // Проверка на редактирование
            const existingIndex = workouts.findIndex(w => w.date === date);
            if (existingIndex !== -1) {
                if (confirm('На эту дату уже есть тренировка. Заменить ее?')) {
                    workouts.splice(existingIndex, 1);
                } else {
                    return;
                }
            }
            
            workouts.push(newWorkout);
            workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            save();
            currentWorkout = [];
            expandedExId = null; // Сброс
            alert('✅ Тренировка сохранена!');
            go('home');
        }

        function removeExFromWorkout(exId) {
            currentWorkout = currentWorkout.filter(ex => ex.exerciseId !== exId);
            if (expandedExId === exId) { expandedExId = null; }
            render();
        }

        function editToday() {
            const todayDateStr = new Date().toISOString().split('T')[0]; 
            editWorkout(todayDateStr);
        }

        function editWorkout(date) {
            selectedDate = date;
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) return go('calendar'); 
            
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            go('editWorkout');
        }

        function renderEditWorkout() {
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) return go('calendar'); 
            
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('detail')">←</button>
                        <h2>Редактировать</h2>
                        <button class="save-btn" onclick="saveEditWorkout()">✅</button>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Дата</h3>
                        <input type="date" id="workoutDate" value="${selectedDate}">
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Упражнения в тренировке</h3>`;
            
            // Тот же код инлайн-редактирования, что и в renderNewWorkout
            if (currentWorkout.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">Нажмите "Добавить упражнение"</div>`;
            }
            
            currentWorkout.forEach(ex => {
                const eBase = exercises.find(e => e.id === ex.exerciseId);
                const t = eBase ? eBase.type : 'reps';
                const isExpanded = ex.exerciseId === expandedExId;
                const maxVol = getMaxSetVolume(ex.exerciseId);
                
                // Exercise header
                h += `<div class="exercise-item" style="margin-bottom: ${isExpanded ? '8px' : '0'}; flex-wrap: wrap; cursor: pointer; border-bottom: ${isExpanded ? 'none' : '1px solid #f0f0f0'};" onclick="toggleExExpansion('${ex.exerciseId}')"> 
                    <div style="font-weight: 600; flex-grow: 1;">${ex.exerciseName}</div>
                    <div style="color: #666; font-size: 14px; margin-right: 8px;">${ex.sets.length} ${numbForm(ex.sets.length, ['подход', 'подхода', 'подходов'])}</div>
                    <span style="font-size: 20px; color: #bbb;">${isExpanded ? '▼' : '›'}</span>
                    <button class="delete-btn" style="color: #ef4444; font-size: 16px; margin-left: 8px;" onclick="event.stopPropagation(); removeExFromWorkout('${ex.exerciseId}');">❌</button>
                </div>`;
                
                if (isExpanded) {
                    h += `<div style="padding: 8px 0; border-top: 1px solid #ddd; margin-bottom: 8px; padding-bottom: 12px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px; font-style: italic;">Нажмите на строку упражнения, чтобы свернуть.</div>`;

                    // Sets list - Inline Editing
                    ex.sets.forEach((set, index) => { 
                        const setVol = calculateSetVolume(set, t);
                        const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01);
                        const prLabel = isPR ? ' <span style="font-size: 10px; color: white; background: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: bold; margin-left: 4px;">PR</span>' : '';
                        
                        h += `<div class="set-row" style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #eee; align-items: stretch; flex-wrap: wrap;">
                                <div style="font-weight: 600; width: 30px; margin-right: 8px; display: flex; align-items: center; justify-content: flex-start;">
                                    ${index + 1}.${prLabel}
                                </div>`;
                        
                        if (t === 'weight') {
                            // Weight and Reps
                            h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Вес (кг)</span>
                                    <input type="number" inputmode="decimal" step="0.5" placeholder="кг" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Повт</span>
                                    <input type="number" inputmode="numeric" placeholder="повт" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        } else if (t === 'distance') {
                            // Distance and Time
                            h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Дистанция (км)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="км" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Время (мин)</span>
                                    <input type="number" inputmode="numeric" step="1" placeholder="мин" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        } else if (t === 'time') {
                            // Time and Distance
                            h += `<div style="flex: 1; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Время (мин)</span>
                                    <input type="number" inputmode="numeric" step="1" placeholder="мин" value="${set.weight || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'weight', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; margin-left: 8px;">
                                    <span style="font-size: 12px; color: #666;">Дистанция (км)</span>
                                    <input type="number" inputmode="decimal" step="0.1" placeholder="км" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        } else { // 'reps'
                            // Reps only (using the reps field)
                            h += `<div style="flex: 2; display: flex; flex-direction: column;">
                                    <span style="font-size: 12px; color: #666;">Повторения</span>
                                    <input type="number" inputmode="numeric" placeholder="повт" value="${set.reps || ''}" oninput="updateSetForEx('${ex.exerciseId}', ${index}, 'reps', this.value)" style="padding: 8px; font-size: 14px; margin-top: 4px;">
                                </div>`;
                        }

                        h += `<button class="delete-btn" style="color: #ef4444; margin-left: 8px; padding: 0 4px;" onclick="deleteSetForEx('${ex.exerciseId}', ${index})">❌</button>
                            </div>`;

                    }); // End sets loop

                    h += `<button class="btn btn-green" style="width: 100%; padding: 8px; margin-top: 8px;" onclick="addSetForEx('${ex.exerciseId}')">➕ Добавить подход</button>`;
                    
                    h += `</div>`; // Close expanded content div
                } else {
                    h += `<div style="height: 1px; background: #f0f0f0;"></div>`; // Separator if not expanded
                }
            }); // End exercises loop
            h += `</div>
                    <div class="btn-grid" style="grid-template-columns: 1fr;">
                        <button class="btn btn-blue" onclick="showAddExModal('workout')">➕ Добавить упражнение</button>
                        <button class="btn btn-orange" onclick="delWorkout('${wo.id}')" style="background: #ef4444;">🗑️ Удалить тренировку</button>
                    </div>`;

            if (routines.length > 0) {
                h += `<div class="card">
                        <h3 style="margin-bottom: 12px;">Загрузить шаблон</h3>
                        <select id="loadRoutineSelect" onchange="loadRoutine(this.value)" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
                            <option value="">Выберите шаблон...</option>`;
                routines.forEach(rt => {
                    h += `<option value="${rt.id}">${rt.name}</option>`;
                });
                h += `</select></div>`;
            }

            h += renderAddExModal('workout');
            return h;
        }

        function saveEditWorkout() {
            const date = document.getElementById('workoutDate').value;
            if (!date) { alert('Укажите дату!'); return; }
            if (currentWorkout.length === 0) { alert('Добавьте хотя бы одно упражнение!'); return; }
            
            // Фильтрация пустых сетов
            const exercisesToSave = currentWorkout.map(ex => ({
                ...ex,
                sets: ex.sets.filter(set => set.weight !== '' || set.reps !== '')
            })).filter(ex => ex.sets.length > 0);

            if (exercisesToSave.length === 0) {
                alert('Необходимо заполнить хотя бы один подход в упражнении.');
                return;
            }

            // Удаляем старую тренировку и добавляем новую
            workouts = workouts.filter(w => w.date !== selectedDate);
            
            const newWorkout = {
                id: Date.now().toString(),
                date: date,
                exercises: exercisesToSave
            };

            // Проверка на дату, если она была изменена
            if (selectedDate !== date) {
                const existingIndex = workouts.findIndex(w => w.date === date);
                if (existingIndex !== -1) {
                    if (confirm('На новую дату уже есть тренировка. Заменить ее?')) {
                        workouts.splice(existingIndex, 1);
                    } else {
                        return;
                    }
                }
            }
            
            workouts.push(newWorkout);
            workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
            save();
            currentWorkout = [];
            expandedExId = null; 
            alert('✅ Тренировка сохранена!');
            selectedDate = date; // Обновляем выбранную дату для перехода в detail
            go('detail');
        }

        function delWorkout(woId) {
            if (confirm('Удалить эту тренировку?')) {
                workouts = workouts.filter(wo => wo.id !== woId);
                save();
                currentWorkout = [];
                go('calendar');
            }
        }

        function showAddExModal(mode) {
            document.getElementById('addExModal').classList.remove('hide');
        }

        function renderAddExModal(mode) {
            let h = `<div id="addExModal" class="hide" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 100; display: flex; justify-content: center; align-items: center;">
                        <div class="card" style="max-width: 400px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4); padding: 20px;">
                            <h3 style="margin-bottom: 16px;">Выберите упражнение</h3>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 8px;">`; 
            if (!exercises.length) {
                h += `<div class="empty-state" style="padding: 10px;">Сначала добавьте упражнения в разделе "Упражнения"</div>`;
            } else {
                exercises.forEach(ex => {
                    if (!currentWorkout.some(cw => cw.exerciseId === ex.id)) {
                        if (mode === 'routine') {
                            h += `<div class="exercise-item" onclick="addExToRoutine('${ex.id}', '${ex.name.replace(/'/g, "\\'")}')"> 
                                <div style="font-weight: 600;">${ex.name}</div>
                                <span style="font-size: 20px; color: #10b981;">➕</span>
                            </div>`;
                        } else {
                            h += `<div class="exercise-item" onclick="addExToWorkout('${ex.id}', '${ex.name.replace(/'/g, "\\'")}')"> 
                                <div style="font-weight: 600;">${ex.name}</div>
                                <span style="font-size: 20px; color: #10b981;">➕</span>
                            </div>`;
                        }
                    }
                });
            }
            h += `</div> 
                        <button class="btn btn-orange" style="width: 100%; padding: 12px; margin-top: 16px; background: #ef4444;" onclick="document.getElementById('addExModal').classList.add('hide')">Отмена</button>
                    </div>
                </div>`;
            return h;
        }

        function addExToWorkout(exId, exName) {
            currentWorkout.push({ exerciseId: exId, exerciseName: exName, sets: [] });
            document.getElementById('addExModal').classList.add('hide');
            expandedExId = exId; // Автоматически раскрыть добавленное упражнение
            render();
        }

        function loadRoutine(routineId) {
            if (!routineId) return;
            if (currentWorkout.length > 0) {
                if (!confirm('Текущая тренировка будет очищена. Продолжить?')) {
                    document.getElementById('loadRoutineSelect').value = '';
                    return;
                }
            }
            
            const routine = routines.find(r => r.id === routineId);
            if (routine) {
                currentWorkout = JSON.parse(JSON.stringify(routine.exercises.map(ex => ({
                    exerciseId: ex.exerciseId,
                    exerciseName: ex.exerciseName,
                    sets: []
                }))));
                alert(`✅ Шаблон "${routine.name}" загружен!`);
                document.getElementById('loadRoutineSelect').value = '';
                render();
            }
        }
        
        // --- ФУНКЦИИ ДЛЯ ИНЛАЙН-РЕДАКТИРОВАНИЯ ---
        
        function addSetForEx(exId) {
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === exId);
            if (exIndex === -1) return;
            const newSet = { setNumber: currentWorkout[exIndex].sets.length + 1, weight: '', reps: '' };
            currentWorkout[exIndex].sets.push(newSet);
            expandedExId = exId; // Сохранить раскрытым
            render(); 
        }

        function deleteSetForEx(exId, index) {
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === exId);
            if (exIndex === -1) return;
            currentWorkout[exIndex].sets.splice(index, 1); 
            // Обновляем номера подходов
            currentWorkout[exIndex].sets.forEach((set, i) => { set.setNumber = i + 1; });
            expandedExId = exId; // Сохранить раскрытым
            render(); 
        }

        function updateSetForEx(exId, index, field, value) {
            const exIndex = currentWorkout.findIndex(ex => ex.exerciseId === exId);
            if (exIndex === -1) return;
            const numVal = parseFloat(value);
            // Сохраняем пустую строку, если не число или просто пробелы
            currentWorkout[exIndex].sets[index][field] = (isNaN(numVal) || value.trim() === '') ? '' : numVal;
            // НЕ вызываем render(), чтобы не прерывать ввод.
        }

        // --- ИМПЛЕМЕНТАЦИЯ КАЛЕНДАРЯ ---

        function renderCalendar() {
            const d = currentViewDate;
            const year = d.getFullYear();
            const month = d.getMonth();
            const todayStr = new Date().toISOString().split('T')[0];
            
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // 0=Вс, 1=Пн... Сдвигаем на 1, чтобы неделя начиналась с Пн
            let startDay = firstDayOfMonth.getDay(); 
            startDay = startDay === 0 ? 6 : startDay - 1; 

            // Находим все даты с тренировками в этом месяце
            const workoutDates = new Set(workouts
                .filter(w => new Date(w.date).getFullYear() === year && new Date(w.date).getMonth() === month)
                .map(w => w.date)
            );

            const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];

            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">←</button>
                        <h2>Календарь</h2>
                        <div style="width: 36px;"></div>
                    </div>
                    <div class="card">
                        <div class="month-nav">
                            <button onclick="changeMonth(-1)">←</button>
                            <h3>${monthNames[month]} ${year}</h3>
                            <button onclick="changeMonth(1)">→</button>
                        </div>
                        <div class="calendar-header">
                            <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
                        </div>
                        <div class="calendar-grid">`;
            
            // Пустые дни до начала месяца
            for (let i = 0; i < startDay; i++) {
                h += `<div class="calendar-day day-padding"></div>`;
            }

            // Дни месяца
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const hasWorkout = workoutDates.has(dateStr);
                const isToday = dateStr === todayStr;
                
                let classes = 'calendar-day';
                if (hasWorkout) { classes += ' day-workout'; } 
                if (isToday) { classes += ' day-today'; }
                
                h += `<button class="${classes}" onclick="viewDetail('${dateStr}')">${day}</button>`;
            }
            
            h += `</div></div>`;
            return h;
        }

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            const dateDisplay = new Date(selectedDate).toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('calendar')">←</button>
                        <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${dateDisplay}</h2>
                        <div style="width: 36px;"></div>
                    </div>`;

            if (wo) {
                const totalVolume = calculateWorkoutVolume(wo);
                
                h += `<div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0;">Тренировка</h3>
                            <button onclick="editWorkout('${selectedDate}')" class="save-btn" style="background: #3b82f6; box-shadow: none; padding: 8px 12px; font-size: 16px;">✏️ Редактировать</button>
                        </div>
                        <p style="font-size: 14px; color: #666; margin-bottom: 16px;">Общий объем: ${totalVolume} ед.</p>
                        
                        <h3 style="margin-bottom: 12px; padding-top: 8px; border-top: 1px solid #f0f0f0;">Упражнения</h3>`;

                wo.exercises.forEach(ex => {
                    const e = exercises.find(e => e.id === ex.exerciseId);
                    const t = e ? e.type : 'reps';
                    
                    let setList = '';
                    let setDetails = '';

                    ex.sets.forEach((set, index) => {
                        const setVol = calculateSetVolume(set, t);
                        const maxVol = getMaxSetVolume(ex.exerciseId);
                        const isPR = (setVol > 0 && Math.abs(setVol - maxVol) < 0.01);
                        const prLabel = isPR ? ' <span style="font-size: 10px; color: white; background: #ef4444; padding: 2px 4px; border-radius: 4px; font-weight: bold; margin-left: 4px;">PR</span>' : '';

                        if (t === 'weight') {
                            setDetails = `${set.weight || '?'} кг x ${set.reps || '?'} повт`;
                        } else if (t === 'distance') {
                            setDetails = `${set.weight || '?'} км за ${set.reps || '?'} мин`;
                        } else if (t === 'time') {
                            setDetails = `${set.weight || '?'} мин за ${set.reps || '?'} км`;
                        } else { // reps
                            setDetails = `${set.reps || '?'} повт`;
                        }
                        setList += `<div style="display: flex; justify-content: space-between; font-size: 14px; color: #333; padding: 4px 0;">
                                        <span>${index + 1}. ${setDetails}${prLabel}</span>
                                        <span style="color: #999;">Объем: ${Math.round(setVol)}</span>
                                    </div>`;
                    });

                    h += `<div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0;">
                                <div style="font-weight: 600; margin-bottom: 8px;">${ex.exerciseName}</div>
                                <div>${setList}</div>
                            </div>`;
                });
                h += `</div>`;
            } else {
                h += `<div class="empty-state">
                        <p style="margin-bottom: 16px;">На эту дату нет тренировок.</p>
                        <button class="btn btn-green" style="padding: 12px 20px; font-size: 16px;" onclick="startNewWorkoutFromDate('${selectedDate}')">➕ Добавить тренировку</button>
                    </div>`;
            }

            return h;
        }

        function startNewWorkoutFromDate(dateStr) {
            selectedDate = dateStr;
            currentWorkout = [];
            go('newWorkout');
        }

        // --- ИМПЛЕМЕНТАЦИЯ СТАТИСТИКИ ---

        function renderGraph(id, labels, data, type = 'line', color = '#3b82f6') {
            const ctx = document.getElementById(id).getContext('2d');
            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Объем / PR',
                        data: data,
                        backgroundColor: color.replace('3b82f6', '3b82f650'), 
                        borderColor: color,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += Math.round(context.parsed.y) + ' ед.'; }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function drawPieChart(id, data, labels, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1) + '%';
                                    return `${label}: ${Math.round(value)} ед. (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateExerciseSummary(exId) {
            let totalVolume = 0;
            let totalWorkouts = 0;
            let maxSetVolume = 0;
            
            const exBase = exercises.find(e => e.id === exId);
            const type = exBase ? exBase.type : 'reps';

            workouts.forEach(w => {
                const ex = w.exercises.find(e => e.exerciseId === exId);
                if (ex) {
                    totalWorkouts++;
                    ex.sets.forEach(set => {
                        const volume = calculateSetVolume(set, type);
                        totalVolume += volume;
                        if (volume > maxSetVolume) { maxSetVolume = volume; }
                    });
                }
            });

            return { totalVolume: Math.round(totalVolume), totalWorkouts, maxSetVolume: Math.round(maxSetVolume) };
        }
        
        function getVolumeData(exId, range) {
            const dataMap = new Map(); // Date -> Volume
            const exBase = exercises.find(e => e.id === exId);
            const type = exBase ? exBase.type : 'reps';
            
            const filteredWorkouts = workouts.filter(w => w.exercises.some(ex => ex.exerciseId === exId));
            
            filteredWorkouts.forEach(w => {
                let workoutVolume = 0;
                const ex = w.exercises.find(e => e.exerciseId === exId);
                if (ex) {
                    ex.sets.forEach(set => {
                        workoutVolume += calculateSetVolume(set, type);
                    });
                }
                dataMap.set(w.date, Math.round(workoutVolume));
            });

            const sortedDates = Array.from(dataMap.keys()).sort((a, b) => new Date(a) - new Date(b));
            
            // Ограничиваем по количеству точек
            const maxPoints = 30;
            const finalDates = sortedDates.slice(Math.max(sortedDates.length - maxPoints, 0));
            
            const labels = finalDates.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
            });
            const data = finalDates.map(d => dataMap.get(d));

            return { labels, data };
        }

        function getPeriodWorkouts(exId, weeks) {
            const exBase = exercises.find(e => e.id === exId);
            const type = exBase ? exBase.type : 'reps';
            
            let totalVolume = 0;
            let workoutCount = 0;
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - (weeks * 7));
            
            workouts.forEach(w => {
                if (new Date(w.date) >= cutoffDate) {
                    const ex = w.exercises.find(e => e.exerciseId === exId);
                    if (ex) {
                        workoutCount++;
                        ex.sets.forEach(set => {
                            totalVolume += calculateSetVolume(set, type);
                        });
                    }
                }
            });
            return { totalVolume: Math.round(totalVolume), workoutCount };
        }

        function renderDynamicStat(label, current, previous) {
            const diff = current - previous;
            let diffStr = '';
            let color = '#666';

            if (diff > 0) {
                diffStr = `(+${diff.toLocaleString()} ед.)`;
                color = '#10b981';
            } else if (diff < 0) {
                diffStr = `(${diff.toLocaleString()} ед.)`;
                color = '#ef4444';
            }

            return `<div class="dynamic-stat-row">
                        <div style="font-weight: 600;">${label} (Последние 4 нед.)</div>
                        <div style="text-align: right;">
                            <span style="font-weight: bold; color: #333;">${current.toLocaleString()} ед.</span>
                            <span style="font-size: 12px; color: ${color}; display: block;">vs 4 нед. назад ${diffStr}</span>
                        </div>
                    </div>`;
        }


        function renderStats() {
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('home')">←</button>
                        <h2>Статистика</h2>
                        <div style="width: 36px;"></div>
                    </div>`;
            
            if (workouts.length === 0) {
                h += `<div class="card"><div class="empty-state">Нет данных для статистики. Начните с тренировки!</div></div>`;
                return h;
            }

            // 1. Общая статистика - ПАЙ ЧАРТ
            const totalWorkouts = workouts.length;
            const exDistribution = {};
            let totalOverallVolume = 0;

            workouts.forEach(wo => {
                wo.exercises.forEach(ex => {
                    if (!exDistribution[ex.exerciseId]) {
                        exDistribution[ex.exerciseId] = { name: ex.exerciseName, volume: 0 };
                    }
                    
                    const exBase = exercises.find(e => e.id === ex.exerciseId);
                    const type = exBase ? exBase.type : 'reps';
                    
                    ex.sets.forEach(set => {
                        const vol = calculateSetVolume(set, type);
                        exDistribution[ex.exerciseId].volume += vol;
                        totalOverallVolume += vol;
                    });
                });
            });

            const topEx = Object.values(exDistribution).sort((a, b) => b.volume - a.volume).slice(0, 5);
            const otherVolume = totalOverallVolume - topEx.reduce((sum, ex) => sum + ex.volume, 0);

            let chartData = topEx.map(ex => ex.volume);
            let chartLabels = topEx.map(ex => ex.name);
            let chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#666']; 

            if (otherVolume > 0) {
                chartData.push(otherVolume);
                chartLabels.push('Прочее');
            }


            h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">Общее распределение объема</h3>
                    <div style="height: 250px;"><canvas id="volumePieChart"></canvas></div>
                    <div style="margin-top: 20px;">
                        <p style="font-weight: 600; margin-bottom: 4px;">Всего тренировок: ${totalWorkouts}</p>
                        <p style="font-weight: 600;">Общий объем: ${Math.round(totalOverallVolume).toLocaleString()} ед.</p>
                    </div>
                    <div style="text-align: right; margin-top: 12px;">
                         <button class="save-btn" style="background: #3b82f6; box-shadow: none; padding: 6px 12px;" onclick="viewExerciseStats('total')">Детали</button>
                    </div>
                  </div>`;


            // 2. Список упражнений (кликабельный)
            h += `<div class="card">
                    <h3 style="margin-bottom: 12px;">Статистика по упражнениям</h3>`;
            
            if (exercises.length === 0) {
                h += `<div class="empty-state" style="padding: 20px;">Нет упражнений для отображения.</div>`;
            } else {
                exercises.forEach(ex => {
                    const summary = calculateExerciseSummary(ex.id);
                    if (summary.totalWorkouts > 0) {
                        h += `<div class="exercise-item" onclick="viewExerciseStats('${ex.id}')"> 
                            <div>
                                <div style="font-weight: 600;">${ex.name}</div>
                                <div style="color: #666; font-size: 14px;">PR: ${summary.maxSetVolume} ед. | Тренировок: ${summary.totalWorkouts}</div>
                            </div>
                            <span style="font-size: 24px; color: #bbb;">›</span>
                        </div>`;
                    }
                });
                // Если ни по одному упражнению нет данных
                if (exercises.every(ex => calculateExerciseSummary(ex.id).totalWorkouts === 0)) {
                    h += `<div class="empty-state" style="padding: 20px;">Нет записей по упражнениям.</div>`;
                }
            }
            
            h += `</div>`;

            // Вызываем отрисовку пай-чарта после рендеринга DOM
            setTimeout(() => {
                if (document.getElementById('volumePieChart')) {
                    drawPieChart('volumePieChart', chartData, chartLabels, chartColors);
                }
            }, 0);
            
            return h;
        }

        function renderExerciseStats() {
            if (!selectedExStatsId) return go('stats');

            if (selectedExStatsId === 'total') {
                return renderTotalStatsDetail();
            }

            const ex = exercises.find(e => e.id === selectedExStatsId);
            if (!ex) return go('stats');
            
            const summary = calculateExerciseSummary(ex.id);
            const volumeData = getVolumeData(ex.id, 30); // Последние 30 тренировок

            // Динамика: Сравниваем объем за последние 4 недели с объемом за 4 недели до этого
            const current4Weeks = getPeriodWorkouts(ex.id, 4);
            const prev4Weeks = getPeriodWorkouts(ex.id, 8);
            
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('stats')">←</button>
                        <h2 style="max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ex.name}</h2>
                        <div style="width: 36px;"></div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">График объема (последние ${volumeData.labels.length} тренировок)</h3>
                        <div style="height: 250px;"><canvas id="exVolumeChart"></canvas></div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Динамика</h3>
                        ${renderDynamicStat('Объем тренировок', current4Weeks.totalVolume, prev4Weeks.totalVolume)}
                        <div class="dynamic-stat-row" style="border-bottom: none;">
                            <div style="font-weight: 600;">PR (Макс. объем подхода)</div>
                            <div style="font-weight: bold;">${summary.maxSetVolume} ед.</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Общие показатели</h3>
                        <p>Всего тренировок с упр.: <span style="font-weight: bold;">${summary.totalWorkouts}</span></p>
                        <p>Общий выполненный объем: <span style="font-weight: bold;">${summary.totalVolume.toLocaleString()} ед.</span></p>
                    </div>`;

            // Вызываем отрисовку графика
            setTimeout(() => {
                if (document.getElementById('exVolumeChart')) {
                    renderGraph('exVolumeChart', volumeData.labels, volumeData.data, 'line', '#3b82f6');
                }
            }, 0);

            return h;
        }
        
        function renderTotalStatsDetail() {
            // ... (Временно оставим заглушку, чтобы не усложнять. Главное - запустить календарь и статистику упражнений)
            let h = `<div class="top-bar">
                        <button class="back-btn" onclick="go('stats')">←</button>
                        <h2>Общая статистика</h2>
                        <div style="width: 36px;"></div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Общий объем по дням</h3>
                        <div class="empty-state">
                            <p>Функция отображения общего объема пока в разработке. Вернитесь позже!</p>
                        </div>
                    </div>`;
            return h;
        }

        function renderSettings() {
             let h = `<div class="top-bar">
                         <button class="back-btn" onclick="go('home')">←</button>
                         <h2>Настройки</h2>
                         <div style="width: 36px;"></div>
                     </div>
                     <div class="card">
                         <h3 style="margin-bottom: 12px;">Данные</h3>
                         <button class="btn btn-blue" style="width: 100%; padding: 12px; margin-bottom: 8px;" onclick="exportData()">⬇️ Экспорт данных</button>
                         <button class="btn btn-blue" style="width: 100%; padding: 12px; background: #f59e0b; margin-bottom: 16px;" onclick="importData()">⬆️ Импорт данных</button>
                         
                         <h3 style="margin-bottom: 12px; color: #ef4444;">Удаление данных</h3>
                         <button class="btn btn-green" style="width: 100%; padding: 12px; background: #ef4444; margin-bottom: 8px;" onclick="resetRoutines()">🗑️ Удалить шаблоны</button>
                         <button class="btn btn-green" style="width: 100%; padding: 12px; background: #ef4444; margin-bottom: 8px;" onclick="resetWo()">🗑️ Удалить тренировки</button>
                         <button class="btn btn-green" style="width: 100%; padding: 12px; background: #ef4444; margin-bottom: 8px;" onclick="resetEx()">🗑️ Удалить упражнения, тренировки и шаблоны</button>
                         <button onclick="resetAll()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">⚠️ СБРОСИТЬ ВСЁ</button></div>
                     <div class="card"><h3 style="margin-bottom: 12px;">О приложении</h3>
                     <p style="color: #666; font-size: 14px;">💪 Трекер Тренировок **v2.1** (Calendar/Stats Fix)<br>Все данные хранятся локально</p></div>`;
             return h;
        }
        
        function resetRoutines() {
            if (confirm('Удалить ВСЕ шаблоны?')) {
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetWo() {
            if (confirm('Удалить ВСЕ тренировки?')) {
                workouts = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetEx() {
            if (confirm('Удалить ВСЕ упражнения, тренировки и шаблоны?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetAll() {
            if (confirm('⚠️ УДАЛИТЬ ВСЕ ДАННЫЕ?')) {
                if (confirm('Точно? Последнее предупреждение!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('🔥 Все данные сброшены. Перезагрузите страницу.');
                    render();
                }
            }
        }

        init();
    </script>
</body>
</html>
