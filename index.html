<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Трекер Тренировок</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center; 
        }
        .stat-item h3 { font-size: 20px; font-weight: 700; }
        .stat-item p { font-size: 12px; opacity: 0.8; }
        .card { 
            background: #fff; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 8px 16px;
            background: #fff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
        .nav-button {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px; /* Увеличен для эстетики */
            background: #fff;
            color: #333;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease-in-out; /* Улучшенная анимация */
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            /* --- ИСПРАВЛЕНИЕ 1: Добавляем выразительность --- */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .nav-button:active {
            background: #f0f0f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05), 0 0 1px rgba(0, 0, 0, 0.05);
            transform: translateY(1px); /* Эффект "нажатия" */
        }
        
        .nav-button.active {
            color: #764ba2;
        }
        .icon { font-size: 20px; margin-bottom: 4px; }
        
        /* --- ИСПРАВЛЕНИЕ 2: Стили календаря --- */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            color: #764ba2;
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 равномерных колонок */
            text-align: center;
            font-weight: 600;
            color: #999;
            margin-bottom: 8px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 равномерных колонок для дней */
            gap: 4px; /* Небольшие промежутки между днями */
        }
        .calendar-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Делает ячейку квадратной (КРИТИЧНОЕ ИСПРАВЛЕНИЕ) */
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            padding: 0; /* Убираем лишний padding */
            line-height: 1; /* Выравнивание текста */
        }
        .calendar-day.prev-month, 
        .calendar-day.next-month {
            opacity: 0.5;
        }
        .calendar-day.has-workout {
            background-color: #e0f7fa; /* Светло-голубой фон для дня с тренировкой */
            font-weight: 600;
        }
        .calendar-day.current-day {
            border: 2px solid #764ba2;
            background-color: #f0e6ff;
        }
        .day-dot {
            width: 6px;
            height: 6px;
            background-color: #764ba2;
            border-radius: 50%;
            margin-top: 2px;
        }
        /* Остальные стили для других экранов... */
        .list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
            cursor: pointer;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item h4 { font-size: 16px; font-weight: 600; }
        .list-item p { font-size: 12px; color: #999; }
        .list-item-right { text-align: right; }
        .button-group { display: flex; gap: 8px; margin-top: 12px; }
        .button-group button { 
            padding: 8px 12px; 
            border-radius: 8px; 
            border: none; 
            font-size: 14px; 
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-primary { background: #764ba2; color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-block { width: 100%; margin-top: 12px; }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .workout-exercise-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .set-row {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            align-items: center;
        }
        .set-row input {
            flex-grow: 1;
            text-align: center;
            margin-bottom: 0;
        }
        .set-row .label {
            font-size: 12px;
            width: 30px;
            text-align: right;
            color: #999;
        }
        .set-row .remove-btn {
            flex-grow: 0;
            width: 30px;
            padding: 8px;
            background: #f0f0f0;
            color: #333;
        }
        .total-stats {
            margin-top: 8px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        .stat-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
            font-size: 14px;
        }
        .stat-detail-item:last-child { border-bottom: none; }
        .chart-container {
             margin-top: 16px;
             padding: 16px;
             background: #fff;
             border-radius: 12px;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .pr-list-item {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .pr-list-item:last-child { border-bottom: none; }
        .pr-name { font-weight: 600; }
        .pr-date { font-size: 12px; color: #999; }
        .pr-value { text-align: right; font-weight: 600; color: #764ba2; }
    </style>
</head>
<body>
    <div id="app" class="container"></div>

    <div id="nav-bar" class="nav-bar">
        </div>

    <script>
        // --- Настройки и Инициализация ---
        const VIEWS = { HOME: 'home', WORKOUT: 'workout', ROUTINES: 'routines', STATS: 'stats', SETTINGS: 'settings' };
        let currentView = VIEWS.HOME;
        let workouts = [];
        let exercises = [];
        let routines = [];
        let currentWorkout = [];
        let currentWorkoutId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentExerciseStatsId = null;

        function save() {
            localStorage.setItem('workouts', JSON.stringify(workouts));
            localStorage.setItem('exercises', JSON.stringify(exercises));
            localStorage.setItem('routines', JSON.stringify(routines));
        }

        function load() {
            const savedWorkouts = localStorage.getItem('workouts');
            const savedExercises = localStorage.getItem('exercises');
            const savedRoutines = localStorage.getItem('routines');

            if (savedWorkouts) workouts = JSON.parse(savedWorkouts);
            if (savedExercises) exercises = JSON.parse(savedExercises);
            if (savedRoutines) routines = JSON.parse(savedRoutines);
        }

        function init() {
            load();
            if (exercises.length === 0) {
                // Инициализация при первом запуске
                exercises = [
                    { id: 1, name: 'Жим лежа', group: 'Грудь' },
                    { id: 2, name: 'Приседания', group: 'Ноги' },
                    { id: 3, name: 'Тяга блока', group: 'Спина' },
                    { id: 4, name: 'Разводка гантелей', group: 'Грудь' },
                    { id: 5, name: 'Жим ногами', group: 'Ноги' },
                    { id: 6, name: 'Подтягивания', group: 'Спина' },
                    { id: 7, name: 'Армейский жим', group: 'Плечи' },
                    { id: 8, name: 'Сгибание рук со штангой', group: 'Бицепс' },
                    { id: 9, name: 'Разгибание рук в блоке', group: 'Трицепс' }
                ];
                save();
            }
            render();
        }

        // --- Навигация и Рендеринг ---
        function setView(view) {
            currentView = view;
            render();
        }

        function renderNavBar() {
            const navBar = document.getElementById('nav-bar');
            const navItems = [
                { view: VIEWS.HOME, icon: '🏠', label: 'Главная' },
                { view: VIEWS.WORKOUT, icon: '📝', label: 'Тренировка' },
                { view: VIEWS.ROUTINES, icon: '📋', label: 'Шаблоны' },
                { view: VIEWS.STATS, icon: '📈', label: 'Статистика' },
                { view: VIEWS.SETTINGS, icon: '⚙️', label: 'Настройки' }
            ];

            navBar.innerHTML = navItems.map(item => `
                <button class="nav-button ${currentView === item.view ? 'active' : ''}" onclick="setView('${item.view}')">
                    <span class="icon">${item.icon}</span>
                    ${item.label}
                </button>
            `).join('');
        }

        function render() {
            renderNavBar();
            const app = document.getElementById('app');
            let html = '';

            switch (currentView) {
                case VIEWS.HOME:
                    html = renderHome();
                    break;
                case VIEWS.WORKOUT:
                    html = renderWorkout();
                    break;
                case VIEWS.ROUTINES:
                    html = renderRoutines();
                    break;
                case VIEWS.STATS:
                    html = renderStats();
                    break;
                case VIEWS.SETTINGS:
                    html = renderSettings();
                    break;
            }

            app.innerHTML = html;
            // Дополнительный рендеринг графиков, если нужно
            if (currentView === VIEWS.STATS && currentExerciseStatsId) {
                renderChart(currentExerciseStatsId);
            }
        }

        // --- Главный экран ---
        function renderHome() {
            const totalWorkouts = workouts.length;
            const totalExercises = new Set(workouts.flatMap(w => w.exercises.map(e => e.exerciseId))).size;
            const totalVolume = workouts.reduce((sum, w) => sum + w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0), 0);
            
            const lastWorkout = workouts.length > 0 ? workouts[workouts.length - 1] : null;
            const lastWorkoutDate = lastWorkout ? new Date(lastWorkout.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }) : 'Нет данных';
            const lastWorkoutName = lastWorkout ? lastWorkout.name : '';

            const h = `
                <div class="header-card">
                    <h2>👋 Привет!</h2>
                    <p style="opacity: 0.8; font-size: 14px;">Твой прогресс за все время:</p>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <h3>${totalWorkouts}</h3>
                            <p>Тренировок</p>
                        </div>
                        <div class="stat-item">
                            <h3>${totalExercises}</h3>
                            <p>Упражнений</p>
                        </div>
                        <div class="stat-item">
                            <h3>${(totalVolume / 1000).toFixed(1)} т</h3>
                            <p>Общий объем</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">Последняя тренировка</h3>
                        <p style="font-size: 14px; color: #764ba2;">${lastWorkoutDate}</p>
                    </div>
                    <p style="font-size: 16px; font-weight: 600;">${lastWorkoutName || 'Начни первую тренировку!'}</p>
                    <div class="button-group" style="margin-top: 16px;">
                        <button class="btn-primary" onclick="startNewWorkout()" style="flex-grow: 1;">▶️ Начать новую</button>
                        ${lastWorkout ? `<button class="btn-secondary" onclick="loadWorkoutFromHistory(${lastWorkout.id})" style="flex-grow: 1;">🔄 Повторить</button>` : ''}
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 12px;">Твой Календарь</h3>
                    ${renderCalendar(currentMonth, currentYear)}
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 12px;">
                        <span style="font-size: 14px;"><span style="color: #764ba2; font-weight: bold;">●</span> Сегодня</span>
                        <span style="font-size: 14px;"><span style="color: #e0f7fa; background: #764ba2; border-radius: 50%; padding: 0 5px;">&nbsp;</span> Тренировка</span>
                    </div>
                </div>
            `;
            return h;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            render();
        }

        // --- ИСПРАВЛЕНИЕ 2: Логика рендеринга календаря ---
        function renderCalendar(month, year) {
            const date = new Date(year, month);
            const today = new Date();
            const startDay = new Date(year, month, 1).getDay(); // 0=Вс, 1=Пн
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();
            
            // Смещаем начало недели на понедельник (если startDay=0 (Вс), то 6, иначе startDay-1)
            const firstDayOfWeek = startDay === 0 ? 6 : startDay - 1; 

            const monthName = date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            const workoutDates = workouts.map(w => new Date(w.date).toDateString());

            let daysHtml = '';

            // Дни предыдущего месяца (для заполнения сетки)
            const numPrevDays = firstDayOfWeek;
            for (let i = numPrevDays - 1; i >= 0; i--) {
                const dayNum = prevMonthDays - i;
                daysHtml += `<div class="calendar-day prev-month">${dayNum}</div>`;
            }

            // Дни текущего месяца
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDate = new Date(year, month, i);
                const isToday = dayDate.toDateString() === today.toDateString();
                const hasWorkout = workoutDates.includes(dayDate.toDateString());

                let classes = '';
                if (isToday) classes += ' current-day';
                if (hasWorkout) classes += ' has-workout';

                daysHtml += `
                    <div class="calendar-day${classes}" onclick="showDayWorkouts('${dayDate.toISOString().split('T')[0]}')">
                        <span>${i}</span>
                        ${hasWorkout ? '<div class="day-dot"></div>' : ''}
                    </div>
                `;
            }

            // Дни следующего месяца (для заполнения сетки до 6 рядов)
            const totalCells = numPrevDays + daysInMonth;
            const numNextDays = 42 - totalCells; // 6 рядов по 7 дней = 42
            
            for (let i = 1; i <= numNextDays; i++) {
                daysHtml += `<div class="calendar-day next-month">${i}</div>`;
            }
            
            return `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button onclick="changeMonth(-1)">&#x25C0;</button>
                        <span>${monthName}</span>
                        <button onclick="changeMonth(1)">&#x25B6;</button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Пн</span><span>Вт</span><span>Ср</span><span>Чт</span><span>Пт</span><span>Сб</span><span>Вс</span>
                    </div>
                    <div class="calendar-grid">
                        ${daysHtml}
                    </div>
                </div>
            `;
        }

        // --- Логика других экранов... (оставляем без изменений) ---

        function showDayWorkouts(dateString) {
            const date = new Date(dateString);
            const dailyWorkouts = workouts.filter(w => new Date(w.date).toDateString() === date.toDateString());
            
            if (dailyWorkouts.length === 0) {
                alert(`На ${date.toLocaleDateString('ru-RU')} тренировок нет.`);
                return;
            }

            let detailsHtml = `<h3>Тренировки за ${date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}</h3>`;
            
            dailyWorkouts.forEach(w => {
                const totalVolume = w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0);
                const totalSets = w.exercises.reduce((sets, e) => sets + e.sets.length, 0);

                detailsHtml += `
                    <div class="card" onclick="viewWorkoutHistory(${w.id})">
                        <h4>${w.name}</h4>
                        <p style="font-size: 12px; color: #999;">${new Date(w.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</p>
                        <div class="total-stats">
                            <span>Объем: ${(totalVolume / 1000).toFixed(1)} т</span>
                            <span>Сетов: ${totalSets}</span>
                        </div>
                    </div>
                `;
            });

            // Использование Telegram WebApp для отображения модального окна или просто alert
            if (window.Telegram && window.Telegram.WebApp) {
                 window.Telegram.WebApp.showAlert(detailsHtml); // Настоящее модальное окно требует более сложного UI
            } else {
                 let alertText = `Тренировки за ${date.toLocaleDateString('ru-RU')}:\n`;
                 dailyWorkouts.forEach(w => {
                     const totalVolume = w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0);
                     alertText += `\n${w.name} (${(totalVolume / 1000).toFixed(1)} т)`;
                 });
                 alert(alertText);
            }
        }
        
        function getExerciseName(id) {
            const ex = exercises.find(e => e.id === id);
            return ex ? ex.name : 'Неизвестное упражнение';
        }

        function calculateWorkoutStats(workout) {
            let totalVolume = 0;
            let totalSets = 0;
            workout.exercises.forEach(ex => {
                totalSets += ex.sets.length;
                ex.sets.forEach(set => {
                    totalVolume += set.weight * set.reps;
                });
            });
            return { totalVolume, totalSets };
        }

        // --- Тренировка (Workouts) ---

        function startNewWorkout() {
            currentWorkout = [];
            currentWorkoutId = Date.now();
            currentView = VIEWS.WORKOUT;
            render();
        }

        function addExercise(id = null) {
            const newExId = id || Date.now();
            currentWorkout.push({
                id: newExId,
                exerciseId: null,
                sets: [{ id: Date.now(), weight: 0, reps: 0 }]
            });
            render();
            // Прокрутка вниз для видимости нового упражнения
            setTimeout(() => {
                document.getElementById(`ex-${newExId}`).scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function selectExercise(workoutExId, exerciseId) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                workoutEx.exerciseId = parseInt(exerciseId);
                render();
            }
        }

        function addSet(workoutExId) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                // Предзаполнение весом из последнего сета
                const lastSet = workoutEx.sets[workoutEx.sets.length - 1] || { weight: 0, reps: 0 };
                workoutEx.sets.push({ id: Date.now(), weight: lastSet.weight, reps: lastSet.reps });
                render();
            }
        }

        function removeSet(workoutExId, setId) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                workoutEx.sets = workoutEx.sets.filter(s => s.id != setId);
                render();
            }
        }

        function updateSet(workoutExId, setId, field, value) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                const set = workoutEx.sets.find(s => s.id == setId);
                if (set) {
                    set[field] = parseFloat(value) || 0;
                }
            }
        }

        function finishWorkout() {
            const workoutName = prompt('Введите название тренировки:', 'Моя тренировка');
            if (!workoutName) return;

            // Фильтрация: убрать упражнения без выбранного id и сеты с 0 весом/повторами
            const finalWorkout = currentWorkout.filter(ex => ex.exerciseId !== null).map(ex => ({
                ...ex,
                sets: ex.sets.filter(s => s.weight > 0 || s.reps > 0)
            })).filter(ex => ex.sets.length > 0);

            if (finalWorkout.length === 0) {
                alert('Тренировка пуста.');
                return;
            }

            const newWorkout = {
                id: currentWorkoutId,
                name: workoutName,
                date: new Date().toISOString(),
                exercises: finalWorkout
            };

            workouts.push(newWorkout);
            save();
            currentWorkout = [];
            currentWorkoutId = null;
            alert('✅ Тренировка сохранена!');
            setView(VIEWS.HOME);
        }

        function renderWorkout() {
            if (currentWorkout.length === 0) {
                setTimeout(() => addExercise(), 0); // Автоматическое добавление первого упражнения
                return `<div class="card"><h3>Начало тренировки...</h3></div>`;
            }

            const allExercises = exercises.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');

            let html = `
                <div class="card">
                    <h2 style="margin-bottom: 12px;">Текущая тренировка</h2>
                    <button class="btn-primary" onclick="addExercise()" style="width: 100%;">➕ Добавить упражнение</button>
                    <div style="margin-top: 12px; font-size: 14px; color: #666;">
                        ${currentWorkout.length} упражнений
                    </div>
                </div>
                <div id="workout-list">
                    ${currentWorkout.map(ex => `
                        <div class="card" id="ex-${ex.id}">
                            <div class="workout-exercise-title">
                                <select 
                                    onchange="selectExercise(${ex.id}, this.value)" 
                                    style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; flex-grow: 1;"
                                >
                                    <option value="" ${ex.exerciseId === null ? 'selected' : ''}>Выберите упражнение</option>
                                    ${exercises.map(e => 
                                        `<option value="${e.id}" ${ex.exerciseId == e.id ? 'selected' : ''}>${e.name}</option>`
                                    ).join('')}
                                </select>
                                <button class="btn-secondary" style="margin-left: 8px;" onclick="removeExercise(${ex.id})">❌</button>
                            </div>
                            
                            <h5 style="margin-top: 12px; margin-bottom: 4px; display: flex; justify-content: space-between;">
                                <span>Сет</span>
                                <span style="flex-grow: 1; text-align: center;">Вес (кг)</span>
                                <span style="flex-grow: 1; text-align: center;">Повт.</span>
                                <span style="width: 30px;"></span>
                            </h5>
                            
                            ${ex.sets.map(set => `
                                <div class="set-row">
                                    <span class="label">${ex.sets.indexOf(set) + 1}</span>
                                    <input 
                                        type="number" 
                                        value="${set.weight}" 
                                        oninput="updateSet(${ex.id}, ${set.id}, 'weight', this.value)"
                                        placeholder="Вес"
                                    >
                                    <input 
                                        type="number" 
                                        value="${set.reps}" 
                                        oninput="updateSet(${ex.id}, ${set.id}, 'reps', this.value)"
                                        placeholder="Повт."
                                    >
                                    <button class="remove-btn" onclick="removeSet(${ex.id}, ${set.id})">x</button>
                                </div>
                            `).join('')}

                            <button class="btn-secondary" onclick="addSet(${ex.id})" style="width: 100%; margin-top: 8px;">➕ Добавить сет</button>
                        </div>
                    `).join('')}
                </div>

                <div style="position: fixed; bottom: 64px; left: 0; right: 0; padding: 16px; background: #f5f5f5; border-top: 1px solid #eee;">
                    <button class="btn-primary" onclick="finishWorkout()" style="width: 100%; padding: 12px; font-size: 16px;">
                        ✅ Завершить и сохранить
                    </button>
                </div>
            `;
            return html;
        }

        function removeExercise(workoutExId) {
            currentWorkout = currentWorkout.filter(ex => ex.id !== workoutExId);
            render();
        }

        function loadWorkoutFromHistory(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (workout) {
                currentWorkoutId = Date.now(); // Новый ID для новой тренировки
                currentWorkout = workout.exercises.map(ex => ({
                    id: Date.now() + Math.random(),
                    exerciseId: ex.exerciseId,
                    sets: ex.sets.map(set => ({
                        id: Date.now() + Math.random() + 1,
                        weight: set.weight,
                        reps: set.reps
                    }))
                }));
                setView(VIEWS.WORKOUT);
            }
        }
        
        // --- Шаблоны (Routines) ---

        function renderRoutines() {
            let html = `
                <div class="card">
                    <h2 style="margin-bottom: 12px;">Шаблоны тренировок</h2>
                    <button class="btn-primary" onclick="showAddRoutineModal()" style="width: 100%;">➕ Создать шаблон</button>
                </div>
                <div id="routines-list">
                    ${routines.length > 0 ? routines.map(r => `
                        <div class="card list-item" onclick="loadRoutine(${r.id})">
                            <div>
                                <h4>${r.name}</h4>
                                <p>${r.exercises.length} упражнений</p>
                            </div>
                            <div class="list-item-right">
                                <button class="btn-secondary" onclick="event.stopPropagation(); editRoutine(${r.id})">✏️</button>
                                <button class="btn-danger" onclick="event.stopPropagation(); deleteRoutine(${r.id})">🗑️</button>
                            </div>
                        </div>
                    `).join('') : '<div class="card"><p style="color: #666;">Пока нет шаблонов. Создайте первый!</p></div>'}
                </div>
            `;
            return html;
        }

        function showAddRoutineModal(routineToEdit = null) {
            const isEdit = !!routineToEdit;
            const routineName = isEdit ? routineToEdit.name : '';
            const routineExercises = isEdit ? routineToEdit.exercises.map(ex => ex.exerciseId) : [];

            let content = `
                <h3>${isEdit ? 'Редактировать шаблон' : 'Новый шаблон'}</h3>
                <input type="text" id="routineName" placeholder="Название шаблона (например, День Груди)" value="${routineName}">
                
                <h4 style="margin-top: 15px; margin-bottom: 10px;">Упражнения:</h4>
                <div id="exerciseChecklist" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                    ${exercises.map(ex => `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                            <label for="ex-${ex.id}">${ex.name} (${ex.group})</label>
                            <input type="checkbox" id="ex-${ex.id}" value="${ex.id}" ${routineExercises.includes(ex.id) ? 'checked' : ''}>
                        </div>
                    `).join('')}
                </div>
                
                <button 
                    class="btn-primary" 
                    onclick="${isEdit ? `saveRoutine(${routineToEdit.id})` : 'saveRoutine()'}" 
                    style="width: 100%; margin-top: 15px;"
                >
                    ${isEdit ? '💾 Сохранить' : '➕ Создать'}
                </button>
            `;

            // В реальном приложении здесь было бы модальное окно. 
            // Используем Telegram WebApp alert как заглушку, хотя это не лучший UI
            if (window.Telegram && window.Telegram.WebApp) {
                // В реальном Telegram Web App нужно использовать кастомный UI. 
                // Здесь будет просто alert для демонстрации логики:
                window.Telegram.WebApp.showAlert('В реальном приложении здесь появится модальное окно для создания/редактирования шаблона.');
            } else {
                 alert('Откройте консоль для отладки, или представьте здесь модальное окно.');
            }
        }
        
        function saveRoutine(id = null) {
            const name = document.getElementById('routineName') ? document.getElementById('routineName').value : prompt('Введите название шаблона:');
            if (!name) return;

            const selectedExercises = [];
            document.querySelectorAll('#exerciseChecklist input:checked').forEach(input => {
                selectedExercises.push({ exerciseId: parseInt(input.value) });
            });

            if (selectedExercises.length === 0) {
                alert('Выберите хотя бы одно упражнение.');
                return;
            }

            if (id) {
                // Редактирование
                const index = routines.findIndex(r => r.id === id);
                if (index !== -1) {
                    routines[index] = { id, name, exercises: selectedExercises };
                }
            } else {
                // Создание
                const newRoutine = {
                    id: Date.now(),
                    name: name,
                    exercises: selectedExercises
                };
                routines.push(newRoutine);
            }

            save();
            render();
            // В реальном приложении: закрыть модальное окно.
        }

        function editRoutine(id) {
            const routine = routines.find(r => r.id === id);
            if (routine) {
                showAddRoutineModal(routine);
            }
        }

        function deleteRoutine(id) {
            if (confirm('Удалить этот шаблон?')) {
                routines = routines.filter(r => r.id !== id);
                save();
                render();
            }
        }

        function loadRoutine(id) {
            const routine = routines.find(r => r.id === id);
            if (routine) {
                if (!confirm(`Начать тренировку по шаблону "${routine.name}"?`)) return;

                currentWorkoutId = Date.now();
                currentWorkout = routine.exercises.map(ex => ({
                    id: Date.now() + Math.random(),
                    exerciseId: ex.exerciseId,
                    sets: [{ id: Date.now() + Math.random() + 1, weight: 0, reps: 0 }]
                }));
                setView(VIEWS.WORKOUT);
            }
        }

        // --- Статистика (Stats) ---

        function renderStats() {
            // Подсчет Total PRs (наибольший вес * повторения для каждого упражнения)
            const prs = calculatePersonalRecords();
            
            const totalVolume = workouts.reduce((sum, w) => sum + w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0), 0);
            
            let html = `
                <div class="card header-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h2 style="margin-bottom: 8px;">Сводка</h2>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <h3>${prs.length}</h3>
                            <p>PR Упражнений</p>
                        </div>
                        <div class="stat-item">
                            <h3>${(totalVolume / 1000).toFixed(1)} т</h3>
                            <p>Общий объем</p>
                        </div>
                        <div class="stat-item">
                            <h3>${workouts.length}</h3>
                            <p>Всего тренировок</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 12px;">Личные Рекорды (PR)</h3>
                    <div id="pr-list">
                        ${prs.map(pr => `
                            <div class="pr-list-item" onclick="viewExerciseStats(${pr.exerciseId})">
                                <div>
                                    <div class="pr-name">${getExerciseName(pr.exerciseId)}</div>
                                    <div class="pr-date">${new Date(pr.date).toLocaleDateString('ru-RU')}</div>
                                </div>
                                <div class="pr-value">${pr.prValue} кг x ${pr.reps}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            if (currentExerciseStatsId) {
                html += renderExerciseStatsDetail(currentExerciseStatsId);
            }
            
            return html;
        }
        
        function calculatePersonalRecords() {
            const records = {}; // { exerciseId: { prValue: X, reps: Y, date: Z } }

            workouts.forEach(w => {
                const date = w.date;
                w.exercises.forEach(ex => {
                    const id = ex.exerciseId;
                    ex.sets.forEach(set => {
                        // PR считается по максимальному весу (set.weight)
                        if (!records[id] || set.weight > records[id].prValue) {
                            records[id] = { 
                                exerciseId: id, 
                                prValue: set.weight, 
                                reps: set.reps, 
                                date: date 
                            };
                        } else if (set.weight === records[id].prValue && set.reps > records[id].reps) {
                             // Если вес равен, берем сет с большим количеством повторений
                            records[id].reps = set.reps;
                            records[id].date = date; // Обновляем дату, если это последний раз, когда был достигнут этот вес/повторения
                        }
                    });
                });
            });

            return Object.values(records).sort((a, b) => getExerciseName(a.exerciseId).localeCompare(getExerciseName(b.exerciseId)));
        }

        function viewExerciseStats(exerciseId) {
            currentExerciseStatsId = exerciseId;
            render();
            // Прокрутка вниз к графику
            setTimeout(() => {
                document.getElementById('exercise-stats-detail').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function renderExerciseStatsDetail(exerciseId) {
            const exName = getExerciseName(exerciseId);
            const exWorkouts = workouts.filter(w => w.exercises.some(ex => ex.exerciseId === exerciseId));

            if (exWorkouts.length === 0) return '';
            
            // Расчет максимального веса (Max Weight) и общего объема (Total Volume) для графика
            const chartData = exWorkouts.map(w => {
                const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                const maxWeight = Math.max(...ex.sets.map(s => s.weight));
                const totalVolume = ex.sets.reduce((sum, s) => sum + s.weight * s.reps, 0);
                
                return {
                    date: new Date(w.date).toLocaleDateString('ru-RU'),
                    maxWeight: maxWeight,
                    totalVolume: totalVolume / 1000 // в тоннах
                };
            });

            return `
                <div class="card" id="exercise-stats-detail">
                    <h3 style="margin-bottom: 12px;">Динамика: ${exName}</h3>
                    <div class="button-group" style="margin-bottom: 12px;">
                        <button class="btn-primary" id="maxWeightBtn" onclick="toggleChartType('maxWeight')" style="flex-grow: 1;">Макс. Вес</button>
                        <button class="btn-secondary" id="totalVolumeBtn" onclick="toggleChartType('totalVolume')" style="flex-grow: 1;">Объем</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="statChart"></canvas>
                    </div>
                    
                    <h4 style="margin-top: 20px;">История</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${exWorkouts.reverse().map(w => {
                            const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                            const { totalVolume, totalSets } = calculateWorkoutStats({ exercises: [ex] });
                            return `
                                <div class="stat-detail-item">
                                    <span>${new Date(w.date).toLocaleDateString('ru-RU')}</span>
                                    <span>Объем: ${(totalVolume / 1000).toFixed(2)} т / Сетов: ${totalSets}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        let statChartInstance = null;
        let currentChartType = 'maxWeight'; // maxWeight или totalVolume

        function toggleChartType(type) {
            currentChartType = type;
            document.getElementById('maxWeightBtn').className = type === 'maxWeight' ? 'btn-primary' : 'btn-secondary';
            document.getElementById('totalVolumeBtn').className = type === 'totalVolume' ? 'btn-primary' : 'btn-secondary';
            renderChart(currentExerciseStatsId);
        }

        function renderChart(exerciseId) {
            const exWorkouts = workouts.filter(w => w.exercises.some(ex => ex.exerciseId === exerciseId));

            const chartData = exWorkouts.map(w => {
                const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                const maxWeight = Math.max(...ex.sets.map(s => s.weight));
                const totalVolume = ex.sets.reduce((sum, s) => sum + s.weight * s.reps, 0);
                
                return {
                    date: new Date(w.date).toLocaleDateString('ru-RU'),
                    maxWeight: maxWeight,
                    totalVolume: totalVolume / 1000 // в тоннах
                };
            });
            
            const labels = chartData.map(d => d.date);
            const data = chartData.map(d => d[currentChartType]);
            const unit = currentChartType === 'maxWeight' ? 'кг' : 'т';

            const ctx = document.getElementById('statChart');
            if (statChartInstance) {
                statChartInstance.destroy();
            }

            statChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentChartType === 'maxWeight' ? 'Максимальный вес' : 'Общий объем',
                        data: data,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#764ba2',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} ${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: unit
                            }
                        }
                    }
                }
            });
        }


        // --- Настройки (Settings) ---

        function renderSettings() {
             // Проверка на ошибки: если какой-то ID в workouts не соответствует ID в exercises
             const allWorkoutExIds = new Set(workouts.flatMap(w => w.exercises.map(e => e.exerciseId)));
             const invalidExIds = Array.from(allWorkoutExIds).filter(id => !exercises.some(e => e.id === id));
             
             let validationAlert = '';
             if (invalidExIds.length > 0) {
                 validationAlert = `<div class="card" style="background: #fef2f2; border: 1px solid #fca5a5; color: #ef4444;">
                    <h4 style="margin-bottom: 8px;">🚨 Ошибка данных!</h4>
                    <p style="font-size: 14px;">В тренировках найдены упражнения с ID, которых нет в списке упражнений. Рекомендуется сбросить упражнения или использовать экспорт/импорт.</p>
                 </div>`;
             }

             const h = `
                 <div class="card">
                     <h2 style="margin-bottom: 12px;">Настройки</h2>
                     <h3 style="margin-top: 15px; margin-bottom: 10px;">Список упражнений (${exercises.length})</h3>
                     <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                         ${exercises.map(ex => `
                             <div class="list-item">
                                 <span>${ex.name} (${ex.group})</span>
                                 <button class="btn-danger" onclick="deleteExercise(${ex.id})">🗑️</button>
                             </div>
                         `).join('')}
                     </div>
                     <button class="btn-primary" onclick="showAddExerciseModal()">➕ Добавить упражнение</button>
                 </div>
                 
                 ${validationAlert}

                 <div class="card">
                     <h3 style="margin-bottom: 12px;">Управление данными</h3>
                     <button class="btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 8px;">📤 Экспорт данных</button>
                     <button class="btn-secondary" onclick="importData()" style="width: 100%; margin-bottom: 16px;">📥 Импорт данных</button>
                     
                     <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <button class="btn-danger" onclick="resetRoutines()" style="width: 100%; margin-bottom: 8px;">Сбросить шаблоны</button>
                        <button class="btn-danger" onclick="resetWo()" style="width: 100%; margin-bottom: 8px;">Сбросить тренировки</button>
                        <button class="btn-danger" onclick="resetEx()" style="width: 100%; margin-bottom: 16px;">Сбросить упражнения, тренировки и шаблоны</button>
                        <button onclick="resetAll()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">⚠️ СБРОСИТЬ ВСЁ</button>
                     </div>
                 </div>
                 <div class="card"><h3 style="margin-bottom: 12px;">О приложении</h3>
                 <p style="color: #666; font-size: 14px;">💪 Трекер Тренировок **v2.2** (Шаблоны Fix + Подробная Статистика + **Calendar/Button Fix**)<br>Все данные хранятся локально</p>
                 </div>`;
             return h;
        }

        function showAddExerciseModal() {
             const name = prompt('Введите название упражнения:');
             if (!name) return;
             const group = prompt('Введите группу мышц (например, Грудь):', 'Без группы');
             
             const newEx = {
                 id: Date.now(),
                 name: name.trim(),
                 group: group.trim()
             };
             exercises.push(newEx);
             save();
             render();
        }

        function deleteExercise(id) {
            if (confirm(`Удалить упражнение "${getExerciseName(id)}"? Все связанные с ним данные в тренировках останутся.`)) {
                exercises = exercises.filter(ex => ex.id !== id);
                save();
                render();
            }
        }
        
        function resetRoutines() {
            if (confirm('Удалить ВСЕ шаблоны?')) {
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetWo() {
            if (confirm('Удалить ВСЕ тренировки?')) {
                workouts = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetEx() {
            if (confirm('Удалить ВСЕ упражнения, тренировки и шаблоны?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('✅ Удалено');
                render();
            }
        }

        function resetAll() {
            if (confirm('⚠️ УДАЛИТЬ ВСЕ ДАННЫЕ?')) {
                if (confirm('Точно? Последнее предупреждение!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('🔥 Все данные сброшены. Перезагрузите страницу.');
                    render();
                }
            }
        }
        
        // --- Импорт/Экспорт ---
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout_tracker_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (confirm('Внимание! Импортированные данные заменят текущие. Продолжить?')) {
                            if (importedData.exercises) exercises = importedData.exercises;
                            if (importedData.workouts) workouts = importedData.workouts;
                            if (importedData.routines) routines = importedData.routines;
                            save();
                            alert('✅ Данные успешно импортированы!');
                            render();
                        }
                    } catch (error) {
                        alert('❌ Ошибка при чтении или парсинге файла JSON.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        init();
    </script>
</body>
</html>
