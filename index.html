<!DOCTYPE html><html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ ‚Äî Premium + –ß–µ–ª–ª–µ–Ω–¥–∂–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- PREMIUM + ANIMATIONS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html,body { height: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: radial-gradient(circle at top, #0f172a, #1e293b);
            color: #f8fafc; 
            line-height: 1.5; 
            min-height: 100vh; 
            overflow-x: hidden;
        }/* faster, snappier animation */
    .fade-in { animation: fadeInUp 0.3s cubic-bezier(.2,.9,.2,1) forwards; opacity: 0; transform: translateY(12px); }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

    .container { max-width: 720px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
    .card { background: rgba(255,255,255,0.04); border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.45); padding: 18px; margin-bottom: 18px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.06); }
    .header { font-size: 22px; font-weight: 600; margin-bottom: 12px; color: #fff; }

    .top-bar { display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .back-btn, .save-btn { border: none; cursor: pointer; }
    .back-btn { width:40px; height:40px; border-radius: 50%; background: linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; box-shadow: 0 3px 8px rgba(99,102,241,0.28); }
    .save-btn { padding:8px 14px; border-radius:10px; background: linear-gradient(135deg,#10b981,#059669); color:white; font-weight:600; box-shadow:0 3px 10px rgba(16,185,129,0.25); }

    .stat-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .stat-item { background: rgba(255,255,255,0.06); border-radius:10px; padding:10px; text-align:center; transition: transform .18s ease, background .18s ease; }
    .stat-item:hover { transform: translateY(-3px); background: rgba(255,255,255,0.09); }
    .stat-item p:first-child { font-size:13px; color:#cbd5e1; }
    .stat-item p:last-child { font-size:18px; font-weight:700; color:#fff; }

    .btn-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:14px; }
    .btn { padding:14px; border-radius:12px; background: linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; font-weight:600; border:none; cursor:pointer; box-shadow:0 6px 18px rgba(99,102,241,0.25); transition: transform .12s cubic-bezier(.2,.9,.2,1), box-shadow .12s; }
    .btn:active { transform: translateY(2px) scale(.997); }
    .btn-secondary { background: rgba(255,255,255,0.06); color:#e6eefc; box-shadow:none; }
    .btn-danger { background: linear-gradient(135deg,#f43f5e,#e11d48); }

    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab { padding:8px 12px; border-radius:10px; background: rgba(255,255,255,0.03); cursor:pointer; font-weight:600; color:#cfe0ff; }
    .tab.active { background: linear-gradient(135deg,#6366f1,#8b5cf6); color:white; box-shadow:0 6px 18px rgba(99,102,241,0.25); }

    input[type=text], input[type=number], select, input[type=date] { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.18); color:#f8fafc; margin-bottom:10px; }
    label { display:block; color:#cbd5e1; margin-bottom:6px; font-size:14px; }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .exercise-item { padding:12px; border-radius:10px; background: rgba(255,255,255,0.03); display:flex; justify-content:space-between; align-items:center; cursor:pointer; }

    .calendar-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .calendar-day { aspect-ratio:1; border-radius:8px; background: rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; font-size:14px; color:#f8fafc; }
    .day-workout { background: linear-gradient(135deg,#10b981,#059669); box-shadow:0 6px 16px rgba(16,185,129,0.18); }

    /* STATS GRAPH AREA */
    .stats-controls { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .period-btn { padding:8px 10px; border-radius:8px; background: rgba(255,255,255,0.03); color:#cfe0ff; border:none; cursor:pointer; }
    .period-btn.active { background: rgba(99,102,241,0.12); color:#fff; }

    /* CHALLENGES & ACHIEVEMENTS */
    .challenge { display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px; background: rgba(255,255,255,0.03); }
    .progress { height:10px; background: rgba(255,255,255,0.04); border-radius:8px; overflow:hidden; width:100%; }
    .progress > i { display:block; height:10px; background: linear-gradient(90deg,#6366f1,#8b5cf6); width:0%; transition: width .6s cubic-bezier(.2,.9,.2,1); }
    .badge { padding:6px 10px; border-radius:999px; background: linear-gradient(135deg,#10b981,#059669); color:white; font-weight:700; }

    /* TOASTS */
    #toast-container { position: fixed; top: 16px; left: 16px; right: 16px; z-index: 4000; display:flex; flex-direction:column; gap:12px; max-width:520px; margin:0 auto; }
    .toast { display:flex; gap:12px; align-items:flex-start; padding:12px 14px; border-radius:12px; color:white; box-shadow:0 10px 30px rgba(0,0,0,0.6); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.06); }
    .toast .title { font-weight:700; }

    /* ACHIEVEMENTS LIST */
    .ach-list { display:grid; gap:8px; }

    @media (max-width:600px){ .btn-grid { grid-template-columns: repeat(2,1fr); } }
</style>

</head>
<body>
    <div class="container">
        <div class="tabs fade-in" style="animation-delay:0.05s;">
            <div class="tab active" id="tab-home" onclick="switchTab('home')">–ì–ª–∞–≤–Ω–∞—è</div>
            <div class="tab" id="tab-stats" onclick="switchTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <div class="tab" id="tab-challenges" onclick="switchTab('challenges')">–ß–µ–ª–ª–µ–Ω–¥–∂–∏</div>
            <div class="tab" id="tab-ach" onclick="switchTab('achievements')">–ê—á–∏–≤–∫–∏</div>
        </div><div id="view" class="fade-in" style="animation-delay:0.08s;"></div>
</div>

<div id="toast-container"></div>

<script>
// ---- Data stores ----
let exercises = [], workouts = [], routines = [], challenges = [], achievements = [];
let currentTab = 'home';

// load from localStorage
function loadAll() {
    try {
        exercises = JSON.parse(localStorage.getItem('workout-exercises')||'[]');
        workouts = JSON.parse(localStorage.getItem('workout-logs')||'[]');
        routines = JSON.parse(localStorage.getItem('workout-routines')||'[]');
        challenges = JSON.parse(localStorage.getItem('workout-challenges')||'[]');
        achievements = JSON.parse(localStorage.getItem('workout-achievements')||'[]');
    } catch(e){ console.error(e); exercises=[]; workouts=[]; routines=[]; challenges=[]; achievements=[]; }
}
function saveAll() {
    localStorage.setItem('workout-exercises', JSON.stringify(exercises));
    localStorage.setItem('workout-logs', JSON.stringify(workouts));
    localStorage.setItem('workout-routines', JSON.stringify(routines));
    localStorage.setItem('workout-challenges', JSON.stringify(challenges));
    localStorage.setItem('workout-achievements', JSON.stringify(achievements));
}

// ---- Toasts ----
function showToast(title, msg, type='info', duration=2500) {
    const container = document.getElementById('toast-container');
    const el = document.createElement('div');
    el.className = 'toast';
    el.style.background = (type==='success') ? 'linear-gradient(135deg,#10b981,#059669)' : (type==='error') ? 'linear-gradient(135deg,#f43f5e,#e11d48)' : 'linear-gradient(135deg,#6366f1,#8b5cf6)';
    el.innerHTML = `<div style="font-size:18px;">${type==='success'?'‚úÖ': type==='error' ? '‚õî' : 'üîî'}</div><div><div class='title'>${title}</div><div style='opacity:.9;margin-top:4px;font-size:14px;'>${msg}</div></div>`;
    container.appendChild(el);
    setTimeout(()=>{ el.style.transform='translateY(-8px)'; el.style.opacity='0'; el.addEventListener('transitionend', ()=>el.remove()); }, duration);
}

// ---- UI helpers ----
function switchTab(tab) { currentTab = tab; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.getElementById('tab-'+tab).classList.add('active'); renderView(); }

// compute sums for exercise within date range
function sumExerciseBetween(exId, startDate, endDate) {
    const s = new Date(startDate); const e = new Date(endDate);
    let total = 0;
    workouts.forEach(w => {
        const wd = new Date(w.date);
        if (wd >= s && wd <= e) {
            w.exercises.forEach(ex => {
                if (ex.exerciseId === exId) {
                    ex.sets.forEach(st => { total += Number(st.reps||0); if(st.weight) total += 0; });
                }
            });
        }
    });
    return total;
}

function percentChange(current, previous) {
    if(previous === 0) return current === 0 ? 0 : 100;
    return Math.round(((current - previous) / previous) * 100);
}

// ---- STATS view (charts + period selector) ----
let statChart = null;
function renderStats() {
    const usedExercises = getExercisesUsed();
    const exOptions = usedExercises.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    const html = `
        <div class='top-bar'>
            <div class='header'>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            <button class='save-btn' onclick='renderView()'>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class='card'>
            <label>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
            <select id='stat-ex'>${exOptions || '<option value="">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</option>'}</select>
            <div class='stats-controls' style='margin-top:10px;'>
                <button class='period-btn active' data-days='7' onclick='changePeriod(this)'>7–¥</button>
                <button class='period-btn' data-days='14' onclick='changePeriod(this)'>2–Ω</button>
                <button class='period-btn' data-days='30' onclick='changePeriod(this)'>1–º</button>
                <button class='period-btn' data-days='180' onclick='changePeriod(this)'>6–º</button>
            </div>
            <div style='height:260px; margin-top:10px;'><canvas id='stat-c'></canvas></div>
            <div id='stat-change' style='margin-top:10px; color:#cbd5e1;'></div>
        </div>
    `;
    return html;
}

function getExercisesUsed() {
    const set = new Set();
    workouts.forEach(w=> w.exercises.forEach(e=> set.add(e.exerciseId)));
    // map to exercise objects
    return Array.from(set).map(id=> exercises.find(ex=>ex.id===id)).filter(Boolean);
}

function changePeriod(btn) {
    document.querySelectorAll('.period-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    drawStatChart();
}

function drawStatChart() {
    const select = document.getElementById('stat-ex');
    if(!select) return;
    const exId = select.value; if(!exId) return;
    const days = Number(document.querySelector('.period-btn.active').dataset.days || 7);
    const end = new Date(); const start = new Date(); start.setDate(end.getDate()- (days-1));
    // build labels and data by day
    const labels = []; const data = [];
    for(let i=0;i<days;i++){ const d = new Date(start); d.setDate(start.getDate()+i); labels.push(d.toLocaleDateString('ru-RU',{day:'numeric', month:'short'})); data.push(sumExerciseBetween(exId, d.toISOString().split('T')[0], d.toISOString().split('T')[0])); }
    // previous period for percent change
    const prevStart = new Date(start); prevStart.setDate(start.getDate()-days); const prevEnd = new Date(start); prevEnd.setDate(start.getDate()-1);
    const curSum = data.reduce((s,v)=>s+v,0); const prevSum = sumExerciseBetween(exId, prevStart.toISOString().split('T')[0], prevEnd.toISOString().split('T')[0]);
    const change = percentChange(curSum, prevSum);
    document.getElementById('stat-change').innerHTML = `<div style='font-weight:700;color:${change>=0?"#10b981":"#f43f5e"};'>üìà ${change>=0?'+':''}${change}% ${ exercises.find(e=>e.id===exId)?.name || '' } –∑–∞ ${days==7? '7 –¥–Ω–µ–π' : days==14 ? '2 –Ω–µ–¥–µ–ª–∏' : days==30 ? '1 –º–µ—Å—è—Ü' : '6 –º–µ—Å—è—Ü–µ–≤' }</div>`;

    if(statChart){ statChart.destroy(); statChart=null; }
    const ctx = document.getElementById('stat-c').getContext('2d');
    statChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ data, borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,0.12)', tension:0.35, fill:true, pointRadius:3 }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{color:'rgba(255,255,255,0.04)'}}, x:{grid:{display:false}}} }
    });
}

// ---- CHALLENGES view ----
function renderChallenges() {
    const exOptions = exercises.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    const html = `
        <div class='top-bar'>
            <div class='header'>–ß–µ–ª–ª–µ–Ω–¥–∂–∏</div>
            <button class='save-btn' onclick='renderView()'>–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class='card'>
            <label>–°–æ–∑–¥–∞—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂</label>
            <select id='ch-ex'>${exOptions || '<option value="">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</option>'}</select>
            <div class='grid-2'>
                <div><label>–¶–µ–ª—å (–∫–æ–ª-–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)</label><input id='ch-goal' type='number' min='1' placeholder='–Ω–∞–ø—Ä–∏–º–µ—Ä 200'></div>
                <div><label>–°—Ä–æ–∫ (–¥–Ω–µ–π)</label><input id='ch-days' type='number' min='1' value='7'></div>
            </div>
            <button class='btn' style='margin-top:8px;' onclick='createChallenge()'>–°–æ–∑–¥–∞—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂</button>
        </div>
        <div class='card'>
            <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'><div class='header'>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏</div><div style='color:#cbd5e1;font-size:13px;'>${challenges.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö</div></div>
            <div style='display:grid;gap:10px;'>
                ${challenges.map(c=>renderChallengeCard(c)).join('') || '<div class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π</div>'}
            </div>
        </div>
    `;
    return html;
}

function renderChallengeCard(c){
    const percent = Math.min(100, Math.round((c.progress / c.goal) * 100));
    const daysLeft = Math.max(0, Math.ceil((new Date(c.endsAt) - new Date())/(1000*60*60*24)));
    return `
        <div class='challenge card'>
            <div style='min-width:90px;'><div style='font-weight:700;color:#fff;'>${exercises.find(e=>e.id===c.exerciseId)?.name||'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ'}</div><div style='color:#cbd5e1;font-size:13px;'>${c.goal} –ø–æ–≤—Ç ‚Ä¢ ${c.days}–¥</div></div>
            <div style='flex:1;'>
                <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;'><div style='color:#cbd5e1;font-size:13px;'>–ü—Ä–æ–≥—Ä–µ—Å—Å</div><div style='font-weight:700;'>${c.progress}/${c.goal}</div></div>
                <div class='progress'><i style='width:${percent}%'></i></div>
            </div>
            <div style='min-width:84px;text-align:right;'>${daysLeft>0?`<div style="color:#cbd5e1; font-size:13px;">${daysLeft}–¥</div>`:'<div class="badge">–ò—Å—Ç—ë–∫</div>'}
            <div style='margin-top:8px;'><button class='btn-secondary' onclick="completeChallenge('${c.id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button></div></div>
        </div>
    `;
}

function createChallenge(){
    const exId = document.getElementById('ch-ex').value;
    const goal = Number(document.getElementById('ch-goal').value);
    const days = Number(document.getElementById('ch-days').value);
    if(!exId || !goal || !days){ showToast('–û—à–∏–±–∫–∞','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error'); return; }
    const now = new Date(); const endsAt = new Date(); endsAt.setDate(now.getDate()+days);
    const ch = { id: Date.now().toString(), exerciseId: exId, goal, days, createdAt: now.toISOString(), endsAt: endsAt.toISOString(), progress:0, completed:false };
    challenges.push(ch); saveAll(); showToast('–ß–µ–ª–ª–µ–Ω–¥–∂ —Å–æ–∑–¥–∞–Ω', '–£–¥–∞—á–∏!', 'success'); renderView(); checkAllChallenges();
}

function completeChallenge(id){
    const idx = challenges.findIndex(c=>c.id===id); if(idx===-1) return; const ch = challenges[idx]; ch.completed = true; // move to achievements
    achievements.unshift({ id: 'ach_'+Date.now(), challengeId: ch.id, exerciseId: ch.exerciseId, goal: ch.goal, completedAt: new Date().toISOString() });
    challenges.splice(idx,1); saveAll(); showToast('–ß–µ–ª–ª–µ–Ω–¥–∂ –∑–∞–≤–µ—Ä—à—ë–Ω','–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤—Ä—É—á–Ω—É—é','success'); renderView();
}

// when a workout is saved, update challenge progress
function updateChallengesProgress() {
    const now = new Date();
    challenges.forEach(ch => {
        // compute sum of exercise from ch.createdAt to ch.endsAt (or from now-days)
        const start = new Date(ch.createdAt);
        const end = new Date(ch.endsAt);
        const sum = sumExerciseBetween(ch.exerciseId, start.toISOString().split('T')[0], end.toISOString().split('T')[0]);
        ch.progress = sum;
        if(!ch.completed && ch.progress >= ch.goal) {
            // mark completed
            ch.completed = true;
            achievements.unshift({ id: 'ach_'+Date.now(), challengeId: ch.id, exerciseId: ch.exerciseId, goal: ch.goal, completedAt: new Date().toISOString() });
            showToast('–ß–µ–ª–ª–µ–Ω–¥–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω!', `üî• –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —á–µ–ª–ª–µ–Ω–¥–∂: ${exercises.find(e=>e.id===ch.exerciseId)?.name || ''} ‚Äî ${ch.goal} –ø–æ–≤—Ç`, 'success', 3500);
        }
    });
    // remove expired incomplete challenges? keep them but mark expired
    saveAll();
}

function checkAllChallenges(){ updateChallengesProgress(); renderView(); }

// ---- ACHIEVEMENTS ----
function renderAchievements(){
    const html = `
        <div class='top-bar'><div class='header'>–ê—á–∏–≤–∫–∏</div><button class='save-btn' onclick='clearAchievements()'>–û—á–∏—Å—Ç–∏—Ç—å</button></div>
        <div class='card'>
            <div class='ach-list'>
                ${achievements.map(a=>`<div class='challenge'><div><strong>${exercises.find(e=>e.id===a.exerciseId)?.name||''}</strong><div style='font-size:13px;color:#cbd5e1;'>–¶–µ–ª—å: ${a.goal}</div></div><div style='margin-left:auto;color:#94a3b8;font-size:13px;'>${new Date(a.completedAt).toLocaleString()}</div></div>`).join('') || '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∞—á–∏–≤–æ–∫</div>'}
            </div>
        </div>
    `;
    return html;
}
function clearAchievements(){ if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∞—Ä—Ö–∏–≤ –∞—á–∏–≤–æ–∫?')) return; achievements=[]; saveAll(); renderView(); }

// ---- HOME (keep lightweight) ----
function renderHome(){
    const streak = getStreak(); const weekStreak = getWeeklyStreak();
    const today = workouts.find(w=>w.date === (new Date().toISOString().split('T')[0]));
    const html = `
        <div class='top-bar'><div class='header'>–¢—Ä–µ–∫–µ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div><button class='save-btn' onclick='renderView()'>–û–±–Ω–æ–≤–∏—Ç—å</button></div>
        <div class='card stat-grid'>
            <div class='stat-item'><p>–°—Ç—Ä–∏–∫</p><p>${streak}–¥</p></div>
            <div class='stat-item'><p>–°—Ç—Ä–∏–∫ (–Ω–µ–¥–µ–ª–∏)</p><p>${weekStreak}</p></div>
            <div class='stat-item'><p>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p><p>${workouts.length}</p></div>
        </div>
        <div class='card btn-grid'>
            <button class='btn' onclick="goNewWorkout()">‚ûï –ù–æ–≤–∞—è</button>
            <button class='btn' onclick="switchTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class='btn' onclick="switchTab('challenges')">üî• –ß–µ–ª–ª–µ–Ω–¥–∂–∏</button>
        </div>
        <div class='card' style='margin-top:12px;'>
            <div class='header' style='font-size:16px;'>–ê–∫—Ç–∏–≤–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏</div>
            <div style='margin-top:10px; display:grid; gap:8px;'>${challenges.slice(0,3).map(c=>renderChallengeCard(c)).join('') || '<div class="empty-state">–ù–µ—Ç —á–µ–ª–ª–µ–Ω–¥–∂–µ–π ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ß–µ–ª–ª–µ–Ω–¥–∂–∏¬ª</div>'}</div>
        </div>
    `;
    return html;
}

// ---- Simple workout editor (reuse existing save logic) ----
function goNewWorkout(){
    currentWorkout = [];
    selectedDate = new Date().toISOString().split('T')[0];
    currentView = 'newWorkout'; renderView();
}

// We'll reuse some of user's existing functions for adding exercises/workouts etc.
let selectedDate = new Date().toISOString().split('T')[0];
let currentWorkout = [];
let currentView = 'home';

function renderNewWorkoutView(){
    const exOptions = exercises.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
    const html = `
        <div class='top-bar'><div class='header'>–ù–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div><button class='save-btn' onclick='saveWorkout()'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        <div class='card'>
            <label>–î–∞—Ç–∞</label>
            <input type='date' id='workoutDate' value='${selectedDate}' onchange="selectedDate=this.value">
            <label>–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</label>
            <select id='addExSelect'>${exOptions || '<option value="">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</option>'}</select>
            <div style='display:flex;gap:8px;margin-top:8px;'><input id='addSets' type='number' placeholder='–ü–æ–¥—Ö–æ–¥—ã' min='1'><input id='addReps' type='number' placeholder='–ü–æ–≤—Ç–æ—Ä—ã' min='1'></div>
            <button class='btn' style='margin-top:10px;' onclick='addExToCurrent()'>–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class='card'>
            <div class='header' style='font-size:16px;'>–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
            <div id='cw-list' style='margin-top:10px;'>${currentWorkout.map((ex,i)=>`<div class='exercise-item'>${ex.exerciseName}<div>${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤</div></div>`).join('') || '<div class="empty-state">–ü—É—Å—Ç–æ</div>'}</div>
        </div>
    `;
    return html;
}

function addExToCurrent(){ const sel = document.getElementById('addExSelect'); const setsN = Number(document.getElementById('addSets').value)||1; const repsN = Number(document.getElementById('addReps').value)||0; if(!sel.value){ showToast('–û—à–∏–±–∫–∞','–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ','error'); return; } const exObj = exercises.find(e=>e.id===sel.value); if(!exObj) return; const cwEx = { exerciseId: exObj.id, exerciseName: exObj.name, sets: [] }; for(let i=0;i<setsN;i++) cwEx.sets.push({ setNumber: i+1, reps: repsN }); currentWorkout.push(cwEx); renderView(); }

function saveWorkout(){ if(currentWorkout.length===0){ showToast('–û—à–∏–±–∫–∞','–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è','error'); return; } const newW = { date: selectedDate, exercises: currentWorkout }; // merge
    const idx = workouts.findIndex(w=>w.date===selectedDate); if(idx>-1) { workouts[idx] = newW; } else workouts.push(newW); workouts.sort((a,b)=> new Date(b.date) - new Date(a.date)); saveAll(); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞','success'); updateChallengesProgress(); renderView(); }

// ---- Utilities: streaks ----
function getStreak(){ if(workouts.length===0) return 0; const dates = new Set(workouts.map(w=>w.date)); let streak=0; let d=new Date(); for(let i=0;i<365;i++){ const ds = d.toISOString().split('T')[0]; if(dates.has(ds)) streak++; else if(i===0) { d.setDate(d.getDate()-1); continue; } else break; d.setDate(d.getDate()-1); } return streak; }
function getWeeklyStreak(){ if(workouts.length===0) return 0; const weeks = new Set(workouts.map(w=> getMonday(w.date))); let streak=0; let curr = new Date(); curr.setHours(12,0,0,0); let monday = new Date(getMonday(curr)); while(true){ const id = monday.toISOString().split('T')[0]; if(weeks.has(id)){ streak++; monday.setDate(monday.getDate()-7); } else break; } return streak; }
function getMonday(d){ d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day===0?-6:1); const m = new Date(d.setDate(diff)); m.setHours(12,0,0,0); return m.toISOString().split('T')[0]; }

// ---- Router-like render ----
function renderView(){ loadAll(); // refresh data
    let html='';
    if(currentTab==='home') html = renderHome();
    else if(currentTab==='stats') html = renderStats();
    else if(currentTab==='challenges') html = renderChallenges();
    else if(currentTab==='achievements') html = renderAchievements();
    else if(currentView==='newWorkout') html = renderNewWorkoutView();
    document.getElementById('view').innerHTML = html;
    // after render hooks
    if(currentTab==='stats'){ // init selector/change handlers
        const sel = document.getElementById('stat-ex'); if(sel){ sel.onchange = drawStatChart; const activeBtn = document.querySelector('.period-btn.active'); if(!activeBtn) document.querySelector('.period-btn')?.classList.add('active'); drawStatChart(); }
    }
    if(currentTab==='challenges'){ /* nothing */ }
    if(currentView==='newWorkout'){ document.getElementById('cw-list')?.scrollIntoView(); }
    // save any changes
    saveAll();
}

// ---- Init demo data if empty (only for first run) ----
function seedDemo(){ if(exercises.length) return; exercises = [ {id:'e_push', name:'–û—Ç–∂–∏–º–∞–Ω–∏—è', type:'reps'}, {id:'e_squat', name:'–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', type:'reps'}, {id:'e_run', name:'–ë–µ–≥', type:'distance'} ]; // seed some workouts last 30 days
    const today = new Date(); for(let i=0;i<18;i++){ const d = new Date(); d.setDate(today.getDate() - i); const dateStr = d.toISOString().split('T')[0]; if(Math.random()>0.6){ workouts.push({ date: dateStr, exercises: [ {exerciseId:'e_push', exerciseName:'–û—Ç–∂–∏–º–∞–Ω–∏—è', sets:[ {setNumber:1,reps:Math.floor(10+Math.random()*30)} ]}, {exerciseId:'e_squat', exerciseName:'–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', sets:[{setNumber:1,reps:Math.floor(20+Math.random()*40)}]} ] }); } }
    saveAll(); }

// ---- Initial load ----
loadAll(); seedDemo(); renderView(); checkAllChallenges();

// make sure to update progress on page load
updateChallengesProgress();

// expose some functions for html inline use
window.switchTab = switchTab; window.renderView = renderView; window.changePeriod = changePeriod; window.createChallenge = createChallenge; window.completeChallenge = completeChallenge; window.goNewWorkout = goNewWorkout; window.addExToCurrent = addExToCurrent; window.saveWorkout = saveWorkout; window.checkAllChallenges = checkAllChallenges; window.renderStats = renderStats;
</script>

</body>
</html>