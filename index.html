<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Трекер Тренировок</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } = Recharts;

        // Иконки как SVG компоненты
        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Dumbbell = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14.4 14.4L9.6 9.6"></path>
                <path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.768a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.828 2.829z"></path>
                <path d="m21.5 21.5-1.4-1.4"></path>
                <path d="M3.9 3.9 2.5 2.5"></path>
                <path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.828-2.829l2.828-2.828a2 2 0 1 1 2.829 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z"></path>
            </svg>
        );

        const Calendar = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const TrendingUp = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const ChevronLeft = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Check = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );

        const Trash2 = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        // Простая реализация storage API для тестирования
        if (!window.storage) {
            window.storage = {
                data: {},
                async get(key) {
                    const value = localStorage.getItem(key);
                    return value ? { key, value } : null;
                },
                async set(key, value) {
                    localStorage.setItem(key, value);
                    return { key, value };
                },
                async delete(key) {
                    localStorage.removeItem(key);
                    return { key, deleted: true };
                },
                async list(prefix) {
                    const keys = Object.keys(localStorage).filter(k => !prefix || k.startsWith(prefix));
                    return { keys };
                }
            };
        }

        function WorkoutTracker() {
            const [tg, setTg] = useState(null);
            const [exercises, setExercises] = useState([]);
            const [workouts, setWorkouts] = useState([]);
            const [currentView, setCurrentView] = useState('home');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [currentWorkout, setCurrentWorkout] = useState([]);
            const [newExerciseName, setNewExerciseName] = useState('');
            const [showExerciseForm, setShowExerciseForm] = useState(false);

            useEffect(() => {
                if (window.Telegram?.WebApp) {
                    const telegram = window.Telegram.WebApp;
                    telegram.ready();
                    telegram.expand();
                    setTg(telegram);
                }
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const exercisesData = await window.storage.get('workout-exercises');
                    const workoutsData = await window.storage.get('workout-logs');
                    
                    if (exercisesData?.value) {
                        setExercises(JSON.parse(exercisesData.value));
                    }
                    if (workoutsData?.value) {
                        setWorkouts(JSON.parse(workoutsData.value));
                    }
                } catch (error) {
                    console.log('First time loading');
                }
            };

            const saveExercises = async (newExercises) => {
                setExercises(newExercises);
                await window.storage.set('workout-exercises', JSON.stringify(newExercises));
            };

            const saveWorkouts = async (newWorkouts) => {
                setWorkouts(newWorkouts);
                await window.storage.set('workout-logs', JSON.stringify(newWorkouts));
            };

            const addExercise = () => {
                if (newExerciseName.trim()) {
                    const newEx = {
                        id: Date.now().toString(),
                        name: newExerciseName.trim(),
                        createdAt: new Date().toISOString()
                    };
                    saveExercises([...exercises, newEx]);
                    setNewExerciseName('');
                    setShowExerciseForm(false);
                }
            };

            const deleteExercise = (id) => {
                saveExercises(exercises.filter(e => e.id !== id));
            };

            const addSetToWorkout = (exerciseId) => {
                const exercise = exercises.find(e => e.id === exerciseId);
                if (!exercise) return;

                const existingExercise = currentWorkout.find(w => w.exerciseId === exerciseId);
                
                if (existingExercise) {
                    setCurrentWorkout(currentWorkout.map(w => 
                        w.exerciseId === exerciseId 
                            ? { ...w, sets: [...w.sets, { reps: 0, setNumber: w.sets.length + 1 }] }
                            : w
                    ));
                } else {
                    setCurrentWorkout([...currentWorkout, {
                        exerciseId,
                        exerciseName: exercise.name,
                        sets: [{ reps: 0, setNumber: 1 }]
                    }]);
                }
            };

            const updateReps = (exerciseId, setIndex, reps) => {
                setCurrentWorkout(currentWorkout.map(w => 
                    w.exerciseId === exerciseId
                        ? {
                            ...w,
                            sets: w.sets.map((s, i) => i === setIndex ? { ...s, reps: parseInt(reps) || 0 } : s)
                        }
                        : w
                ));
            };

            const removeSet = (exerciseId, setIndex) => {
                setCurrentWorkout(currentWorkout.map(w => 
                    w.exerciseId === exerciseId
                        ? {
                            ...w,
                            sets: w.sets.filter((_, i) => i !== setIndex).map((s, i) => ({ ...s, setNumber: i + 1 }))
                        }
                        : w
                ).filter(w => w.sets.length > 0));
            };

            const saveWorkout = () => {
                if (currentWorkout.length === 0) return;

                const workout = {
                    id: Date.now().toString(),
                    date: selectedDate,
                    exercises: currentWorkout,
                    timestamp: new Date().toISOString()
                };

                const existingWorkoutIndex = workouts.findIndex(w => w.date === selectedDate);
                let newWorkouts;
                
                if (existingWorkoutIndex >= 0) {
                    newWorkouts = [...workouts];
                    newWorkouts[existingWorkoutIndex] = workout;
                } else {
                    newWorkouts = [...workouts, workout];
                }

                saveWorkouts(newWorkouts);
                setCurrentWorkout([]);
                setCurrentView('home');
            };

            const getWorkoutForDate = (date) => {
                return workouts.find(w => w.date === date);
            };

            const getCurrentStreak = () => {
                if (workouts.length === 0) return 0;
                
                const sortedWorkouts = [...workouts].sort((a, b) => new Date(b.date) - new Date(a.date));
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let streak = 0;
                let currentDate = new Date(today);
                
                for (let i = 0; i < 365; i++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const hasWorkout = sortedWorkouts.some(w => w.date === dateStr);
                    
                    if (hasWorkout) {
                        streak++;
                        currentDate.setDate(currentDate.getDate() - 1);
                    } else if (i === 0) {
                        currentDate.setDate(currentDate.getDate() - 1);
                    } else {
                        break;
                    }
                }
                
                return streak;
            };

            const getTotalVolume = () => {
                return workouts.reduce((total, w) => {
                    return total + w.exercises.reduce((exTotal, ex) => {
                        return exTotal + ex.sets.reduce((setTotal, set) => setTotal + set.reps, 0);
                    }, 0);
                }, 0);
            };

            const getTotalSets = () => {
                return workouts.reduce((total, w) => {
                    return total + w.exercises.reduce((exTotal, ex) => exTotal + ex.sets.length, 0);
                }, 0);
            };

            const getTotalExercises = () => {
                return workouts.reduce((total, w) => total + w.exercises.length, 0);
            };

            const getAverageRepsPerWorkout = () => {
                if (workouts.length === 0) return 0;
                return Math.round(getTotalVolume() / workouts.length);
            };

            const getWeeklyStats = () => {
                const today = new Date();
                const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                const weekWorkouts = workouts.filter(w => {
                    const workoutDate = new Date(w.date);
                    return workoutDate >= sevenDaysAgo && workoutDate <= today;
                });

                const stats = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayWorkout = weekWorkouts.find(w => w.date === dateStr);
                    
                    const totalReps = dayWorkout ? dayWorkout.exercises.reduce((total, ex) => {
                        return total + ex.sets.reduce((s, set) => s + set.reps, 0);
                    }, 0) : 0;

                    stats.push({
                        date: dateStr,
                        day: date.toLocaleDateString('ru-RU', { weekday: 'short' }),
                        reps: totalReps
                    });
                }
                
                return stats;
            };

            const getWeeklyProgress = () => {
                const today = new Date();
                const thisWeekStart = new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000);
                const lastWeekStart = new Date(today.getTime() - 13 * 24 * 60 * 60 * 1000);
                const lastWeekEnd = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

                const thisWeekWorkouts = workouts.filter(w => {
                    const date = new Date(w.date);
                    return date >= thisWeekStart && date <= today;
                });

                const lastWeekWorkouts = workouts.filter(w => {
                    const date = new Date(w.date);
                    return date >= lastWeekStart && date < lastWeekEnd;
                });

                const thisWeekTotal = thisWeekWorkouts.reduce((total, w) => {
                    return total + w.exercises.reduce((exTotal, ex) => {
                        return exTotal + ex.sets.reduce((setTotal, set) => setTotal + set.reps, 0);
                    }, 0);
                }, 0);

                const lastWeekTotal = lastWeekWorkouts.reduce((total, w) => {
                    return total + w.exercises.reduce((exTotal, ex) => {
                        return exTotal + ex.sets.reduce((setTotal, set) => setTotal + set.reps, 0);
                    }, 0);
                }, 0);

                const diff = thisWeekTotal - lastWeekTotal;
                const percentChange = lastWeekTotal === 0 ? 0 : Math.round((diff / lastWeekTotal) * 100);

                return { diff, percentChange, isPositive: diff >= 0 };
            };

            const getMonthlyStats = () => {
                const today = new Date();
                const stats = [];
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const dateStr = date.toISOString().split('T')[0];
                    const dayWorkout = workouts.find(w => w.date === dateStr);
                    
                    const totalReps = dayWorkout ? dayWorkout.exercises.reduce((total, ex) => {
                        return total + ex.sets.reduce((s, set) => s + set.reps, 0);
                    }, 0) : 0;

                    stats.push({
                        date: date.getDate(),
                        fullDate: dateStr,
                        reps: totalReps
                    });
                }
                
                return stats;
            };

            const getMonthlyProgress = () => {
                const today = new Date();
                const thisMonthStart = new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000);
                const lastMonthStart = new Date(today.getTime() - 59 * 24 * 60 * 60 * 1000);
                const lastMonthEnd = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

                const thisMonthWorkouts = workouts.filter(w => {
                    const date = new Date(w.date);
                    return date >= thisMonthStart && date <= today;
                });

                const lastMonthWorkouts = workouts.filter(w => {
                    const date = new Date(w.date);
                    return date >= lastMonthStart && date < lastMonthEnd;
                });

                const thisMonthTotal = thisMonthWorkouts.reduce((total, w) => {
                    return total + w.exercises.reduce((exTotal, ex) => {
                        return exTotal + ex.sets.reduce((setTotal, set) => setTotal + set.reps, 0);
                    }, 0);
                }, 0);

                const lastMonthTotal = lastMonthWorkouts.reduce((total, w) => {
                    return total + w.exercises.reduce((exTotal, ex) => {
                        return exTotal + ex.sets.reduce((setTotal, set) => setTotal + set.reps, 0);
                    }, 0);
                }, 0);

                const diff = thisMonthTotal - lastMonthTotal;
                const percentChange = lastMonthTotal === 0 ? 0 : Math.round((diff / lastMonthTotal) * 100);

                return { diff, percentChange, isPositive: diff >= 0 };
            };

            const getYearlyStats = () => {
                const today = new Date();
                const stats = [];
                
                for (let i = 11; i >= 0; i--) {
                    const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                    const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
                    
                    const monthWorkouts = workouts.filter(w => {
                        const workoutDate = new Date(w.date);
                        return workoutDate >= monthStart && workoutDate <= monthEnd;
                    });

                    const totalReps = monthWorkouts.reduce((total, w) => {
                        return total + w.exercises.reduce((exTotal, ex) => {
                            return exTotal + ex.sets.reduce((setTotal, set) => setTotal + set.reps, 0);
                        }, 0);
                    }, 0);

                    stats.push({
                        month: monthDate.toLocaleDateString('ru-RU', { month: 'short' }),
                        fullMonth: monthDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' }),
                        reps: totalReps,
                        workouts: monthWorkouts.length
                    });
                }
                
                return stats;
            };

            const getYear