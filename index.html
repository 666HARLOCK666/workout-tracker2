<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –î–ò–ó–ê–ô–ù "PREMIUM" (v3.0 - Full Features + Scroll Picker) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: radial-gradient(circle at top, #0f172a, #1e293b); 
            color: #f8fafc; 
            line-height: 1.5; 
            min-height: 100vh; 
            overflow-x: hidden; 
        }
        .fade-in { animation: fadeInUp 0.4s ease forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        .container { max-width: 640px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .card { 
            background: rgba(255,255,255,0.05); border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); 
            padding: 20px; margin-bottom: 20px; backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); 
        }
        .header { font-size: 24px; font-weight: 600; margin-bottom: 16px; color: #ffffff; }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; text-align: center; }
        .stat-item { 
            background: rgba(255,255,255,0.08); border-radius: 10px; padding: 10px 0; 
            transition: transform 0.2s ease; 
        }
        .stat-item:hover { transform: translateY(-2px); background: rgba(255,255,255,0.12); }
        .stat-item p:first-child { font-size: 13px; color: #cbd5e1; }
        .stat-item p:last-child { font-size: 20px; font-weight: 600; color: #ffffff; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 20px; }
        .btn { 
            padding: 18px; border-radius: 14px; border: none; cursor: pointer; font-size: 16px; font-weight: 500; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; transition: all 0.3s ease; 
            box-shadow: 0 4px 12px rgba(99,102,241,0.3); width: 100%;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e2e8f0; box-shadow: none; }
        .btn-danger { background: linear-gradient(135deg, #f43f5e, #e11d48); color: white; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .back-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: none; 
            background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; font-size: 18px; cursor: pointer; 
        }
        .save-btn { 
            background: linear-gradient(135deg, #10b981, #059669); border: none; color: white; 
            padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; 
        }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–≤ */
        .exercise-item { 
            display: flex; justify-content: space-between; align-items: center; padding: 14px; 
            background: rgba(255,255,255,0.08); border-radius: 10px; margin-bottom: 8px; cursor: pointer; 
        }
        .delete-btn { background: none; border: none; color: #f472b6; cursor: pointer; font-size: 20px; }
        
        /* --- SCROLL PICKER STYLES (–ù–û–í–û–ï) --- */
        .set-row-display {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            padding: 16px; border-radius: 12px; margin-bottom: 10px; cursor: pointer;
        }
        .set-row-display:active { background: rgba(255,255,255,0.08); }
        .set-info { display: flex; align-items: center; gap: 12px; }
        .set-idx { 
            font-size: 12px; font-weight: 700; color: #94a3b8; 
            width: 24px; height: 24px; background: rgba(255,255,255,0.1); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
        }
        .set-values { font-size: 18px; font-weight: 600; color: #fff; }
        .set-sub { font-size: 12px; color: #64748b; margin-left: 4px; }
        
        /* Modal Picker */
        .picker-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: flex-end;
            animation: fadeIn 0.2s;
        }
        .picker-overlay.active { display: flex; }
        .picker-modal {
            background: #1e293b; width: 100%; border-radius: 24px 24px 0 0; padding: 20px 0;
            border-top: 1px solid rgba(255,255,255,0.1); box-shadow: 0 -4px 30px rgba(0,0,0,0.5);
            animation: slideUp 0.3s;
        }
        .picker-header {
            display: flex; justify-content: space-between; padding: 0 20px 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px;
        }
        .picker-btn { background: none; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
        .picker-cancel { color: #ef4444; }
        .picker-confirm { color: #6366f1; }
        
        .picker-body { display: flex; justify-content: center; gap: 10px; height: 220px; position: relative; overflow: hidden; }
        .picker-highlight {
            position: absolute; top: 50%; left: 0; right: 0; height: 50px; transform: translateY(-50%);
            background: rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1);
            pointer-events: none; z-index: 0;
        }
        .picker-col-wrapper { text-align: center; z-index: 1; width: 90px; }
        .picker-col-title { font-size: 12px; color: #64748b; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
        .picker-scroll {
            height: 220px; overflow-y: scroll; scroll-snap-type: y mandatory;
            scrollbar-width: none; 
        }
        .picker-scroll::-webkit-scrollbar { display: none; }
        .picker-item { height: 50px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #cbd5e1; scroll-snap-align: center; }
        .picker-spacer { height: 85px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
        .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .month-nav button { background: rgba(255,255,255,0.08); color: #e2e8f0; border: none; padding: 8px 16px; border-radius: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .calendar-day { aspect-ratio: 1; border-radius: 10px; background: rgba(255,255,255,0.08); border: none; color: #f8fafc; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .day-workout { background: linear-gradient(135deg, #10b981, #059669); }
        .day-today { box-shadow: 0 0 0 2px #6366f1 inset; }
        
        /* –£—Ç–∏–ª–∏—Ç—ã */
        input[type="text"], input[type="date"], select { width: 100%; padding: 14px; border-radius: 10px; background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;}
        .hide { display: none; }
        #toast-container { position: fixed; top: 16px; left: 16px; right: 16px; z-index: 4000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 16px; border-radius: 12px; background: #334155; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: fadeIn 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div id="view"></div>
    </div>

    <div id="pickerModal" class="picker-overlay">
        <div class="picker-modal">
            <div class="picker-header">
                <button class="picker-btn picker-cancel" onclick="closePicker()">–û—Ç–º–µ–Ω–∞</button>
                <div style="color:white; font-weight:600" id="pickerTitle">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
                <button class="picker-btn picker-confirm" onclick="savePickerValue()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
            <div class="picker-body">
                <div class="picker-highlight"></div>
                
                <div id="col1" class="picker-col-wrapper">
                    <div id="lbl1" class="picker-col-title">–í–µ—Å</div>
                    <div id="scroll1" class="picker-scroll"></div>
                </div>
                
                <div style="width: 20px; display: flex; align-items: center; justify-content: center; z-index: 1; font-size: 24px; font-weight: bold; padding-bottom: 20px; display: none;" id="pickerDot">.</div>

                <div id="colDecimal" class="picker-col-wrapper" style="display:none; width: 60px;">
                    <div class="picker-col-title">–ì—Ä</div>
                    <div id="scrollDecimal" class="picker-scroll"></div>
                </div>

                <div id="col2" class="picker-col-wrapper">
                    <div id="lbl2" class="picker-col-title">–ü–æ–≤—Ç</div>
                    <div id="scroll2" class="picker-scroll"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>
    
    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let exercises = [];
        let workouts = [];
        let routines = []; 
        let currentView = 'home';
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentWorkout = [];
        let selExId = null; 
        let workoutBackView = 'home';
        
        // –î–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        let exStatsBackView = 'stats';
        let currentViewDate = new Date(); 
        let selExIdHome = null; 
        let selectedExIdEdit = null; 
        let selectedRoutineIdEdit = null;

        // –î–ª—è –ü–∏–∫–µ—Ä–∞
        let activeSetIndex = null;
        let pickerType = 'reps';

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        function init() {
            try {
                const ex = localStorage.getItem('workout-exercises');
                const wo = localStorage.getItem('workout-logs');
                const rt = localStorage.getItem('workout-routines'); 
                exercises = ex ? JSON.parse(ex) : [];
                workouts = wo ? JSON.parse(wo) : [];
                routines = rt ? JSON.parse(rt) : []; 
            } catch (e) {
                console.error(e);
            }
            render();
        }

        function save() {
            localStorage.setItem('workout-exercises', JSON.stringify(exercises));
            localStorage.setItem('workout-logs', JSON.stringify(workouts));
            localStorage.setItem('workout-routines', JSON.stringify(routines)); 
        }

        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerHTML = `<b>${title}</b><br>${message}`;
            container.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function go(view) {
            currentView = view;
            if (view === 'home') {
                selectedDate = new Date().toISOString().split('T')[0];
                workoutBackView = 'home';
            }
            render();
            window.scrollTo(0, 0);
        }

        function render() {
            const views = {
                home: renderHome,
                exercises: renderExercises,
                routines: renderRoutines,
                newWorkout: renderNewWorkout,
                editWorkout: renderNewWorkout, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é
                calendar: renderCalendar,
                detail: renderDetail,
                stats: renderStats,
                exerciseStats: renderExerciseStats,
                settings: renderSettings,
                homeExDetail: renderHomeExerciseDetail,
                editExercise: renderEditExercise,
                editRoutine: renderEditRoutine,
                workoutDetails: renderWorkoutDetails // –≠–ö–†–ê–ù –° –ü–ò–ö–ï–†–û–ú
            };
            if (views[currentView]) {
                document.getElementById('view').innerHTML = views[currentView]();
            }
        }

        // --- –ì–õ–ê–í–ù–ê–Ø ---
        function renderHome() {
            const todayStr = new Date().toISOString().split('T')[0]; 
            const today = workouts.find(w => w.date === todayStr);
            
            let h = `<div class="header fade-in">üí™ –¢—Ä–µ–∫–µ—Ä</div>
                     <div class="card stat-grid fade-in">
                        <div class="stat-item"><p>–í—Å–µ–≥–æ</p><p>${workouts.length}</p></div>
                        <div class="stat-item"><p>–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</p><p>${getStreak()}</p></div>
                        <div class="stat-item"><p>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p><p>${exercises.length}</p></div>
                     </div>
                     <div class="btn-grid">
                        <button class="btn fade-in" onclick="go('newWorkout')">‚ûï –ù–æ–≤–∞—è</button>
                        <button class="btn fade-in" onclick="go('exercises')">üèãÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</button>
                        <button class="btn fade-in" onclick="go('routines')">üìã –®–∞–±–ª–æ–Ω—ã</button>
                        <button class="btn fade-in" onclick="go('calendar')">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
                     </div>
                     <button class="btn btn-secondary fade-in" style="width:100%; margin-top:16px" onclick="go('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                     <button class="btn btn-secondary fade-in" style="width:100%; margin-top:8px" onclick="go('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>`;

            if (today) {
                h += `<div class="card fade-in" style="margin-top: 20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                            <h3 class="header" style="font-size:18px; margin:0;">–°–µ–≥–æ–¥–Ω—è</h3>
                            <button onclick="editToday()" class="save-btn" style="padding:6px 12px;">‚úèÔ∏è</button>
                        </div>`;
                today.exercises.forEach(ex => {
                    const tot = ex.sets.reduce((a,b)=>a+(b.reps||0),0);
                    h += `<div class="exercise-item" onclick="editTodayExercise('${ex.exerciseId}')">
                            <div><b>${ex.exerciseName}</b><br><span style="font-size:12px; color:#cbd5e1;">${ex.sets.length} –ø–æ–¥—Ö ‚Ä¢ ${tot} –ø–æ–≤—Ç</span></div>
                            <span>‚Ä∫</span>
                          </div>`;
                });
                h += `</div>`;
            }
            return h;
        }

        // --- SCROLL PICKER FUNCTIONS (CORE) ---
        function openPicker(index, type) {
            activeSetIndex = index;
            pickerType = type;
            const modal = document.getElementById('pickerModal');
            const ex = currentWorkout.find(e => e.exerciseId === selExId);
            const set = ex.sets[index];

            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
            const col1 = document.getElementById('col1');
            const col2 = document.getElementById('col2');
            const colDec = document.getElementById('colDecimal');
            const dot = document.getElementById('pickerDot');
            const lbl1 = document.getElementById('lbl1');
            const lbl2 = document.getElementById('lbl2');

            // –°–±—Ä–æ—Å
            colDec.style.display = 'none';
            dot.style.display = 'none';

            if (type === 'weight') {
                col1.style.display = 'block';
                col2.style.display = 'block';
                colDec.style.display = 'block';
                dot.style.display = 'flex';
                
                lbl1.innerText = "–ö–≥";
                lbl2.innerText = "–ü–æ–≤—Ç–æ—Ä—ã";

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
                generateScroll('scroll1', 0, 300, 1); // –í–µ—Å —Ü–µ–ª—ã–µ
                generateScroll('scrollDecimal', 0, 75, 25, true); // –í–µ—Å –¥—Ä–æ–±–Ω—ã–µ (.00, .25, .50, .75)
                generateScroll('scroll2', 0, 100, 1); // –ü–æ–≤—Ç–æ—Ä—ã

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π
                const w = set.weight || 0;
                const wInt = Math.floor(w);
                const wDec = Math.round((w - wInt) * 100);
                
                scrollToVal('scroll1', wInt);
                scrollToVal('scrollDecimal', wDec, true);
                scrollToVal('scroll2', set.reps || 0);

            } else if (type === 'distance') {
                col1.style.display = 'block';
                col2.style.display = 'none';
                colDec.style.display = 'block';
                dot.style.display = 'flex';
                
                lbl1.innerText = "–ö–º";
                
                generateScroll('scroll1', 0, 100, 1);
                generateScroll('scrollDecimal', 0, 9, 1, false); // .0 - .9

                const d = set.reps || 0;
                const dInt = Math.floor(d);
                const dDec = Math.round((d - dInt) * 10);

                scrollToVal('scroll1', dInt);
                scrollToVal('scrollDecimal', dDec);

            } else if (type === 'time') {
                col1.style.display = 'none';
                col2.style.display = 'block';
                lbl2.innerText = "–ú–∏–Ω—É—Ç—ã";
                generateScroll('scroll2', 0, 300, 1);
                scrollToVal('scroll2', set.reps || 0);
            } else {
                // Reps only
                col1.style.display = 'none';
                col2.style.display = 'block';
                lbl2.innerText = "–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è";
                generateScroll('scroll2', 0, 200, 1);
                scrollToVal('scroll2', set.reps || 0);
            }

            modal.classList.add('active');
        }

        function closePicker() {
            document.getElementById('pickerModal').classList.remove('active');
        }

        function generateScroll(id, start, end, step, isDec25 = false) {
            const el = document.getElementById(id);
            let h = '<div class="picker-spacer"></div>';
            for (let i = start; i <= end; i += step) {
                let display = i;
                if (isDec25) display = '.' + (i === 0 ? '00' : i);
                else if (id === 'scrollDecimal') display = '.' + i;
                
                h += `<div class="picker-item" data-val="${i}">${display}</div>`;
            }
            h += '<div class="picker-spacer"></div>';
            el.innerHTML = h;
        }

        function scrollToVal(id, val, isDec25 = false) {
            const el = document.getElementById(id);
            // –ù–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–∞–∫–∏–º data-val –∏ –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ –Ω–µ–º—É
            // –ü—Ä–æ—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –≤—ã—Å–æ—Ç—ã (50px item)
            // –ù–æ –Ω–∞–¥–µ–∂–Ω–µ–µ –Ω–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å
            setTimeout(() => {
                const items = Array.from(el.querySelectorAll('.picker-item'));
                const idx = items.findIndex(it => parseInt(it.dataset.val) === val);
                if (idx > -1) el.scrollTop = idx * 50;
            }, 10);
        }

        function getScrollVal(id) {
            const el = document.getElementById(id);
            const idx = Math.round(el.scrollTop / 50);
            const items = el.querySelectorAll('.picker-item');
            if (items[idx]) return parseFloat(items[idx].dataset.val);
            return 0;
        }

        function savePickerValue() {
            const ex = currentWorkout.find(e => e.exerciseId === selExId);
            const set = ex.sets[activeSetIndex];

            if (pickerType === 'weight') {
                const wInt = getScrollVal('scroll1');
                const wDec = getScrollVal('scrollDecimal');
                set.weight = wInt + (wDec / 100);
                set.reps = getScrollVal('scroll2');
            } else if (pickerType === 'distance') {
                const dInt = getScrollVal('scroll1');
                const dDec = getScrollVal('scrollDecimal');
                set.reps = dInt + (dDec / 10);
            } else {
                set.reps = getScrollVal('scroll2');
            }

            closePicker();
            render(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —ç–∫—Ä–∞–Ω
        }

        // --- WORKOUT DETAILS & EDITING ---
        function viewWorkoutDetails(exId, backView = 'newWorkout') {
            selExId = exId;
            workoutBackView = backView;
            go('workoutDetails');
        }

        function handleWorkoutDetailsBack() {
            if (workoutBackView === 'home') {
                saveWorkout(); // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            } else {
                go(workoutBackView);
            }
        }

        function renderWorkoutDetails() {
            if (!selExId) return go('newWorkout');
            const ex = currentWorkout.find(e => e.exerciseId === selExId);
            if (!ex) return go('newWorkout');

            const baseEx = exercises.find(e => e.id === selExId) || { type: 'reps' };
            const type = baseEx.type;

            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="handleWorkoutDetailsBack()">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0; overflow: hidden; text-overflow: ellipsis; max-width:220px; white-space:nowrap;">${ex.exerciseName}</h2>
                        <div style="width: 40px;"></div>
                     </div>
                     <div class="card fade-in">
                        <h3 style="color:#cbd5e1; font-size:16px; margin-bottom:16px;">–ü–æ–¥—Ö–æ–¥—ã</h3>`;

            if (ex.sets.length === 0) h += `<div style="text-align:center; padding:20px; color:#64748b">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥"</div>`;

            ex.sets.forEach((set, i) => {
                let valText = "";
                let subText = "";
                
                if (type === 'weight') {
                    valText = `${set.weight || 0}`;
                    subText = `–∫–≥ √ó ${set.reps || 0} –ø–æ–≤—Ç`;
                } else if (type === 'distance') {
                    valText = `${set.reps || 0}`;
                    subText = `–∫–º`;
                } else if (type === 'time') {
                    valText = `${set.reps || 0}`;
                    subText = `–º–∏–Ω`;
                } else {
                    valText = `${set.reps || 0}`;
                    subText = `–ø–æ–≤—Ç`;
                }

                h += `<div class="set-row-display" onclick="openPicker(${i}, '${type}')">
                        <div class="set-info">
                            <div class="set-idx">${i + 1}</div>
                            <div>
                                <span class="set-values">${valText}</span>
                                <span class="set-sub">${subText}</span>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="color:#6366f1; font-size:14px;">–ò–∑–º–µ–Ω–∏—Ç—å</span>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteSet(${i})">üóëÔ∏è</button>
                        </div>
                      </div>`;
            });

            h += `<button class="btn" style="margin-top:16px;" onclick="addSet('${type}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>
                  </div>`;
            return h;
        }

        function addSet(type) {
            const ex = currentWorkout.find(e => e.exerciseId === selExId);
            // –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ–¥—Ö–æ–¥
            let newSet = { setNumber: ex.sets.length + 1, reps: 0, weight: 0 };
            if (ex.sets.length > 0) {
                const last = ex.sets[ex.sets.length - 1];
                newSet.reps = last.reps;
                newSet.weight = last.weight;
            }
            ex.sets.push(newSet);
            render();
        }

        function deleteSet(index) {
            const ex = currentWorkout.find(e => e.exerciseId === selExId);
            ex.sets.splice(index, 1);
            ex.sets.forEach((s, i) => s.setNumber = i + 1);
            render();
        }

        // --- –õ–û–ì–ò–ö–ê –¢–†–ï–ù–ò–†–û–í–û–ö ---
        function editToday() {
            const todayStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayStr);
            if (wo) {
                selectedDate = todayStr;
                editWorkout(todayStr);
            } else {
                go('newWorkout');
            }
        }
        
        function editTodayExercise(exId) {
            const todayStr = new Date().toISOString().split('T')[0];
            const wo = workouts.find(w => w.date === todayStr);
            if (!wo) return;
            selectedDate = todayStr;
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            selExId = exId;
            workoutBackView = 'home';
            go('workoutDetails');
        }

        function editWorkout(dateStr) {
            selectedDate = dateStr;
            const wo = workouts.find(w => w.date === selectedDate);
            if (!wo) { return go('calendar'); }
            currentWorkout = JSON.parse(JSON.stringify(wo.exercises));
            go('editWorkout');
        }

        function saveWorkout() {
            if (currentWorkout.length === 0) { showToast('–û—à–∏–±–∫–∞', '–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π'); return; }
            const valid = currentWorkout.filter(e => e.sets.length > 0); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥—Ö–æ–¥—ã
            
            const newWo = { date: selectedDate, exercises: valid };
            const idx = workouts.findIndex(w => w.date === selectedDate);
            if (idx > -1) workouts[idx] = newWo;
            else workouts.push(newWo);
            
            workouts.sort((a,b) => new Date(b.date) - new Date(a.date));
            save();
            showToast('–£—Å–ø–µ—Ö', '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
            go('home');
        }

        function renderNewWorkout() {
            let h = `<div class="top-bar fade-in">
                        <button class="back-btn" onclick="go('home')">‚Üê</button>
                        <h2 class="header" style="margin-bottom: 0;">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                        <button class="save-btn" onclick="saveWorkout()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                     </div>
                     <div class="card fade-in">
                        <input type="date" value="${selectedDate}" onchange="selectedDate=this.value">
                        
                        ${routines.length ? `<div style="margin:10px 0; display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;">
                            ${routines.map(r => `<button class="btn btn-secondary" style="min-width:100px; padding:8px;" onclick="loadRoutine('${r.id}')">${r.name}</button>`).join('')}
                        </div>` : ''}

                        <div id="woList">`;
            
            if (currentWorkout.length === 0) h += `<div class="empty-state">–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>`;
            
            currentWorkout.forEach(ex => {
                const b = exercises.find(e=>e.id===ex.exerciseId);
                let desc = `${ex.sets.length} –ø–æ–¥—Ö–æ–¥–æ–≤`;
                h += `<div class="exercise-item" onclick="viewWorkoutDetails('${ex.exerciseId}', currentView)">
                        <div><b>${ex.exerciseName}</b><br><span style="font-size:12px; color:#94a3b8;">${desc}</span></div>
                        <button class="delete-btn" onclick="event.stopPropagation(); removeExFromWo('${ex.exerciseId}')">üóëÔ∏è</button>
                      </div>`;
            });

            h += `</div>
                  <button class="btn" style="margin-top:16px;" onclick="document.getElementById('addExModal').classList.remove('hide')">–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                  </div>`;
            
            // –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            h += `<div id="addExModal" class="card hide" style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000; width:90%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.7);">
                    <h3 class="header">–í—ã–±–µ—Ä–∏—Ç–µ</h3>
                    <div style="max-height:300px; overflow-y:auto;">`;
            exercises.forEach(ex => {
                if(!currentWorkout.find(c=>c.exerciseId===ex.id)) {
                    h += `<div class="exercise-item" onclick="addExToWo('${ex.id}', '${ex.name}')">${ex.name}</div>`;
                }
            });
            h += `</div><button class="btn btn-secondary" style="margin-top:10px" onclick="document.getElementById('addExModal').classList.add('hide')">–û—Ç–º–µ–Ω–∞</button></div>`;

            return h;
        }

        function addExToWo(id, name) {
            currentWorkout.push({ exerciseId: id, exerciseName: name, sets: [] });
            document.getElementById('addExModal').classList.add('hide');
            render();
        }

        function removeExFromWo(id) {
            currentWorkout = currentWorkout.filter(e => e.exerciseId !== id);
            render();
        }

        function loadRoutine(id) {
            const r = routines.find(x => x.id === id);
            if(r) {
                if(currentWorkout.length > 0 && !confirm('–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é?')) return;
                currentWorkout = JSON.parse(JSON.stringify(r.exercises));
                currentWorkout.forEach(e => e.sets = []); // –û—á–∏—â–∞–µ–º –ø–æ–¥—Ö–æ–¥—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞–±–ª–æ–Ω–∞
                render();
            }
        }

        // --- –ö–ê–õ–ï–ù–î–ê–†–¨ ---
        function renderCalendar() {
            const monthName = currentViewDate.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay() || 7;
            
            let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('home')">‚Üê</button><h2 class="header" style="margin:0">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2><div></div></div>
                     <div class="card fade-in">
                        <div class="month-nav">
                            <button onclick="changeMonth(-1)">‚Äπ</button><h3>${monthName}</h3><button onclick="changeMonth(1)">‚Ä∫</button>
                        </div>
                        <div class="calendar-grid">
                            ${['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(d=>`<div style="text-align:center; font-size:12px; color:#94a3b8;">${d}</div>`).join('')}`;
            
            for(let i=1; i<firstDay; i++) h+=`<div></div>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dateStr = new Date(year, month, d+1).toISOString().split('T')[0]; // fix timezone offset simple hack
                const hasWo = workouts.some(w => w.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                let cls = 'calendar-day';
                if(hasWo) cls += ' day-workout';
                if(isToday) cls += ' day-today';
                h += `<button class="${cls}" onclick="selectedDate='${dateStr}'; go('detail')">${d}</button>`;
            }
            h += `</div></div>`;
            return h;
        }
        
        function changeMonth(dir) {
            currentViewDate.setMonth(currentViewDate.getMonth() + dir);
            render();
        }

        function renderDetail() {
            const wo = workouts.find(w => w.date === selectedDate);
            if(!wo) return go('newWorkout'); // –ï—Å–ª–∏ –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å
            
            let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('calendar')">‚Üê</button><h2 class="header" style="margin:0">–û–±–∑–æ—Ä</h2><button class="save-btn" onclick="editWorkout('${selectedDate}')">‚úèÔ∏è</button></div>
                     <div class="card fade-in">
                        <h3 style="color:#cbd5e1">${selectedDate}</h3>
                        ${wo.exercises.map(e => `
                            <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1)">
                                <b>${e.exerciseName}</b>
                                <div style="font-size:14px; color:#94a3b8;">
                                    ${e.sets.map((s,i) => `<div>${i+1}. ${s.weight?s.weight+'–∫–≥ √ó ':''}${s.reps}</div>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                     </div>`;
            return h;
        }

        // --- –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø ---
        function renderExercises() {
            let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('home')">‚Üê</button><h2 class="header" style="margin:0">–ë–∞–∑–∞</h2><div></div></div>
                     <div class="card fade-in">
                        <input id="newExName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                        <select id="newExType">
                            <option value="weight">–í–µ—Å + –ü–æ–≤—Ç–æ—Ä—ã</option>
                            <option value="reps">–¢–æ–ª—å–∫–æ –ø–æ–≤—Ç–æ—Ä—ã</option>
                            <option value="distance">–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</option>
                            <option value="time">–í—Ä–µ–º—è (–º–∏–Ω)</option>
                        </select>
                        <button class="btn" onclick="addExBase()">–°–æ–∑–¥–∞—Ç—å</button>
                     </div>`;
            exercises.forEach(e => {
                h += `<div class="exercise-item fade-in" onclick="editExBase('${e.id}')">
                        <span>${e.name}</span><span>‚úèÔ∏è</span>
                      </div>`;
            });
            return h;
        }

        function addExBase() {
            const name = document.getElementById('newExName').value;
            const type = document.getElementById('newExType').value;
            if(name) {
                exercises.push({id: Date.now().toString(), name, type});
                save(); render();
            }
        }

        function editExBase(id) { selectedExIdEdit = id; go('editExercise'); }

        function renderEditExercise() {
            const ex = exercises.find(e=>e.id===selectedExIdEdit);
            return `<div class="top-bar fade-in"><button class="back-btn" onclick="go('exercises')">‚Üê</button><h2 class="header" style="margin:0">–†–µ–¥.</h2><button class="save-btn" onclick="saveExEdit()">OK</button></div>
                    <div class="card fade-in">
                        <input id="editExName" value="${ex.name}">
                        <button class="btn btn-danger" style="margin-top:20px" onclick="delExBase('${ex.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;
        }

        function saveExEdit() {
            const n = document.getElementById('editExName').value;
            const ex = exercises.find(e=>e.id===selectedExIdEdit);
            if(ex && n) { ex.name = n; save(); go('exercises'); }
        }
        
        function delExBase(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ?')) {
                exercises = exercises.filter(e=>e.id!==id);
                save(); go('exercises');
            }
        }

        // --- –®–ê–ë–õ–û–ù–´ ---
        function renderRoutines() {
            let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('home')">‚Üê</button><h2 class="header" style="margin:0">–®–∞–±–ª–æ–Ω—ã</h2><div></div></div>
                     <div class="card fade-in">
                        <input id="newRtName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞">
                        <button class="btn" onclick="addRoutine()">–°–æ–∑–¥–∞—Ç—å</button>
                     </div>`;
            routines.forEach(r => {
                h += `<div class="exercise-item fade-in" onclick="editRoutine('${r.id}')">
                        <span>${r.name}</span><span>‚úèÔ∏è</span>
                      </div>`;
            });
            return h;
        }

        function addRoutine() {
            const n = document.getElementById('newRtName').value;
            if(n) { routines.push({id:Date.now().toString(), name:n, exercises:[]}); save(); render(); }
        }
        
        function editRoutine(id) { selectedRoutineIdEdit = id; go('editRoutine'); }
        
        function renderEditRoutine() {
            const rt = routines.find(r=>r.id===selectedRoutineIdEdit);
            currentWorkout = rt.exercises; // HACK: –∏—Å–ø–æ–ª—å–∑—É–µ–º currentWorkout –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
            
            // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º renderNewWorkout —á–∞—Å—Ç–∏—á–Ω–æ –¥–ª—è —à–∞–±–ª–æ–Ω–∞, –Ω–æ –ø—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ UI
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ —ç—Ç–æ–º –∫–æ–¥–µ, —Å–æ—Ö—Ä–∞–Ω–∏–º –ª–æ–≥–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –±–ª–æ–∫–µ
            
            let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('routines')">‚Üê</button><h2 class="header" style="margin:0">${rt.name}</h2><button class="save-btn" onclick="saveRoutineData()">–°–æ—Ö—Ä</button></div>
                     <div class="card fade-in">
                        <p style="color:#94a3b8; font-size:14px; margin-bottom:10px;">–î–æ–±–∞–≤—å—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —à–∞–±–ª–æ–Ω:</p>
                        ${rt.exercises.map(e=>`<div class="exercise-item"><span>${e.exerciseName}</span><button class="delete-btn" onclick="remExFromRt('${e.exerciseId}')">üóëÔ∏è</button></div>`).join('')}
                        <button class="btn" style="margin-top:10px" onclick="document.getElementById('addExRt').classList.remove('hide')">–î–æ–±–∞–≤–∏—Ç—å</button>
                        <button class="btn btn-danger" style="margin-top:20px" onclick="delRoutine()">–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
                     </div>
                     
                     <div id="addExRt" class="card hide" style="position:fixed; top:20%; left:5%; width:90%; z-index:100;">
                        <h3>–î–æ–±–∞–≤–∏—Ç—å</h3>
                        <div style="max-height:300px; overflow-y:auto">
                            ${exercises.map(e=>`<div class="exercise-item" onclick="addExToRt('${e.id}','${e.name}')">${e.name}</div>`).join('')}
                        </div>
                        <button class="btn btn-secondary" onclick="document.getElementById('addExRt').classList.add('hide')">–ó–∞–∫—Ä—ã—Ç—å</button>
                     </div>`;
            return h;
        }

        function addExToRt(id, name) {
            const rt = routines.find(r=>r.id===selectedRoutineIdEdit);
            rt.exercises.push({exerciseId:id, exerciseName:name, sets:[]});
            save(); render();
        }
        
        function remExFromRt(id) {
            const rt = routines.find(r=>r.id===selectedRoutineIdEdit);
            rt.exercises = rt.exercises.filter(e=>e.exerciseId!==id);
            save(); render();
        }

        function delRoutine() {
            routines = routines.filter(r=>r.id!==selectedRoutineIdEdit);
            save(); go('routines');
        }
        function saveRoutineData() { save(); go('routines'); }

        // --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê (Charts) ---
        function renderStats() {
             let h = `<div class="top-bar fade-in"><button class="back-btn" onclick="go('home')">‚Üê</button><h2 class="header" style="margin:0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2><div></div></div>
                      <div class="card fade-in">`;
             if(!exercises.length) h += '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
             exercises.forEach(ex => {
                 h += `<div class="exercise-item" onclick="selExId='${ex.id}'; go('exerciseStats')"><span>${ex.name}</span><span>üìä</span></div>`;
             });
             h += `</div>`;
             return h;
        }

        function renderExerciseStats() {
            const ex = exercises.find(e=>e.id===selExId);
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const data = [];
            workouts.forEach(w => {
                const we = w.exercises.find(e=>e.exerciseId===selExId);
                if(we) {
                    const max = we.sets.reduce((a,b)=>Math.max(a, b.weight||b.reps), 0);
                    data.push({date: w.date, val: max});
                }
            });
            data.sort((a,b)=>new Date(a.date)-new Date(b.date));
            
            setTimeout(() => {
                if(document.getElementById('chart')) {
                    new Chart(document.getElementById('chart'), {
                        type: 'line',
                        data: {
                            labels: data.map(d=>d.date.slice(5)),
                            datasets: [{
                                label: '–ü—Ä–æ–≥—Ä–µ—Å—Å',
                                data: data.map(d=>d.val),
                                borderColor: '#6366f1',
                                tension: 0.4
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true } } }
                    });
                }
            }, 100);

            return `<div class="top-bar fade-in"><button class="back-btn" onclick="go('stats')">‚Üê</button><h2 class="header" style="margin:0">${ex.name}</h2><div></div></div>
                    <div class="card fade-in">
                        <canvas id="chart"></canvas>
                    </div>`;
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        function renderSettings() {
            return `<div class="top-bar fade-in"><button class="back-btn" onclick="go('home')">‚Üê</button><h2 class="header" style="margin:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2><div></div></div>
                    <div class="card fade-in">
                        <button class="btn" onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç (JSON)</button>
                        <button class="btn btn-secondary" style="margin-top:10px" onclick="importData()">–ò–º–ø–æ—Ä—Ç (JSON)</button>
                        <button class="btn btn-danger" style="margin-top:30px" onclick="if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ?')) {localStorage.clear(); location.reload();}">–°–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö</button>
                    </div>`;
        }

        function exportData() {
            const d = JSON.stringify({exercises, workouts, routines});
            const blob = new Blob([d], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href=url; a.download='workout_backup.json'; a.click();
        }
        
        function importData() {
            const input = document.createElement('input'); input.type='file';
            input.onchange = e => {
                const fr = new FileReader();
                fr.onload = ev => {
                    const d = JSON.parse(ev.target.result);
                    exercises = d.exercises; workouts = d.workouts; routines = d.routines;
                    save(); render();
                };
                fr.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function getStreak() {
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ç—Ä–∏–∫–∞
            return workouts.length; 
        }

        init();
    </script>
</body>
</html>
