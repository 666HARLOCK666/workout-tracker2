<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            background: #f5f5f5;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }
        .header-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 24px; color: white; margin-bottom: 16px; }
        .stat-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 16px; 
            margin-top: 16px; 
            text-align: center; 
        }
        .stat-item h3 { font-size: 20px; font-weight: 700; }
        .stat-item p { font-size: 12px; opacity: 0.8; }
        .card { 
            background: #fff; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 8px 16px;
            background: #fff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
        .nav-button {
            flex-grow: 1;
            padding: 12px;
            border-radius: 12px; /* –£–≤–µ–ª–∏—á–µ–Ω –¥–ª—è —ç—Å—Ç–µ—Ç–∏–∫–∏ */
            background: #fff;
            color: #333;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease-in-out; /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å --- */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .nav-button:active {
            background: #f0f0f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05), 0 0 1px rgba(0, 0, 0, 0.05);
            transform: translateY(1px); /* –≠—Ñ—Ñ–µ–∫—Ç "–Ω–∞–∂–∞—Ç–∏—è" */
        }
        
        .nav-button.active {
            color: #764ba2;
        }
        .icon { font-size: 20px; margin-bottom: 4px; }
        
        /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –°—Ç–∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è --- */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
        }
        .calendar-header button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            color: #764ba2;
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ */
            text-align: center;
            font-weight: 600;
            color: #999;
            margin-bottom: 8px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –¥–Ω–µ–π */
            gap: 4px; /* –ù–µ–±–æ–ª—å—à–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ –º–µ–∂–¥—É –¥–Ω—è–º–∏ */
        }
        .calendar-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* –î–µ–ª–∞–µ—Ç —è—á–µ–π–∫—É –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π (–ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï) */
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            padding: 0; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π padding */
            line-height: 1; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        }
        .calendar-day.prev-month, 
        .calendar-day.next-month {
            opacity: 0.5;
        }
        .calendar-day.has-workout {
            background-color: #e0f7fa; /* –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω –¥–ª—è –¥–Ω—è —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π */
            font-weight: 600;
        }
        .calendar-day.current-day {
            border: 2px solid #764ba2;
            background-color: #f0e6ff;
        }
        .day-dot {
            width: 6px;
            height: 6px;
            background-color: #764ba2;
            border-radius: 50%;
            margin-top: 2px;
        }
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤... */
        .list-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
            cursor: pointer;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item h4 { font-size: 16px; font-weight: 600; }
        .list-item p { font-size: 12px; color: #999; }
        .list-item-right { text-align: right; }
        .button-group { display: flex; gap: 8px; margin-top: 12px; }
        .button-group button { 
            padding: 8px 12px; 
            border-radius: 8px; 
            border: none; 
            font-size: 14px; 
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-primary { background: #764ba2; color: white; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-block { width: 100%; margin-top: 12px; }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .workout-exercise-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .set-row {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            align-items: center;
        }
        .set-row input {
            flex-grow: 1;
            text-align: center;
            margin-bottom: 0;
        }
        .set-row .label {
            font-size: 12px;
            width: 30px;
            text-align: right;
            color: #999;
        }
        .set-row .remove-btn {
            flex-grow: 0;
            width: 30px;
            padding: 8px;
            background: #f0f0f0;
            color: #333;
        }
        .total-stats {
            margin-top: 8px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        .stat-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
            font-size: 14px;
        }
        .stat-detail-item:last-child { border-bottom: none; }
        .chart-container {
             margin-top: 16px;
             padding: 16px;
             background: #fff;
             border-radius: 12px;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .pr-list-item {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .pr-list-item:last-child { border-bottom: none; }
        .pr-name { font-weight: 600; }
        .pr-date { font-size: 12px; color: #999; }
        .pr-value { text-align: right; font-weight: 600; color: #764ba2; }
    </style>
</head>
<body>
    <div id="app" class="container"></div>

    <div id="nav-bar" class="nav-bar">
        </div>

    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        const VIEWS = { HOME: 'home', WORKOUT: 'workout', ROUTINES: 'routines', STATS: 'stats', SETTINGS: 'settings' };
        let currentView = VIEWS.HOME;
        let workouts = [];
        let exercises = [];
        let routines = [];
        let currentWorkout = [];
        let currentWorkoutId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentExerciseStatsId = null;

        function save() {
            localStorage.setItem('workouts', JSON.stringify(workouts));
            localStorage.setItem('exercises', JSON.stringify(exercises));
            localStorage.setItem('routines', JSON.stringify(routines));
        }

        function load() {
            const savedWorkouts = localStorage.getItem('workouts');
            const savedExercises = localStorage.getItem('exercises');
            const savedRoutines = localStorage.getItem('routines');

            if (savedWorkouts) workouts = JSON.parse(savedWorkouts);
            if (savedExercises) exercises = JSON.parse(savedExercises);
            if (savedRoutines) routines = JSON.parse(savedRoutines);
        }

        function init() {
            load();
            if (exercises.length === 0) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
                exercises = [
                    { id: 1, name: '–ñ–∏–º –ª–µ–∂–∞', group: '–ì—Ä—É–¥—å' },
                    { id: 2, name: '–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', group: '–ù–æ–≥–∏' },
                    { id: 3, name: '–¢—è–≥–∞ –±–ª–æ–∫–∞', group: '–°–ø–∏–Ω–∞' },
                    { id: 4, name: '–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π', group: '–ì—Ä—É–¥—å' },
                    { id: 5, name: '–ñ–∏–º –Ω–æ–≥–∞–º–∏', group: '–ù–æ–≥–∏' },
                    { id: 6, name: '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', group: '–°–ø–∏–Ω–∞' },
                    { id: 7, name: '–ê—Ä–º–µ–π—Å–∫–∏–π –∂–∏–º', group: '–ü–ª–µ—á–∏' },
                    { id: 8, name: '–°–≥–∏–±–∞–Ω–∏–µ —Ä—É–∫ —Å–æ —à—Ç–∞–Ω–≥–æ–π', group: '–ë–∏—Ü–µ–ø—Å' },
                    { id: 9, name: '–†–∞–∑–≥–∏–±–∞–Ω–∏–µ —Ä—É–∫ –≤ –±–ª–æ–∫–µ', group: '–¢—Ä–∏—Ü–µ–ø—Å' }
                ];
                save();
            }
            render();
        }

        // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ---
        function setView(view) {
            currentView = view;
            render();
        }

        function renderNavBar() {
            const navBar = document.getElementById('nav-bar');
            const navItems = [
                { view: VIEWS.HOME, icon: 'üè†', label: '–ì–ª–∞–≤–Ω–∞—è' },
                { view: VIEWS.WORKOUT, icon: 'üìù', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' },
                { view: VIEWS.ROUTINES, icon: 'üìã', label: '–®–∞–±–ª–æ–Ω—ã' },
                { view: VIEWS.STATS, icon: 'üìà', label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' },
                { view: VIEWS.SETTINGS, icon: '‚öôÔ∏è', label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' }
            ];

            navBar.innerHTML = navItems.map(item => `
                <button class="nav-button ${currentView === item.view ? 'active' : ''}" onclick="setView('${item.view}')">
                    <span class="icon">${item.icon}</span>
                    ${item.label}
                </button>
            `).join('');
        }

        function render() {
            renderNavBar();
            const app = document.getElementById('app');
            let html = '';

            switch (currentView) {
                case VIEWS.HOME:
                    html = renderHome();
                    break;
                case VIEWS.WORKOUT:
                    html = renderWorkout();
                    break;
                case VIEWS.ROUTINES:
                    html = renderRoutines();
                    break;
                case VIEWS.STATS:
                    html = renderStats();
                    break;
                case VIEWS.SETTINGS:
                    html = renderSettings();
                    break;
            }

            app.innerHTML = html;
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≥—Ä–∞—Ñ–∏–∫–æ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (currentView === VIEWS.STATS && currentExerciseStatsId) {
                renderChart(currentExerciseStatsId);
            }
        }

        // --- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ---
        function renderHome() {
            const totalWorkouts = workouts.length;
            const totalExercises = new Set(workouts.flatMap(w => w.exercises.map(e => e.exerciseId))).size;
            const totalVolume = workouts.reduce((sum, w) => sum + w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0), 0);
            
            const lastWorkout = workouts.length > 0 ? workouts[workouts.length - 1] : null;
            const lastWorkoutDate = lastWorkout ? new Date(lastWorkout.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }) : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            const lastWorkoutName = lastWorkout ? lastWorkout.name : '';

            const h = `
                <div class="header-card">
                    <h2>üëã –ü—Ä–∏–≤–µ—Ç!</h2>
                    <p style="opacity: 0.8; font-size: 14px;">–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è:</p>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <h3>${totalWorkouts}</h3>
                            <p>–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                        </div>
                        <div class="stat-item">
                            <h3>${totalExercises}</h3>
                            <p>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
                        </div>
                        <div class="stat-item">
                            <h3>${(totalVolume / 1000).toFixed(1)} —Ç</h3>
                            <p>–û–±—â–∏–π –æ–±—ä–µ–º</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin: 0;">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h3>
                        <p style="font-size: 14px; color: #764ba2;">${lastWorkoutDate}</p>
                    </div>
                    <p style="font-size: 16px; font-weight: 600;">${lastWorkoutName || '–ù–∞—á–Ω–∏ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!'}</p>
                    <div class="button-group" style="margin-top: 16px;">
                        <button class="btn-primary" onclick="startNewWorkout()" style="flex-grow: 1;">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é</button>
                        ${lastWorkout ? `<button class="btn-secondary" onclick="loadWorkoutFromHistory(${lastWorkout.id})" style="flex-grow: 1;">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>` : ''}
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 12px;">–¢–≤–æ–π –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
                    ${renderCalendar(currentMonth, currentYear)}
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 12px;">
                        <span style="font-size: 14px;"><span style="color: #764ba2; font-weight: bold;">‚óè</span> –°–µ–≥–æ–¥–Ω—è</span>
                        <span style="font-size: 14px;"><span style="color: #e0f7fa; background: #764ba2; border-radius: 50%; padding: 0 5px;">&nbsp;</span> –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span>
                    </div>
                </div>
            `;
            return h;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            render();
        }

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –õ–æ–≥–∏–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è ---
        function renderCalendar(month, year) {
            const date = new Date(year, month);
            const today = new Date();
            const startDay = new Date(year, month, 1).getDay(); // 0=–í—Å, 1=–ü–Ω
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();
            
            // –°–º–µ—â–∞–µ–º –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (–µ—Å–ª–∏ startDay=0 (–í—Å), —Ç–æ 6, –∏–Ω–∞—á–µ startDay-1)
            const firstDayOfWeek = startDay === 0 ? 6 : startDay - 1; 

            const monthName = date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            const workoutDates = workouts.map(w => new Date(w.date).toDateString());

            let daysHtml = '';

            // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏)
            const numPrevDays = firstDayOfWeek;
            for (let i = numPrevDays - 1; i >= 0; i--) {
                const dayNum = prevMonthDays - i;
                daysHtml += `<div class="calendar-day prev-month">${dayNum}</div>`;
            }

            // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDate = new Date(year, month, i);
                const isToday = dayDate.toDateString() === today.toDateString();
                const hasWorkout = workoutDates.includes(dayDate.toDateString());

                let classes = '';
                if (isToday) classes += ' current-day';
                if (hasWorkout) classes += ' has-workout';

                daysHtml += `
                    <div class="calendar-day${classes}" onclick="showDayWorkouts('${dayDate.toISOString().split('T')[0]}')">
                        <span>${i}</span>
                        ${hasWorkout ? '<div class="day-dot"></div>' : ''}
                    </div>
                `;
            }

            // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏ –¥–æ 6 —Ä—è–¥–æ–≤)
            const totalCells = numPrevDays + daysInMonth;
            const numNextDays = 42 - totalCells; // 6 —Ä—è–¥–æ–≤ –ø–æ 7 –¥–Ω–µ–π = 42
            
            for (let i = 1; i <= numNextDays; i++) {
                daysHtml += `<div class="calendar-day next-month">${i}</div>`;
            }
            
            return `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button onclick="changeMonth(-1)">&#x25C0;</button>
                        <span>${monthName}</span>
                        <button onclick="changeMonth(1)">&#x25B6;</button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>–ü–Ω</span><span>–í—Ç</span><span>–°—Ä</span><span>–ß—Ç</span><span>–ü—Ç</span><span>–°–±</span><span>–í—Å</span>
                    </div>
                    <div class="calendar-grid">
                        ${daysHtml}
                    </div>
                </div>
            `;
        }

        // --- –õ–æ–≥–∏–∫–∞ –¥—Ä—É–≥–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤... (–æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

        function showDayWorkouts(dateString) {
            const date = new Date(dateString);
            const dailyWorkouts = workouts.filter(w => new Date(w.date).toDateString() === date.toDateString());
            
            if (dailyWorkouts.length === 0) {
                alert(`–ù–∞ ${date.toLocaleDateString('ru-RU')} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –Ω–µ—Ç.`);
                return;
            }

            let detailsHtml = `<h3>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ ${date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}</h3>`;
            
            dailyWorkouts.forEach(w => {
                const totalVolume = w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0);
                const totalSets = w.exercises.reduce((sets, e) => sets + e.sets.length, 0);

                detailsHtml += `
                    <div class="card" onclick="viewWorkoutHistory(${w.id})">
                        <h4>${w.name}</h4>
                        <p style="font-size: 12px; color: #999;">${new Date(w.date).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}</p>
                        <div class="total-stats">
                            <span>–û–±—ä–µ–º: ${(totalVolume / 1000).toFixed(1)} —Ç</span>
                            <span>–°–µ—Ç–æ–≤: ${totalSets}</span>
                        </div>
                    </div>
                `;
            });

            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Telegram WebApp –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ alert
            if (window.Telegram && window.Telegram.WebApp) {
                 window.Telegram.WebApp.showAlert(detailsHtml); // –ù–∞—Å—Ç–æ—è—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–≥–æ UI
            } else {
                 let alertText = `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∑–∞ ${date.toLocaleDateString('ru-RU')}:\n`;
                 dailyWorkouts.forEach(w => {
                     const totalVolume = w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0);
                     alertText += `\n${w.name} (${(totalVolume / 1000).toFixed(1)} —Ç)`;
                 });
                 alert(alertText);
            }
        }
        
        function getExerciseName(id) {
            const ex = exercises.find(e => e.id === id);
            return ex ? ex.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ';
        }

        function calculateWorkoutStats(workout) {
            let totalVolume = 0;
            let totalSets = 0;
            workout.exercises.forEach(ex => {
                totalSets += ex.sets.length;
                ex.sets.forEach(set => {
                    totalVolume += set.weight * set.reps;
                });
            });
            return { totalVolume, totalSets };
        }

        // --- –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (Workouts) ---

        function startNewWorkout() {
            currentWorkout = [];
            currentWorkoutId = Date.now();
            currentView = VIEWS.WORKOUT;
            render();
        }

        function addExercise(id = null) {
            const newExId = id || Date.now();
            currentWorkout.push({
                id: newExId,
                exerciseId: null,
                sets: [{ id: Date.now(), weight: 0, reps: 0 }]
            });
            render();
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–æ–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            setTimeout(() => {
                document.getElementById(`ex-${newExId}`).scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function selectExercise(workoutExId, exerciseId) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                workoutEx.exerciseId = parseInt(exerciseId);
                render();
            }
        }

        function addSet(workoutExId) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–µ—Å–æ–º –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–µ—Ç–∞
                const lastSet = workoutEx.sets[workoutEx.sets.length - 1] || { weight: 0, reps: 0 };
                workoutEx.sets.push({ id: Date.now(), weight: lastSet.weight, reps: lastSet.reps });
                render();
            }
        }

        function removeSet(workoutExId, setId) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                workoutEx.sets = workoutEx.sets.filter(s => s.id != setId);
                render();
            }
        }

        function updateSet(workoutExId, setId, field, value) {
            const workoutEx = currentWorkout.find(ex => ex.id == workoutExId);
            if (workoutEx) {
                const set = workoutEx.sets.find(s => s.id == setId);
                if (set) {
                    set[field] = parseFloat(value) || 0;
                }
            }
        }

        function finishWorkout() {
            const workoutName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', '–ú–æ—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞');
            if (!workoutName) return;

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —É–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ id –∏ —Å–µ—Ç—ã —Å 0 –≤–µ—Å–æ–º/–ø–æ–≤—Ç–æ—Ä–∞–º–∏
            const finalWorkout = currentWorkout.filter(ex => ex.exerciseId !== null).map(ex => ({
                ...ex,
                sets: ex.sets.filter(s => s.weight > 0 || s.reps > 0)
            })).filter(ex => ex.sets.length > 0);

            if (finalWorkout.length === 0) {
                alert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø—É—Å—Ç–∞.');
                return;
            }

            const newWorkout = {
                id: currentWorkoutId,
                name: workoutName,
                date: new Date().toISOString(),
                exercises: finalWorkout
            };

            workouts.push(newWorkout);
            save();
            currentWorkout = [];
            currentWorkoutId = null;
            alert('‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            setView(VIEWS.HOME);
        }

        function renderWorkout() {
            if (currentWorkout.length === 0) {
                setTimeout(() => addExercise(), 0); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                return `<div class="card"><h3>–ù–∞—á–∞–ª–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏...</h3></div>`;
            }

            const allExercises = exercises.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('');

            let html = `
                <div class="card">
                    <h2 style="margin-bottom: 12px;">–¢–µ–∫—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</h2>
                    <button class="btn-primary" onclick="addExercise()" style="width: 100%;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                    <div style="margin-top: 12px; font-size: 14px; color: #666;">
                        ${currentWorkout.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                    </div>
                </div>
                <div id="workout-list">
                    ${currentWorkout.map(ex => `
                        <div class="card" id="ex-${ex.id}">
                            <div class="workout-exercise-title">
                                <select 
                                    onchange="selectExercise(${ex.id}, this.value)" 
                                    style="padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; flex-grow: 1;"
                                >
                                    <option value="" ${ex.exerciseId === null ? 'selected' : ''}>–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</option>
                                    ${exercises.map(e => 
                                        `<option value="${e.id}" ${ex.exerciseId == e.id ? 'selected' : ''}>${e.name}</option>`
                                    ).join('')}
                                </select>
                                <button class="btn-secondary" style="margin-left: 8px;" onclick="removeExercise(${ex.id})">‚ùå</button>
                            </div>
                            
                            <h5 style="margin-top: 12px; margin-bottom: 4px; display: flex; justify-content: space-between;">
                                <span>–°–µ—Ç</span>
                                <span style="flex-grow: 1; text-align: center;">–í–µ—Å (–∫–≥)</span>
                                <span style="flex-grow: 1; text-align: center;">–ü–æ–≤—Ç.</span>
                                <span style="width: 30px;"></span>
                            </h5>
                            
                            ${ex.sets.map(set => `
                                <div class="set-row">
                                    <span class="label">${ex.sets.indexOf(set) + 1}</span>
                                    <input 
                                        type="number" 
                                        value="${set.weight}" 
                                        oninput="updateSet(${ex.id}, ${set.id}, 'weight', this.value)"
                                        placeholder="–í–µ—Å"
                                    >
                                    <input 
                                        type="number" 
                                        value="${set.reps}" 
                                        oninput="updateSet(${ex.id}, ${set.id}, 'reps', this.value)"
                                        placeholder="–ü–æ–≤—Ç."
                                    >
                                    <button class="remove-btn" onclick="removeSet(${ex.id}, ${set.id})">x</button>
                                </div>
                            `).join('')}

                            <button class="btn-secondary" onclick="addSet(${ex.id})" style="width: 100%; margin-top: 8px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ç</button>
                        </div>
                    `).join('')}
                </div>

                <div style="position: fixed; bottom: 64px; left: 0; right: 0; padding: 16px; background: #f5f5f5; border-top: 1px solid #eee;">
                    <button class="btn-primary" onclick="finishWorkout()" style="width: 100%; padding: 12px; font-size: 16px;">
                        ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            `;
            return html;
        }

        function removeExercise(workoutExId) {
            currentWorkout = currentWorkout.filter(ex => ex.id !== workoutExId);
            render();
        }

        function loadWorkoutFromHistory(workoutId) {
            const workout = workouts.find(w => w.id === workoutId);
            if (workout) {
                currentWorkoutId = Date.now(); // –ù–æ–≤—ã–π ID –¥–ª—è –Ω–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                currentWorkout = workout.exercises.map(ex => ({
                    id: Date.now() + Math.random(),
                    exerciseId: ex.exerciseId,
                    sets: ex.sets.map(set => ({
                        id: Date.now() + Math.random() + 1,
                        weight: set.weight,
                        reps: set.reps
                    }))
                }));
                setView(VIEWS.WORKOUT);
            }
        }
        
        // --- –®–∞–±–ª–æ–Ω—ã (Routines) ---

        function renderRoutines() {
            let html = `
                <div class="card">
                    <h2 style="margin-bottom: 12px;">–®–∞–±–ª–æ–Ω—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>
                    <button class="btn-primary" onclick="showAddRoutineModal()" style="width: 100%;">‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω</button>
                </div>
                <div id="routines-list">
                    ${routines.length > 0 ? routines.map(r => `
                        <div class="card list-item" onclick="loadRoutine(${r.id})">
                            <div>
                                <h4>${r.name}</h4>
                                <p>${r.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
                            </div>
                            <div class="list-item-right">
                                <button class="btn-secondary" onclick="event.stopPropagation(); editRoutine(${r.id})">‚úèÔ∏è</button>
                                <button class="btn-danger" onclick="event.stopPropagation(); deleteRoutine(${r.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('') : '<div class="card"><p style="color: #666;">–ü–æ–∫–∞ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</p></div>'}
                </div>
            `;
            return html;
        }

        function showAddRoutineModal(routineToEdit = null) {
            const isEdit = !!routineToEdit;
            const routineName = isEdit ? routineToEdit.name : '';
            const routineExercises = isEdit ? routineToEdit.exercises.map(ex => ex.exerciseId) : [];

            let content = `
                <h3>${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω' : '–ù–æ–≤—ã–π —à–∞–±–ª–æ–Ω'}</h3>
                <input type="text" id="routineName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –î–µ–Ω—å –ì—Ä—É–¥–∏)" value="${routineName}">
                
                <h4 style="margin-top: 15px; margin-bottom: 10px;">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:</h4>
                <div id="exerciseChecklist" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                    ${exercises.map(ex => `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                            <label for="ex-${ex.id}">${ex.name} (${ex.group})</label>
                            <input type="checkbox" id="ex-${ex.id}" value="${ex.id}" ${routineExercises.includes(ex.id) ? 'checked' : ''}>
                        </div>
                    `).join('')}
                </div>
                
                <button 
                    class="btn-primary" 
                    onclick="${isEdit ? `saveRoutine(${routineToEdit.id})` : 'saveRoutine()'}" 
                    style="width: 100%; margin-top: 15px;"
                >
                    ${isEdit ? 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '‚ûï –°–æ–∑–¥–∞—Ç—å'}
                </button>
            `;

            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–æ –±—ã –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ. 
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram WebApp alert –∫–∞–∫ –∑–∞–≥–ª—É—à–∫—É, —Ö–æ—Ç—è —ç—Ç–æ –Ω–µ –ª—É—á—à–∏–π UI
            if (window.Telegram && window.Telegram.WebApp) {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º Telegram Web App –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π UI. 
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø—Ä–æ—Å—Ç–æ alert –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏:
                window.Telegram.WebApp.showAlert('–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞.');
            } else {
                 alert('–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –∏–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –∑–¥–µ—Å—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.');
            }
        }
        
        function saveRoutine(id = null) {
            const name = document.getElementById('routineName') ? document.getElementById('routineName').value : prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞:');
            if (!name) return;

            const selectedExercises = [];
            document.querySelectorAll('#exerciseChecklist input:checked').forEach(input => {
                selectedExercises.push({ exerciseId: parseInt(input.value) });
            });

            if (selectedExercises.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ.');
                return;
            }

            if (id) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                const index = routines.findIndex(r => r.id === id);
                if (index !== -1) {
                    routines[index] = { id, name, exercises: selectedExercises };
                }
            } else {
                // –°–æ–∑–¥–∞–Ω–∏–µ
                const newRoutine = {
                    id: Date.now(),
                    name: name,
                    exercises: selectedExercises
                };
                routines.push(newRoutine);
            }

            save();
            render();
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.
        }

        function editRoutine(id) {
            const routine = routines.find(r => r.id === id);
            if (routine) {
                showAddRoutineModal(routine);
            }
        }

        function deleteRoutine(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
                routines = routines.filter(r => r.id !== id);
                save();
                render();
            }
        }

        function loadRoutine(id) {
            const routine = routines.find(r => r.id === id);
            if (routine) {
                if (!confirm(`–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –ø–æ —à–∞–±–ª–æ–Ω—É "${routine.name}"?`)) return;

                currentWorkoutId = Date.now();
                currentWorkout = routine.exercises.map(ex => ({
                    id: Date.now() + Math.random(),
                    exerciseId: ex.exerciseId,
                    sets: [{ id: Date.now() + Math.random() + 1, weight: 0, reps: 0 }]
                }));
                setView(VIEWS.WORKOUT);
            }
        }

        // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (Stats) ---

        function renderStats() {
            // –ü–æ–¥—Å—á–µ—Ç Total PRs (–Ω–∞–∏–±–æ–ª—å—à–∏–π –≤–µ—Å * –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è)
            const prs = calculatePersonalRecords();
            
            const totalVolume = workouts.reduce((sum, w) => sum + w.exercises.reduce((vol, e) => vol + e.sets.reduce((setVol, s) => setVol + s.weight * s.reps, 0), 0), 0);
            
            let html = `
                <div class="card header-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h2 style="margin-bottom: 8px;">–°–≤–æ–¥–∫–∞</h2>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <h3>${prs.length}</h3>
                            <p>PR –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</p>
                        </div>
                        <div class="stat-item">
                            <h3>${(totalVolume / 1000).toFixed(1)} —Ç</h3>
                            <p>–û–±—â–∏–π –æ–±—ä–µ–º</p>
                        </div>
                        <div class="stat-item">
                            <h3>${workouts.length}</h3>
                            <p>–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 12px;">–õ–∏—á–Ω—ã–µ –†–µ–∫–æ—Ä–¥—ã (PR)</h3>
                    <div id="pr-list">
                        ${prs.map(pr => `
                            <div class="pr-list-item" onclick="viewExerciseStats(${pr.exerciseId})">
                                <div>
                                    <div class="pr-name">${getExerciseName(pr.exerciseId)}</div>
                                    <div class="pr-date">${new Date(pr.date).toLocaleDateString('ru-RU')}</div>
                                </div>
                                <div class="pr-value">${pr.prValue} –∫–≥ x ${pr.reps}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            if (currentExerciseStatsId) {
                html += renderExerciseStatsDetail(currentExerciseStatsId);
            }
            
            return html;
        }
        
        function calculatePersonalRecords() {
            const records = {}; // { exerciseId: { prValue: X, reps: Y, date: Z } }

            workouts.forEach(w => {
                const date = w.date;
                w.exercises.forEach(ex => {
                    const id = ex.exerciseId;
                    ex.sets.forEach(set => {
                        // PR —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –≤–µ—Å—É (set.weight)
                        if (!records[id] || set.weight > records[id].prValue) {
                            records[id] = { 
                                exerciseId: id, 
                                prValue: set.weight, 
                                reps: set.reps, 
                                date: date 
                            };
                        } else if (set.weight === records[id].prValue && set.reps > records[id].reps) {
                             // –ï—Å–ª–∏ –≤–µ—Å —Ä–∞–≤–µ–Ω, –±–µ—Ä–µ–º —Å–µ—Ç —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
                            records[id].reps = set.reps;
                            records[id].date = date; // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –±—ã–ª –¥–æ—Å—Ç–∏–≥–Ω—É—Ç —ç—Ç–æ—Ç –≤–µ—Å/–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                        }
                    });
                });
            });

            return Object.values(records).sort((a, b) => getExerciseName(a.exerciseId).localeCompare(getExerciseName(b.exerciseId)));
        }

        function viewExerciseStats(exerciseId) {
            currentExerciseStatsId = exerciseId;
            render();
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –∫ –≥—Ä–∞—Ñ–∏–∫—É
            setTimeout(() => {
                document.getElementById('exercise-stats-detail').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function renderExerciseStatsDetail(exerciseId) {
            const exName = getExerciseName(exerciseId);
            const exWorkouts = workouts.filter(w => w.exercises.some(ex => ex.exerciseId === exerciseId));

            if (exWorkouts.length === 0) return '';
            
            // –†–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –≤–µ—Å–∞ (Max Weight) –∏ –æ–±—â–µ–≥–æ –æ–±—ä–µ–º–∞ (Total Volume) –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            const chartData = exWorkouts.map(w => {
                const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                const maxWeight = Math.max(...ex.sets.map(s => s.weight));
                const totalVolume = ex.sets.reduce((sum, s) => sum + s.weight * s.reps, 0);
                
                return {
                    date: new Date(w.date).toLocaleDateString('ru-RU'),
                    maxWeight: maxWeight,
                    totalVolume: totalVolume / 1000 // –≤ —Ç–æ–Ω–Ω–∞—Ö
                };
            });

            return `
                <div class="card" id="exercise-stats-detail">
                    <h3 style="margin-bottom: 12px;">–î–∏–Ω–∞–º–∏–∫–∞: ${exName}</h3>
                    <div class="button-group" style="margin-bottom: 12px;">
                        <button class="btn-primary" id="maxWeightBtn" onclick="toggleChartType('maxWeight')" style="flex-grow: 1;">–ú–∞–∫—Å. –í–µ—Å</button>
                        <button class="btn-secondary" id="totalVolumeBtn" onclick="toggleChartType('totalVolume')" style="flex-grow: 1;">–û–±—ä–µ–º</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="statChart"></canvas>
                    </div>
                    
                    <h4 style="margin-top: 20px;">–ò—Å—Ç–æ—Ä–∏—è</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${exWorkouts.reverse().map(w => {
                            const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                            const { totalVolume, totalSets } = calculateWorkoutStats({ exercises: [ex] });
                            return `
                                <div class="stat-detail-item">
                                    <span>${new Date(w.date).toLocaleDateString('ru-RU')}</span>
                                    <span>–û–±—ä–µ–º: ${(totalVolume / 1000).toFixed(2)} —Ç / –°–µ—Ç–æ–≤: ${totalSets}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        let statChartInstance = null;
        let currentChartType = 'maxWeight'; // maxWeight –∏–ª–∏ totalVolume

        function toggleChartType(type) {
            currentChartType = type;
            document.getElementById('maxWeightBtn').className = type === 'maxWeight' ? 'btn-primary' : 'btn-secondary';
            document.getElementById('totalVolumeBtn').className = type === 'totalVolume' ? 'btn-primary' : 'btn-secondary';
            renderChart(currentExerciseStatsId);
        }

        function renderChart(exerciseId) {
            const exWorkouts = workouts.filter(w => w.exercises.some(ex => ex.exerciseId === exerciseId));

            const chartData = exWorkouts.map(w => {
                const ex = w.exercises.find(e => e.exerciseId === exerciseId);
                const maxWeight = Math.max(...ex.sets.map(s => s.weight));
                const totalVolume = ex.sets.reduce((sum, s) => sum + s.weight * s.reps, 0);
                
                return {
                    date: new Date(w.date).toLocaleDateString('ru-RU'),
                    maxWeight: maxWeight,
                    totalVolume: totalVolume / 1000 // –≤ —Ç–æ–Ω–Ω–∞—Ö
                };
            });
            
            const labels = chartData.map(d => d.date);
            const data = chartData.map(d => d[currentChartType]);
            const unit = currentChartType === 'maxWeight' ? '–∫–≥' : '—Ç';

            const ctx = document.getElementById('statChart');
            if (statChartInstance) {
                statChartInstance.destroy();
            }

            statChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentChartType === 'maxWeight' ? '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å' : '–û–±—â–∏–π –æ–±—ä–µ–º',
                        data: data,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#764ba2',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} ${unit}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: unit
                            }
                        }
                    }
                }
            });
        }


        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Settings) ---

        function renderSettings() {
             // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏: –µ—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ ID –≤ workouts –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ID –≤ exercises
             const allWorkoutExIds = new Set(workouts.flatMap(w => w.exercises.map(e => e.exerciseId)));
             const invalidExIds = Array.from(allWorkoutExIds).filter(id => !exercises.some(e => e.id === id));
             
             let validationAlert = '';
             if (invalidExIds.length > 0) {
                 validationAlert = `<div class="card" style="background: #fef2f2; border: 1px solid #fca5a5; color: #ef4444;">
                    <h4 style="margin-bottom: 8px;">üö® –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö!</h4>
                    <p style="font-size: 14px;">–í —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –Ω–∞–π–¥–µ–Ω—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å ID, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–±—Ä–æ—Å–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç.</p>
                 </div>`;
             }

             const h = `
                 <div class="card">
                     <h2 style="margin-bottom: 12px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                     <h3 style="margin-top: 15px; margin-bottom: 10px;">–°–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π (${exercises.length})</h3>
                     <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                         ${exercises.map(ex => `
                             <div class="list-item">
                                 <span>${ex.name} (${ex.group})</span>
                                 <button class="btn-danger" onclick="deleteExercise(${ex.id})">üóëÔ∏è</button>
                             </div>
                         `).join('')}
                     </div>
                     <button class="btn-primary" onclick="showAddExerciseModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
                 </div>
                 
                 ${validationAlert}

                 <div class="card">
                     <h3 style="margin-bottom: 12px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                     <button class="btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 8px;">üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                     <button class="btn-secondary" onclick="importData()" style="width: 100%; margin-bottom: 16px;">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                     
                     <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                        <button class="btn-danger" onclick="resetRoutines()" style="width: 100%; margin-bottom: 8px;">–°–±—Ä–æ—Å–∏—Ç—å —à–∞–±–ª–æ–Ω—ã</button>
                        <button class="btn-danger" onclick="resetWo()" style="width: 100%; margin-bottom: 8px;">–°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</button>
                        <button class="btn-danger" onclick="resetEx()" style="width: 100%; margin-bottom: 16px;">–°–±—Ä–æ—Å–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã</button>
                        <button onclick="resetAll()" style="width: 100%; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">‚ö†Ô∏è –°–ë–†–û–°–ò–¢–¨ –í–°–Å</button>
                     </div>
                 </div>
                 <div class="card"><h3 style="margin-bottom: 12px;">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                 <p style="color: #666; font-size: 14px;">üí™ –¢—Ä–µ–∫–µ—Ä –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ **v2.2** (–®–∞–±–ª–æ–Ω—ã Fix + –ü–æ–¥—Ä–æ–±–Ω–∞—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ + **Calendar/Button Fix**)<br>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</p>
                 </div>`;
             return h;
        }

        function showAddExerciseModal() {
             const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:');
             if (!name) return;
             const group = prompt('–í–≤–µ–¥–∏—Ç–µ –≥—Ä—É–ø–ø—É –º—ã—à—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ì—Ä—É–¥—å):', '–ë–µ–∑ –≥—Ä—É–ø–ø—ã');
             
             const newEx = {
                 id: Date.now(),
                 name: name.trim(),
                 group: group.trim()
             };
             exercises.push(newEx);
             save();
             render();
        }

        function deleteExercise(id) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${getExerciseName(id)}"? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –æ—Å—Ç–∞–Ω—É—Ç—Å—è.`)) {
                exercises = exercises.filter(ex => ex.id !== id);
                save();
                render();
            }
        }
        
        function resetRoutines() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —à–∞–±–ª–æ–Ω—ã?')) {
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetWo() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?')) {
                workouts = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetEx() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —à–∞–±–ª–æ–Ω—ã?')) {
                exercises = [];
                workouts = [];
                routines = [];
                save();
                alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ');
                render();
            }
        }

        function resetAll() {
            if (confirm('‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï?')) {
                if (confirm('–¢–æ—á–Ω–æ? –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!')) {
                    exercises = [];
                    workouts = [];
                    routines = [];
                    currentWorkout = [];
                    localStorage.clear();
                    alert('üî• –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    render();
                }
            }
        }
        
        // --- –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç ---
        function exportData() {
            const data = {
                exercises: exercises,
                workouts: workouts,
                routines: routines
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout_tracker_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (confirm('–í–Ω–∏–º–∞–Ω–∏–µ! –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–º–µ–Ω—è—Ç —Ç–µ–∫—É—â–∏–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                            if (importedData.exercises) exercises = importedData.exercises;
                            if (importedData.workouts) workouts = importedData.workouts;
                            if (importedData.routines) routines = importedData.routines;
                            save();
                            alert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                            render();
                        }
                    } catch (error) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Ñ–∞–π–ª–∞ JSON.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        init();
    </script>
</body>
</html>
